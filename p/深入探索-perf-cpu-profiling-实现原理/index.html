<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="# perf æ˜¯ä»€ä¹ˆ perf æ˜¯ç”± Linux å®˜æ–¹æä¾›çš„ç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…· ã€‚æˆ‘ä»¬é€šå¸¸è¯´çš„ perf å®é™…ä¸ŠåŒ…å«ä¸¤éƒ¨åˆ†ï¼š perf å‘½ä»¤ï¼Œç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åº perf_events ï¼ŒLinux å†…æ ¸ä¸­çš„ä¸€ä¸ªå­ç³»ç»Ÿ å†…æ ¸">
<title>æ·±å…¥æ¢ç´¢ perf CPU Profiling å®ç°åŸç†</title>

<link rel='canonical' href='https://mazhen.tech/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2-perf-cpu-profiling-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/'>

<link rel="stylesheet" href="/scss/style.min.760e3dabc1e140d2e6abd27a8ca0aabb60e568829b29f67d2df12024136eff37.css"><meta property='og:title' content="æ·±å…¥æ¢ç´¢ perf CPU Profiling å®ç°åŸç†">
<meta property='og:description' content="# perf æ˜¯ä»€ä¹ˆ perf æ˜¯ç”± Linux å®˜æ–¹æä¾›çš„ç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…· ã€‚æˆ‘ä»¬é€šå¸¸è¯´çš„ perf å®é™…ä¸ŠåŒ…å«ä¸¤éƒ¨åˆ†ï¼š perf å‘½ä»¤ï¼Œç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åº perf_events ï¼ŒLinux å†…æ ¸ä¸­çš„ä¸€ä¸ªå­ç³»ç»Ÿ å†…æ ¸">
<meta property='og:url' content='https://mazhen.tech/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2-perf-cpu-profiling-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/'>
<meta property='og:site_name' content='mazhen.tech'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='linux' /><meta property='article:tag' content='kernel' /><meta property='article:published_time' content='2023-11-06T11:18:06&#43;08:00'/><meta property='article:modified_time' content='2023-11-06T11:18:06&#43;08:00'/>
<meta name="twitter:site" content="@rootletmistake">
    <meta name="twitter:creator" content="@rootletmistake"><meta name="twitter:title" content="æ·±å…¥æ¢ç´¢ perf CPU Profiling å®ç°åŸç†">
<meta name="twitter:description" content="# perf æ˜¯ä»€ä¹ˆ perf æ˜¯ç”± Linux å®˜æ–¹æä¾›çš„ç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…· ã€‚æˆ‘ä»¬é€šå¸¸è¯´çš„ perf å®é™…ä¸ŠåŒ…å«ä¸¤éƒ¨åˆ†ï¼š perf å‘½ä»¤ï¼Œç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åº perf_events ï¼ŒLinux å†…æ ¸ä¸­çš„ä¸€ä¸ªå­ç³»ç»Ÿ å†…æ ¸">
    <link rel="shortcut icon" href="/favicon.png" />

  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-LBEVB8TRX2"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-LBEVB8TRX2');
        }
      </script>
    
  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/mazhen_hu6e56901738cd7f8ddabbbe3def51a5b4_111611_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">mazhen.tech</a></h1>
            <h2 class="site-description">Stay hungry. Stay foolish.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='mailto:me@mazhen.tech'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="3" y="5" width="18" height="14" rx="2" />
  <polyline points="3 7 12 13 21 7" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/mz1999'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.instagram.com/clippercongo/'
                        target="_blank"
                        title="instagram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-instagram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="4" y="4" width="16" height="16" rx="4" />
  <circle cx="12" cy="12" r="3" />
  <line x1="16.5" y1="7.5" x2="16.5" y2="7.501" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://t.me/crownrecount'
                        target="_blank"
                        title="telegram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-telegram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/rootletmistake'
                        target="_blank"
                        title="twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://mazhen.tech/" selected>ä¸­æ–‡</option>
                                
                                    <option value="https://mazhen.tech/en/" >English</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#perf-æ˜¯ä»€ä¹ˆ">perf æ˜¯ä»€ä¹ˆ</a></li>
    <li><a href="#perf-äº‹ä»¶æº">perf äº‹ä»¶æº</a></li>
    <li><a href="#hardware-event">Hardware Event</a></li>
    <li><a href="#cpu-profiling">CPU Profiling</a>
      <ol>
        <li><a href="#cycles-äº‹ä»¶">cycles äº‹ä»¶</a></li>
        <li><a href="#è®¾ç½®é‡‡æ ·é¢‘ç‡">è®¾ç½®é‡‡æ ·é¢‘ç‡</a></li>
      </ol>
    </li>
    <li><a href="#èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†</a>
      <ol>
        <li><a href="#cpu-æ‰§è¡ŒæŒ‡ä»¤">CPU æ‰§è¡ŒæŒ‡ä»¤</a></li>
        <li><a href="#è¿˜åŸå‡½æ•°è°ƒç”¨æ ˆ">è¿˜åŸå‡½æ•°è°ƒç”¨æ ˆ</a></li>
        <li><a href="#ç”¨æˆ·æ€å’Œå†…æ ¸æ€">ç”¨æˆ·æ€å’Œå†…æ ¸æ€</a></li>
        <li><a href="#ç³»ç»Ÿè°ƒç”¨">ç³»ç»Ÿè°ƒç”¨</a></li>
        <li><a href="#ç”¨æˆ·æ ˆå’Œå†…æ ¸æ ˆ">ç”¨æˆ·æ ˆå’Œå†…æ ¸æ ˆ</a></li>
        <li><a href="#è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´">è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´</a></li>
        <li><a href="#è¿˜åŸå®Œæ•´è°ƒç”¨æ ˆ">è¿˜åŸå®Œæ•´è°ƒç”¨æ ˆ</a></li>
        <li><a href="#ä¸­æ–­å¤„ç†">ä¸­æ–­å¤„ç†</a></li>
      </ol>
    </li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tech/" >
                Tech
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2-perf-cpu-profiling-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">æ·±å…¥æ¢ç´¢ perf CPU Profiling å®ç°åŸç†</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2023-11-06</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 26 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p><img src="https://cdn.mazhen.tech/images/202311211430792.png"
	
	
	
	loading="lazy"
	
		alt="title"
	
	
></p>
<h2 id="perf-æ˜¯ä»€ä¹ˆ">
    <a href="#perf-%e6%98%af%e4%bb%80%e4%b9%88" class="header-anchor">#</a>
    perf æ˜¯ä»€ä¹ˆ
</h2><p><a class="link" href="https://perf.wiki.kernel.org/index.php/Main_Page"  target="_blank" rel="noopener"
    >perf</a> æ˜¯ç”± Linux å®˜æ–¹æä¾›çš„ç³»ç»Ÿæ€§èƒ½åˆ†æå·¥å…· ã€‚æˆ‘ä»¬é€šå¸¸è¯´çš„ perf å®é™…ä¸ŠåŒ…å«ä¸¤éƒ¨åˆ†ï¼š</p>
<ul>
<li><strong>perf</strong> å‘½ä»¤ï¼Œç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åº</li>
<li><strong>perf_events</strong> ï¼ŒLinux å†…æ ¸ä¸­çš„ä¸€ä¸ªå­ç³»ç»Ÿ</li>
</ul>
<p>å†…æ ¸å­ç³»ç»Ÿ <code>perf_events</code> æä¾›äº†æ€§èƒ½è®¡æ•°å™¨ï¼ˆ<a class="link" href="https://en.wikipedia.org/wiki/Hardware_performance_counter"  target="_blank" rel="noopener"
    >hardware performance counters</a>ï¼‰å’Œæ€§èƒ½äº‹ä»¶çš„æ”¯æŒï¼Œå®ƒä»¥äº‹ä»¶é©±åŠ¨å‹çš„æ–¹å¼å·¥ä½œï¼Œé€šè¿‡æ”¶é›†ç‰¹å®šäº‹ä»¶ï¼ˆå¦‚ CPU æ—¶é’Ÿå‘¨æœŸï¼Œç¼“å­˜æœªå‘½ä¸­ç­‰ï¼‰æ¥è·Ÿè¸ªå’Œåˆ†æç³»ç»Ÿæ€§èƒ½ã€‚<code>perf_events</code>æ˜¯åœ¨ <a class="link" href="https://lwn.net/Articles/339361/"  target="_blank" rel="noopener"
    >2009 å¹´åˆå¹¶åˆ° Linux å†…æ ¸æºä»£ç ä¸­</a>ï¼Œæˆä¸ºå†…æ ¸ä¸€ä¸ªæ–°çš„å­ç³»ç»Ÿã€‚</p>
<p><code>perf</code> å‘½ä»¤æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´å·¥å…·ï¼Œå…·å¤‡ profilingã€tracing å’Œè„šæœ¬ç¼–å†™ç­‰å¤šç§åŠŸèƒ½ï¼Œæ˜¯å†…æ ¸å­ç³»ç»Ÿ perf_events çš„å‰ç«¯å·¥å…·ã€‚é€šè¿‡<code>perf</code> å‘½ä»¤å¯ä»¥è®¾ç½®å’Œæ“ä½œå†…æ ¸å­ç³»ç»Ÿ <code>perf_events</code>ï¼Œå®Œæˆç³»ç»Ÿæ€§èƒ½æ•°æ®çš„æ”¶é›†å’Œåˆ†æã€‚</p>
<p>è™½ç„¶ <code>perf</code> å‘½ä»¤æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºï¼Œä½†å®ƒå´ä½äº Linux å†…æ ¸æºä»£ç æ ‘ä¸­ï¼Œåœ¨ <a class="link" href="https://github.com/torvalds/linux/tree/master/tools/perf"  target="_blank" rel="noopener"
    >tools/perf</a> ç›®å½•ä¸‹ï¼Œå®ƒå¯èƒ½æ˜¯å”¯ä¸€ä¸€ä¸ªè¢«åŒ…å«åœ¨ Linux å†…æ ¸æºç ä¸­çš„å¤æ‚ç”¨æˆ·è½¯ä»¶ã€‚</p>
<p>perf å’Œ perf_events æœ€åˆæ”¯æŒç¡¬ä»¶è®¡æ•°å™¨ï¼ˆperformance monitoring countersï¼Œ<strong>PMC</strong>ï¼‰ï¼Œåæ¥é€æ­¥æ‰©å±•åˆ°æ”¯æŒå¤šç§äº‹ä»¶æºï¼ŒåŒ…æ‹¬ï¼š<a class="link" href="https://docs.kernel.org/trace/events.html"  target="_blank" rel="noopener"
    >tracepoints</a>ã€kernel è½¯ä»¶äº‹ä»¶ã€<a class="link" href="https://www.kernel.org/doc/html/latest/trace/kprobes.html"  target="_blank" rel="noopener"
    >kprobes</a>ã€<a class="link" href="https://docs.kernel.org/trace/uprobetracer.html?highlight=uprobe"  target="_blank" rel="noopener"
    >uprobes</a> å’Œ USDTï¼ˆUser-level statically-defined tracingï¼‰ã€‚</p>
<p>ä¸‹å›¾æ˜¾ç¤ºäº† perf å‘½ä»¤å’Œ perf_events çš„å…³ç³»ï¼Œä»¥åŠ perf_events æ”¯æŒçš„äº‹ä»¶æºã€‚</p>
<p><img src="https://cdn.mazhen.tech/images/202311071635405.png"
	
	
	
	loading="lazy"
	
		alt="perf events"
	
	
></p>
<h2 id="perf-äº‹ä»¶æº">
    <a href="#perf-%e4%ba%8b%e4%bb%b6%e6%ba%90" class="header-anchor">#</a>
    perf äº‹ä»¶æº
</h2><p>perf æ”¯æŒæ¥è‡ªç¡¬ä»¶å’Œè½¯ä»¶æ–¹é¢çš„å„ç§äº‹ä»¶ã€‚ç¡¬ä»¶äº‹ä»¶æ¥è‡ªèŠ¯ç‰‡ç»„ä¸­çš„ç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨ï¼ˆ<a class="link" href="https://en.wikipedia.org/wiki/Hardware_performance_counter"  target="_blank" rel="noopener"
    >hardware performance counters</a>ï¼‰ï¼Œè€Œè½¯ä»¶äº‹ä»¶åˆ™ç”±<a class="link" href="https://docs.kernel.org/trace/events.html"  target="_blank" rel="noopener"
    >tracepoints</a>ã€<a class="link" href="https://www.kernel.org/doc/html/latest/trace/kprobes.html"  target="_blank" rel="noopener"
    >kprobe</a> å’Œ <a class="link" href="https://docs.kernel.org/trace/uprobetracer.html?highlight=uprobe"  target="_blank" rel="noopener"
    >uprobe</a> ç­‰è°ƒè¯•è®¾æ–½æä¾›ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ perf çš„å­å‘½ä»¤ <strong>list</strong> åˆ—å‡ºå½“å‰å¯ç”¨çš„æ‰€æœ‰äº‹ä»¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo perf list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">List of pre-defined events <span class="o">(</span>to be used in -e or -M<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  branch-instructions OR branches                    <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  branch-misses                                      <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  bus-cycles                                         <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cache-misses                                       <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cache-references                                   <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cpu-cycles OR cycles                               <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cgroup-switches                                    <span class="o">[</span>Software event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  context-switches OR cs                             <span class="o">[</span>Software event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cpu-clock                                          <span class="o">[</span>Software event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl">  L1-dcache-load-misses                              <span class="o">[</span>Hardware cache event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  L1-dcache-loads                                    <span class="o">[</span>Hardware cache event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl">  branch-instructions OR cpu/branch-instructions/    <span class="o">[</span>Kernel PMU event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  branch-misses OR cpu/branch-misses/                <span class="o">[</span>Kernel PMU event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl">  sched:sched_process_exec                           <span class="o">[</span>Tracepoint event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  sched:sched_process_exit                           <span class="o">[</span>Tracepoint event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  sched:sched_process_fork                           <span class="o">[</span>Tracepoint event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>äº‹ä»¶ç±»å‹å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>Hardware Event</strong>ï¼šCPU æ€§èƒ½è®¡æ•°å™¨ï¼ˆperformance monitoring countersï¼‰</li>
<li><strong>Software event</strong>ï¼šå†…æ ¸è®¡æ•°å™¨äº‹ä»¶</li>
<li><strong>Hardware cache event</strong>ï¼šCPU Cache äº‹ä»¶</li>
<li><strong>Kernel PMU event</strong>ï¼šPerformance Monitoring Unit (PMU) äº‹ä»¶</li>
<li><strong>Tracepoint event</strong>ï¼šåŒ…å«äº†é™æ€å’ŒåŠ¨æ€ä»£ç è¿½è¸ªäº‹ä»¶
<ul>
<li><strong>Kernel tracepoints</strong>ï¼šåœ¨ kernel ä¸­å…³é”®ä½ç½®çš„é™æ€è¿½è¸ªä»£ç </li>
<li><strong>kprobes</strong>ï¼šåœ¨å†…æ ¸ä¸­çš„ä»»æ„ä½ç½®åŠ¨æ€åœ°è¢«æ’å…¥è¿½è¸ªä»£ç </li>
<li><strong>uprobes</strong>ï¼šä¸kprobesç±»ä¼¼ï¼Œä½†ç”¨äºç”¨æˆ·ç©ºé—´ã€‚åŠ¨æ€åœ°åœ¨åº”ç”¨ç¨‹åºå’Œåº“ä¸­çš„ä»»æ„ä½ç½®æ’å…¥è¿½è¸ªä»£ç </li>
<li><strong>USDT</strong>ï¼šæ˜¯ tracepoints åœ¨ç”¨æˆ·ç©ºé—´çš„å¯¹åº”æŠ€æœ¯ï¼Œæ˜¯åº”ç”¨ç¨‹åºå’Œåº“åœ¨å®ƒä»¬çš„ä»£ç ä¸­æå‰åŠ å…¥çš„é™æ€è¿½è¸ªä»£ç </li>
</ul>
</li>
</ul>
<p>perf çš„ â€œTracepoint eventâ€ äº‹ä»¶æºå¾ˆå®¹æ˜“å¼•èµ·æ··æ·†ï¼Œå› ä¸ºé™¤äº†å†…æ ¸çš„ tracepointsï¼ŒåŸºäº kprobeã€uprobe å’Œ USDT çš„è·Ÿè¸ªäº‹ä»¶ä¹Ÿè¢«æ ‡è®°ä¸ºäº†â€œTracepoint eventâ€ã€‚é»˜è®¤æƒ…å†µä¸‹å®ƒä»¬ä¸ä¼šå‡ºç°åœ¨ perf list çš„è¾“å‡ºä¸­ï¼Œ å¿…é¡»å…ˆåˆå§‹åŒ–æ‰ä¼šä½œä¸º &ldquo;Tracepoint event&rdquo; ä¸­çš„äº‹ä»¶ã€‚</p>
<p>å†…æ ¸ tracepoints æ˜¯ç”± <a class="link" href="https://elixir.bootlin.com/linux/latest/source/include/trace/trace_events.h#L39"  target="_blank" rel="noopener"
    >TRACE_EVENT</a> å®å®šä¹‰ã€‚TRACE_EVENT è‡ªåŠ¨ç”Ÿæˆé™æ€è¿½è¸ªä»£ç ï¼Œå®šä¹‰å¹¶æ ¼å¼åŒ–å…¶å‚æ•°ï¼Œå¹¶å°†è·Ÿè¸ªäº‹ä»¶æ”¾å…¥ tracefs ï¼ˆ/sys/kernel/debug/tracingï¼‰å’Œ <a class="link" href="https://www.man7.org/linux/man-pages/man2/perf_event_open.2.html"  target="_blank" rel="noopener"
    >perf_event_open</a> æ¥å£ã€‚</p>
<p>ä¸å…¶ä»–æ€§èƒ½åˆ†æå·¥å…·ç›¸æ¯”ï¼Œperf ç‰¹åˆ«é€‚åˆ CPU åˆ†æï¼Œå®ƒèƒ½å¯¹è¿è¡Œåœ¨ CPU ä¸Šä»£ç è°ƒç”¨æ ˆï¼ˆstack tracesï¼‰è¿›è¡Œé‡‡æ ·ï¼Œä»¥ç¡®å®šç¨‹åºåœ¨ CPU ä¸Šçš„è¿è¡Œæƒ…å†µï¼Œè¯†åˆ«å’Œä¼˜åŒ–ä»£ç ä¸­çš„çƒ­ç‚¹ã€‚è¿™ç§ CPU Profiling èƒ½åŠ›æ˜¯åŸºäºç¡¬ä»¶è®¡æ•°å™¨ (performance monitoring countersï¼ŒPMC) å®ç°çš„ï¼Œè€Œ PMC è¢«å†…æ ¸å­ç³»ç»Ÿ <code>perf_events</code>  åŒ…è£…æˆäº† <strong>Hardware Event</strong>ï¼Œä¸‹é¢é‡ç‚¹ä»‹ç»ã€‚</p>
<h2 id="hardware-event">
    <a href="#hardware-event" class="header-anchor">#</a>
    Hardware Event
</h2><p>CPU å’Œå…¶ä»–ç¡¬ä»¶è®¾å¤‡é€šå¸¸æä¾›ç”¨äºè§‚æµ‹æ€§èƒ½æ•°æ®çš„ PMCã€‚ç®€å•æ¥è¯´ï¼Œ<strong>PMC</strong> å°±æ˜¯ CPU ä¸Šçš„<strong>å¯ç¼–ç¨‹å¯„å­˜å™¨</strong>ï¼Œå¯é€šè¿‡ç¼–ç¨‹å¯¹ç‰¹å®šç¡¬ä»¶äº‹ä»¶è¿›è¡Œè®¡æ•°ã€‚é€šè¿‡ PMC å¯ä»¥ç›‘æ§å’Œè®¡ç®— CPU å†…éƒ¨å„ç§äº‹ä»¶ï¼Œæ¯”å¦‚ CPU æŒ‡ä»¤çš„æ‰§è¡Œæ•ˆç‡ã€CPU caches çš„å‘½ä¸­ç‡ã€åˆ†æ”¯é¢„æµ‹çš„æˆåŠŸç‡ç­‰ micro-architectural çº§çš„æ€§èƒ½ä¿¡æ¯ã€‚åˆ©ç”¨è¿™äº›æ•°æ®åˆ†ææ€§èƒ½ï¼Œå¯ä»¥å®ç°å„ç§æ€§èƒ½ä¼˜åŒ–ã€‚</p>
<p>perf å‘½ä»¤é€šè¿‡ <a class="link" href="https://www.man7.org/linux/man-pages/man2/perf_event_open.2.html"  target="_blank" rel="noopener"
    >perf_event_open(2)</a> ç³»ç»Ÿè°ƒç”¨è®¿é—® PMCï¼Œé…ç½®æƒ³è¦æ•è·çš„ç¡¬ä»¶äº‹ä»¶ã€‚PMC å¯ä»¥åœ¨ä¸¤ç§æ¨¡å¼ä¸‹ä½¿ç”¨ï¼š</p>
<ul>
<li>Countingï¼ˆè®¡æ•°æ¨¡å¼ï¼‰ï¼Œåªè®¡ç®—å’ŒæŠ¥å‘Šç¡¬ä»¶äº‹ä»¶çš„æ€»æ•°ï¼Œå¼€é”€å‡ ä¹ä¸ºé›¶ã€‚</li>
<li>Samplingï¼ˆé‡‡æ ·æ¨¡å¼ï¼‰ï¼Œå½“å‘ç”Ÿä¸€å®šæ•°é‡çš„äº‹ä»¶åï¼Œä¼šè§¦å‘ä¸€ä¸ªä¸­æ–­ï¼Œä»¥ä¾¿æ•è·ç³»ç»Ÿçš„çŠ¶æ€ä¿¡æ¯ã€‚å¯ç”¨äºé‡‡é›†ä»£ç è·¯å¾„ã€‚</li>
</ul>
<p>glibc æ²¡æœ‰æä¾›å¯¹ç³»ç»Ÿè°ƒç”¨ perf_event_open çš„åŒ…è£…ï¼Œperf åœ¨ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.2/source/tools/perf/perf-sys.h"  target="_blank" rel="noopener"
    >tools/perf/perf-sys.h</a> å®šä¹‰äº†è‡ªå·±çš„åŒ…è£…å‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">sys_perf_event_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group_fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_perf_event_open</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">group_fd</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸€ä¸ªå‚æ•° <a class="link" href="https://elixir.bootlin.com/linux/v6.6.2/source/include/uapi/linux/perf_event.h#L385"  target="_blank" rel="noopener"
    >perf_event_attr</a> ç»“æ„ä½“å®šä¹‰äº†æƒ³è¦ç›‘æ§çš„äº‹ä»¶çš„ç±»å‹å’Œè¡Œä¸ºã€‚ä¾‹å¦‚æƒ³è¦ç»Ÿè®¡ CPU çš„æ€»æŒ‡ä»¤æ•°ï¼Œå¯ä»¥è¿™æ ·åˆå§‹åŒ– <code>perf_event_attr</code> ç»“æ„ä½“ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">perf_event_attr</span>  <span class="n">pe</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pe</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HARDWARE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">exclude_kernel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">exclude_hv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>perf åœ¨ <a class="link" href="https://elixir.bootlin.com/linux/v6.2.16/source/include/uapi/linux/perf_event.h"  target="_blank" rel="noopener"
    >perf_event.h</a> ä¸­å®šä¹‰äº†é€‚ç”¨äºå„ç±»å¤„ç†å™¨çš„é€šç”¨äº‹ä»¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">perf_hw_id</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CPU_CYCLES</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_INSTRUCTIONS</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">perf_hw_cache_id</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CACHE_L1D</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CACHE_L1I</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CACHE_LL</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é’ˆå¯¹æ¯ç§ CPUï¼Œéœ€è¦å°†äº‹ä»¶æšä¸¾ç±»å‹æ˜ å°„ä¸ºç‰¹å®š CPU çš„åŸå§‹ç¡¬ä»¶äº‹ä»¶æè¿°ç¬¦ã€‚ä¾‹å¦‚å¯¹äº Intel x86 æ¶æ„çš„ CPUï¼Œ<strong>PERF_COUNT_HW_INSTRUCTIONS</strong> äº‹ä»¶æ˜ å°„ä¸º <code>0x00c0</code>ï¼Œåœ¨ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.2/source/arch/x86/events/intel/core.c#L31"  target="_blank" rel="noopener"
    >arch/x86/events/intel/core.c</a> ä¸­å®šä¹‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">u64</span> <span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_MAX</span><span class="p">]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x003c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00c0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4f2e</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™äº›åŸå§‹ç¡¬ä»¶äº‹ä»¶æè¿°ç¬¦åœ¨ç›¸åº”çš„å¤„ç†å™¨è½¯ä»¶å¼€å‘äººå‘˜æ‰‹å†Œä¸­è¿›è¡Œäº†è¯´æ˜ã€‚å†…æ ¸å¼€å‘äººå‘˜æ ¹æ® CPU å‚å•†æä¾›çš„è½¯ä»¶å¼€å‘äººå‘˜æ‰‹å†Œï¼Œå®Œæˆ PMC äº‹ä»¶å’Œç‰¹å®š CPU ä»£ç çš„æ˜ å°„ã€‚</p>
<p>ä¾‹å¦‚ Intel x86 æ¶æ„çš„ CPUå¯ä»¥å‚è€ƒ <a class="link" href="https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html"  target="_blank" rel="noopener"
    >IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual</a> çš„ç¬¬ä¸‰å·ç¬¬ 20 ç«  â€œPERFORMANCE MONITORINGâ€ã€‚Intel è¿˜æä¾›äº†ä¸€ä¸ªç½‘ç«™ <a class="link" href="https://perfmon-events.intel.com/"  target="_blank" rel="noopener"
    >perfmon-events.intel.com</a>ï¼Œå¯ä»¥æŸ¥è¯¢ CPU çš„æ‰€æœ‰ PMC äº‹ä»¶ã€‚</p>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨ perf æ—¶ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šç‰¹å®š CPU çš„åŸå§‹äº‹ä»¶ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo perf stat -e r00c0 -e instructions -a sleep <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äº Intel CPUï¼Œ<code>instructions</code> äº‹ä»¶çš„åŸå§‹äº‹ä»¶ä»£ç ä¸º <code>r00c0</code>ï¼Œä¸¤è€…å¯ä»¥ç­‰ä»·ä½¿ç”¨ã€‚</p>
<p>å¯¹äºå¤§éƒ¨åˆ†é€šç”¨äº‹ä»¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦è®°ä½è¿™äº›åŸå§‹äº‹ä»¶ä»£ç ï¼Œperf éƒ½æä¾›äº†å¯è¯»çš„æ˜ å°„ã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¾‹å¦‚æœ€æ–° CPU å¢åŠ çš„äº‹ä»¶è¿˜æ²¡æœ‰åœ¨ perf ä¸­æ·»åŠ æ˜ å°„ï¼Œæˆ–è€…æŸç§ CPU çš„ç‰¹å®šäº‹ä»¶ä¸ä¼šé€šè¿‡å¯è¯»çš„åç§°æš´éœ²å‡ºæ¥ï¼Œè¿™æ—¶å°±åªèƒ½é€šè¿‡æŒ‡å®šåŸå§‹ç¡¬ä»¶äº‹ä»¶ä»£ç æ¥ç›‘æ§äº‹ä»¶ã€‚</p>
<p>ç®€å•äº†è§£äº† PMC åï¼Œæˆ‘ä»¬æ¥çœ‹å¦‚ä½•åŸºäº PMC äº‹ä»¶è¿›è¡Œ CPU Profilingã€‚</p>
<h2 id="cpu-profiling">
    <a href="#cpu-profiling" class="header-anchor">#</a>
    CPU Profiling
</h2><p>perf æ˜¯äº‹ä»¶é©±åŠ¨çš„æ–¹å¼å·¥ä½œï¼Œé€šè¿‡ <strong>-e</strong> å‚æ•°æŒ‡å®šæƒ³è¦æ”¶é›†çš„ç‰¹å®šäº‹ä»¶ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo perf stat -e LLC-loads,LLC-load-misses,LLC-stores,LLC-prefetches ls
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬åœ¨å¯¹æ•´ä¸ªç³»ç»Ÿçš„ CPU è¿›è¡Œ30 ç§’çš„é‡‡æ ·æ—¶ï¼Œä½¿ç”¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo perf record -F <span class="m">99</span> -a -g -- sleep <span class="m">30</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œå¹¶æœªæ˜ç¡®æŒ‡å®šäº‹ä»¶ï¼ˆæ²¡æœ‰ -e å‚æ•°ï¼‰ï¼Œperf å°†é»˜è®¤ä½¿ç”¨ä»¥ä¸‹é¢„å®šä¹‰äº‹ä»¶ä¸­ç¬¬ä¸€ä¸ªå¯ç”¨çš„ï¼š</p>
<ol>
<li>cycles:ppp</li>
<li>cycles:pp</li>
<li>cycles:p</li>
<li>cycles</li>
<li>cpu-clock</li>
</ol>
<p>å‰å››ä¸ªäº‹ä»¶éƒ½æ˜¯ PMC æä¾›çš„ CPU <strong>cycles</strong> äº‹ä»¶ï¼ŒåŒºåˆ«åœ¨äºç²¾ç¡®åº¦ä¸åŒï¼Œä»æœ€ç²¾ç¡®ï¼ˆ<code>ppp</code>ï¼‰åˆ°æ— ç²¾ç¡®è®¾ç½®ï¼ˆæ²¡æœ‰ <code>p</code>ï¼‰ï¼Œæœ€ç²¾ç¡®çš„äº‹ä»¶ä¼˜å…ˆè¢«é€‰æ‹©ã€‚<strong>cpu-clock</strong> æ˜¯åŸºäºè½¯ä»¶çš„ CPU é¢‘ç‡é‡‡æ ·ï¼Œåœ¨æ²¡æœ‰ç¡¬ä»¶ <strong>cycles</strong> äº‹ä»¶å¯ç”¨æ—¶ï¼Œä¼šé€‰æ‹©ä½¿ç”¨ <strong>cpu-clock</strong> è½¯ä»¶äº‹ä»¶ã€‚</p>
<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯CPU <strong>cycles</strong> äº‹ä»¶ï¼Œä¸ºä»€ä¹ˆå¯¹ <strong>cycles</strong> äº‹ä»¶è¿›è¡Œé‡‡æ ·å¯ä»¥åˆ†æ CPU çš„æ€§èƒ½ï¼Ÿ</p>
<h3 id="cycles-äº‹ä»¶">
    <a href="#cycles-%e4%ba%8b%e4%bb%b6" class="header-anchor">#</a>
    cycles äº‹ä»¶
</h3><p>é¦–å…ˆä»‹ç»ä¸€ä¸ªå…³äº CPU æ€§èƒ½çš„é‡è¦æ¦‚å¿µï¼Œ<strong>Clock Rate</strong>ï¼ˆæ—¶é’Ÿé¢‘ç‡ï¼‰ã€‚Clockï¼ˆæ—¶é’Ÿï¼‰æ˜¯é©±åŠ¨ CPU çš„æ•°å­—ä¿¡å·ï¼ŒCPU ä»¥ç‰¹å®šçš„æ—¶é’Ÿé¢‘ç‡æ‰§è¡Œï¼Œä¾‹å¦‚ 4 GHzçš„ CPU æ¯ç§’å¯æ‰§è¡Œ40äº¿ä¸ª cyclesï¼ˆå‘¨æœŸï¼‰ã€‚</p>
<p>CPU <strong>cycles ï¼ˆå‘¨æœŸï¼‰<strong>æ˜¯ CPU æ‰§è¡ŒæŒ‡ä»¤çš„æ—¶é—´å•ä½ï¼Œè€Œ</strong>æ—¶é’Ÿé¢‘ç‡</strong>è¡¨ç¤º CPU æ¯ç§’æ‰§è¡Œçš„ CPU å‘¨æœŸæ•°ã€‚æ¯ä¸ª CPU æŒ‡ä»¤æ‰§è¡Œå¯èƒ½éœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ª CPU å‘¨æœŸã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œæ›´é«˜çš„æ—¶é’Ÿé¢‘ç‡æ„å‘³ç€æ›´å¿«çš„CPUï¼Œå› ä¸ºå®ƒå…è®¸ CPU åœ¨å•ä½æ—¶é—´å†…æ‰§è¡Œæ›´å¤šçš„æŒ‡ä»¤ã€‚</p>
<p><img src="https://cdn.mazhen.tech/images/202311091031747.jpg"
	
	
	
	loading="lazy"
	
		alt="CPU cycles"
	
	
></p>
<p>æ¯ç»è¿‡ä¸€ä¸ª CPU å‘¨æœŸéƒ½ä¼šè§¦å‘ä¸€ä¸ª <strong>cycles</strong> äº‹ä»¶ã€‚å¯ä»¥è®¤ä¸ºï¼Œ<strong>cycles</strong> äº‹ä»¶æ˜¯å‡åŒ€çš„åˆ†å¸ƒåœ¨ç¨‹åºçš„æ‰§è¡ŒæœŸé—´ã€‚è¿™æ ·ï¼Œä»¥å›ºå®šé¢‘ç‡å»é‡‡æ ·çš„ <strong>cycles</strong> äº‹ä»¶ï¼Œä¹Ÿæ˜¯å‡åŒ€çš„åˆ†å¸ƒåœ¨ç¨‹åºçš„æ‰§è¡ŒæœŸé—´ã€‚æˆ‘ä»¬åœ¨é‡‡æ · <strong>cycles</strong> äº‹ä»¶æ—¶ï¼Œè®°å½• CPU æ­£åœ¨å¹²ä»€ä¹ˆï¼ŒæŒç»­ä¸€æ®µæ—¶é—´æ”¶é›†åˆ°å¤šä¸ªé‡‡æ ·åï¼Œæˆ‘ä»¬å°±èƒ½åŸºäºè¿™äº›ä¿¡æ¯åˆ†æç¨‹åºçš„è¡Œä¸ºï¼Œå¤šæ¬¡å‡ºç°çš„åŒæ ·åŠ¨ä½œï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç¨‹åºçš„çƒ­ç‚¹ï¼Œæˆä¸ºä¸‹ä¸€æ­¥åˆ†æé‡ç‚¹å…³æ³¨çš„æ–¹é¢ã€‚</p>
<p>å› ä¸º <strong>cycles</strong> äº‹ä»¶çš„å‡åŒ€åˆ†å¸ƒï¼Œé€šè¿‡ä»¥å›ºå®šé¢‘ç‡é‡‡æ · <strong>cycles</strong> äº‹ä»¶è·å¾—çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±èƒ½è¿›è¡Œ CPU æ€§èƒ½åˆ†æã€‚é‚£ä¹ˆå¦‚ä½•æŒ‡å®šé‡‡æ ·é¢‘ç‡å‘¢ï¼Ÿ</p>
<h3 id="è®¾ç½®é‡‡æ ·é¢‘ç‡">
    <a href="#%e8%ae%be%e7%bd%ae%e9%87%87%e6%a0%b7%e9%a2%91%e7%8e%87" class="header-anchor">#</a>
    è®¾ç½®é‡‡æ ·é¢‘ç‡
</h3><p>åœ¨ä½¿ç”¨ perf record è®°å½• PMC äº‹ä»¶æ—¶ï¼Œä¼šä½¿ç”¨ä¸€ä¸ªé»˜è®¤çš„é‡‡æ ·é¢‘ç‡ï¼Œä¸æ˜¯æ¯ä¸ªäº‹ä»¶éƒ½ä¼šè¢«è®°å½•ã€‚ä¾‹å¦‚è®°å½• cycles äº‹ä»¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ perf record -vve cycles -a sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">Using CPUID GenuineIntel-6-45-1
</span></span><span class="line"><span class="cl"><span class="nv">DEBUGINFOD_URLS</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">nr_cblocks: <span class="m">0</span>
</span></span><span class="line"><span class="cl">affinity: SYS
</span></span><span class="line"><span class="cl">mmap flush: <span class="m">1</span>
</span></span><span class="line"><span class="cl">comp level: <span class="m">0</span>
</span></span><span class="line"><span class="cl">------------------------------------------------------------
</span></span><span class="line"><span class="cl">perf_event_attr:
</span></span><span class="line"><span class="cl">  size                             <span class="m">128</span>
</span></span><span class="line"><span class="cl">  <span class="o">{</span> sample_period, sample_freq <span class="o">}</span>   <span class="m">4000</span>
</span></span><span class="line"><span class="cl">  sample_type                      IP<span class="p">|</span>TID<span class="p">|</span>TIME<span class="p">|</span>ID<span class="p">|</span>CPU<span class="p">|</span>PERIOD
</span></span><span class="line"><span class="cl">  read_format                      ID<span class="p">|</span>LOST
</span></span><span class="line"><span class="cl">  disabled                         <span class="m">1</span>
</span></span><span class="line"><span class="cl">  inherit                          <span class="m">1</span>
</span></span><span class="line"><span class="cl">  freq                             <span class="m">1</span>
</span></span><span class="line"><span class="cl">  sample_id_all                    <span class="m">1</span>
</span></span><span class="line"><span class="cl">  exclude_guest                    <span class="m">1</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[</span> perf record: Captured and wrote 0.422 MB perf.data <span class="o">(</span><span class="m">297</span> samples<span class="o">)</span> <span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŠ äº† <strong>-vv</strong> é€‰é¡¹å¯ä»¥è¾“å‡ºæ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚ä»è¾“å‡ºä¸­å¯ä»¥çœ‹å‡ºï¼Œå³ä½¿æˆ‘ä»¬æ²¡æœ‰æ˜ç¡®è®¾ç½®é‡‡æ ·é¢‘ç‡ï¼Œé‡‡æ ·é¢‘ç‡å·²ç»å¯ç”¨ï¼ˆ<code>freq 1</code>ï¼‰ï¼Œå¹¶ä¸”é‡‡æ ·é¢‘ç‡ä¸º 4000 ï¼ˆ<code>{ sample_period, sample_freq }   4000</code>ï¼‰ï¼Œå³æ¯ CPU æ¯ç§’é‡‡é›†çº¦ 4000ä¸ªäº‹ä»¶ã€‚cycles äº‹ä»¶æ¯ç§’ä¸­æœ‰å‡ åäº¿æ¬¡ï¼Œé»˜è®¤é‡‡æ ·é¢‘ç‡çš„è®¾ç½®å¾ˆåˆç†ï¼Œå¦åˆ™è®°å½•äº‹ä»¶çš„å¼€é”€è¿‡é«˜ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ <strong>-F</strong> é€‰é¡¹æ˜ç¡®è®¾ç½®äº‹ä»¶é‡‡æ ·é¢‘ç‡ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">perf record -F <span class="m">99</span> -e cycles -a sleep <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>-F 99</strong> è®¾ç½®é‡‡æ ·é¢‘ç‡ä¸º 99 Hertzï¼Œå³æ¯ç§’è¿›è¡Œ 99 æ¬¡é‡‡æ ·ã€‚<a class="link" href="https://www.brendangregg.com/index.html"  target="_blank" rel="noopener"
    >Brendan Gregg</a> åœ¨å¤§é‡çš„ä¾‹å­ä¸­éƒ½ä½¿ç”¨äº† 99 Hertz è¿™ä¸ªé‡‡æ ·é¢‘ç‡ï¼Œè‡³äºä¸ºä»€ä¹ˆè¿™æ ·è®¾ç½®ï¼Œä»–åœ¨æ–‡ç«  <a class="link" href="https://www.brendangregg.com/perf.html"  target="_blank" rel="noopener"
    >perf Examples</a> ä¸­ç»™å‡ºäº†è§£é‡Šï¼Œå¤§æ„æ˜¯ï¼šé€‰æ‹© 99 Hertz è€Œä¸æ˜¯100 Hertzï¼Œæ˜¯ä¸ºäº†é¿å…æ„å¤–åœ°ä¸ä¸€äº›å‘¨æœŸæ€§æ´»åŠ¨åŒæ­¥ï¼Œè¿™ä¼šäº§ç”Ÿåå·®çš„ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœç¨‹åºä¸­æœ‰å‘¨æœŸæ€§çš„å®šæ—¶ä»»åŠ¡ï¼Œä¾‹å¦‚æ¯ç§’é’Ÿæ‰§è¡Œçš„ä»»åŠ¡ï¼Œä»¥ 100 Hertz é¢‘ç‡è¿›è¡Œé‡‡æ ·ï¼Œé‚£ä¹ˆæ¯æ¬¡å‘¨æœŸæ€§ä»»åŠ¡è¿è¡Œæ—¶éƒ½ä¼šè¢«é‡‡æ ·ï¼Œè¿™æ ·äº§ç”Ÿçš„ç»“æœâ€œæ”¾å¤§â€äº†å‘¨æœŸæ€§ä»»åŠ¡çš„å½±å“ï¼Œåç¦»äº†ç¨‹åºæ­£å¸¸çš„è¡Œä¸ºæ¨¡å¼ã€‚</p>
<p><code>perf record</code> å‘½ä»¤è¿˜å¯ä»¥ä½¿ç”¨ <strong>-c</strong> é€‰é¡¹æ¥è®¾ç½®é‡‡æ ·äº‹ä»¶çš„å‘¨æœŸï¼Œè¿™ä¸ªå‘¨æœŸä»£è¡¨äº†é‡‡æ ·äº‹ä»¶ä¹‹é—´çš„é—´éš”ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo perf record -c <span class="m">1000</span> -e cycles -a sleep <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<strong>-c</strong> é€‰é¡¹è®¾ç½®é‡‡æ ·å‘¨æœŸä¸º 1000ï¼Œå³æ¯éš” 1000 æ¬¡äº‹ä»¶è¿›è¡Œä¸€æ¬¡é‡‡æ ·ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•ä»¥å›ºå®šçš„é¢‘ç‡å¯¹ cycles äº‹ä»¶è¿›è¡Œé‡‡æ ·ï¼Œé‚£ä¹ˆå¦‚ä½•è·çŸ¥åœ¨é‡‡æ ·æ—¶ï¼ŒCPU æ­£åœ¨å¹²ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<h2 id="èƒŒæ™¯çŸ¥è¯†">
    <a href="#%e8%83%8c%e6%99%af%e7%9f%a5%e8%af%86" class="header-anchor">#</a>
    èƒŒæ™¯çŸ¥è¯†
</h2><p>è¦çŸ¥é“  cycles äº‹ä»¶å‘ç”Ÿæ—¶ CPU æ­£åœ¨å¹²ä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€äº›ç¡¬ä»¶çŸ¥è¯†ï¼Œä»¥åŠå†…æ ¸ä¸ç¡¬ä»¶æ˜¯å¦‚ä½•é…åˆå·¥ä½œçš„ã€‚å…ˆçœ‹çœ‹ CPU æ˜¯å¦‚ä½•æ‰§è¡ŒæŒ‡ä»¤çš„ã€‚</p>
<h3 id="cpu-æ‰§è¡ŒæŒ‡ä»¤">
    <a href="#cpu-%e6%89%a7%e8%a1%8c%e6%8c%87%e4%bb%a4" class="header-anchor">#</a>
    CPU æ‰§è¡ŒæŒ‡ä»¤
</h3><p>CPU å†…éƒ¨æœ‰å¤šç§ä¸åŒåŠŸèƒ½çš„å¯„å­˜å™¨ï¼Œæ¶‰åŠåˆ°æŒ‡ä»¤æ‰§è¡Œçš„ï¼Œæœ‰ä¸‰ä¸ªé‡è¦çš„å¯„å­˜å™¨ï¼š</p>
<ul>
<li>PC å¯„å­˜å™¨ï¼ˆ<strong>PC</strong>ï¼ŒProgram Counterï¼‰ï¼Œå­˜æ”¾ä¸‹ä¸€æ¡æŒ‡ä»¤çš„å†…å­˜åœ°å€</li>
<li>æŒ‡ä»¤å¯„å­˜å™¨ï¼ˆ<strong>IR</strong>ï¼ŒInstruction Registerï¼‰ï¼Œå­˜æ”¾å½“å‰æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤</li>
<li>çŠ¶æ€å¯„å­˜å™¨ï¼ˆ<strong>SR</strong>ï¼ŒStatus Registerï¼‰ï¼Œç”¨äºå­˜å‚¨ CPU å½“å‰çš„çŠ¶æ€ï¼Œå¦‚æ¡ä»¶æ ‡å¿—ä½ã€ä¸­æ–­ç¦æ­¢ä½ã€å¤„ç†å™¨æ¨¡å¼æ ‡å¿—ç­‰</li>
</ul>
<p>CPU è¿˜æœ‰å…¶ä»–ç”¨äºå­˜å‚¨æ•°æ®å’Œå†…å­˜åœ°å€çš„å¯„å­˜å™¨ï¼Œæ ¹æ®å­˜æ”¾å†…å®¹å‘½åï¼Œå¦‚æ•´æ•°å¯„å­˜å™¨ã€æµ®ç‚¹æ•°å¯„å­˜å™¨ã€å‘é‡å¯„å­˜å™¨å’Œåœ°å€å¯„å­˜å™¨ç­‰ã€‚æœ‰äº›å¯„å­˜å™¨æ—¢å¯ä»¥å­˜æ”¾æ•°æ®ï¼Œåˆå¯ä»¥å­˜æ”¾åœ°å€ï¼Œè¢«ç§°ä¸ºé€šç”¨å¯„å­˜å™¨ï¼ˆ<strong>GR</strong>ï¼ŒGeneral registerï¼‰ã€‚</p>
<p><img src="https://cdn.mazhen.tech/images/202311091736945.png"
	
	
	
	loading="lazy"
	
		alt="cpu registers"
	
	
></p>
<p>ç¨‹åºæ‰§è¡Œæ—¶ï¼ŒCPU æ ¹æ® <strong>PC</strong> å¯„å­˜å™¨ä¸­çš„åœ°å€ä»å†…å­˜ä¸­è¯»å–æŒ‡ä»¤åˆ° <strong>IR</strong> å¯„å­˜å™¨ä¸­æ‰§è¡Œï¼Œå¹¶æ ¹æ®æŒ‡ä»¤é•¿åº¦è‡ªå¢ï¼ŒåŠ è½½ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p>
<p>åªè¦æˆ‘ä»¬åœ¨é‡‡æ ·æ—¶è·å–CPU çš„ <strong>PC</strong> å¯„å­˜å™¨å’Œ <strong>IR</strong> å¯„å­˜å™¨çš„å†…å®¹ï¼Œå°±èƒ½æ¨æ–­å‡º CPU å½“æ—¶æ­£åœ¨å¹²ä»€ä¹ˆã€‚</p>
<p>åœ¨ x86-64 æ¶æ„ä¸­ï¼ŒProgram Counter çš„åŠŸèƒ½æ˜¯ç”±  <strong>RIP (Instruction Pointer Register)</strong> å¯„å­˜å™¨å®ç°çš„ã€‚</p>
<p>åœ¨ç¼–è¯‘ç¨‹åºæ—¶ï¼Œå¯ä»¥è®©ç¼–è¯‘å™¨ç”Ÿæˆä¸€ä¸ªæ˜ å°„ï¼Œå°†æºä»£ç è¡Œä¸ç”Ÿæˆçš„æœºå™¨æŒ‡ä»¤å…³è”èµ·æ¥ï¼Œè¿™ä¸ªæ˜ å°„é€šå¸¸å­˜å‚¨åœ¨ <a class="link" href="https://dwarfstd.org/"  target="_blank" rel="noopener"
    >DWARF æ ¼å¼ï¼ˆDebugging With Attributed Record Formatsï¼‰</a>çš„è°ƒè¯•ä¿¡æ¯ä¸­ã€‚åŒæ—¶ç¼–è¯‘æ—¶ä¼šç”Ÿæˆ<strong>ç¬¦å·è¡¨ï¼ˆSymbol Tableï¼‰</strong>ï¼Œå…¶ä¸­åŒ…å«äº†ç¨‹åºä¸­å„ç§ç¬¦å·ï¼ˆå¦‚å‡½æ•°åã€å˜é‡åï¼‰åŠå…¶åœ°å€çš„æ˜ å°„ã€‚perf å€ŸåŠ©è°ƒè¯•ä¿¡æ¯å’Œç¬¦å·è¡¨ï¼ˆsymbol tableï¼‰ï¼Œå¯ä»¥å°†é‡‡æ ·æ—¶å¯„å­˜å™¨ä¸­çš„æŒ‡ä»¤åœ°å€è½¬æ¢ä¸ºå¯¹åº”çš„å‡½æ•°åã€æºä»£ç è¡Œå·ç­‰ä¿¡æ¯ã€‚</p>
<p>çŸ¥é“äº† CPU å½“æ—¶çš„â€œåŠ¨ä½œâ€è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ CPU æ˜¯æ€ä¹ˆåšè¿™ä¸ªâ€œåŠ¨ä½œâ€çš„ï¼Œä¹Ÿå°±æ˜¯ä»£ç çš„æ‰§è¡Œè·¯å¾„ã€‚ä¸‹é¢ä»‹ç»å‡½æ•°è°ƒç”¨æ ˆçš„ç›¸å…³æ¦‚å¿µã€‚</p>
<h3 id="è¿˜åŸå‡½æ•°è°ƒç”¨æ ˆ">
    <a href="#%e8%bf%98%e5%8e%9f%e5%87%bd%e6%95%b0%e8%b0%83%e7%94%a8%e6%a0%88" class="header-anchor">#</a>
    è¿˜åŸå‡½æ•°è°ƒç”¨æ ˆ
</h3><p>å‡½æ•°æ˜¯è½¯ä»¶ä¸­çš„ä¸€ä¸ªå…³é”®æŠ½è±¡æ¦‚å¿µï¼Œå®ƒè®©å¼€å‘è€…å°†å…·æœ‰ç‰¹å®šåŠŸèƒ½çš„ä»£ç æ‰“åŒ…ï¼Œç„¶åè¿™ä¸ªåŠŸèƒ½å¯ä»¥åœ¨ç¨‹åºçš„å¤šä¸ªä½ç½®è¢«è°ƒç”¨ã€‚</p>
<p>å‡è®¾å‡½æ•° P è°ƒç”¨å‡½æ•° Qï¼Œç„¶å Q æ‰§è¡Œå¹¶è¿”å›ç»“æœç»™ Pï¼Œè¿™ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°ä»¥ä¸‹æœºåˆ¶ï¼š</p>
<ul>
<li><strong>ä¼ é€’æ§åˆ¶</strong>ï¼šåœ¨è¿›å…¥å‡½æ•° Q æ—¶ï¼Œ<strong>PC</strong> å¯„å­˜å™¨è®¾ç½®ä¸º Q çš„èµ·å§‹åœ°å€ï¼›åœ¨ä» Q è¿”å›æ—¶ï¼Œ<strong>PC</strong> å¯„å­˜å™¨è®¾ç½®ä¸º P ä¸­è°ƒç”¨ Q åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤å¤„ã€‚</li>
<li><strong>ä¼ é€’æ•°æ®</strong>ï¼šP èƒ½å¤Ÿå‘ Q æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼ŒQ ä¹Ÿèƒ½å¤Ÿå°†ä¸€ä¸ªå€¼è¿”å›ç»™ Pã€‚</li>
<li><strong>åˆ†é…å’Œé‡Šæ”¾å†…å­˜</strong>ï¼šQ éœ€è¦åœ¨å¼€å§‹æ—¶ä¸ºå±€éƒ¨å˜é‡åˆ†é…ç©ºé—´ï¼Œç„¶ååœ¨è¿”å›å‰é‡Šæ”¾è¯¥å­˜å‚¨ç©ºé—´ã€‚</li>
</ul>
<p><img src="https://cdn.mazhen.tech/images/202311141521021.png"
	
	
	
	loading="lazy"
	
		alt="stack & code"
	
	
></p>
<p>x86-64 å¹³å°ä¸Šçš„ç¨‹åºä½¿ç”¨<strong>å †æ ˆï¼ˆStackï¼‰<strong>æ¥å®ç°å‡½æ•°è°ƒç”¨ã€‚<strong>å †æ ˆï¼ˆStackï¼‰<strong>çš„ç‰¹æ€§æ˜¯</strong>åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰</strong>ï¼Œå‡½æ•°è°ƒç”¨æ­£æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‰¹æ€§ã€‚è°ƒç”¨æŸä¸ªå‡½æ•°å°±æ˜¯åœ¨å †æ ˆä¸Šä¸ºè¿™ä¸ªå‡½æ•°åˆ†é…æ‰€éœ€çš„å†…å­˜ç©ºé—´ï¼Œè¿™éƒ¨åˆ†ç©ºé—´è¢«ç§°ä¸º</strong>æ ˆå¸§ï¼ˆstack frameï¼‰</strong>ï¼Œä»å‡½æ•°è¿”å›ï¼Œå°±æ˜¯å°†è¿™ä¸ªå‡½æ•°çš„**æ ˆå¸§ï¼ˆstack frameï¼‰<strong>ä»å †æ ˆä¸­å¼¹å‡ºï¼Œé‡Šæ”¾ç©ºé—´ã€‚å¤šä¸ª</strong>æ ˆå¸§ï¼ˆstack frameï¼‰**ç»„æˆ <a class="link" href="https://en.wikipedia.org/wiki/Call_stack"  target="_blank" rel="noopener"
    >Call stack</a>ï¼Œä½“ç°å‡ºäº†å‡½æ•°çš„è°ƒç”¨å…³ç³»ã€‚</p>
<p>æ³¨æ„ï¼šç¼–è¯‘åçš„ç¨‹åºå­˜å‚¨åœ¨<strong>ä»£ç æ®µ</strong>ï¼Œæ˜¯é™æ€çš„ï¼›è€Œ <a class="link" href="https://en.wikipedia.org/wiki/Call_stack"  target="_blank" rel="noopener"
    >Call stack</a> æ˜¯åŠ¨æ€çš„ï¼Œååº”äº†ç¨‹åºè¿è¡Œæ—¶çš„çŠ¶æ€ã€‚</p>
<p>ä¸‹é¢ä»¥ç¤ºä¾‹ç¨‹åºä¸ºä¾‹ï¼Œx86-64 å¹³å°ä¸Šå¦‚ä½•åˆ©ç”¨**å †æ ˆï¼ˆStackï¼‰**å®ç°å‡½æ•°è°ƒç”¨çš„ã€‚</p>
<p><img src="https://cdn.mazhen.tech/images/202311141524326.png"
	
	
	
	loading="lazy"
	
		alt="stack"
	
	
></p>
<p><code>main</code>å‡½æ•°æœ‰ä¸‰ä¸ªå±€éƒ¨å˜é‡<code>a</code>ã€<code>b</code>å’Œ <code>res</code> å­˜å‚¨åœ¨è‡ªå·±çš„ <strong>stack frame</strong> ä¸­ã€‚å½“ <code>main</code> è°ƒç”¨ <code>Calc</code> å‡½æ•°æ—¶ï¼Œä¼šå…ˆå°†å‚æ•° <code>i</code>å’Œ<code>j</code> å‹å…¥ Stackï¼Œç„¶åå°† <strong>PC</strong> å¯„å­˜å™¨ä¸­çš„å€¼ä¹Ÿå‹å…¥ Stackã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ<strong>PC</strong> å¯„å­˜å™¨å­˜æ”¾çš„æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œè¿™æ—¶ <strong>PC</strong> å¯„å­˜å™¨ä¸­çš„å€¼æ˜¯å‡½æ•°è°ƒç”¨æŒ‡ä»¤ï¼ˆcallï¼‰åç´§è·Ÿç€çš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ã€‚æŠŠ <strong>PC</strong> å¯„å­˜å™¨å‹å…¥ Stackï¼Œç›¸å½“äºä¿ç•™äº†å‡½æ•°è°ƒç”¨ç»“æŸåè¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ï¼Œè¿™æ ·<code>Calc</code>å®Œæˆåç¨‹åºçŸ¥é“ä»å“ªé‡Œç»§ç»­æ‰§è¡Œã€‚</p>
<p><strong>rbp</strong> æ˜¯æ ˆåŸºå€å¯„å­˜å™¨ï¼ˆregister base pointer ï¼‰ï¼Œåˆå«æ ˆå¸§æŒ‡é’ˆï¼ˆ<strong>Frame Pointer</strong>ï¼‰ï¼Œå­˜æ”¾äº†å½“å‰ <strong>stack frame</strong> çš„èµ·å§‹åœ°å€ã€‚<strong>rsp</strong> æ˜¯æ ˆé¡¶å¯„å­˜å™¨ï¼ˆregister stack pointerï¼‰ï¼Œç§°ä¸ºæ ˆæŒ‡é’ˆï¼ˆ<strong>Stack Pointer</strong>ï¼‰ï¼Œéšç€å…¥æ ˆå‡ºæ ˆåŠ¨ä½œè€Œç§»åŠ¨ï¼Œå§‹ç»ˆæŒ‡å‘æ ˆé¡¶å…ƒç´ ã€‚<strong>x86-64</strong> çš„å †æ ˆæ˜¯<strong>ä»é«˜åœ°å€å‘ä½åœ°å€</strong>å¢é•¿çš„ã€‚</p>
<p>åœ¨ä¸º <code>calc</code>  æ–°å»º <strong>stack frame</strong> æ—¶ï¼Œä¼šå…ˆå°† <strong>rbp</strong> å¯„å­˜å™¨å‹å…¥ Stackã€‚å½“å‰ <strong>rbp</strong> å¯„å­˜å™¨ä¸­å­˜æ”¾çš„æ˜¯ <code>main</code>  <strong>stack frame</strong> çš„èµ·å§‹åœ°å€ï¼Œå°†  <strong>rbp</strong> å¯„å­˜å™¨å‹å…¥ Stackï¼Œä¹Ÿå°±æ˜¯å°† <code>main</code>  <strong>stack frame</strong> çš„èµ·å§‹åœ°å€å‹å…¥äº† Stackã€‚</p>
<p>éšåæŠŠ <strong>rsp</strong> çš„å€¼å¤åˆ¶åˆ° <strong>rbp</strong>ï¼Œå› ä¸º <strong>rsp</strong> å§‹ç»ˆä¼šæŒ‡å‘æ ˆé¡¶ï¼ŒæŠŠ <strong>rsp</strong> çš„å€¼å¤åˆ¶åˆ° <strong>rbp</strong> å°±æ˜¯è®©  <strong>rbp</strong> å¯„å­˜å™¨æŒ‡å‘å½“å‰ä½ç½®ï¼Œå³ <code>calc</code> <strong>stack frame</strong> çš„èµ·å§‹ä½ç½®ã€‚</p>
<p>æ³¨æ„ <code>Calc</code> çš„å‚æ•°å’Œè¿”å›åœ°å€åŒ…å«åœ¨ <code>main</code> çš„ <strong>stack frame</strong> ä¸­ï¼Œå› ä¸ºå®ƒä»¬ä¿å­˜äº†ä¸ <code>main</code> ç›¸å…³çš„çŠ¶æ€ã€‚<code>Calc</code> å‡½æ•°å±€éƒ¨å˜é‡<code>sum</code>å’Œ<code>result</code> è¢«åˆ†é…åœ¨è‡ªå·±çš„ <strong>stack frame</strong> ä¸Šã€‚</p>
<p>åœ¨ <code>Calc</code> è°ƒç”¨ <code>Sum</code> æ—¶ï¼Œé‡å¤ä¸Šé¢çš„åŠ¨ä½œï¼šå‚æ•°å’Œè¿”å›åœ°å€å…¥æ ˆï¼Œä¿å­˜å¹¶æ›´æ–° <strong>rbp</strong> å¯„å­˜å™¨ï¼Œä¸º <code>Sum</code> çš„å±€éƒ¨å˜é‡åˆ†é…åœ°å€ã€‚</p>
<p>åœ¨å‡½æ•° <code>Sum</code> æ‰§è¡Œå®Œæˆä¹‹åï¼Œä¼šå°†ä¹‹å‰ä¿å­˜çš„  <strong>rbp</strong> å‡ºæ ˆï¼Œæ¢å¤åˆ° <strong>rbp</strong> ä¸­ï¼Œä¹Ÿå°±æ˜¯è®© <strong>rbp</strong> æŒ‡å‘ <code>Calc</code>  <strong>stack frame</strong> çš„èµ·å§‹åœ°å€ï¼Œå°† <code>Sum</code>çš„  <strong>stack frame</strong> å¼¹å‡ºäº† Stackï¼Œé‡Šæ”¾äº† <code>Sum</code> å ç”¨çš„ç©ºé—´ã€‚ç„¶åå°†è¿”å›åœ°å€å‡ºæ ˆï¼Œæ›´æ–°åˆ° <strong>PC</strong> å¯„å­˜å™¨ä¸­ã€‚è¿”å›åœ°å€æ˜¯å‡½æ•°è°ƒç”¨æŒ‡ä»¤ï¼ˆcallï¼‰åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œå³ <code>Calc</code> è°ƒç”¨å®Œ <code>Sum</code> åç´§è·Ÿç€çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ŒæŠŠè¿™ä¸ªæŒ‡ä»¤çš„åœ°å€æ¢å¤åˆ° <strong>PC</strong> å¯„å­˜å™¨ä¸­ï¼Œå®é™…ä¸Šæ˜¯å°†æ§åˆ¶æƒè¿”å›ç»™äº† <code>Calc</code> ï¼Œè®© <code>Calc</code> å‰©ä½™éƒ¨åˆ†æ¥ç€æ‰§è¡Œã€‚</p>
<p><code>Calc</code> æ‰§è¡Œå®Œä¹Ÿä¼šåšåŒæ ·çš„å‡ºæ ˆåŠ¨ä½œï¼Œé‡Šæ”¾ <strong>stack frame</strong> ï¼Œå°†æ§åˆ¶æƒè¿”å›ç»™ <code>main</code>ã€‚</p>
<p>è¿™æ ·ï¼Œå‡½æ•°è°ƒç”¨åˆ©ç”¨äº†**å †æ ˆï¼ˆStackï¼‰**ä¼ é€’å‚æ•°ï¼Œå­˜å‚¨è¿”å›ä¿¡æ¯ï¼Œä¿å­˜å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œä»¥åŠå­˜å‚¨å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œæ¥å®ç°å‡½æ•°è°ƒç”¨ã€‚</p>
<p>æ¯ä¸ªå‡½æ•°çš„æ´»åŠ¨è®°å½•å¯¹åº”ä¸€ä¸ª<strong>æ ˆå¸§ï¼ˆstack frameï¼‰</strong>ï¼Œå¤šä¸ª<strong>æ ˆå¸§ï¼ˆstack frameï¼‰<strong>å åŠ åœ¨ä¸€èµ·æ„æˆ</strong>è°ƒç”¨æ ˆ</strong>ï¼ˆ <a class="link" href="https://en.wikipedia.org/wiki/Call_stack"  target="_blank" rel="noopener"
    >Call stack</a>ï¼‰ã€‚<strong>Frame Pointer</strong>ï¼ˆé€šå¸¸æ˜¯ <strong>rbp</strong> å¯„å­˜å™¨ï¼‰æŒ‡å‘å½“å‰æ¿€æ´»çš„å‡½æ•°çš„<strong>æ ˆå¸§ï¼ˆstack frameï¼‰<strong>çš„èµ·å§‹å¤„ï¼Œè¿™ä¸ªèµ·å§‹å¤„ä¿å­˜äº†è°ƒç”¨å®ƒçš„å‡½æ•°çš„</strong>æ ˆå¸§ï¼ˆstack frameï¼‰<strong>çš„èµ·å§‹åœ°å€ã€‚é€šè¿‡è¿™ç§é“¾æ¥ï¼Œæˆ‘ä»¬å°±èƒ½ä»¥ <strong>Frame Pointer</strong> ä¸ºèµ·ç‚¹ï¼Œè¿½æº¯æ•´ä¸ªè°ƒç”¨é“¾ï¼Œå³ä»å½“å‰å‡½æ•°å¼€å§‹ï¼Œé€çº§è®¿é—®åˆ°æ¯ä¸ªè°ƒç”¨è€…çš„</strong>æ ˆå¸§ï¼ˆstack frameï¼‰</strong>ï¼Œä»è€Œé‡æ„å‡ºç¨‹åºæ‰§è¡Œçš„è·¯å¾„ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‡ºäºç©ºé—´å’Œæ—¶é—´æ•ˆç‡çš„è€ƒè™‘ï¼Œç¨‹åºéƒ½ä¼šä¼˜å…ˆä½¿ç”¨é€šç”¨å¯„å­˜å™¨æ¥ä¼ é€’å‚æ•°ï¼Œåªæœ‰åœ¨å¯„å­˜å™¨ä¸å¤Ÿç”¨çš„æ—¶å€™æ‰ä¼šå°†å¤šå‡ºçš„å‚æ•°å‹å…¥æ ˆä¸­ã€‚</p>
<p>perf æ­£æ˜¯åˆ©ç”¨ <strong>Frame Pointer</strong>ï¼Œè¿˜åŸé‡‡æ ·æ—¶çš„ä»£ç æ‰§è¡Œè·¯å¾„ã€‚</p>
<p>åœ¨å¼€å¯ç¼–è¯‘å™¨ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œç¨‹åºä¼šå°† <strong>rbp</strong> å¯„å­˜å™¨ä½œä¸ºé€šç”¨å¯„å­˜å™¨é‡æ–°ä½¿ç”¨ï¼Œè¿™æ—¶å°±ä¸èƒ½å†ä½¿ç”¨ <strong>Frame Pointer</strong> è¿˜åŸå‡½æ•°è°ƒç”¨æ ˆã€‚perf è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•è¿›è¡Œ stack walkingï¼š</p>
<ul>
<li><strong>&ndash;call-graph dwarf</strong> ï¼šä½¿ç”¨è°ƒè¯•ä¿¡æ¯</li>
<li><strong>&ndash;call-graph lbr</strong>ï¼š ä½¿ç”¨ Intel çš„ last branch record (LBR)</li>
<li><strong>&ndash;call-graph fp</strong>ï¼šä½¿ç”¨ <strong>Frame Pointer</strong> ï¼Œç¼ºçœæ–¹æ³•</li>
</ul>
<p>æœ¬æ–‡å°±ä¸è¯¦ç»†è®¨è®ºå…¶ä»–ä¸¤ç§è¿˜åŸè°ƒç”¨æ ˆçš„æ–¹æ³•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒ<a class="link" href="https://www.brendangregg.com/bpf-performance-tools-book.html"  target="_blank" rel="noopener"
    >ã€ŠBPF Performance Toolsã€‹</a>ã€‚</p>
<p>åœ¨ Linux ä¸Šï¼Œè¿›ç¨‹çš„æ‰§è¡Œåˆ†ä¸ºäº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Œè¦çŸ¥é“å®Œæ•´çš„ä»£ç æ‰§è¡Œè·¯å¾„ï¼Œå°±éœ€è¦åˆ†åˆ«è¿˜åŸç”¨æˆ·æ ˆå’Œå†…æ ¸æ ˆã€‚ä»€ä¹ˆæ˜¯ç”¨æˆ·æ€å’Œå†…æ ¸æ€å‘¢ï¼Ÿ</p>
<h3 id="ç”¨æˆ·æ€å’Œå†…æ ¸æ€">
    <a href="#%e7%94%a8%e6%88%b7%e6%80%81%e5%92%8c%e5%86%85%e6%a0%b8%e6%80%81" class="header-anchor">#</a>
    ç”¨æˆ·æ€å’Œå†…æ ¸æ€
</h3><p>æ“ä½œç³»ç»Ÿéœ€è¦èƒ½å¤Ÿé™åˆ¶å¯¹å…³é”®ç³»ç»Ÿèµ„æºçš„è®¿é—®ï¼Œæä¾›å¯¹èµ„æºä¸åŒçº§åˆ«çš„è®¿é—®æƒé™ï¼Œè¿™æ ·å¯ä»¥ä¿æŠ¤ç³»ç»Ÿå…å—é”™è¯¯å’Œæ¶æ„è¡Œä¸ºçš„ä¾µå®³ã€‚è¿™ç§è®¿é—®æƒé™ç”± CPU åœ¨ç¡¬ä»¶çº§åˆ«ä¸Šå®ç°ï¼Œä¾‹å¦‚ x86 æ¶æ„å®šä¹‰äº†ç‰¹æƒçº§åˆ«ï¼Œä¹Ÿç§°ä¸ºä¿æŠ¤ç¯ï¼ˆ<strong>protection rings</strong>ï¼‰ï¼Œä» <strong>Ring 0</strong> åˆ° <strong>Ring 3</strong> ï¼Œæ¯ä¸ªçº§åˆ«å®šä¹‰äº†å¯ä½¿ç”¨çš„æŒ‡ä»¤é›†å’Œå¯è®¿é—®çš„èµ„æºï¼Œ<strong>Ring 0</strong> å…·æœ‰æœ€é«˜çš„ç‰¹æƒçº§åˆ«ã€‚</p>
<p><img src="https://cdn.mazhen.tech/images/202311151103732.png"
	
	
	
	loading="lazy"
	
		alt="protection rings"
	
	
></p>
<ul>
<li><strong>Ring 0</strong>: æœ€é«˜ç‰¹æƒçº§åˆ«ï¼Œç”¨äºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œå¯ä»¥ç›´æ¥è®¿é—®æ‰€æœ‰çš„ç¡¬ä»¶å’Œç³»ç»Ÿèµ„æºã€‚</li>
<li><strong>Ring 1 å’Œ Ring 2</strong>: è¿™äº›ä¸­é—´å±‚æ¬¡çš„ç¯é€šå¸¸ç”¨äºç‰¹å®šçš„ç³»ç»Ÿä»»åŠ¡ï¼Œå¦‚è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œä½†åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿™äº›ä»»åŠ¡é€šå¸¸ä¹Ÿåœ¨ Ring 0 æ‰§è¡Œã€‚</li>
<li><strong>Ring 3</strong>: æœ€ä½ç‰¹æƒçº§åˆ«ï¼Œç”¨äºæ™®é€šçš„åº”ç”¨ç¨‹åºï¼Œè¿™äº›åº”ç”¨ç¨‹åºä¸èƒ½ç›´æ¥æ‰§è¡Œå½±å“ç³»ç»Ÿç¨³å®šæ€§æˆ–å®‰å…¨æ€§çš„æ“ä½œã€‚</li>
</ul>
<p>Linux ä¸»è¦ä½¿ç”¨äº† <strong>Ring 0</strong> å’Œ <strong>Ring 3</strong>ï¼Œå°†èƒ½å¤Ÿè®¿é—®å…³é”®èµ„æºçš„å†…æ ¸æ”¾åœ¨ Ring0ï¼Œç§°ä¸ºå†…æ ¸æ€ï¼ˆ<strong>Kernel Mode</strong>ï¼‰ï¼Œæ™®é€šçš„åº”ç”¨ç¨‹åºå°†æ”¾åœ¨ Ring3ï¼Œç§°ä¸ºç”¨æˆ·æ€ï¼ˆ<strong>User Mode</strong>ï¼‰ã€‚</p>
<h3 id="ç³»ç»Ÿè°ƒç”¨">
    <a href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" class="header-anchor">#</a>
    ç³»ç»Ÿè°ƒç”¨
</h3><p>å¦‚æœç”¨æˆ·æ€ä»£ç éœ€è¦è®¿é—®æ ¸å¿ƒèµ„æºï¼Œå®ƒå¿…é¡»é€šè¿‡<strong>ç³»ç»Ÿè°ƒç”¨ï¼ˆsystem call ï¼‰</strong>ã€‚ç³»ç»Ÿè°ƒç”¨æ˜¯è¿›å…¥å†…æ ¸çš„å…¥å£ç‚¹ï¼Œå†…æ ¸é€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘ç¨‹åºæä¾›ä¸€ç³»åˆ—æœåŠ¡ï¼Œå¦‚æ–‡ä»¶è¯»å†™ã€è¿›ç¨‹åˆ›å»ºã€è¾“å…¥è¾“å‡ºæ“ä½œç­‰ã€‚åº”ç”¨ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¯·æ±‚å†…æ ¸ä»£ä¸ºæ‰§è¡Œè¿™äº›æœåŠ¡ã€‚</p>
<p>è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çœ‹èµ·æ¥å¾ˆåƒè°ƒç”¨ C å‡½æ•°ã€‚ä½†å®é™…ä¸Šï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šè¿›è¡Œå¤šä¸ªæ­¥éª¤ã€‚ä»¥ x86 å¹³å°çš„å®ç°ä¸ºä¾‹ï¼ŒåŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå…³é”®ç¯èŠ‚ï¼š</p>
<p><img src="https://cdn.mazhen.tech/images/202311211416813.png"
	
	
	
	loading="lazy"
	
		alt="system call"
	
	
></p>
<ol>
<li>åº”ç”¨ç¨‹åºé€šè¿‡è°ƒç”¨ C åº“ä¸­çš„åŒ…è£…å‡½æ•°æ¥å‘èµ·ç³»ç»Ÿè°ƒç”¨ã€‚</li>
<li>åŒ…è£…å‡½æ•°è´Ÿè´£å°†æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨å‚æ•°ä¼ é€’ç»™å†…æ ¸ã€‚è¿™äº›å‚æ•°é€šå¸¸é€šè¿‡æ ˆä¼ é€’ç»™åŒ…è£…å‡½æ•°ï¼Œç„¶åè¢«å¤åˆ¶åˆ°ç‰¹å®šçš„ CPU å¯„å­˜å™¨ä¸­ã€‚</li>
<li>ä¸ºäº†è®©å†…æ ¸è¯†åˆ«ä¸åŒçš„ç³»ç»Ÿè°ƒç”¨ï¼ŒåŒ…è£…å‡½æ•°ä¼šæŠŠç³»ç»Ÿè°ƒç”¨çš„ç¼–å·å¤åˆ¶åˆ°ä¸€ä¸ªç‰¹å®šçš„ CPU å¯„å­˜å™¨ï¼ˆ%eaxï¼‰ä¸­ã€‚</li>
<li>åŒ…è£…å‡½æ•°æ‰§è¡Œ <strong>trap</strong> æœºå™¨æŒ‡ä»¤ï¼ˆ x86 æ¶æ„ <code>sysenter</code> æŒ‡ä»¤ï¼‰ï¼Œä½¿ CPU ä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼ã€‚</li>
<li>å†…æ ¸å“åº”ä¸­æ–­ï¼ŒæŠŠå½“å‰çš„å¯„å­˜å™¨å€¼ä¿å­˜åˆ°å†…æ ¸æ ˆæ•°æ®ç»“æ„ <strong>struct pt_regs</strong> ä¸­ï¼Œæ ¹æ®ç¼–å·åœ¨ä¸€ä¸ªè¡¨æ ¼ä¸­æ‰¾åˆ°ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨æœåŠ¡ç¨‹åºï¼Œå¹¶æ‰§è¡Œå®ƒï¼Œç„¶åè¿”å›ç»“æœã€‚</li>
<li>å®Œæˆæ“ä½œåï¼Œå†…æ ¸å°†å¯„å­˜å™¨å€¼æ¢å¤åˆ°åŸå§‹çŠ¶æ€ï¼Œå¹¶å°†æ§åˆ¶æƒè¿”å›ç»™ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºï¼ŒåŒæ—¶è¿”å›ç³»ç»Ÿè°ƒç”¨çš„ç»“æœã€‚</li>
</ol>
<h3 id="ç”¨æˆ·æ ˆå’Œå†…æ ¸æ ˆ">
    <a href="#%e7%94%a8%e6%88%b7%e6%a0%88%e5%92%8c%e5%86%85%e6%a0%b8%e6%a0%88" class="header-anchor">#</a>
    ç”¨æˆ·æ ˆå’Œå†…æ ¸æ ˆ
</h3><p>å¯ä»¥çœ‹å‡ºåœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¿›ç¨‹å…·æœ‰ä¸¤ä¸ªæ ˆï¼š<strong>ç”¨æˆ·æ ˆï¼ˆUser Stackï¼‰<strong>å’Œ</strong>å†…æ ¸æ ˆï¼ˆKernel Stackï¼‰</strong>ã€‚</p>
<ul>
<li><strong>ç”¨æˆ·æ ˆï¼ˆUser Stackï¼‰</strong> ä¿ç•™äº†è¿›å…¥ç³»ç»Ÿè°ƒç”¨å‰çš„çŠ¶æ€ï¼Œç”¨æˆ·æ ˆåœ¨ç³»ç»Ÿè°ƒç”¨æœŸé—´ä¸ä¼šæ”¹å˜</li>
<li><strong>å†…æ ¸æ ˆï¼ˆKernel Stackï¼‰</strong> æ˜¯åœ¨ç³»ç»Ÿè°ƒç”¨æœŸé—´ä½¿ç”¨ï¼Œç”¨äºå­˜å‚¨åœ¨å†…æ ¸æ€ä¸‹æ‰§è¡Œçš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯„å­˜å™¨çš„å€¼å’Œç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ã€‚æ­¤å¤–å¤„ç†ä¸­æ–­å’Œå¼‚å¸¸æ—¶ï¼Œä¹Ÿä¼šä½¿ç”¨å†…æ ¸æ ˆã€‚</li>
</ul>
<p>ç”¨æˆ·æ ˆå’Œå†…æ ¸æ ˆåœ¨ä»€ä¹ˆä»€ä¹ˆä½ç½®ï¼Ÿæˆ‘ä»¬éœ€è¦å…ˆäº†è§£è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ¦‚å¿µã€‚</p>
<h3 id="è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´">
    <a href="#%e8%bf%9b%e7%a8%8b%e8%99%9a%e6%8b%9f%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4" class="header-anchor">#</a>
    è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´
</h3><p>åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸Šï¼Œç”¨æˆ·ç¨‹åºéƒ½ä¸èƒ½ç›´æ¥æ“ä½œç‰©ç†å†…å­˜ã€‚æ“ä½œç³»ç»Ÿä¼šç»™è¿›ç¨‹åˆ†é…è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œæ‰€æœ‰è¿›ç¨‹çœ‹åˆ°çš„è¿™ä¸ªåœ°å€éƒ½æ˜¯ä¸€æ ·çš„ï¼Œé‡Œé¢çš„å†…å­˜éƒ½æ˜¯ä» 0 å¼€å§‹ç¼–å·ã€‚</p>
<p>ç¨‹åºé‡ŒæŒ‡ä»¤æ“ä½œçš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ã€‚å†…æ ¸ä¼šç»´æŠ¤ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„è¡¨ï¼Œå°†ä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€å’Œä¸åŒçš„ç‰©ç†åœ°å€æ˜ å°„èµ·æ¥ã€‚å½“ç¨‹åºè¦è®¿é—®è™šæ‹Ÿåœ°å€æ—¶ï¼Œä¼šé€šè¿‡æ˜ å°„è¡¨è¿›è¡Œè½¬æ¢ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç‰©ç†å†…å­˜åœ°å€ã€‚ä¸åŒè¿›ç¨‹ç›¸åŒçš„è™šæ‹Ÿåœ°å€ï¼Œä¼šæ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†åœ°å€ï¼Œä¸ä¼šå‘ç”Ÿå†²çªã€‚è¿™æ ·æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œç›¸äº’éš”ç¦»äº’ä¸å½±å“ã€‚</p>
<p><img src="https://cdn.mazhen.tech/images/202311151758027.png"
	
	
	
	loading="lazy"
	
		alt="Virtual Memory Address"
	
	
></p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€ã€‚</p>
<p>ä¸€ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ç”¨æˆ·æ€åœ°å€ç©ºé—´ï¼Œä¸€éƒ¨åˆ†æ˜¯å†…æ ¸æ€åœ°å€ç©ºé—´ã€‚</p>
<p>ç”¨æˆ·ç©ºé—´æ˜¯åº”ç”¨ç¨‹åºæ‰§è¡Œçš„åœºæ‰€ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ç”¨æˆ·ç©ºé—´ï¼Œå…¶å¸ƒå±€åŒ…å«ä»£ç ã€å…¨å±€å˜é‡ã€å †ã€æ ˆå’Œå†…å­˜æ˜ å°„åŒºåŸŸç­‰å¤šç§éƒ¨åˆ†ã€‚</p>
<p>å†…æ ¸ç©ºé—´æ˜¯å†…æ ¸ä»£ç è¿è¡Œçš„å†…å­˜åŒºåŸŸï¼Œå®ƒå¹¶éä¸“å±äºæŸä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œæ‰€æœ‰è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥åˆ°å†…æ ¸ä¹‹åï¼Œçœ‹åˆ°çš„è™šæ‹Ÿåœ°å€ç©ºé—´éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„è¿™ç§åˆ†ç¦»ï¼Œç¡®ä¿äº†ç”¨æˆ·åº”ç”¨ç¨‹åºä¸èƒ½ç›´æ¥å¹²æ‰°å†…æ ¸ï¼Œä¿è¯äº†ç³»ç»Ÿçš„å®‰å…¨ç¨³å®šæ€§ã€‚</p>
<p><img src="https://cdn.mazhen.tech/images/202311161738057.png"
	
	
	
	loading="lazy"
	
		alt="process virtual addrsss space"
	
	
></p>
<p>Linux çš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯ <a class="link" href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format"  target="_blank" rel="noopener"
    >ELFï¼ˆExecutable and Linkable Formatï¼‰</a>æ ¼å¼ï¼Œæ‰§è¡Œæ—¶ä»ç¡¬ç›˜åŠ è½½åˆ°å†…å­˜ï¼ŒELF æ–‡ä»¶ä¸­çš„ä»£ç æ®µå’Œæ•°æ®æ®µè¢«ç›´æ¥æ˜ å°„åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ç”¨æˆ·æ€çš„æ•°æ®æ®µå’Œä»£ç æ®µã€‚</p>
<p>ç”¨æˆ·ç©ºé—´çš„**å †ï¼ˆheapï¼‰**æ˜¯åŠ¨æ€å†…å­˜åˆ†é…çš„åŒºåŸŸï¼Œå¯ä»¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ <a class="link" href="https://www.man7.org/linux/man-pages/man2/brk.2.html"  target="_blank" rel="noopener"
    >sbrk</a> ã€<a class="link" href="https://www.man7.org/linux/man-pages/man2/mmap.2.html"  target="_blank" rel="noopener"
    >mmap</a> å’Œ glibc æä¾›çš„ <a class="link" href="https://elixir.bootlin.com/glibc/glibc-2.38/source/malloc/malloc.c"  target="_blank" rel="noopener"
    >malloc</a> å‡½æ•°è¿›è¡Œå †å†…å­˜çš„ç”³è¯·ã€‚å†…æ ¸ä¼šç»´æŠ¤ä¸€ä¸ªå˜é‡ <strong>brk</strong> æŒ‡å‘å †çš„é¡¶éƒ¨ï¼Œ<strong>sbrk</strong> é€šè¿‡æ”¹å˜ <strong>brk</strong> æ¥ç»´æŠ¤å †çš„å¤§å°ã€‚<strong>malloc</strong> å†…éƒ¨ä¹Ÿä½¿ç”¨äº†ç³»ç»Ÿè°ƒç”¨ <strong>sbrk</strong> æˆ– <strong>mmap</strong>ï¼Œä½† glibc ä¼šç»´æŠ¤ä¸€ä¸ªå†…å­˜æ± ï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡ä½¿ç”¨ <strong>malloc</strong> ç”³è¯·å†…å­˜æ—¶éƒ½ç›´æ¥è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>å†…å­˜æ˜ å°„åŒºåŸŸä¸ºå…±äº«åº“åŠæ–‡ä»¶æ˜ å°„æä¾›ç©ºé—´ã€‚å¯ä»¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ <a class="link" href="https://www.man7.org/linux/man-pages/man2/mmap.2.html"  target="_blank" rel="noopener"
    >mmap</a> å°†åˆ›å»ºæ–‡ä»¶æ˜ å°„æå‡ IO æ•ˆç‡ã€‚</p>
<p>ç”¨æˆ·ç©ºé—´çš„<strong>å †æ ˆï¼ˆStackï¼‰</strong> æ˜¯ç”¨æˆ·æ€å‡½æ•°æ‰§è¡Œçš„æ´»è·ƒè®°å½•ï¼Œ<code>%rsp</code>æŒ‡å‘å½“å‰å †æ ˆé¡¶éƒ¨ã€‚</p>
<p>å†…æ ¸ç©ºé—´ä¹Ÿæœ‰ä»£ç æ®µå’Œæ•°æ®æ®µï¼Œæ˜ å°„å†…æ ¸çš„ä»£ç æ®µå’Œæ•°æ®æ®µã€‚</p>
<p>å½“è¿›ç¨‹æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šä»ç”¨æˆ·ç©ºé—´åˆ‡æ¢åˆ°å†…æ ¸ç©ºé—´ï¼Œè¿›ç¨‹çš„å½“å‰çŠ¶æ€ï¼ŒåŒ…æ‹¬æ ˆæŒ‡é’ˆï¼ˆ<strong>rsp</strong> å¯„å­˜å™¨ï¼‰ã€ç¨‹åºè®¡æ•°å™¨ï¼ˆ<strong>rip</strong>ï¼Œä¹Ÿå°±æ˜¯ <strong>PC</strong> å¯„å­˜å™¨ï¼‰ç­‰ï¼Œä¼šè¢«ä¿å­˜åœ¨å†…æ ¸æ•°æ®ç»“æ„ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/include/asm/ptrace.h#L59"  target="_blank" rel="noopener"
    >struct pt_regs</a> å†…ï¼Œä»¥ä¾¿åœ¨ç³»ç»Ÿè°ƒç”¨å®Œæˆåèƒ½å¤Ÿå‡†ç¡®åœ°æ¢å¤ï¼Œç»§ç»­æ‰§è¡Œå› ç³»ç»Ÿè°ƒç”¨è€Œæš‚åœçš„ç”¨æˆ·ç©ºé—´æ“ä½œã€‚</p>
<p>æ‰§è¡Œå†…æ ¸ä»£ç ä¼šä½¿ç”¨<strong>å†…æ ¸æ ˆï¼ˆKernel-Stackï¼‰</strong>ã€‚</p>
<p>ç°åœ¨æœ‰äº†è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„å…¨æ™¯å›¾ï¼Œæˆ‘ä»¬å†å›å¤´çœ‹çœ‹è¿˜åŸå‡½æ•°è°ƒç”¨æ ˆçš„é—®é¢˜ã€‚</p>
<h3 id="è¿˜åŸå®Œæ•´è°ƒç”¨æ ˆ">
    <a href="#%e8%bf%98%e5%8e%9f%e5%ae%8c%e6%95%b4%e8%b0%83%e7%94%a8%e6%a0%88" class="header-anchor">#</a>
    è¿˜åŸå®Œæ•´è°ƒç”¨æ ˆ
</h3><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¯´åœ¨ä»»ä½•ç»™å®šçš„æ—¶åˆ»ï¼ŒCPU å¤„äºä¸‹é¢ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p>
<ol>
<li>åœ¨ç”¨æˆ·ç©ºé—´ï¼Œæ‰§è¡ŒæŸä¸ªè¿›ç¨‹é‡Œçš„ç”¨æˆ·çº§ä»£ç </li>
<li>åœ¨å†…æ ¸ç©ºé—´ï¼Œä»¥è¿›ç¨‹çš„èº«ä»½è¿è¡Œï¼Œä¸ºç‰¹å®šçš„è¿›ç¨‹æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œç³»ç»Ÿè°ƒç”¨</li>
<li>åœ¨å†…æ ¸ç©ºé—´ï¼Œå¤„äºå¤„ç†ä¸­æ–­çš„çŠ¶æ€ï¼Œæ­¤æ—¶ä¸ä¸ä»»ä½•è¿›ç¨‹ç›¸å…³è”ï¼Œè¿è¡Œåœ¨å†…æ ¸çº¿ç¨‹ä¸­ï¼Œä¸“æ³¨äºå¤„ç†ä¸­æ–­äº‹ä»¶</li>
</ol>
<p>å¯¹äºç¬¬ä¸€ã€ç¬¬ä¸‰ç§æƒ…å†µï¼Œ perf åœ¨é‡‡æ ·äº‹ä»¶è§¦å‘æ—¶ï¼Œåªè¦é€šè¿‡ <strong>Frame Pointer</strong>ï¼ˆ <strong>rsp</strong> å¯„å­˜å™¨ï¼‰å°±å¯ä»¥è¿˜åŸç”¨æˆ·æ ˆæˆ–å†…æ ¸æ ˆï¼Œå¹¶ä¸”å·²ç»æ˜¯å®Œæ•´çš„è°ƒç”¨æ ˆã€‚</p>
<p>å¯¹äºç¬¬äºŒç§æƒ…å†µï¼Œè¿›ç¨‹æ­£å¥½é™·å…¥å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆé€šè¿‡ <strong>Frame Pointer</strong>ï¼ˆ <strong>rsp</strong> å¯„å­˜å™¨ï¼‰å¯ä»¥è¿˜åŸå†…æ ¸ä»£ç çš„æ‰§è¡Œè·¯å¾„ã€‚ç„¶åå†é€šè¿‡å†…æ ¸æ•°æ®ç»“æ„ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/include/asm/ptrace.h#L59"  target="_blank" rel="noopener"
    >struct pt_regs</a> å†…ä¿å­˜çš„å¯„å­˜å™¨çŠ¶æ€ï¼Œè¿˜åŸè¿›å…¥å†…æ ¸å‰ç”¨æˆ·ç©ºé—´çš„ä»£ç æ‰§è¡Œè·¯å¾„ã€‚è¿™æ ·æˆ‘ä»¬å°±èƒ½è·å¾—é‡‡æ ·äº‹ä»¶è§¦å‘æ—¶ï¼ŒåŒ…å«äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„å®Œæ•´ä»£ç æ‰§è¡Œè·¯å¾„ã€‚</p>
<p>é€šè¿‡ <strong>PC</strong> å¯„å­˜å™¨ã€ <strong>rsp</strong> å¯„å­˜å™¨ï¼Œä»¥åŠå†…æ ¸æ•°æ®ç»“æ„<strong>pt_regs</strong>ï¼Œæˆ‘ä»¬èƒ½çŸ¥é“ CPU ç¬æ—¶çš„â€œåŠ¨ä½œâ€ï¼Œä»¥åŠå®ƒæ˜¯æ€ä¹ˆåšè¿™ä¸ªåŠ¨ä½œçš„ï¼ˆä»£ç æ‰§è¡Œè·¯å¾„ï¼‰ï¼Œé‚£ä¹ˆè¿˜å‰©æœ€åä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ€ä¹ˆçŸ¥é“é‡‡æ ·å‘ç”Ÿæ—¶åˆ» CPU å¯„å­˜å™¨çš„å†…å®¹å‘¢ï¼Ÿ</p>
<h3 id="ä¸­æ–­å¤„ç†">
    <a href="#%e4%b8%ad%e6%96%ad%e5%a4%84%e7%90%86" class="header-anchor">#</a>
    ä¸­æ–­å¤„ç†
</h3><p>å†…æ ¸æ˜¯è¢«åŠ¨å·¥ä½œæ¨¡å¼ï¼Œå®ƒâ€œèººâ€åœ¨å†…æ ¸ç©ºé—´ä¸ä¼šä¸»åŠ¨å·¥ä½œï¼Œè¦ä¹ˆé€šè¿‡ç³»ç»Ÿè°ƒç”¨è®©å®ƒä¸ºç”¨æˆ·è¿›ç¨‹æœåŠ¡ï¼Œè¦ä¹ˆç”±æ—¶é’Ÿä¸­æ–­å’Œå„ç§å¤–éƒ¨è®¾å¤‡ä¸­æ–­äº‹ä»¶é©±åŠ¨æ‰§è¡Œã€‚</p>
<p>ä¸­æ–­æ˜¯ Linux çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒå…è®¸ CPU å“åº”å¤–éƒ¨æˆ–å†…éƒ¨äº‹ä»¶ï¼Œå¦‚æºè‡ªç¡¬ä»¶è®¾å¤‡çš„é”®ç›˜ã€é¼ æ ‡ã€ç½‘å¡ï¼Œæˆ–æ¥è‡ªè½¯ä»¶çš„å¼‚å¸¸ã€‚å½“è¿™äº›äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸­æ–­äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒCPU ä¼šæš‚åœå½“å‰çš„å·¥ä½œï¼Œè½¬å…¥å†…æ ¸çš„<strong>ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆInterrupt Handlerï¼‰</strong>ã€‚å½“å¤„ç†å®Œæˆåï¼Œä¼šä»ä¸­æ–­å¤„ç†ç¨‹åºè¿”å›åˆ°åŸæ¥è¢«ä¸­æ–­çš„ä»£ç å¤„ç»§ç»­æ‰§è¡Œã€‚</p>
<p>ä¸­æ–­å¯ä»¥åˆ†ä¸º**åŒæ­¥ï¼ˆSynchronousï¼‰<strong>ä¸­æ–­å’Œ</strong>å¼‚æ­¥ï¼ˆAsynchronousï¼‰**ä¸­æ–­ä¸¤ç±»ï¼š</p>
<ul>
<li><strong>åŒæ­¥ä¸­æ–­</strong>ï¼šç”±CPUå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—å¼•èµ·çš„ã€‚</li>
<li><strong>å¼‚æ­¥ä¸­æ–­</strong>ï¼šç”±å¤–éƒ¨äº‹ä»¶ï¼ˆå®šæ—¶ä¸­æ–­å’Œ I/O è®¾å¤‡ï¼‰å¼•èµ·ï¼Œä¸CPUå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—æ— å…³ã€‚</li>
</ul>
<p>åœ¨ x86 å¹³å°ä¸Šï¼ŒåŒæ­¥ä¸­æ–­è¢«ç§°ä¸º<strong>å¼‚å¸¸ï¼ˆExceptionï¼‰</strong>ï¼Œè€Œå¼‚æ­¥ä¸­æ–­è¢«ç§°ä¸º<strong>ä¸­æ–­ï¼ˆInterruptï¼‰</strong>ã€‚æ³¨æ„â€œä¸­æ–­â€è¿™ä¸ªè¯æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ä»…æŒ‡å¼‚æ­¥ä¸­æ–­ï¼Œä¹Ÿå¯ä»¥æŒ‡åŒ…å«äº†å¼‚å¸¸çš„ä¸¤ç±»ä¸­æ–­çš„æ€»ç§°ã€‚</p>
<p><img src="https://cdn.mazhen.tech/images/202311201051594.png"
	
	
	
	loading="lazy"
	
		alt="interrupts"
	
	
></p>
<p>åœ¨ x86 æ¶æ„ä¸­ï¼Œæ¯ä¸ªä¸­æ–­æˆ–å¼‚å¸¸éƒ½é€šè¿‡ä¸€ä¸ª 0 åˆ° 255 èŒƒå›´å†…çš„æ•°å­—æ¥è¯†åˆ«ï¼Œè¿™ä¸ªæ•°å­—æ˜¯ä¸€ä¸ª 8 ä½çš„æ— ç¬¦å·æ•°ï¼Œè¢«ç§°ä¸ºâ€œ<strong>å‘é‡ï¼ˆ<em>vector</em>ï¼‰</strong>â€ã€‚å…¶ä¸­ï¼Œå¼‚å¸¸å’Œä¸å¯å±è”½ä¸­æ–­çš„å‘é‡å€¼æ˜¯å›ºå®šä¸å˜çš„ï¼ˆ0ï½31ï¼‰ï¼Œè€Œå¯å±è”½ä¸­æ–­çš„å‘é‡å¯ä»¥é€šè¿‡<strong>å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨</strong>ï¼ˆ<em>Programmable Interrupt Controller</em>ï¼Œ<strong>PIC</strong>ï¼‰è¿›è¡Œè°ƒæ•´ã€‚</p>
<p>æ¯ä¸ª I/O è®¾å¤‡é€šå¸¸æœ‰ä¸€ä¸ªå•ç‹¬çš„è¾“å‡ºçº¿è·¯ï¼Œç”¨æ¥å‘é€ä¸­æ–­è¯·æ±‚ï¼ˆ<strong>I</strong>nterrupt <strong>R</strong>e<strong>Q</strong>uest, <strong>IRQ</strong>ï¼‰ã€‚æ‰€æœ‰ <strong>IRQ</strong> çº¿è·¯éƒ½è¿æ¥åˆ° <strong>PIC</strong>ï¼Œç„¶å <strong>PIC</strong> åˆè¿æ¥åˆ° CPU çš„ <strong>INTR</strong> å¼•è„šã€‚å½“æŸä¸ª I/O è®¾å¤‡å‘ç”Ÿäº†éœ€è¦ CPU æ³¨æ„çš„äº‹ä»¶ï¼Œä¾‹å¦‚ç”¨æˆ·æ•²å‡»é”®ç›˜ï¼Œæ•°æ®åˆ°è¾¾ç½‘å¡ï¼Œè¯¥è®¾å¤‡åœ¨ç›¸åº”çš„ IRQ çº¿è·¯ä¸Šå‘é€ä¿¡å·ï¼Œ<strong>PIC</strong> å°†è¿™ä¸ª <strong>IRQ</strong> ä¿¡å·è½¬æ¢æˆä¸€ä¸ª<strong>ä¸­æ–­å‘é‡</strong>ï¼Œç„¶ååœ¨ CPU çš„ <strong>INTR</strong> å¼•è„šä¸Šå‘èµ·ä¸€ä¸ªä¸­æ–­è¯·æ±‚ï¼Œç­‰å¾… CPU å¤„ç†ã€‚</p>
<p>ä¸å¯å±è”½ä¸­æ–­é€šè¿‡ <strong>NMI</strong> å¼•è„šæ¥å…¥ CPUã€‚</p>
<p><img src="https://cdn.mazhen.tech/images/202311201445225.png"
	
	
	
	loading="lazy"
	
		alt="PIC"
	
	
></p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ <strong>/proc/interrupts</strong> æŸ¥çœ‹åˆ°ç³»ç»Ÿç¡¬ä»¶è®¾å¤‡ <strong>IRQ</strong> çº¿è·¯åŠå¯¹åº” CPU çš„ç»Ÿè®¡ä¿¡æ¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat /proc/interrupts 
</span></span><span class="line"><span class="cl">           CPU0       CPU1       CPU2       CPU3       
</span></span><span class="line"><span class="cl">  8:          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  IR-IO-APIC   8-edge      rtc0
</span></span><span class="line"><span class="cl">  9:          <span class="m">0</span>          <span class="m">4</span>          <span class="m">0</span>          <span class="m">0</span>  IR-IO-APIC   9-fasteoi   acpi
</span></span><span class="line"><span class="cl"> 18:          <span class="m">0</span>          <span class="m">2</span>          <span class="m">0</span>          <span class="m">0</span>  IR-IO-APIC  18-fasteoi   i801_smbus
</span></span><span class="line"><span class="cl"> 23:         <span class="m">35</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  IR-IO-APIC  23-fasteoi   ehci_hcd:usb1
</span></span><span class="line"><span class="cl"> 40:          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  DMAR-MSI   0-edge      dmar0
</span></span><span class="line"><span class="cl"> 41:          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  DMAR-MSI   1-edge      dmar1
</span></span><span class="line"><span class="cl"> 42:          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  IR-PCI-MSI-0000:00:1c.0   0-edge      PCIe PME
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">NMI:         <span class="m">67</span>        <span class="m">124</span>         <span class="m">61</span>         <span class="m">60</span>   Non-maskable interrupts
</span></span><span class="line"><span class="cl">LOC:    <span class="m">7386692</span>    <span class="m">9261862</span>    <span class="m">8162396</span>    <span class="m">7051922</span>   Local timer interrupts
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">PMI:         <span class="m">67</span>        <span class="m">124</span>         <span class="m">61</span>         <span class="m">60</span>   Performance monitoring interrupts
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„ç¬¬ä¸€åˆ—è¾“å‡ºçš„æ˜¯ <strong>IRQ</strong> çº¿è·¯ç¼–å·ï¼Œéœ€è¦é€šè¿‡ <strong>PIC</strong> è½¬æ¢ä¸º CPU ä½¿ç”¨çš„<strong>ä¸­æ–­å‘é‡</strong>ï¼Œå¯¹äº Intel CPUï¼ŒIRQn è½¬æ¢ä¸ºçš„ä¸­æ–­å‘é‡æ˜¯ <strong>n+32</strong>ï¼Œå› ä¸º 0ï½31 æ˜¯å›ºå®šç»™äº†å¼‚å¸¸ä½¿ç”¨ã€‚</p>
<p>Ã—86 ç³»åˆ—çš„ CPU èƒ½å¤„ç† 20 ç§ä¸åŒç±»å‹çš„å¼‚å¸¸ï¼Œå†…æ ¸å¿…é¡»ä¸ºæ¯ä¸€ç§å¼‚å¸¸éƒ½æä¾›ä¸€ä¸ªä¸“é—¨çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <a class="link" href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html"  target="_blank" rel="noopener"
    >Intel&rsquo;s Software Development Manual: System Programming Guide</a> ä¸­æ‰¾åˆ°å¯¹è¿™äº›å¼‚å¸¸çš„å®Œæ•´æè¿°ã€‚</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Vector</th>
<th>Mnemonic</th>
<th>Description</th>
<th>Type</th>
<th>Error Code</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>#DE</td>
<td>Divide Error</td>
<td>Fault</td>
<td>No</td>
<td>DIV and IDIV instructions.</td>
</tr>
<tr>
<td>1</td>
<td>#DB</td>
<td>Debug Exception</td>
<td>Fault/ Trap</td>
<td>No</td>
<td>Instruction, data, and I/O breakpoints; single-step; and others.</td>
</tr>
<tr>
<td>2</td>
<td>-</td>
<td>NMI Interrupt</td>
<td>Interrupt</td>
<td>No</td>
<td>Nonmaskable external interrupt.</td>
</tr>
<tr>
<td>3</td>
<td>#BP</td>
<td>Breakpoint</td>
<td>Trap</td>
<td>No</td>
<td>INT3 instruction.</td>
</tr>
<tr>
<td>4</td>
<td>#OF</td>
<td>Overflow</td>
<td>Trap</td>
<td>No</td>
<td>INTO instruction.</td>
</tr>
<tr>
<td>5</td>
<td>#BR</td>
<td>BOUND Range  Exceeded</td>
<td>Fault</td>
<td>No</td>
<td>BOUND instruction.</td>
</tr>
<tr>
<td>6</td>
<td>#UD</td>
<td>Invalid Opcode (Undefined Opcode)</td>
<td>Fault</td>
<td>No</td>
<td>UD instruction or reserved opcode.</td>
</tr>
<tr>
<td>7</td>
<td>#NM</td>
<td>Device Not Available (No Math  Coprocessor)</td>
<td>Fault</td>
<td>No</td>
<td>Floating-point or WAIT/FWAIT instruction.</td>
</tr>
<tr>
<td>8</td>
<td>#DF</td>
<td>Double Fault</td>
<td>Abort</td>
<td>Yes (zero)</td>
<td>Any instruction that can generate an  exception, an NMI, or an INTR.</td>
</tr>
<tr>
<td>9</td>
<td></td>
<td>Coprocessor Segment Overrun (reserved)</td>
<td>Fault</td>
<td>No</td>
<td>Floating-point instruction.</td>
</tr>
<tr>
<td>10</td>
<td>#TS</td>
<td>Invalid TSS</td>
<td>Fault</td>
<td>Yes</td>
<td>Task switch or TSS access.</td>
</tr>
<tr>
<td>11</td>
<td>#NP</td>
<td>Segment Not Present</td>
<td>Fault</td>
<td>Yes</td>
<td>Loading segment registers or accessing  system segments.</td>
</tr>
<tr>
<td>12</td>
<td>#SS</td>
<td>Stack-Segment Fault</td>
<td>Fault</td>
<td>Yes</td>
<td>Stack operations and SS register loads.</td>
</tr>
<tr>
<td>13</td>
<td>#GP</td>
<td>General Protection</td>
<td>Fault</td>
<td>Yes</td>
<td>Any memory reference and other protection checks.</td>
</tr>
<tr>
<td>14</td>
<td>#PF</td>
<td>Page Fault</td>
<td>Fault</td>
<td>Yes</td>
<td>Any memory reference.</td>
</tr>
<tr>
<td>15</td>
<td>â€”</td>
<td>(Intel reserved. Do  not use.)</td>
<td></td>
<td>No</td>
<td></td>
</tr>
<tr>
<td>16</td>
<td>#MF</td>
<td>x87 FPU Floating-Point Error (Math Fault)</td>
<td>Fault</td>
<td>No</td>
<td>x87 FPU  floating-point or WAIT/FWAIT instruction.</td>
</tr>
<tr>
<td>17</td>
<td>#AC</td>
<td>Alignment Check</td>
<td>Fault</td>
<td>Yes (Zero)</td>
<td>Any data reference in memory.</td>
</tr>
<tr>
<td>18</td>
<td>#MC</td>
<td>Machine Check</td>
<td>Abort</td>
<td>No</td>
<td>Error codes (if any) and source are model  dependent.</td>
</tr>
<tr>
<td>19</td>
<td>#XM</td>
<td>SIMD Floating-Point Exception</td>
<td>Fault</td>
<td>No</td>
<td>SSE/SSE2/SSE3 floating-point instructions</td>
</tr>
<tr>
<td>20</td>
<td>#VE</td>
<td>Virtualization Exception</td>
<td>Fault</td>
<td>No</td>
<td>EPT violations</td>
</tr>
<tr>
<td>21</td>
<td>#CP</td>
<td>Control Protection Exception</td>
<td>Fault</td>
<td>Yes</td>
<td>RET, IRET, RSTORSSP, and SETSSBSY  instructions can generate this exception. When CET indirect branch tracking  is enabled, this exception can be generated due to a missing ENDBRANCH  instruction at target of an indirect call or jump.</td>
</tr>
<tr>
<td>22-31</td>
<td>-</td>
<td>Intel reserved. Do not use.</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table></div>
<p>ä¸‹å›¾æè¿°äº†ä¸­æ–­å¤„ç†çš„å¤§è‡´æµç¨‹ï¼š</p>
<p><img src="https://cdn.mazhen.tech/images/202311201727048.png"
	
	
	
	loading="lazy"
	
		alt="Interrupt Handler"
	
	
></p>
<p>å¼‚å¸¸æ˜¯ç”± CPU æ‰§è¡Œçš„æŒ‡ä»¤äº§ç”Ÿï¼Œä¸­æ–­æ˜¯ç”±å¤–éƒ¨è®¾å¤‡çš„ç´§æ€¥äº‹ä»¶äº§ç”Ÿã€‚</p>
<p>CPU åœ¨æ”¶åˆ°ä¸­æ–­è¯·æ±‚åï¼Œæ ¹æ®ä¸­æ–­å·åœ¨<strong>ä¸­æ–­å‘é‡è¡¨</strong>ä¸­æ‰¾åˆ°ç›¸åº”çš„**ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆInterrupt Handlerï¼‰**å…¥å£ï¼Œä»è€Œåšå‡ºç›¸åº”çš„å¤„ç†ã€‚<strong>ä¸­æ–­å‘é‡è¡¨</strong>å°†æ¯ä¸ªä¸­æ–­æˆ–å¼‚å¸¸ä¸å¯¹åº”çš„ä¸­æ–­å¤„ç†ç¨‹åºå…³è”äº†èµ·æ¥ã€‚</p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œä¸­æ–­å‘é‡è¡¨çš„ 0ï½31å›ºå®šä¸ºå¼‚å¸¸å¤„ç†ï¼Œ32ï½127 å’Œ 129ï½238 é¡¹ç”¨æ¥å¤„ç†å¤–éƒ¨ I/O è®¾å¤‡çš„è¯·æ±‚ã€‚ <strong>PIC</strong> ä¼šå°† <strong>IRQ</strong> ç¼–å·è½¬æ¢ä¸º<strong>ä¸­æ–­å‘é‡</strong>ã€‚</p>
<p>å½“ç³»ç»Ÿæ”¶åˆ°ä¸­æ–­è¯·æ±‚æ—¶ï¼Œå¦‚æœä¸åœ¨å†…æ ¸æ€ï¼Œå…ˆä¼šä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå¹¶åœ¨å†…æ ¸æ ˆä¸­ä¿å­˜å½“å‰çš„çŠ¶æ€ä¿¡æ¯ï¼ˆä¸»è¦æ˜¯å¯„å­˜å™¨ä¿¡æ¯ï¼‰ã€‚</p>
<p>æ¥ç€ä½¿ç”¨ä¸­æ–­å‘é‡å·ï¼Œåœ¨ä¸­æ–­å‘é‡è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„å¤„ç†ä»£ç çš„å…¥å£åœ°å€ã€‚ç„¶åç³»ç»Ÿè·³è½¬åˆ°è¿™ä¸ªåœ°å€ï¼Œæ‰§è¡Œç›¸åº”çš„ä¸­æ–­å¤„ç†ç¨‹åºã€‚</p>
<p>å¤„ç†å®Œæˆåï¼Œç³»ç»Ÿé€šè¿‡ä¸­æ–­è¿”å›æœºåˆ¶æ¢å¤è¢«ä¸­æ–­ä»»åŠ¡çš„ç°åœºï¼ˆå†…æ ¸æ€æˆ–ç”¨æˆ·æ€ï¼‰ï¼Œå¹¶ç»§ç»­æ‰§è¡ŒåŸæ¥çš„ä»£ç ã€‚</p>
<p>ä¸­æ–­å¤„ç†çš„ä¸€ä¸ªå…³é”®æ­¥éª¤æ˜¯ï¼Œ<strong>ä¿ç•™ä¸­æ–­å‘ç”Ÿæ—¶çš„ç°åœºä¿¡æ¯</strong>ï¼Œperf çš„ CPU é‡‡æ ·åŠŸèƒ½æ­£æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‚¹ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <code>perf record</code> è¿›è¡Œ CPU åˆ†ææ—¶ï¼Œä¼šé€šè¿‡ <strong>-F</strong> æŒ‡å®šé‡‡æ ·é¢‘ç‡ã€‚å½“è¾¾åˆ°é¢„è®¾çš„é˜ˆå€¼ï¼ˆå¦‚ä¸€å®šæ•°é‡çš„æŒ‡ä»¤æ‰§è¡Œæˆ–ç‰¹å®šæ—¶é—´é—´éš”ï¼‰ï¼Œç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨ä¼šè§¦å‘ä¸€ä¸ª <strong>PMI</strong> ï¼ˆPerformance monitoring interruptsï¼‰ä¸­æ–­ã€‚</p>
<p><strong>PMI</strong> æ˜¯ä¸ªä»€ä¹ˆç±»å‹çš„ä¸­æ–­å‘¢ï¼Ÿä¸€èˆ¬ <strong>PMI</strong> æ˜¯ç”±æœ¬åœ° <strong>APIC</strong>ï¼ˆ <em>Advanced</em> PICï¼‰äº§ç”Ÿï¼Œè€Œ APIC æ¥å…¥ CPU çš„ <strong>INTR</strong> å¼•è„šï¼Œä½ å¯èƒ½è§‰å¾—å®ƒæ˜¯ä¸€ä¸ªå¯å±è”½ä¸­æ–­ã€‚ä½†æ ¹æ®<a class="link" href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html"  target="_blank" rel="noopener"
    >Intel&rsquo;s Software Development Manual: System Programming Guide</a> ï¼Œ<strong>éå±è”½ä¸­æ–­ (NMI)</strong> å¯é€šè¿‡ä¸¤ç§æ–¹å¼ç”Ÿæˆï¼š</p>
<ul>
<li>å¤–éƒ¨ç¡¬ä»¶æ¿€æ´» CPU çš„ <strong>NMI</strong> å¼•è„š</li>
<li>CPU é€šè¿‡ç³»ç»Ÿæ€»çº¿æˆ– APIC ä¸²è¡Œæ€»çº¿æ¥æ”¶ä¸€æ¡åŒ…å« <strong>NMI</strong> ä¼ é€’æ¨¡å¼çš„æ¶ˆæ¯</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒAPIC å¯ä»¥ç”Ÿæˆ <strong>NMI</strong> æ¨¡å¼çš„ä¸­æ–­æ¶ˆæ¯ï¼Œä»¥è°ƒç”¨ NMI ä¸­æ–­å¤„ç†ç¨‹åºã€‚</p>
<p>ç”±äº <strong>NMI</strong> æ— æ³•è¢«å¿½ç•¥ï¼Œå®ƒä»¬å¸¸è¢«ä¸€äº›ç³»ç»Ÿç”¨ä½œç¡¬ä»¶ç›‘æ§å·¥å…·ã€‚å¦‚æœå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µï¼Œæ¯”å¦‚åœ¨é¢„å®šçš„æ—¶é—´å†…æ²¡æœ‰è§¦å‘ä¸­æ–­ï¼ŒNMI å¤„ç†ç¨‹åºå°±ä¼šäº§ç”Ÿè­¦å‘Šå¹¶æä¾›å…³äºè¯¥é—®é¢˜çš„è°ƒè¯•ä¿¡æ¯ã€‚è¿™ç§æœºåˆ¶æœ‰åŠ©äºå‘ç°å¹¶é¢„é˜²ç³»ç»Ÿæ­»é”ã€‚</p>
<p>ç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨è§¦å‘çš„ <strong>PMI</strong> ä¸­æ–­è¢«è®¾ç½®ä¸ºäº† <strong>NMI</strong>ç±»å‹ã€‚æˆ‘ä»¬ä»¥ x86 å¹³å°ä¸ºä¾‹ï¼Œå½“ <strong>PMI</strong> ä¸­æ–­å‘ç”Ÿæ—¶ï¼Œå¤„ç†å…¥å£ä½ç½®åœ¨ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/entry/entry_64.S"  target="_blank" rel="noopener"
    >arch/x86/entry/entry_64.S</a>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">SYM_CODE_START</span><span class="p">(</span><span class="no">asm_exc_nmi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="na">...</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">5</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;ss */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">4</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;rsp */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">3</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;flags */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">2</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;cs */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">1</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;rip */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">UNWIND_HINT_IRET_REGS</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>   <span class="no">$-1</span>		<span class="cm">/* pt_regs-&gt;orig_ax */</span>
</span></span><span class="line"><span class="cl">	<span class="na">...</span>
</span></span><span class="line"><span class="cl">	<span class="nf">movq</span>	<span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rdi</span>
</span></span><span class="line"><span class="cl">	<span class="nf">movq</span>	<span class="no">$-1</span><span class="p">,</span> <span class="nv">%rsi</span>
</span></span><span class="line"><span class="cl">	<span class="nf">call</span>	<span class="no">exc_nmi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/entry/entry_64.S"  target="_blank" rel="noopener"
    >arch/x86/entry/entry_64.S</a>æ˜¯ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™ï¼Œè´Ÿè´£ç³»ç»Ÿè°ƒç”¨ã€ä¸­æ–­å¼‚å¸¸å¤„ç†ã€ä»»åŠ¡åˆ‡æ¢å’Œä¿¡å·å¤„ç†ï¼Œä¸“é—¨é’ˆå¯¹ x86_64 æ¶æ„è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p>
<p><code>asm_exc_nmi</code> å‡½æ•°æ˜¯å¤„ç† <strong>NMI</strong> çš„å…¥å£ï¼Œä»æˆªå–ä»£ç ç‰‡æ®µçš„æ³¨é‡Šå¯ä»¥çœ‹å‡ºï¼Œ <code>asm_exc_nmi</code> ä¼šä½¿ç”¨ <code>pushq</code> æŒ‡ä»¤å°†å½“å‰çš„å¯„å­˜å™¨çŠ¶æ€ä¿å­˜åˆ°å†…æ ¸æ ˆä¸Šï¼Œè¿™äº›åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ï¼ˆ<strong>rip</strong>ï¼Œä¹Ÿå°±æ˜¯ PC å¯„å­˜å™¨ï¼‰ã€ä»£ç æ®µï¼ˆ<strong>cs</strong>ï¼‰ã€æ ‡å¿—ï¼ˆ<strong>flags</strong>ï¼‰ã€å †æ ˆæŒ‡é’ˆï¼ˆ<strong>rsp</strong>ï¼‰å’Œå †æ ˆæ®µï¼ˆ<strong>ss</strong>ï¼‰ã€‚è¿™ä¸€æ­¥éå¸¸å…³é”®ï¼Œä¿ç•™ä¸­æ–­å‘ç”Ÿæ—¶çš„ç°åœºä¿¡æ¯ã€‚æœ€åä½¿ç”¨**<code>call exc_nmi</code>** æŒ‡ä»¤è°ƒç”¨ <code>exc_nmi</code> å‡½æ•°ã€‚<code>exc_nmi</code> ä¼šæ ¹æ®ç±»å‹ï¼Œè°ƒç”¨é¢„å…ˆæ³¨å†Œçš„ NMI å¤„ç†å‡½æ•°ã€‚</p>
<p>å¦‚æœæ˜¯ <strong>PMI</strong> ç±»å‹çš„ä¸­æ–­ï¼Œæœ€ç»ˆè°ƒç”¨çš„å¤„ç†å‡½æ•°æ˜¯ <strong>perf_event_nmi_handler</strong> ï¼Œå®šä¹‰åœ¨ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/events/core.c#L1729"  target="_blank" rel="noopener"
    >arch/x86/events/core.c</a>ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">perf_event_nmi_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">start_clock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">finish_clock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * All PMUs/events that share this PMI handler should make sure to
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * increment active_events for their events.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">active_events</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">NMI_DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">start_clock</span> <span class="o">=</span> <span class="nf">sched_clock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">ret</span> <span class="o">=</span> <span class="nf">static_call</span><span class="p">(</span><span class="n">x86_pmu_handle_irq</span><span class="p">)(</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">finish_clock</span> <span class="o">=</span> <span class="nf">sched_clock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">perf_sample_event_took</span><span class="p">(</span><span class="n">finish_clock</span> <span class="o">-</span> <span class="n">start_clock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒä¸ªå‚æ•° <strong>pt_regs</strong> åœ¨å‰é¢ä»‹ç»ç³»ç»Ÿè°ƒç”¨æ—¶å·²ç»å‡ºç°è¿‡ï¼Œæ˜¯å†…æ ¸ç”¨æ¥ä¿å­˜å¯„å­˜å™¨çŠ¶æ€çš„ç»“æ„ä½“ã€‚è¿™æ ·åœ¨<strong>perf_event_nmi_handler</strong>ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <strong>pt_regs</strong> ä¸­ä¿å­˜çš„å¯„å­˜å™¨çŠ¶æ€ï¼Œè¿˜åŸå‡º <strong>PMI</strong> ä¸­æ–­å‘ç”Ÿæ—¶ï¼ŒCPU å½“æ—¶çš„åŠ¨ä½œï¼Œä»¥åŠåŒ…å«äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„å®Œæ•´ä»£ç æ‰§è¡Œè·¯å¾„ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬äº†è§£äº† perf åœ¨è¿›è¡Œ CPU Profiling æ—¶æ¶‰åŠçš„å…¨éƒ¨æŠ€æœ¯æœºåˆ¶ã€‚</p>
<h2 id="æ€»ç»“">
    <a href="#%e6%80%bb%e7%bb%93" class="header-anchor">#</a>
    æ€»ç»“
</h2><p>ç°åœ¨å†å›é¡¾æˆ‘ä»¬ä½¿ç”¨ perf è¿›è¡Œ CPU Profiling æ—¶çš„å‘½ä»¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo perf record -F <span class="m">99</span> -a -g -- sleep <span class="m">30</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>perf æ˜¯äº‹ä»¶é©±åŠ¨çš„æ–¹å¼å·¥ä½œï¼Œè¿™ä¸ªå‘½ä»¤æ²¡æœ‰æŒ‡å®š <strong>-e</strong> å‚æ•°ï¼Œä¼šæ”¶é›†ä»€ä¹ˆäº‹ä»¶å‘¢ï¼Ÿperf ä¼šé»˜è®¤æ”¶é›† <strong>cycles</strong> ç›¸å…³äº‹ä»¶ï¼Œä»æœ€ç²¾ç¡®çš„ <strong>cycles:ppp</strong> åˆ°æ— ç²¾ç¡®è®¾ç½®çš„ <strong>cycles</strong>ï¼Œä¼˜å…ˆé€‰æ‹©å¯ç”¨ä¸”ç²¾åº¦é«˜çš„äº‹ä»¶ã€‚å¦‚æœæ²¡æœ‰ç¡¬ä»¶ <strong>cycles</strong> äº‹ä»¶å¯ç”¨ï¼Œé€€è€Œé€‰æ‹© <strong>cpu-clock</strong> è½¯ä»¶äº‹ä»¶ã€‚</p>
<p>ä¸ºä»€ä¹ˆé‡‡æ · <strong>cycles</strong> äº‹ä»¶å°±èƒ½åˆ†æç¨‹åºçš„ CPU æ€§èƒ½ï¼Ÿå› ä¸ºæ¯ä¸ª CPU å‘¨æœŸéƒ½ä¼šè§¦å‘ä¸€ä¸ª <strong>cycles</strong> äº‹ä»¶ï¼Œ<strong>cycles</strong> äº‹ä»¶å‡åŒ€çš„åˆ†å¸ƒåœ¨ç¨‹åºçš„æ‰§è¡ŒæœŸé—´ï¼Œä»¥å›ºå®šé¢‘ç‡é‡‡æ ·çš„ <strong>cycles</strong> äº‹ä»¶åŒæ ·å‡åŒ€åˆ†å¸ƒï¼Œå¦‚æœæˆ‘ä»¬åœ¨é‡‡æ · <strong>cycles</strong> äº‹ä»¶æ—¶ï¼Œè®°å½• CPU æ­£åœ¨å¹²ä»€ä¹ˆï¼ŒæŒç»­ä¸€æ®µæ—¶é—´æ”¶é›†åˆ°å¤šä¸ªé‡‡æ ·åï¼Œå°±èƒ½åŸºäºè¿™äº›ä¿¡æ¯åˆ†æç¨‹åºçš„è¡Œä¸ºï¼Œå¤šæ¬¡å‡ºç°çš„åŒæ ·åŠ¨ä½œï¼Œå°±å¯ä»¥è®¤ä¸ºæ˜¯ç¨‹åºçš„çƒ­ç‚¹ã€‚</p>
<p>å¦‚æœæŒ‡å®šé‡‡æ ·é¢‘ç‡ï¼Ÿ<strong>-F 99</strong> è®¾ç½®é‡‡æ ·é¢‘ç‡ä¸º 99 Hertzï¼Œå³æ¯ç§’è¿›è¡Œ 99 æ¬¡é‡‡æ ·ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ **-c 1000 ** è®¾ç½®é‡‡æ ·å‘¨æœŸï¼Œå³æ¯éš” 1000 æ¬¡äº‹ä»¶è¿›è¡Œä¸€æ¬¡é‡‡æ ·ã€‚</p>
<p>å¦‚æœçŸ¥é“é‡‡æ ·æ—¶ CPU æ­£åœ¨åšä»€ä¹ˆï¼Ÿé€šè¿‡CPU çš„ <strong>PCï¼ˆProgram Counterï¼‰å¯„å­˜å™¨</strong>ï¼ˆx86-64 å¹³å°ä¸Šå¯¹åº”çš„æ˜¯ <strong>rip</strong> å¯„å­˜å™¨ï¼‰ã€æŒ‡ä»¤å¯„å­˜å™¨ç­‰çŠ¶æ€ä¿¡æ¯ï¼Œèƒ½æ¨æ–­å‡º CPU çš„ç¬æ—¶åŠ¨ä½œã€‚</p>
<p>çŸ¥é“äº† CPU é‡‡æ ·æ—¶çš„â€œåŠ¨ä½œâ€è¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦çŸ¥é“ CPU æ˜¯æ€ä¹ˆåšè¿™ä¸ªâ€œåŠ¨ä½œâ€çš„ï¼Œä¹Ÿå°±æ˜¯ä»£ç çš„æ‰§è¡Œè·¯å¾„ã€‚ç³»ç»Ÿåˆ©ç”¨äº†<strong>å †æ ˆï¼ˆStackï¼‰<strong>çš„</strong>åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰<strong>å®ç°äº†å‡½æ•°è°ƒç”¨ï¼Œæ¯ä¸ªå‡½æ•°åœ¨å †æ ˆä¸Šåˆ†é…çš„ç©ºé—´ç§°ä¸º</strong>æ ˆå¸§ï¼ˆstack frameï¼‰</strong>ï¼Œå¤šä¸ª<strong>æ ˆå¸§ï¼ˆstack frameï¼‰<strong>ç»„æˆ <a class="link" href="https://en.wikipedia.org/wiki/Call_stack"  target="_blank" rel="noopener"
    >Call stack</a>ï¼Œä½“ç°å‡ºäº†å‡½æ•°çš„è°ƒç”¨å…³ç³»ã€‚é€šè¿‡æ ˆå¸§æŒ‡é’ˆ</strong>Frame Pointer</strong>ï¼ˆ<strong>rbp</strong> å¯„å­˜å™¨ï¼‰ï¼Œå¯ä»¥è¿½æº¯æ•´ä¸ªè°ƒç”¨é“¾ï¼Œé€çº§è®¿é—®åˆ°æ¯ä¸ªè°ƒç”¨è€…çš„<strong>æ ˆå¸§ï¼ˆstack frameï¼‰</strong>ï¼Œé‡æ„å‡ºç¨‹åºæ‰§è¡Œçš„è·¯å¾„ã€‚è¿™å°±æ˜¯ <strong>-g</strong> å‚æ•°çš„ä½œç”¨ï¼šä½¿ç”¨ <strong>Frame Pointer</strong> è¿˜åŸè°ƒç”¨æ ˆã€‚</p>
<p>æ“ä½œç³»ç»Ÿä¸ºäº†å®‰å…¨ä¼šé™åˆ¶ç”¨æˆ·è¿›ç¨‹å¯¹å…³é”®èµ„æºçš„è®¿é—®ï¼Œå°†ç³»ç»Ÿåˆ†ä¸ºäº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Œç”¨æˆ·æ€çš„ä»£ç å¿…é¡»é€šè¿‡**ç³»ç»Ÿè°ƒç”¨ï¼ˆsystem call ï¼‰**è®¿é—®æ ¸å¿ƒèµ„æºã€‚æ‰€ä»¥åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œè¿›ç¨‹å…·æœ‰ä¸¤ä¸ªæ ˆï¼š<strong>ç”¨æˆ·æ ˆï¼ˆUser Stackï¼‰<strong>å’Œ</strong>å†…æ ¸æ ˆï¼ˆKernel Stackï¼‰</strong>ã€‚ä¸ºäº†è¿˜åŸåŒ…å«äº†ç”¨æˆ·æ ˆå’Œå†…æ ¸æ ˆåœ¨å†…å®Œæ•´çš„è°ƒç”¨æ ˆï¼Œæˆ‘ä»¬æ¢ç´¢äº†è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„å¸ƒå±€ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼šåŸæ¥åœ¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¼šå°†è¿›ç¨‹ç”¨æˆ·æ€çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆ<strong>rsp</strong>ã€<strong>rip</strong>ç­‰å¯„å­˜å™¨ï¼‰ä¿å­˜åœ¨å†…æ ¸æ•°æ®ç»“æ„ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/include/asm/ptrace.h#L59"  target="_blank" rel="noopener"
    >struct pt_regs</a> å†…ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡ <strong>Frame Pointer</strong> å’Œ <strong>pt_regs</strong> åˆ†åˆ«è¿˜åŸå†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆã€‚</p>
<p>æ€ä¹ˆè·å–é‡‡æ ·å‘ç”Ÿæ—¶åˆ» CPU å¯„å­˜å™¨çš„å†…å®¹å‘¢ï¼Ÿåœ¨ç‰¹å®šçš„æ—¶é—´é—´éš”åˆ°è¾¾æ—¶ï¼Œä¹Ÿå°±æ˜¯è¯¥é‡‡æ ·çš„æ—¶åˆ»ï¼ŒAPIC ä¼šè§¦å‘ <strong>PMI</strong> ä¸­æ–­ï¼ŒCPU åœ¨å°†æ§åˆ¶æƒè½¬ç»™ä¸­æ–­å¤„ç†ç¨‹åºä¹‹å‰ï¼Œå°†å½“å‰çš„å¯„å­˜å™¨çŠ¶æ€ä¿å­˜åˆ°<strong>pt_regs</strong>ï¼Œç„¶åä½œä¸ºå‚æ•°ä¼ é€’ç»™ <strong>perf_event_nmi_handler</strong>ã€‚è¿™æ · perf å°±æ‹¿åˆ°äº†é‡‡æ ·å‘ç”Ÿæ—¶åˆ»ï¼ŒCPU å¯„å­˜å™¨çš„å†…å®¹ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ <code>perf record</code> æ”¶é›†äº†ä»€ä¹ˆæ ·çš„æ•°æ®ã€‚ä½¿ç”¨ <code>perf script</code> å‘½ä»¤å¯ä»¥æ‰“å°æ”¶é›†åœ¨ <code>perf.data</code> ä¸­çš„æ¯ä¸ªæ ·æœ¬ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo perf script
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">sshd <span class="m">50588</span> 430947.269426:      <span class="m">16854</span> cycles: 
</span></span><span class="line"><span class="cl">        ffffffff824b84f6 native_write_msr+0x6 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff82413dc5 intel_pmu_enable_all+0x15 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff82407abb x86_pmu_enable+0x1ab <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8273d05a perf_ctx_enable+0x3a <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8274646a __perf_event_task_sched_in+0x15a <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff82534bf9 finish_task_switch.isra.0+0x179 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834a57bf __schedule+0x2bf <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834a5b68 schedule+0x68 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834ac3cb schedule_hrtimeout_range_clock+0x11b <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834ac403 schedule_hrtimeout_range+0x13 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8289de3a do_poll.constprop.0+0x22a <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8289e136 do_sys_poll+0x166 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8289e7cc __x64_sys_ppoll+0xbc <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834931ac do_syscall_64+0x5c <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff836000eb entry_SYSCALL_64+0xab <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">                  118e5f __ppoll+0x4f <span class="o">(</span>inlined<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   89a97 server_loop2.constprop.0+0x547 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   89a97 wait_until_can_do_something+0x547 <span class="o">(</span>inlined<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   89a97 server_loop2.constprop.0+0x547 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   2bcf7 do_authenticated2+0x1e7 <span class="o">(</span>inlined<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   2bcf7 do_authenticated+0x1e7 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   11b66 main+0x3616 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   29d8f __libc_start_call_main+0x7f <span class="o">(</span>/usr/lib/x86_64-linux-gnu/libc.so.6<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   29e3f __libc_start_main_impl+0x7f <span class="o">(</span>inlined<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   <span class="m">12844</span> _start+0x24 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»»æ„æˆªå–äº†å…¶ä¸­ä¸€æ®µè¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°åŒ…å«äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€å®Œæ•´çš„è°ƒç”¨æ ˆã€‚åŸºäºå¤šä¸ªè¿™æ ·çš„ä»£ç æ‰§è¡Œè·¯å¾„ï¼Œæˆ‘ä»¬è¿˜èƒ½ç”Ÿæˆ<a class="link" href="https://brendangregg.com/flamegraphs.html"  target="_blank" rel="noopener"
    >ç«ç„°å›¾</a>è¿›ä¸€æ­¥è¿›è¡Œåˆ†æã€‚</p>
<p>ä¸ºäº†äº†è§£ <code>perf record</code> çš„å®ç°åŸç†ï¼Œæˆ‘ä»¬åœ¨ Linux å†…æ ¸è¿›è¡Œäº†ä¸€æ®µæ·±å…¥è€Œåˆºæ¿€çš„æ—…ç¨‹ï¼Œæ„Ÿè°¢å„ä½å‚ä¸æ¢é™©ï¼</p>
<p>æˆ‘çš„åšå®¢å³å°†åŒæ­¥è‡³è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒºï¼Œé‚€è¯·å¤§å®¶ä¸€åŒå…¥é©»ï¼šhttps://cloud.tencent.com/developer/support-plan?invite_code=1k39tbi20c30f</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/linux/">Linux</a>
        
            <a href="/tags/kernel/">Kernel</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/perf-%E7%9A%84-cpu-clock-%E4%B8%8E-cpu-cycles-%E9%87%87%E6%A0%B7%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%AF%B9%E6%AF%94/">
        
        

        <div class="article-details">
            <h2 class="article-title">Perf çš„ cpu-clock ä¸ cpu-cycles é‡‡æ ·å®ç°ä¸å¯¹æ¯”</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/wall-clock-%E4%B8%8E-cpu-cycles-%E9%87%87%E6%A0%B7%E7%9A%84%E5%8C%BA%E5%88%AB/">
        
        

        <div class="article-details">
            <h2 class="article-title">Wall-Clock ä¸ CPU-Cycles é‡‡æ ·çš„åŒºåˆ«</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E4%BB%8E%E6%BA%90%E7%A0%81%E6%9E%84%E5%BB%BA-perf/">
        
        

        <div class="article-details">
            <h2 class="article-title">ä»æºç æ„å»º perf</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/linux-gnu/linux%E4%BB%A5%E5%8F%8Aalpine-linux/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linux, GNU/Linuxä»¥åŠAlpine Linux</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/">
        
        

        <div class="article-details">
            <h2 class="article-title">æ·±å…¥æµ…å‡ºå®¹å™¨æŠ€æœ¯</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mazhen-tech" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2014 - 
        
        2026 mazhen.tech
    </section>
    
    <section class="powerby">
        
            <a target="_blank" href="https://beian.miit.gov.cn">ç²¤ ICP å¤‡ 2022085181 å· -1</a> <br/>
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.25.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
