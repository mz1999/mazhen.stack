<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='perf ÊòØ‰ªÄ‰πà perf ÊòØÁî± Linux ÂÆòÊñπÊèê‰æõÁöÑÁ≥ªÁªüÊÄßËÉΩÂàÜÊûêÂ∑•ÂÖ∑ „ÄÇÊàë‰ª¨ÈÄöÂ∏∏ËØ¥ÁöÑ perf ÂÆûÈôÖ‰∏äÂåÖÂê´‰∏§ÈÉ®ÂàÜÔºö perf ÂëΩ‰ª§ÔºåÁî®Êà∑Á©∫Èó¥ÁöÑÂ∫îÁî®Á®ãÂ∫è perf_events ÔºåLinux ÂÜÖÊ†∏‰∏≠ÁöÑ‰∏Ä‰∏™Â≠êÁ≥ªÁªü ÂÜÖÊ†∏Â≠ê'>
<title>Ê∑±ÂÖ•Êé¢Á¥¢ perf CPU Profiling ÂÆûÁé∞ÂéüÁêÜ</title>

<link rel='canonical' href='https://mazhen.tech/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2-perf-cpu-profiling-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='Ê∑±ÂÖ•Êé¢Á¥¢ perf CPU Profiling ÂÆûÁé∞ÂéüÁêÜ'>
<meta property='og:description' content='perf ÊòØ‰ªÄ‰πà perf ÊòØÁî± Linux ÂÆòÊñπÊèê‰æõÁöÑÁ≥ªÁªüÊÄßËÉΩÂàÜÊûêÂ∑•ÂÖ∑ „ÄÇÊàë‰ª¨ÈÄöÂ∏∏ËØ¥ÁöÑ perf ÂÆûÈôÖ‰∏äÂåÖÂê´‰∏§ÈÉ®ÂàÜÔºö perf ÂëΩ‰ª§ÔºåÁî®Êà∑Á©∫Èó¥ÁöÑÂ∫îÁî®Á®ãÂ∫è perf_events ÔºåLinux ÂÜÖÊ†∏‰∏≠ÁöÑ‰∏Ä‰∏™Â≠êÁ≥ªÁªü ÂÜÖÊ†∏Â≠ê'>
<meta property='og:url' content='https://mazhen.tech/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2-perf-cpu-profiling-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/'>
<meta property='og:site_name' content='mazhen.tech'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='linux' /><meta property='article:tag' content='kernel' /><meta property='article:published_time' content='2023-11-06T11:18:06&#43;08:00'/><meta property='article:modified_time' content='2023-11-06T11:18:06&#43;08:00'/>
<meta name="twitter:site" content="@mazhen">
    <meta name="twitter:creator" content="@mazhen"><meta name="twitter:title" content="Ê∑±ÂÖ•Êé¢Á¥¢ perf CPU Profiling ÂÆûÁé∞ÂéüÁêÜ">
<meta name="twitter:description" content="perf ÊòØ‰ªÄ‰πà perf ÊòØÁî± Linux ÂÆòÊñπÊèê‰æõÁöÑÁ≥ªÁªüÊÄßËÉΩÂàÜÊûêÂ∑•ÂÖ∑ „ÄÇÊàë‰ª¨ÈÄöÂ∏∏ËØ¥ÁöÑ perf ÂÆûÈôÖ‰∏äÂåÖÂê´‰∏§ÈÉ®ÂàÜÔºö perf ÂëΩ‰ª§ÔºåÁî®Êà∑Á©∫Èó¥ÁöÑÂ∫îÁî®Á®ãÂ∫è perf_events ÔºåLinux ÂÜÖÊ†∏‰∏≠ÁöÑ‰∏Ä‰∏™Â≠êÁ≥ªÁªü ÂÜÖÊ†∏Â≠ê">
    <link rel="shortcut icon" href="/favicon.png" />

<script async src="https://www.googletagmanager.com/gtag/js?id=G-LBEVB8TRX2"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LBEVB8TRX2', { 'anonymize_ip': false });
}
</script>

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/mazhen_hu6e56901738cd7f8ddabbbe3def51a5b4_111611_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">mazhen.tech</a></h1>
            <h2 class="site-description">Stay hungry. Stay foolish.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='mailto:me@mazhen.tech'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="3" y="5" width="18" height="14" rx="2" />
  <polyline points="3 7 12 13 21 7" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/mz1999'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.instagram.com/sword_holder/'
                        target="_blank"
                        title="instagram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-instagram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="4" y="4" width="16" height="16" rx="4" />
  <circle cx="12" cy="12" r="3" />
  <line x1="16.5" y1="7.5" x2="16.5" y2="7.501" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://t.me/sword_holder'
                        target="_blank"
                        title="telegram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-telegram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/mazhen'
                        target="_blank"
                        title="twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://mazhen.tech/" selected>‰∏≠Êñá</option>
                        
                            <option value="https://mazhen.tech/en/" >English</option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>ÊöóËâ≤Ê®°Âºè</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#perf-ÊòØ‰ªÄ‰πà">perf ÊòØ‰ªÄ‰πà</a></li>
    <li><a href="#perf-‰∫ã‰ª∂Ê∫ê">perf ‰∫ã‰ª∂Ê∫ê</a></li>
    <li><a href="#hardware-event">Hardware Event</a></li>
    <li><a href="#cpu-profiling">CPU Profiling</a>
      <ol>
        <li><a href="#cycles-‰∫ã‰ª∂">cycles ‰∫ã‰ª∂</a></li>
        <li><a href="#ËÆæÁΩÆÈááÊ†∑È¢ëÁéá">ËÆæÁΩÆÈááÊ†∑È¢ëÁéá</a></li>
      </ol>
    </li>
    <li><a href="#ËÉåÊôØÁü•ËØÜ">ËÉåÊôØÁü•ËØÜ</a>
      <ol>
        <li><a href="#cpu-ÊâßË°åÊåá‰ª§">CPU ÊâßË°åÊåá‰ª§</a></li>
        <li><a href="#ËøòÂéüÂáΩÊï∞Ë∞ÉÁî®Ê†à">ËøòÂéüÂáΩÊï∞Ë∞ÉÁî®Ê†à</a></li>
        <li><a href="#Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ">Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ</a></li>
        <li><a href="#Á≥ªÁªüË∞ÉÁî®">Á≥ªÁªüË∞ÉÁî®</a></li>
        <li><a href="#Áî®Êà∑Ê†àÂíåÂÜÖÊ†∏Ê†à">Áî®Êà∑Ê†àÂíåÂÜÖÊ†∏Ê†à</a></li>
        <li><a href="#ËøõÁ®ãËôöÊãüÂú∞ÂùÄÁ©∫Èó¥">ËøõÁ®ãËôöÊãüÂú∞ÂùÄÁ©∫Èó¥</a></li>
        <li><a href="#ËøòÂéüÂÆåÊï¥Ë∞ÉÁî®Ê†à">ËøòÂéüÂÆåÊï¥Ë∞ÉÁî®Ê†à</a></li>
        <li><a href="#‰∏≠Êñ≠Â§ÑÁêÜ">‰∏≠Êñ≠Â§ÑÁêÜ</a></li>
      </ol>
    </li>
    <li><a href="#ÊÄªÁªì">ÊÄªÁªì</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tech/" >
                Tech
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2-perf-cpu-profiling-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">Ê∑±ÂÖ•Êé¢Á¥¢ perf CPU Profiling ÂÆûÁé∞ÂéüÁêÜ</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2023-11-06</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 26 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p><img src="https://cdn.mazhen.tech/images/202311211430792.png"
	
	
	
	loading="lazy"
	
		alt="title"
	
	
></p>
<h2 id="perf-ÊòØ‰ªÄ‰πà">perf ÊòØ‰ªÄ‰πà</h2>
<p><a class="link" href="https://perf.wiki.kernel.org/index.php/Main_Page"  target="_blank" rel="noopener"
    >perf</a> ÊòØÁî± Linux ÂÆòÊñπÊèê‰æõÁöÑÁ≥ªÁªüÊÄßËÉΩÂàÜÊûêÂ∑•ÂÖ∑ „ÄÇÊàë‰ª¨ÈÄöÂ∏∏ËØ¥ÁöÑ perf ÂÆûÈôÖ‰∏äÂåÖÂê´‰∏§ÈÉ®ÂàÜÔºö</p>
<ul>
<li><strong>perf</strong> ÂëΩ‰ª§ÔºåÁî®Êà∑Á©∫Èó¥ÁöÑÂ∫îÁî®Á®ãÂ∫è</li>
<li><strong>perf_events</strong> ÔºåLinux ÂÜÖÊ†∏‰∏≠ÁöÑ‰∏Ä‰∏™Â≠êÁ≥ªÁªü</li>
</ul>
<p>ÂÜÖÊ†∏Â≠êÁ≥ªÁªü <code>perf_events</code> Êèê‰æõ‰∫ÜÊÄßËÉΩËÆ°Êï∞Âô®Ôºà<a class="link" href="https://en.wikipedia.org/wiki/Hardware_performance_counter"  target="_blank" rel="noopener"
    >hardware performance counters</a>ÔºâÂíåÊÄßËÉΩ‰∫ã‰ª∂ÁöÑÊîØÊåÅÔºåÂÆÉ‰ª•‰∫ã‰ª∂È©±Âä®ÂûãÁöÑÊñπÂºèÂ∑•‰ΩúÔºåÈÄöËøáÊî∂ÈõÜÁâπÂÆö‰∫ã‰ª∂ÔºàÂ¶Ç CPU Êó∂ÈíüÂë®ÊúüÔºåÁºìÂ≠òÊú™ÂëΩ‰∏≠Á≠âÔºâÊù•Ë∑üË∏™ÂíåÂàÜÊûêÁ≥ªÁªüÊÄßËÉΩ„ÄÇ<code>perf_events</code>ÊòØÂú® <a class="link" href="https://lwn.net/Articles/339361/"  target="_blank" rel="noopener"
    >2009 Âπ¥ÂêàÂπ∂Âà∞ Linux ÂÜÖÊ†∏Ê∫ê‰ª£Á†Å‰∏≠</a>ÔºåÊàê‰∏∫ÂÜÖÊ†∏‰∏Ä‰∏™Êñ∞ÁöÑÂ≠êÁ≥ªÁªü„ÄÇ</p>
<p><code>perf</code> ÂëΩ‰ª§ÊòØ‰∏Ä‰∏™Áî®Êà∑Á©∫Èó¥Â∑•ÂÖ∑ÔºåÂÖ∑Â§á profiling„ÄÅtracing ÂíåËÑöÊú¨ÁºñÂÜôÁ≠âÂ§öÁßçÂäüËÉΩÔºåÊòØÂÜÖÊ†∏Â≠êÁ≥ªÁªü perf_events ÁöÑÂâçÁ´ØÂ∑•ÂÖ∑„ÄÇÈÄöËøá<code>perf</code> ÂëΩ‰ª§ÂèØ‰ª•ËÆæÁΩÆÂíåÊìç‰ΩúÂÜÖÊ†∏Â≠êÁ≥ªÁªü <code>perf_events</code>ÔºåÂÆåÊàêÁ≥ªÁªüÊÄßËÉΩÊï∞ÊçÆÁöÑÊî∂ÈõÜÂíåÂàÜÊûê„ÄÇ</p>
<p>ËôΩÁÑ∂ <code>perf</code> ÂëΩ‰ª§ÊòØ‰∏Ä‰∏™Áî®Êà∑Á©∫Èó¥ÁöÑÂ∫îÁî®Á®ãÂ∫èÔºå‰ΩÜÂÆÉÂç¥‰Ωç‰∫é Linux ÂÜÖÊ†∏Ê∫ê‰ª£Á†ÅÊ†ë‰∏≠ÔºåÂú® <a class="link" href="https://github.com/torvalds/linux/tree/master/tools/perf"  target="_blank" rel="noopener"
    >tools/perf</a> ÁõÆÂΩï‰∏ãÔºåÂÆÉÂèØËÉΩÊòØÂîØ‰∏Ä‰∏Ä‰∏™Ë¢´ÂåÖÂê´Âú® Linux ÂÜÖÊ†∏Ê∫êÁ†Å‰∏≠ÁöÑÂ§çÊùÇÁî®Êà∑ËΩØ‰ª∂„ÄÇ</p>
<p>perf Âíå perf_events ÊúÄÂàùÊîØÊåÅÁ°¨‰ª∂ËÆ°Êï∞Âô®Ôºàperformance monitoring countersÔºå<strong>PMC</strong>ÔºâÔºåÂêéÊù•ÈÄêÊ≠•Êâ©Â±ïÂà∞ÊîØÊåÅÂ§öÁßç‰∫ã‰ª∂Ê∫êÔºåÂåÖÊã¨Ôºö<a class="link" href="https://docs.kernel.org/trace/events.html"  target="_blank" rel="noopener"
    >tracepoints</a>„ÄÅkernel ËΩØ‰ª∂‰∫ã‰ª∂„ÄÅ<a class="link" href="https://www.kernel.org/doc/html/latest/trace/kprobes.html"  target="_blank" rel="noopener"
    >kprobes</a>„ÄÅ<a class="link" href="https://docs.kernel.org/trace/uprobetracer.html?highlight=uprobe"  target="_blank" rel="noopener"
    >uprobes</a> Âíå USDTÔºàUser-level statically-defined tracingÔºâ„ÄÇ</p>
<p>‰∏ãÂõæÊòæÁ§∫‰∫Ü perf ÂëΩ‰ª§Âíå perf_events ÁöÑÂÖ≥Á≥ªÔºå‰ª•Âèä perf_events ÊîØÊåÅÁöÑ‰∫ã‰ª∂Ê∫ê„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202311071635405.png"
	
	
	
	loading="lazy"
	
		alt="perf events"
	
	
></p>
<h2 id="perf-‰∫ã‰ª∂Ê∫ê">perf ‰∫ã‰ª∂Ê∫ê</h2>
<p>perf ÊîØÊåÅÊù•Ëá™Á°¨‰ª∂ÂíåËΩØ‰ª∂ÊñπÈù¢ÁöÑÂêÑÁßç‰∫ã‰ª∂„ÄÇÁ°¨‰ª∂‰∫ã‰ª∂Êù•Ëá™ËäØÁâáÁªÑ‰∏≠ÁöÑÁ°¨‰ª∂ÊÄßËÉΩËÆ°Êï∞Âô®Ôºà<a class="link" href="https://en.wikipedia.org/wiki/Hardware_performance_counter"  target="_blank" rel="noopener"
    >hardware performance counters</a>ÔºâÔºåËÄåËΩØ‰ª∂‰∫ã‰ª∂ÂàôÁî±<a class="link" href="https://docs.kernel.org/trace/events.html"  target="_blank" rel="noopener"
    >tracepoints</a>„ÄÅ<a class="link" href="https://www.kernel.org/doc/html/latest/trace/kprobes.html"  target="_blank" rel="noopener"
    >kprobe</a> Âíå <a class="link" href="https://docs.kernel.org/trace/uprobetracer.html?highlight=uprobe"  target="_blank" rel="noopener"
    >uprobe</a> Á≠âË∞ÉËØïËÆæÊñΩÊèê‰æõ„ÄÇ</p>
<p>ÂèØ‰ª•‰ΩøÁî® perf ÁöÑÂ≠êÂëΩ‰ª§ <strong>list</strong> ÂàóÂá∫ÂΩìÂâçÂèØÁî®ÁöÑÊâÄÊúâ‰∫ã‰ª∂Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo perf list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">List of pre-defined events <span class="o">(</span>to be used in -e or -M<span class="o">)</span>:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  branch-instructions OR branches                    <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  branch-misses                                      <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  bus-cycles                                         <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cache-misses                                       <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cache-references                                   <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cpu-cycles OR cycles                               <span class="o">[</span>Hardware event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cgroup-switches                                    <span class="o">[</span>Software event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  context-switches OR cs                             <span class="o">[</span>Software event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  cpu-clock                                          <span class="o">[</span>Software event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl">  L1-dcache-load-misses                              <span class="o">[</span>Hardware cache event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  L1-dcache-loads                                    <span class="o">[</span>Hardware cache event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl">  branch-instructions OR cpu/branch-instructions/    <span class="o">[</span>Kernel PMU event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  branch-misses OR cpu/branch-misses/                <span class="o">[</span>Kernel PMU event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span><span class="line"><span class="cl">  sched:sched_process_exec                           <span class="o">[</span>Tracepoint event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  sched:sched_process_exit                           <span class="o">[</span>Tracepoint event<span class="o">]</span>
</span></span><span class="line"><span class="cl">  sched:sched_process_fork                           <span class="o">[</span>Tracepoint event<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>...<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰∫ã‰ª∂Á±ªÂûãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li><strong>Hardware Event</strong>ÔºöCPU ÊÄßËÉΩËÆ°Êï∞Âô®Ôºàperformance monitoring countersÔºâ</li>
<li><strong>Software event</strong>ÔºöÂÜÖÊ†∏ËÆ°Êï∞Âô®‰∫ã‰ª∂</li>
<li><strong>Hardware cache event</strong>ÔºöCPU Cache ‰∫ã‰ª∂</li>
<li><strong>Kernel PMU event</strong>ÔºöPerformance Monitoring Unit (PMU) ‰∫ã‰ª∂</li>
<li><strong>Tracepoint event</strong>ÔºöÂåÖÂê´‰∫ÜÈùôÊÄÅÂíåÂä®ÊÄÅ‰ª£Á†ÅËøΩË∏™‰∫ã‰ª∂
<ul>
<li><strong>Kernel tracepoints</strong>ÔºöÂú® kernel ‰∏≠ÂÖ≥ÈîÆ‰ΩçÁΩÆÁöÑÈùôÊÄÅËøΩË∏™‰ª£Á†Å</li>
<li><strong>kprobes</strong>ÔºöÂú®ÂÜÖÊ†∏‰∏≠ÁöÑ‰ªªÊÑè‰ΩçÁΩÆÂä®ÊÄÅÂú∞Ë¢´ÊèíÂÖ•ËøΩË∏™‰ª£Á†Å</li>
<li><strong>uprobes</strong>Ôºö‰∏ékprobesÁ±ª‰ººÔºå‰ΩÜÁî®‰∫éÁî®Êà∑Á©∫Èó¥„ÄÇÂä®ÊÄÅÂú∞Âú®Â∫îÁî®Á®ãÂ∫èÂíåÂ∫ì‰∏≠ÁöÑ‰ªªÊÑè‰ΩçÁΩÆÊèíÂÖ•ËøΩË∏™‰ª£Á†Å</li>
<li><strong>USDT</strong>ÔºöÊòØ tracepoints Âú®Áî®Êà∑Á©∫Èó¥ÁöÑÂØπÂ∫îÊäÄÊúØÔºåÊòØÂ∫îÁî®Á®ãÂ∫èÂíåÂ∫ìÂú®ÂÆÉ‰ª¨ÁöÑ‰ª£Á†Å‰∏≠ÊèêÂâçÂä†ÂÖ•ÁöÑÈùôÊÄÅËøΩË∏™‰ª£Á†Å</li>
</ul>
</li>
</ul>
<p>perf ÁöÑ ‚ÄúTracepoint event‚Äù ‰∫ã‰ª∂Ê∫êÂæàÂÆπÊòìÂºïËµ∑Ê∑∑Ê∑ÜÔºåÂõ†‰∏∫Èô§‰∫ÜÂÜÖÊ†∏ÁöÑ tracepointsÔºåÂü∫‰∫é kprobe„ÄÅuprobe Âíå USDT ÁöÑË∑üË∏™‰∫ã‰ª∂‰πüË¢´Ê†áËÆ∞‰∏∫‰∫Ü‚ÄúTracepoint event‚Äù„ÄÇÈªòËÆ§ÊÉÖÂÜµ‰∏ãÂÆÉ‰ª¨‰∏ç‰ºöÂá∫Áé∞Âú® perf list ÁöÑËæìÂá∫‰∏≠Ôºå ÂøÖÈ°ªÂÖàÂàùÂßãÂåñÊâç‰ºö‰Ωú‰∏∫ &ldquo;Tracepoint event&rdquo; ‰∏≠ÁöÑ‰∫ã‰ª∂„ÄÇ</p>
<p>ÂÜÖÊ†∏ tracepoints ÊòØÁî± <a class="link" href="https://elixir.bootlin.com/linux/latest/source/include/trace/trace_events.h#L39"  target="_blank" rel="noopener"
    >TRACE_EVENT</a> ÂÆèÂÆö‰πâ„ÄÇTRACE_EVENT Ëá™Âä®ÁîüÊàêÈùôÊÄÅËøΩË∏™‰ª£Á†ÅÔºåÂÆö‰πâÂπ∂Ê†ºÂºèÂåñÂÖ∂ÂèÇÊï∞ÔºåÂπ∂Â∞ÜË∑üË∏™‰∫ã‰ª∂ÊîæÂÖ• tracefs Ôºà/sys/kernel/debug/tracingÔºâÂíå <a class="link" href="https://www.man7.org/linux/man-pages/man2/perf_event_open.2.html"  target="_blank" rel="noopener"
    >perf_event_open</a> Êé•Âè£„ÄÇ</p>
<p>‰∏éÂÖ∂‰ªñÊÄßËÉΩÂàÜÊûêÂ∑•ÂÖ∑Áõ∏ÊØîÔºåperf ÁâπÂà´ÈÄÇÂêà CPU ÂàÜÊûêÔºåÂÆÉËÉΩÂØπËøêË°åÂú® CPU ‰∏ä‰ª£Á†ÅË∞ÉÁî®Ê†àÔºàstack tracesÔºâËøõË°åÈááÊ†∑Ôºå‰ª•Á°ÆÂÆöÁ®ãÂ∫èÂú® CPU ‰∏äÁöÑËøêË°åÊÉÖÂÜµÔºåËØÜÂà´Âíå‰ºòÂåñ‰ª£Á†Å‰∏≠ÁöÑÁÉ≠ÁÇπ„ÄÇËøôÁßç CPU Profiling ËÉΩÂäõÊòØÂü∫‰∫éÁ°¨‰ª∂ËÆ°Êï∞Âô® (performance monitoring countersÔºåPMC) ÂÆûÁé∞ÁöÑÔºåËÄå PMC Ë¢´ÂÜÖÊ†∏Â≠êÁ≥ªÁªü <code>perf_events</code>  ÂåÖË£ÖÊàê‰∫Ü <strong>Hardware Event</strong>Ôºå‰∏ãÈù¢ÈáçÁÇπ‰ªãÁªç„ÄÇ</p>
<h2 id="hardware-event">Hardware Event</h2>
<p>CPU ÂíåÂÖ∂‰ªñÁ°¨‰ª∂ËÆæÂ§áÈÄöÂ∏∏Êèê‰æõÁî®‰∫éËßÇÊµãÊÄßËÉΩÊï∞ÊçÆÁöÑ PMC„ÄÇÁÆÄÂçïÊù•ËØ¥Ôºå<strong>PMC</strong> Â∞±ÊòØ CPU ‰∏äÁöÑ<strong>ÂèØÁºñÁ®ãÂØÑÂ≠òÂô®</strong>ÔºåÂèØÈÄöËøáÁºñÁ®ãÂØπÁâπÂÆöÁ°¨‰ª∂‰∫ã‰ª∂ËøõË°åËÆ°Êï∞„ÄÇÈÄöËøá PMC ÂèØ‰ª•ÁõëÊéßÂíåËÆ°ÁÆó CPU ÂÜÖÈÉ®ÂêÑÁßç‰∫ã‰ª∂ÔºåÊØîÂ¶Ç CPU Êåá‰ª§ÁöÑÊâßË°åÊïàÁéá„ÄÅCPU caches ÁöÑÂëΩ‰∏≠Áéá„ÄÅÂàÜÊîØÈ¢ÑÊµãÁöÑÊàêÂäüÁéáÁ≠â micro-architectural Á∫ßÁöÑÊÄßËÉΩ‰ø°ÊÅØ„ÄÇÂà©Áî®Ëøô‰∫õÊï∞ÊçÆÂàÜÊûêÊÄßËÉΩÔºåÂèØ‰ª•ÂÆûÁé∞ÂêÑÁßçÊÄßËÉΩ‰ºòÂåñ„ÄÇ</p>
<p>perf ÂëΩ‰ª§ÈÄöËøá <a class="link" href="https://www.man7.org/linux/man-pages/man2/perf_event_open.2.html"  target="_blank" rel="noopener"
    >perf_event_open(2)</a> Á≥ªÁªüË∞ÉÁî®ËÆøÈóÆ PMCÔºåÈÖçÁΩÆÊÉ≥Ë¶ÅÊçïËé∑ÁöÑÁ°¨‰ª∂‰∫ã‰ª∂„ÄÇPMC ÂèØ‰ª•Âú®‰∏§ÁßçÊ®°Âºè‰∏ã‰ΩøÁî®Ôºö</p>
<ul>
<li>CountingÔºàËÆ°Êï∞Ê®°ÂºèÔºâÔºåÂè™ËÆ°ÁÆóÂíåÊä•ÂëäÁ°¨‰ª∂‰∫ã‰ª∂ÁöÑÊÄªÊï∞ÔºåÂºÄÈîÄÂá†‰πé‰∏∫Èõ∂„ÄÇ</li>
<li>SamplingÔºàÈááÊ†∑Ê®°ÂºèÔºâÔºåÂΩìÂèëÁîü‰∏ÄÂÆöÊï∞ÈáèÁöÑ‰∫ã‰ª∂ÂêéÔºå‰ºöËß¶Âèë‰∏Ä‰∏™‰∏≠Êñ≠Ôºå‰ª•‰æøÊçïËé∑Á≥ªÁªüÁöÑÁä∂ÊÄÅ‰ø°ÊÅØ„ÄÇÂèØÁî®‰∫éÈááÈõÜ‰ª£Á†ÅË∑ØÂæÑ„ÄÇ</li>
</ul>
<p>glibc Ê≤°ÊúâÊèê‰æõÂØπÁ≥ªÁªüË∞ÉÁî® perf_event_open ÁöÑÂåÖË£ÖÔºåperf Âú® <a class="link" href="https://elixir.bootlin.com/linux/v6.6.2/source/tools/perf/perf-sys.h"  target="_blank" rel="noopener"
    >tools/perf/perf-sys.h</a> ÂÆö‰πâ‰∫ÜËá™Â∑±ÁöÑÂåÖË£ÖÂáΩÊï∞Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">sys_perf_event_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">perf_event_attr</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group_fd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="nf">syscall</span><span class="p">(</span><span class="n">__NR_perf_event_open</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">group_fd</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Á¨¨‰∏Ä‰∏™ÂèÇÊï∞ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.2/source/include/uapi/linux/perf_event.h#L385"  target="_blank" rel="noopener"
    >perf_event_attr</a> ÁªìÊûÑ‰ΩìÂÆö‰πâ‰∫ÜÊÉ≥Ë¶ÅÁõëÊéßÁöÑ‰∫ã‰ª∂ÁöÑÁ±ªÂûãÂíåË°å‰∏∫„ÄÇ‰æãÂ¶ÇÊÉ≥Ë¶ÅÁªüËÆ° CPU ÁöÑÊÄªÊåá‰ª§Êï∞ÔºåÂèØ‰ª•ËøôÊ†∑ÂàùÂßãÂåñ <code>perf_event_attr</code> ÁªìÊûÑ‰ΩìÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">perf_event_attr</span>  <span class="n">pe</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pe</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">PERF_TYPE_HARDWARE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">exclude_kernel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">pe</span><span class="p">.</span><span class="n">exclude_hv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>perf Âú® <a class="link" href="https://elixir.bootlin.com/linux/v6.2.16/source/include/uapi/linux/perf_event.h"  target="_blank" rel="noopener"
    >perf_event.h</a> ‰∏≠ÂÆö‰πâ‰∫ÜÈÄÇÁî®‰∫éÂêÑÁ±ªÂ§ÑÁêÜÂô®ÁöÑÈÄöÁî®‰∫ã‰ª∂Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">perf_hw_id</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CPU_CYCLES</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_INSTRUCTIONS</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">enum</span> <span class="n">perf_hw_cache_id</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CACHE_L1D</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CACHE_L1I</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">PERF_COUNT_HW_CACHE_LL</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÈíàÂØπÊØèÁßç CPUÔºåÈúÄË¶ÅÂ∞Ü‰∫ã‰ª∂Êûö‰∏æÁ±ªÂûãÊò†Â∞Ñ‰∏∫ÁâπÂÆö CPU ÁöÑÂéüÂßãÁ°¨‰ª∂‰∫ã‰ª∂ÊèèËø∞Á¨¶„ÄÇ‰æãÂ¶ÇÂØπ‰∫é Intel x86 Êû∂ÊûÑÁöÑ CPUÔºå<strong>PERF_COUNT_HW_INSTRUCTIONS</strong> ‰∫ã‰ª∂Êò†Â∞Ñ‰∏∫ <code>0x00c0</code>ÔºåÂú® <a class="link" href="https://elixir.bootlin.com/linux/v6.6.2/source/arch/x86/events/intel/core.c#L31"  target="_blank" rel="noopener"
    >arch/x86/events/intel/core.c</a> ‰∏≠ÂÆö‰πâÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="n">u64</span> <span class="n">intel_perfmon_event_map</span><span class="p">[</span><span class="n">PERF_COUNT_HW_MAX</span><span class="p">]</span> <span class="n">__read_mostly</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="n">PERF_COUNT_HW_CPU_CYCLES</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x003c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="n">PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00c0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="p">[</span><span class="n">PERF_COUNT_HW_CACHE_REFERENCES</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4f2e</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ëøô‰∫õÂéüÂßãÁ°¨‰ª∂‰∫ã‰ª∂ÊèèËø∞Á¨¶Âú®Áõ∏Â∫îÁöÑÂ§ÑÁêÜÂô®ËΩØ‰ª∂ÂºÄÂèë‰∫∫ÂëòÊâãÂÜå‰∏≠ËøõË°å‰∫ÜËØ¥Êòé„ÄÇÂÜÖÊ†∏ÂºÄÂèë‰∫∫ÂëòÊ†πÊçÆ CPU ÂéÇÂïÜÊèê‰æõÁöÑËΩØ‰ª∂ÂºÄÂèë‰∫∫ÂëòÊâãÂÜåÔºåÂÆåÊàê PMC ‰∫ã‰ª∂ÂíåÁâπÂÆö CPU ‰ª£Á†ÅÁöÑÊò†Â∞Ñ„ÄÇ</p>
<p>‰æãÂ¶Ç Intel x86 Êû∂ÊûÑÁöÑ CPUÂèØ‰ª•ÂèÇËÄÉ <a class="link" href="https://www.intel.com/content/www/us/en/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html"  target="_blank" rel="noopener"
    >Intel¬Æ 64 and IA-32 Architectures Software Developer‚Äôs Manual</a> ÁöÑÁ¨¨‰∏âÂç∑Á¨¨ 20 Á´† ‚ÄúPERFORMANCE MONITORING‚Äù„ÄÇIntel ËøòÊèê‰æõ‰∫Ü‰∏Ä‰∏™ÁΩëÁ´ô <a class="link" href="https://perfmon-events.intel.com/"  target="_blank" rel="noopener"
    >perfmon-events.intel.com</a>ÔºåÂèØ‰ª•Êü•ËØ¢ CPU ÁöÑÊâÄÊúâ PMC ‰∫ã‰ª∂„ÄÇ</p>
<p>Êàë‰ª¨Âú®‰ΩøÁî® perf Êó∂ÔºåÂèØ‰ª•Áõ¥Êé•ÊåáÂÆöÁâπÂÆö CPU ÁöÑÂéüÂßã‰∫ã‰ª∂‰ª£Á†ÅÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo perf stat -e r00c0 -e instructions -a sleep <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂØπ‰∫é Intel CPUÔºå<code>instructions</code> ‰∫ã‰ª∂ÁöÑÂéüÂßã‰∫ã‰ª∂‰ª£Á†Å‰∏∫ <code>r00c0</code>Ôºå‰∏§ËÄÖÂèØ‰ª•Á≠â‰ª∑‰ΩøÁî®„ÄÇ</p>
<p>ÂØπ‰∫éÂ§ßÈÉ®ÂàÜÈÄöÁî®‰∫ã‰ª∂ÔºåÊàë‰ª¨‰∏çÈúÄË¶ÅËÆ∞‰ΩèËøô‰∫õÂéüÂßã‰∫ã‰ª∂‰ª£Á†ÅÔºåperf ÈÉΩÊèê‰æõ‰∫ÜÂèØËØªÁöÑÊò†Â∞Ñ„ÄÇ‰ΩÜÂú®Êüê‰∫õÊÉÖÂÜµ‰∏ãÔºå‰æãÂ¶ÇÊúÄÊñ∞ CPU Â¢ûÂä†ÁöÑ‰∫ã‰ª∂ËøòÊ≤°ÊúâÂú® perf ‰∏≠Ê∑ªÂä†Êò†Â∞ÑÔºåÊàñËÄÖÊüêÁßç CPU ÁöÑÁâπÂÆö‰∫ã‰ª∂‰∏ç‰ºöÈÄöËøáÂèØËØªÁöÑÂêçÁß∞Êö¥Èú≤Âá∫Êù•ÔºåËøôÊó∂Â∞±Âè™ËÉΩÈÄöËøáÊåáÂÆöÂéüÂßãÁ°¨‰ª∂‰∫ã‰ª∂‰ª£Á†ÅÊù•ÁõëÊéß‰∫ã‰ª∂„ÄÇ</p>
<p>ÁÆÄÂçï‰∫ÜËß£‰∫Ü PMC ÂêéÔºåÊàë‰ª¨Êù•ÁúãÂ¶Ç‰ΩïÂü∫‰∫é PMC ‰∫ã‰ª∂ËøõË°å CPU Profiling„ÄÇ</p>
<h2 id="cpu-profiling">CPU Profiling</h2>
<p>perf ÊòØ‰∫ã‰ª∂È©±Âä®ÁöÑÊñπÂºèÂ∑•‰ΩúÔºåÈÄöËøá <strong>-e</strong> ÂèÇÊï∞ÊåáÂÆöÊÉ≥Ë¶ÅÊî∂ÈõÜÁöÑÁâπÂÆö‰∫ã‰ª∂Ôºå‰æãÂ¶ÇÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo perf stat -e LLC-loads,LLC-load-misses,LLC-stores,LLC-prefetches ls
</span></span></code></pre></td></tr></table>
</div>
</div><p>Êàë‰ª¨Âú®ÂØπÊï¥‰∏™Á≥ªÁªüÁöÑ CPU ËøõË°å30 ÁßíÁöÑÈááÊ†∑Êó∂Ôºå‰ΩøÁî®ÁöÑÂëΩ‰ª§Â¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo perf record -F <span class="m">99</span> -a -g -- sleep <span class="m">30</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÈáåÂπ∂Êú™ÊòéÁ°ÆÊåáÂÆö‰∫ã‰ª∂ÔºàÊ≤°Êúâ -e ÂèÇÊï∞ÔºâÔºåperf Â∞ÜÈªòËÆ§‰ΩøÁî®‰ª•‰∏ãÈ¢ÑÂÆö‰πâ‰∫ã‰ª∂‰∏≠Á¨¨‰∏Ä‰∏™ÂèØÁî®ÁöÑÔºö</p>
<ol>
<li>cycles:ppp</li>
<li>cycles:pp</li>
<li>cycles:p</li>
<li>cycles</li>
<li>cpu-clock</li>
</ol>
<p>ÂâçÂõõ‰∏™‰∫ã‰ª∂ÈÉΩÊòØ PMC Êèê‰æõÁöÑ CPU <strong>cycles</strong> ‰∫ã‰ª∂ÔºåÂå∫Âà´Âú®‰∫éÁ≤æÁ°ÆÂ∫¶‰∏çÂêåÔºå‰ªéÊúÄÁ≤æÁ°ÆÔºà<code>ppp</code>ÔºâÂà∞Êó†Á≤æÁ°ÆËÆæÁΩÆÔºàÊ≤°Êúâ <code>p</code>ÔºâÔºåÊúÄÁ≤æÁ°ÆÁöÑ‰∫ã‰ª∂‰ºòÂÖàË¢´ÈÄâÊã©„ÄÇ<strong>cpu-clock</strong> ÊòØÂü∫‰∫éËΩØ‰ª∂ÁöÑ CPU È¢ëÁéáÈááÊ†∑ÔºåÂú®Ê≤°ÊúâÁ°¨‰ª∂ <strong>cycles</strong> ‰∫ã‰ª∂ÂèØÁî®Êó∂Ôºå‰ºöÈÄâÊã©‰ΩøÁî® <strong>cpu-clock</strong> ËΩØ‰ª∂‰∫ã‰ª∂„ÄÇ</p>
<p>ÈÇ£‰πà‰ªÄ‰πàÊòØCPU <strong>cycles</strong> ‰∫ã‰ª∂Ôºå‰∏∫‰ªÄ‰πàÂØπ <strong>cycles</strong> ‰∫ã‰ª∂ËøõË°åÈááÊ†∑ÂèØ‰ª•ÂàÜÊûê CPU ÁöÑÊÄßËÉΩÔºü</p>
<h3 id="cycles-‰∫ã‰ª∂">cycles ‰∫ã‰ª∂</h3>
<p>È¶ñÂÖà‰ªãÁªç‰∏Ä‰∏™ÂÖ≥‰∫é CPU ÊÄßËÉΩÁöÑÈáçË¶ÅÊ¶ÇÂøµÔºå<strong>Clock Rate</strong>ÔºàÊó∂ÈíüÈ¢ëÁéáÔºâ„ÄÇClockÔºàÊó∂ÈíüÔºâÊòØÈ©±Âä® CPU ÁöÑÊï∞Â≠ó‰ø°Âè∑ÔºåCPU ‰ª•ÁâπÂÆöÁöÑÊó∂ÈíüÈ¢ëÁéáÊâßË°åÔºå‰æãÂ¶Ç 4 GHzÁöÑ CPU ÊØèÁßíÂèØÊâßË°å40‰∫ø‰∏™ cyclesÔºàÂë®ÊúüÔºâ„ÄÇ</p>
<p>CPU <strong>cycles ÔºàÂë®ÊúüÔºâ<strong>ÊòØ CPU ÊâßË°åÊåá‰ª§ÁöÑÊó∂Èó¥Âçï‰ΩçÔºåËÄå</strong>Êó∂ÈíüÈ¢ëÁéá</strong>Ë°®Á§∫ CPU ÊØèÁßíÊâßË°åÁöÑ CPU Âë®ÊúüÊï∞„ÄÇÊØè‰∏™ CPU Êåá‰ª§ÊâßË°åÂèØËÉΩÈúÄË¶Å‰∏Ä‰∏™ÊàñÂ§ö‰∏™ CPU Âë®Êúü„ÄÇ ÈÄöÂ∏∏ÊÉÖÂÜµ‰∏ãÔºåÊõ¥È´òÁöÑÊó∂ÈíüÈ¢ëÁéáÊÑèÂë≥ÁùÄÊõ¥Âø´ÁöÑCPUÔºåÂõ†‰∏∫ÂÆÉÂÖÅËÆ∏ CPU Âú®Âçï‰ΩçÊó∂Èó¥ÂÜÖÊâßË°åÊõ¥Â§öÁöÑÊåá‰ª§„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202311091031747.jpg"
	
	
	
	loading="lazy"
	
		alt="CPU cycles"
	
	
></p>
<p>ÊØèÁªèËøá‰∏Ä‰∏™ CPU Âë®ÊúüÈÉΩ‰ºöËß¶Âèë‰∏Ä‰∏™ <strong>cycles</strong> ‰∫ã‰ª∂„ÄÇÂèØ‰ª•ËÆ§‰∏∫Ôºå<strong>cycles</strong> ‰∫ã‰ª∂ÊòØÂùáÂåÄÁöÑÂàÜÂ∏ÉÂú®Á®ãÂ∫èÁöÑÊâßË°åÊúüÈó¥„ÄÇËøôÊ†∑Ôºå‰ª•Âõ∫ÂÆöÈ¢ëÁéáÂéªÈááÊ†∑ÁöÑ <strong>cycles</strong> ‰∫ã‰ª∂Ôºå‰πüÊòØÂùáÂåÄÁöÑÂàÜÂ∏ÉÂú®Á®ãÂ∫èÁöÑÊâßË°åÊúüÈó¥„ÄÇÊàë‰ª¨Âú®ÈááÊ†∑ <strong>cycles</strong> ‰∫ã‰ª∂Êó∂ÔºåËÆ∞ÂΩï CPU Ê≠£Âú®Âπ≤‰ªÄ‰πàÔºåÊåÅÁª≠‰∏ÄÊÆµÊó∂Èó¥Êî∂ÈõÜÂà∞Â§ö‰∏™ÈááÊ†∑ÂêéÔºåÊàë‰ª¨Â∞±ËÉΩÂü∫‰∫éËøô‰∫õ‰ø°ÊÅØÂàÜÊûêÁ®ãÂ∫èÁöÑË°å‰∏∫ÔºåÂ§öÊ¨°Âá∫Áé∞ÁöÑÂêåÊ†∑Âä®‰ΩúÔºåÂèØ‰ª•ËÆ§‰∏∫ÊòØÁ®ãÂ∫èÁöÑÁÉ≠ÁÇπÔºåÊàê‰∏∫‰∏ã‰∏ÄÊ≠•ÂàÜÊûêÈáçÁÇπÂÖ≥Ê≥®ÁöÑÊñπÈù¢„ÄÇ</p>
<p>Âõ†‰∏∫ <strong>cycles</strong> ‰∫ã‰ª∂ÁöÑÂùáÂåÄÂàÜÂ∏ÉÔºåÈÄöËøá‰ª•Âõ∫ÂÆöÈ¢ëÁéáÈááÊ†∑ <strong>cycles</strong> ‰∫ã‰ª∂Ëé∑ÂæóÁöÑ‰ø°ÊÅØÔºåÊàë‰ª¨Â∞±ËÉΩËøõË°å CPU ÊÄßËÉΩÂàÜÊûê„ÄÇÈÇ£‰πàÂ¶Ç‰ΩïÊåáÂÆöÈááÊ†∑È¢ëÁéáÂë¢Ôºü</p>
<h3 id="ËÆæÁΩÆÈááÊ†∑È¢ëÁéá">ËÆæÁΩÆÈááÊ†∑È¢ëÁéá</h3>
<p>Âú®‰ΩøÁî® perf record ËÆ∞ÂΩï PMC ‰∫ã‰ª∂Êó∂Ôºå‰ºö‰ΩøÁî®‰∏Ä‰∏™ÈªòËÆ§ÁöÑÈááÊ†∑È¢ëÁéáÔºå‰∏çÊòØÊØè‰∏™‰∫ã‰ª∂ÈÉΩ‰ºöË¢´ËÆ∞ÂΩï„ÄÇ‰æãÂ¶ÇËÆ∞ÂΩï cycles ‰∫ã‰ª∂Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ perf record -vve cycles -a sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">Using CPUID GenuineIntel-6-45-1
</span></span><span class="line"><span class="cl"><span class="nv">DEBUGINFOD_URLS</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">nr_cblocks: <span class="m">0</span>
</span></span><span class="line"><span class="cl">affinity: SYS
</span></span><span class="line"><span class="cl">mmap flush: <span class="m">1</span>
</span></span><span class="line"><span class="cl">comp level: <span class="m">0</span>
</span></span><span class="line"><span class="cl">------------------------------------------------------------
</span></span><span class="line"><span class="cl">perf_event_attr:
</span></span><span class="line"><span class="cl">  size                             <span class="m">128</span>
</span></span><span class="line"><span class="cl">  <span class="o">{</span> sample_period, sample_freq <span class="o">}</span>   <span class="m">4000</span>
</span></span><span class="line"><span class="cl">  sample_type                      IP<span class="p">|</span>TID<span class="p">|</span>TIME<span class="p">|</span>ID<span class="p">|</span>CPU<span class="p">|</span>PERIOD
</span></span><span class="line"><span class="cl">  read_format                      ID<span class="p">|</span>LOST
</span></span><span class="line"><span class="cl">  disabled                         <span class="m">1</span>
</span></span><span class="line"><span class="cl">  inherit                          <span class="m">1</span>
</span></span><span class="line"><span class="cl">  freq                             <span class="m">1</span>
</span></span><span class="line"><span class="cl">  sample_id_all                    <span class="m">1</span>
</span></span><span class="line"><span class="cl">  exclude_guest                    <span class="m">1</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="o">[</span> perf record: Captured and wrote 0.422 MB perf.data <span class="o">(</span><span class="m">297</span> samples<span class="o">)</span> <span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âä†‰∫Ü <strong>-vv</strong> ÈÄâÈ°πÂèØ‰ª•ËæìÂá∫Êõ¥ËØ¶ÁªÜÁöÑ‰ø°ÊÅØ„ÄÇ‰ªéËæìÂá∫‰∏≠ÂèØ‰ª•ÁúãÂá∫ÔºåÂç≥‰ΩøÊàë‰ª¨Ê≤°ÊúâÊòéÁ°ÆËÆæÁΩÆÈááÊ†∑È¢ëÁéáÔºåÈááÊ†∑È¢ëÁéáÂ∑≤ÁªèÂêØÁî®Ôºà<code>freq 1</code>ÔºâÔºåÂπ∂‰∏îÈááÊ†∑È¢ëÁéá‰∏∫ 4000 Ôºà<code>{ sample_period, sample_freq }   4000</code>ÔºâÔºåÂç≥ÊØè CPU ÊØèÁßíÈááÈõÜÁ∫¶ 4000‰∏™‰∫ã‰ª∂„ÄÇcycles ‰∫ã‰ª∂ÊØèÁßí‰∏≠ÊúâÂá†ÂçÅ‰∫øÊ¨°ÔºåÈªòËÆ§ÈááÊ†∑È¢ëÁéáÁöÑËÆæÁΩÆÂæàÂêàÁêÜÔºåÂê¶ÂàôËÆ∞ÂΩï‰∫ã‰ª∂ÁöÑÂºÄÈîÄËøáÈ´ò„ÄÇ</p>
<p>ÂèØ‰ª•‰ΩøÁî® <strong>-F</strong> ÈÄâÈ°πÊòéÁ°ÆËÆæÁΩÆ‰∫ã‰ª∂ÈááÊ†∑È¢ëÁéáÔºå‰æãÂ¶ÇÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">perf record -F <span class="m">99</span> -e cycles -a sleep <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>-F 99</strong> ËÆæÁΩÆÈááÊ†∑È¢ëÁéá‰∏∫ 99 HertzÔºåÂç≥ÊØèÁßíËøõË°å 99 Ê¨°ÈááÊ†∑„ÄÇ<a class="link" href="https://www.brendangregg.com/index.html"  target="_blank" rel="noopener"
    >Brendan Gregg</a> Âú®Â§ßÈáèÁöÑ‰æãÂ≠ê‰∏≠ÈÉΩ‰ΩøÁî®‰∫Ü 99 Hertz Ëøô‰∏™ÈááÊ†∑È¢ëÁéáÔºåËá≥‰∫é‰∏∫‰ªÄ‰πàËøôÊ†∑ËÆæÁΩÆÔºå‰ªñÂú®ÊñáÁ´† <a class="link" href="https://www.brendangregg.com/perf.html"  target="_blank" rel="noopener"
    >perf Examples</a> ‰∏≠ÁªôÂá∫‰∫ÜËß£ÈáäÔºåÂ§ßÊÑèÊòØÔºöÈÄâÊã© 99 Hertz ËÄå‰∏çÊòØ100 HertzÔºåÊòØ‰∏∫‰∫ÜÈÅøÂÖçÊÑèÂ§ñÂú∞‰∏é‰∏Ä‰∫õÂë®ÊúüÊÄßÊ¥ªÂä®ÂêåÊ≠•ÔºåËøô‰ºö‰∫ßÁîüÂÅèÂ∑ÆÁöÑÁªìÊûú„ÄÇ‰πüÂ∞±ÊòØËØ¥ÔºåÂ¶ÇÊûúÁ®ãÂ∫è‰∏≠ÊúâÂë®ÊúüÊÄßÁöÑÂÆöÊó∂‰ªªÂä°Ôºå‰æãÂ¶ÇÊØèÁßíÈíüÊâßË°åÁöÑ‰ªªÂä°Ôºå‰ª• 100 Hertz È¢ëÁéáËøõË°åÈááÊ†∑ÔºåÈÇ£‰πàÊØèÊ¨°Âë®ÊúüÊÄß‰ªªÂä°ËøêË°åÊó∂ÈÉΩ‰ºöË¢´ÈááÊ†∑ÔºåËøôÊ†∑‰∫ßÁîüÁöÑÁªìÊûú‚ÄúÊîæÂ§ß‚Äù‰∫ÜÂë®ÊúüÊÄß‰ªªÂä°ÁöÑÂΩ±ÂìçÔºåÂÅèÁ¶ª‰∫ÜÁ®ãÂ∫èÊ≠£Â∏∏ÁöÑË°å‰∏∫Ê®°Âºè„ÄÇ</p>
<p><code>perf record</code> ÂëΩ‰ª§ËøòÂèØ‰ª•‰ΩøÁî® <strong>-c</strong> ÈÄâÈ°πÊù•ËÆæÁΩÆÈááÊ†∑‰∫ã‰ª∂ÁöÑÂë®ÊúüÔºåËøô‰∏™Âë®Êúü‰ª£Ë°®‰∫ÜÈááÊ†∑‰∫ã‰ª∂‰πãÈó¥ÁöÑÈó¥Èöî„ÄÇ‰æãÂ¶ÇÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo perf record -c <span class="m">1000</span> -e cycles -a sleep <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âú®Ëøô‰∏™Á§∫‰æã‰∏≠Ôºå<strong>-c</strong> ÈÄâÈ°πËÆæÁΩÆÈááÊ†∑Âë®Êúü‰∏∫ 1000ÔºåÂç≥ÊØèÈöî 1000 Ê¨°‰∫ã‰ª∂ËøõË°å‰∏ÄÊ¨°ÈááÊ†∑„ÄÇ</p>
<p>Áé∞Âú®Êàë‰ª¨Áü•ÈÅì‰∫ÜÂ¶Ç‰Ωï‰ª•Âõ∫ÂÆöÁöÑÈ¢ëÁéáÂØπ cycles ‰∫ã‰ª∂ËøõË°åÈááÊ†∑ÔºåÈÇ£‰πàÂ¶Ç‰ΩïËé∑Áü•Âú®ÈááÊ†∑Êó∂ÔºåCPU Ê≠£Âú®Âπ≤‰ªÄ‰πàÂë¢Ôºü</p>
<h2 id="ËÉåÊôØÁü•ËØÜ">ËÉåÊôØÁü•ËØÜ</h2>
<p>Ë¶ÅÁü•ÈÅì  cycles ‰∫ã‰ª∂ÂèëÁîüÊó∂ CPU Ê≠£Âú®Âπ≤‰ªÄ‰πàÔºåÊàë‰ª¨ÈúÄË¶Å‰∫ÜËß£‰∏Ä‰∫õÁ°¨‰ª∂Áü•ËØÜÔºå‰ª•ÂèäÂÜÖÊ†∏‰∏éÁ°¨‰ª∂ÊòØÂ¶Ç‰ΩïÈÖçÂêàÂ∑•‰ΩúÁöÑ„ÄÇÂÖàÁúãÁúã CPU ÊòØÂ¶Ç‰ΩïÊâßË°åÊåá‰ª§ÁöÑ„ÄÇ</p>
<h3 id="cpu-ÊâßË°åÊåá‰ª§">CPU ÊâßË°åÊåá‰ª§</h3>
<p>CPU ÂÜÖÈÉ®ÊúâÂ§öÁßç‰∏çÂêåÂäüËÉΩÁöÑÂØÑÂ≠òÂô®ÔºåÊ∂âÂèäÂà∞Êåá‰ª§ÊâßË°åÁöÑÔºåÊúâ‰∏â‰∏™ÈáçË¶ÅÁöÑÂØÑÂ≠òÂô®Ôºö</p>
<ul>
<li>PC ÂØÑÂ≠òÂô®Ôºà<strong>PC</strong>ÔºåProgram CounterÔºâÔºåÂ≠òÊîæ‰∏ã‰∏ÄÊù°Êåá‰ª§ÁöÑÂÜÖÂ≠òÂú∞ÂùÄ</li>
<li>Êåá‰ª§ÂØÑÂ≠òÂô®Ôºà<strong>IR</strong>ÔºåInstruction RegisterÔºâÔºåÂ≠òÊîæÂΩìÂâçÊ≠£Âú®ÊâßË°åÁöÑÊåá‰ª§</li>
<li>Áä∂ÊÄÅÂØÑÂ≠òÂô®Ôºà<strong>SR</strong>ÔºåStatus RegisterÔºâÔºåÁî®‰∫éÂ≠òÂÇ® CPU ÂΩìÂâçÁöÑÁä∂ÊÄÅÔºåÂ¶ÇÊù°‰ª∂Ê†áÂøó‰Ωç„ÄÅ‰∏≠Êñ≠Á¶ÅÊ≠¢‰Ωç„ÄÅÂ§ÑÁêÜÂô®Ê®°ÂºèÊ†áÂøóÁ≠â</li>
</ul>
<p>CPU ËøòÊúâÂÖ∂‰ªñÁî®‰∫éÂ≠òÂÇ®Êï∞ÊçÆÂíåÂÜÖÂ≠òÂú∞ÂùÄÁöÑÂØÑÂ≠òÂô®ÔºåÊ†πÊçÆÂ≠òÊîæÂÜÖÂÆπÂëΩÂêçÔºåÂ¶ÇÊï¥Êï∞ÂØÑÂ≠òÂô®„ÄÅÊµÆÁÇπÊï∞ÂØÑÂ≠òÂô®„ÄÅÂêëÈáèÂØÑÂ≠òÂô®ÂíåÂú∞ÂùÄÂØÑÂ≠òÂô®Á≠â„ÄÇÊúâ‰∫õÂØÑÂ≠òÂô®Êó¢ÂèØ‰ª•Â≠òÊîæÊï∞ÊçÆÔºåÂèàÂèØ‰ª•Â≠òÊîæÂú∞ÂùÄÔºåË¢´Áß∞‰∏∫ÈÄöÁî®ÂØÑÂ≠òÂô®Ôºà<strong>GR</strong>ÔºåGeneral registerÔºâ„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202311091736945.png"
	
	
	
	loading="lazy"
	
		alt="cpu registers"
	
	
></p>
<p>Á®ãÂ∫èÊâßË°åÊó∂ÔºåCPU Ê†πÊçÆ <strong>PC</strong> ÂØÑÂ≠òÂô®‰∏≠ÁöÑÂú∞ÂùÄ‰ªéÂÜÖÂ≠ò‰∏≠ËØªÂèñÊåá‰ª§Âà∞ <strong>IR</strong> ÂØÑÂ≠òÂô®‰∏≠ÊâßË°åÔºåÂπ∂Ê†πÊçÆÊåá‰ª§ÈïøÂ∫¶Ëá™Â¢ûÔºåÂä†ËΩΩ‰∏ã‰∏ÄÊù°Êåá‰ª§„ÄÇ</p>
<p>Âè™Ë¶ÅÊàë‰ª¨Âú®ÈááÊ†∑Êó∂Ëé∑ÂèñCPU ÁöÑ <strong>PC</strong> ÂØÑÂ≠òÂô®Âíå <strong>IR</strong> ÂØÑÂ≠òÂô®ÁöÑÂÜÖÂÆπÔºåÂ∞±ËÉΩÊé®Êñ≠Âá∫ CPU ÂΩìÊó∂Ê≠£Âú®Âπ≤‰ªÄ‰πà„ÄÇ</p>
<p>Âú® x86-64 Êû∂ÊûÑ‰∏≠ÔºåProgram Counter ÁöÑÂäüËÉΩÊòØÁî±  <strong>RIP (Instruction Pointer Register)</strong> ÂØÑÂ≠òÂô®ÂÆûÁé∞ÁöÑ„ÄÇ</p>
<p>Âú®ÁºñËØëÁ®ãÂ∫èÊó∂ÔºåÂèØ‰ª•ËÆ©ÁºñËØëÂô®ÁîüÊàê‰∏Ä‰∏™Êò†Â∞ÑÔºåÂ∞ÜÊ∫ê‰ª£Á†ÅË°å‰∏éÁîüÊàêÁöÑÊú∫Âô®Êåá‰ª§ÂÖ≥ËÅîËµ∑Êù•ÔºåËøô‰∏™Êò†Â∞ÑÈÄöÂ∏∏Â≠òÂÇ®Âú® <a class="link" href="https://dwarfstd.org/"  target="_blank" rel="noopener"
    >DWARF Ê†ºÂºèÔºàDebugging With Attributed Record FormatsÔºâ</a>ÁöÑË∞ÉËØï‰ø°ÊÅØ‰∏≠„ÄÇÂêåÊó∂ÁºñËØëÊó∂‰ºöÁîüÊàê<strong>Á¨¶Âè∑Ë°®ÔºàSymbol TableÔºâ</strong>ÔºåÂÖ∂‰∏≠ÂåÖÂê´‰∫ÜÁ®ãÂ∫è‰∏≠ÂêÑÁßçÁ¨¶Âè∑ÔºàÂ¶ÇÂáΩÊï∞Âêç„ÄÅÂèòÈáèÂêçÔºâÂèäÂÖ∂Âú∞ÂùÄÁöÑÊò†Â∞Ñ„ÄÇperf ÂÄüÂä©Ë∞ÉËØï‰ø°ÊÅØÂíåÁ¨¶Âè∑Ë°®Ôºàsymbol tableÔºâÔºåÂèØ‰ª•Â∞ÜÈááÊ†∑Êó∂ÂØÑÂ≠òÂô®‰∏≠ÁöÑÊåá‰ª§Âú∞ÂùÄËΩ¨Êç¢‰∏∫ÂØπÂ∫îÁöÑÂáΩÊï∞Âêç„ÄÅÊ∫ê‰ª£Á†ÅË°åÂè∑Á≠â‰ø°ÊÅØ„ÄÇ</p>
<p>Áü•ÈÅì‰∫Ü CPU ÂΩìÊó∂ÁöÑ‚ÄúÂä®‰Ωú‚ÄùËøò‰∏çÂ§üÔºåÊàë‰ª¨ËøòÈúÄË¶ÅÁü•ÈÅì CPU ÊòØÊÄé‰πàÂÅöËøô‰∏™‚ÄúÂä®‰Ωú‚ÄùÁöÑÔºå‰πüÂ∞±ÊòØ‰ª£Á†ÅÁöÑÊâßË°åË∑ØÂæÑ„ÄÇ‰∏ãÈù¢‰ªãÁªçÂáΩÊï∞Ë∞ÉÁî®Ê†àÁöÑÁõ∏ÂÖ≥Ê¶ÇÂøµ„ÄÇ</p>
<h3 id="ËøòÂéüÂáΩÊï∞Ë∞ÉÁî®Ê†à">ËøòÂéüÂáΩÊï∞Ë∞ÉÁî®Ê†à</h3>
<p>ÂáΩÊï∞ÊòØËΩØ‰ª∂‰∏≠ÁöÑ‰∏Ä‰∏™ÂÖ≥ÈîÆÊäΩË±°Ê¶ÇÂøµÔºåÂÆÉËÆ©ÂºÄÂèëËÄÖÂ∞ÜÂÖ∑ÊúâÁâπÂÆöÂäüËÉΩÁöÑ‰ª£Á†ÅÊâìÂåÖÔºåÁÑ∂ÂêéËøô‰∏™ÂäüËÉΩÂèØ‰ª•Âú®Á®ãÂ∫èÁöÑÂ§ö‰∏™‰ΩçÁΩÆË¢´Ë∞ÉÁî®„ÄÇ</p>
<p>ÂÅáËÆæÂáΩÊï∞ P Ë∞ÉÁî®ÂáΩÊï∞ QÔºåÁÑ∂Âêé Q ÊâßË°åÂπ∂ËøîÂõûÁªìÊûúÁªô PÔºåËøô‰∏™ËøáÁ®ãÊ∂âÂèäÂà∞‰ª•‰∏ãÊú∫Âà∂Ôºö</p>
<ul>
<li><strong>‰º†ÈÄíÊéßÂà∂</strong>ÔºöÂú®ËøõÂÖ•ÂáΩÊï∞ Q Êó∂Ôºå<strong>PC</strong> ÂØÑÂ≠òÂô®ËÆæÁΩÆ‰∏∫ Q ÁöÑËµ∑ÂßãÂú∞ÂùÄÔºõÂú®‰ªé Q ËøîÂõûÊó∂Ôºå<strong>PC</strong> ÂØÑÂ≠òÂô®ËÆæÁΩÆ‰∏∫ P ‰∏≠Ë∞ÉÁî® Q ÂêéÁöÑ‰∏ã‰∏ÄÊù°Êåá‰ª§Â§Ñ„ÄÇ</li>
<li><strong>‰º†ÈÄíÊï∞ÊçÆ</strong>ÔºöP ËÉΩÂ§üÂêë Q Êèê‰æõ‰∏Ä‰∏™ÊàñÂ§ö‰∏™ÂèÇÊï∞ÔºåQ ‰πüËÉΩÂ§üÂ∞Ü‰∏Ä‰∏™ÂÄºËøîÂõûÁªô P„ÄÇ</li>
<li><strong>ÂàÜÈÖçÂíåÈáäÊîæÂÜÖÂ≠ò</strong>ÔºöQ ÈúÄË¶ÅÂú®ÂºÄÂßãÊó∂‰∏∫Â±ÄÈÉ®ÂèòÈáèÂàÜÈÖçÁ©∫Èó¥ÔºåÁÑ∂ÂêéÂú®ËøîÂõûÂâçÈáäÊîæËØ•Â≠òÂÇ®Á©∫Èó¥„ÄÇ</li>
</ul>
<p><img src="https://cdn.mazhen.tech/images/202311141521021.png"
	
	
	
	loading="lazy"
	
		alt="stack & code"
	
	
></p>
<p>x86-64 Âπ≥Âè∞‰∏äÁöÑÁ®ãÂ∫è‰ΩøÁî®<strong>Â†ÜÊ†àÔºàStackÔºâ<strong>Êù•ÂÆûÁé∞ÂáΩÊï∞Ë∞ÉÁî®„ÄÇ<strong>Â†ÜÊ†àÔºàStackÔºâ<strong>ÁöÑÁâπÊÄßÊòØ</strong>ÂêéËøõÂÖàÂá∫ÔºàLIFOÔºâ</strong>ÔºåÂáΩÊï∞Ë∞ÉÁî®Ê≠£ÊòØÂà©Áî®‰∫ÜËøô‰∏ÄÁâπÊÄß„ÄÇË∞ÉÁî®Êüê‰∏™ÂáΩÊï∞Â∞±ÊòØÂú®Â†ÜÊ†à‰∏ä‰∏∫Ëøô‰∏™ÂáΩÊï∞ÂàÜÈÖçÊâÄÈúÄÁöÑÂÜÖÂ≠òÁ©∫Èó¥ÔºåËøôÈÉ®ÂàÜÁ©∫Èó¥Ë¢´Áß∞‰∏∫</strong>Ê†àÂ∏ßÔºàstack frameÔºâ</strong>Ôºå‰ªéÂáΩÊï∞ËøîÂõûÔºåÂ∞±ÊòØÂ∞ÜËøô‰∏™ÂáΩÊï∞ÁöÑ**Ê†àÂ∏ßÔºàstack frameÔºâ<strong>‰ªéÂ†ÜÊ†à‰∏≠ÂºπÂá∫ÔºåÈáäÊîæÁ©∫Èó¥„ÄÇÂ§ö‰∏™</strong>Ê†àÂ∏ßÔºàstack frameÔºâ**ÁªÑÊàê <a class="link" href="https://en.wikipedia.org/wiki/Call_stack"  target="_blank" rel="noopener"
    >Call stack</a>Ôºå‰ΩìÁé∞Âá∫‰∫ÜÂáΩÊï∞ÁöÑË∞ÉÁî®ÂÖ≥Á≥ª„ÄÇ</p>
<p>Ê≥®ÊÑèÔºöÁºñËØëÂêéÁöÑÁ®ãÂ∫èÂ≠òÂÇ®Âú®<strong>‰ª£Á†ÅÊÆµ</strong>ÔºåÊòØÈùôÊÄÅÁöÑÔºõËÄå <a class="link" href="https://en.wikipedia.org/wiki/Call_stack"  target="_blank" rel="noopener"
    >Call stack</a> ÊòØÂä®ÊÄÅÁöÑÔºåÂèçÂ∫î‰∫ÜÁ®ãÂ∫èËøêË°åÊó∂ÁöÑÁä∂ÊÄÅ„ÄÇ</p>
<p>‰∏ãÈù¢‰ª•Á§∫‰æãÁ®ãÂ∫è‰∏∫‰æãÔºåx86-64 Âπ≥Âè∞‰∏äÂ¶Ç‰ΩïÂà©Áî®**Â†ÜÊ†àÔºàStackÔºâ**ÂÆûÁé∞ÂáΩÊï∞Ë∞ÉÁî®ÁöÑ„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202311141524326.png"
	
	
	
	loading="lazy"
	
		alt="stack"
	
	
></p>
<p><code>main</code>ÂáΩÊï∞Êúâ‰∏â‰∏™Â±ÄÈÉ®ÂèòÈáè<code>a</code>„ÄÅ<code>b</code>Âíå <code>res</code> Â≠òÂÇ®Âú®Ëá™Â∑±ÁöÑ <strong>stack frame</strong> ‰∏≠„ÄÇÂΩì <code>main</code> Ë∞ÉÁî® <code>Calc</code> ÂáΩÊï∞Êó∂Ôºå‰ºöÂÖàÂ∞ÜÂèÇÊï∞ <code>i</code>Âíå<code>j</code> ÂéãÂÖ• StackÔºåÁÑ∂ÂêéÂ∞Ü <strong>PC</strong> ÂØÑÂ≠òÂô®‰∏≠ÁöÑÂÄº‰πüÂéãÂÖ• Stack„ÄÇÊàë‰ª¨Áü•ÈÅìÔºå<strong>PC</strong> ÂØÑÂ≠òÂô®Â≠òÊîæÁöÑÊòØ‰∏ã‰∏ÄÊù°Êåá‰ª§ÁöÑÂú∞ÂùÄÔºåËøôÊó∂ <strong>PC</strong> ÂØÑÂ≠òÂô®‰∏≠ÁöÑÂÄºÊòØÂáΩÊï∞Ë∞ÉÁî®Êåá‰ª§ÔºàcallÔºâÂêéÁ¥ßË∑üÁùÄÁöÑÈÇ£Êù°Êåá‰ª§ÁöÑÂú∞ÂùÄ„ÄÇÊää <strong>PC</strong> ÂØÑÂ≠òÂô®ÂéãÂÖ• StackÔºåÁõ∏ÂΩì‰∫é‰øùÁïô‰∫ÜÂáΩÊï∞Ë∞ÉÁî®ÁªìÊùüÂêéË¶ÅÊâßË°åÁöÑÊåá‰ª§Âú∞ÂùÄÔºåËøôÊ†∑<code>Calc</code>ÂÆåÊàêÂêéÁ®ãÂ∫èÁü•ÈÅì‰ªéÂì™ÈáåÁªßÁª≠ÊâßË°å„ÄÇ</p>
<p><strong>rbp</strong> ÊòØÊ†àÂü∫ÂùÄÂØÑÂ≠òÂô®Ôºàregister base pointer ÔºâÔºåÂèàÂè´Ê†àÂ∏ßÊåáÈíàÔºà<strong>Frame Pointer</strong>ÔºâÔºåÂ≠òÊîæ‰∫ÜÂΩìÂâç <strong>stack frame</strong> ÁöÑËµ∑ÂßãÂú∞ÂùÄ„ÄÇ<strong>rsp</strong> ÊòØÊ†àÈ°∂ÂØÑÂ≠òÂô®Ôºàregister stack pointerÔºâÔºåÁß∞‰∏∫Ê†àÊåáÈíàÔºà<strong>Stack Pointer</strong>ÔºâÔºåÈöèÁùÄÂÖ•Ê†àÂá∫Ê†àÂä®‰ΩúËÄåÁßªÂä®ÔºåÂßãÁªàÊåáÂêëÊ†àÈ°∂ÂÖÉÁ¥†„ÄÇ<strong>x86-64</strong> ÁöÑÂ†ÜÊ†àÊòØ<strong>‰ªéÈ´òÂú∞ÂùÄÂêë‰ΩéÂú∞ÂùÄ</strong>Â¢ûÈïøÁöÑ„ÄÇ</p>
<p>Âú®‰∏∫ <code>calc</code>  Êñ∞Âª∫ <strong>stack frame</strong> Êó∂Ôºå‰ºöÂÖàÂ∞Ü <strong>rbp</strong> ÂØÑÂ≠òÂô®ÂéãÂÖ• Stack„ÄÇÂΩìÂâç <strong>rbp</strong> ÂØÑÂ≠òÂô®‰∏≠Â≠òÊîæÁöÑÊòØ <code>main</code>  <strong>stack frame</strong> ÁöÑËµ∑ÂßãÂú∞ÂùÄÔºåÂ∞Ü  <strong>rbp</strong> ÂØÑÂ≠òÂô®ÂéãÂÖ• StackÔºå‰πüÂ∞±ÊòØÂ∞Ü <code>main</code>  <strong>stack frame</strong> ÁöÑËµ∑ÂßãÂú∞ÂùÄÂéãÂÖ•‰∫Ü Stack„ÄÇ</p>
<p>ÈöèÂêéÊää <strong>rsp</strong> ÁöÑÂÄºÂ§çÂà∂Âà∞ <strong>rbp</strong>ÔºåÂõ†‰∏∫ <strong>rsp</strong> ÂßãÁªà‰ºöÊåáÂêëÊ†àÈ°∂ÔºåÊää <strong>rsp</strong> ÁöÑÂÄºÂ§çÂà∂Âà∞ <strong>rbp</strong> Â∞±ÊòØËÆ©  <strong>rbp</strong> ÂØÑÂ≠òÂô®ÊåáÂêëÂΩìÂâç‰ΩçÁΩÆÔºåÂç≥ <code>calc</code> <strong>stack frame</strong> ÁöÑËµ∑Âßã‰ΩçÁΩÆ„ÄÇ</p>
<p>Ê≥®ÊÑè <code>Calc</code> ÁöÑÂèÇÊï∞ÂíåËøîÂõûÂú∞ÂùÄÂåÖÂê´Âú® <code>main</code> ÁöÑ <strong>stack frame</strong> ‰∏≠ÔºåÂõ†‰∏∫ÂÆÉ‰ª¨‰øùÂ≠ò‰∫Ü‰∏é <code>main</code> Áõ∏ÂÖ≥ÁöÑÁä∂ÊÄÅ„ÄÇ<code>Calc</code> ÂáΩÊï∞Â±ÄÈÉ®ÂèòÈáè<code>sum</code>Âíå<code>result</code> Ë¢´ÂàÜÈÖçÂú®Ëá™Â∑±ÁöÑ <strong>stack frame</strong> ‰∏ä„ÄÇ</p>
<p>Âú® <code>Calc</code> Ë∞ÉÁî® <code>Sum</code> Êó∂ÔºåÈáçÂ§ç‰∏äÈù¢ÁöÑÂä®‰ΩúÔºöÂèÇÊï∞ÂíåËøîÂõûÂú∞ÂùÄÂÖ•Ê†àÔºå‰øùÂ≠òÂπ∂Êõ¥Êñ∞ <strong>rbp</strong> ÂØÑÂ≠òÂô®Ôºå‰∏∫ <code>Sum</code> ÁöÑÂ±ÄÈÉ®ÂèòÈáèÂàÜÈÖçÂú∞ÂùÄ„ÄÇ</p>
<p>Âú®ÂáΩÊï∞ <code>Sum</code> ÊâßË°åÂÆåÊàê‰πãÂêéÔºå‰ºöÂ∞Ü‰πãÂâç‰øùÂ≠òÁöÑ  <strong>rbp</strong> Âá∫Ê†àÔºåÊÅ¢Â§çÂà∞ <strong>rbp</strong> ‰∏≠Ôºå‰πüÂ∞±ÊòØËÆ© <strong>rbp</strong> ÊåáÂêë <code>Calc</code>  <strong>stack frame</strong> ÁöÑËµ∑ÂßãÂú∞ÂùÄÔºåÂ∞Ü <code>Sum</code>ÁöÑ  <strong>stack frame</strong> ÂºπÂá∫‰∫Ü StackÔºåÈáäÊîæ‰∫Ü <code>Sum</code> Âç†Áî®ÁöÑÁ©∫Èó¥„ÄÇÁÑ∂ÂêéÂ∞ÜËøîÂõûÂú∞ÂùÄÂá∫Ê†àÔºåÊõ¥Êñ∞Âà∞ <strong>PC</strong> ÂØÑÂ≠òÂô®‰∏≠„ÄÇËøîÂõûÂú∞ÂùÄÊòØÂáΩÊï∞Ë∞ÉÁî®Êåá‰ª§ÔºàcallÔºâÂêéÁöÑ‰∏ã‰∏ÄÊù°Êåá‰ª§ÔºåÂç≥ <code>Calc</code> Ë∞ÉÁî®ÂÆå <code>Sum</code> ÂêéÁ¥ßË∑üÁùÄÁöÑ‰∏ã‰∏ÄÊù°Êåá‰ª§ÔºåÊääËøô‰∏™Êåá‰ª§ÁöÑÂú∞ÂùÄÊÅ¢Â§çÂà∞ <strong>PC</strong> ÂØÑÂ≠òÂô®‰∏≠ÔºåÂÆûÈôÖ‰∏äÊòØÂ∞ÜÊéßÂà∂ÊùÉËøîÂõûÁªô‰∫Ü <code>Calc</code> ÔºåËÆ© <code>Calc</code> Ââ©‰ΩôÈÉ®ÂàÜÊé•ÁùÄÊâßË°å„ÄÇ</p>
<p><code>Calc</code> ÊâßË°åÂÆå‰πü‰ºöÂÅöÂêåÊ†∑ÁöÑÂá∫Ê†àÂä®‰ΩúÔºåÈáäÊîæ <strong>stack frame</strong> ÔºåÂ∞ÜÊéßÂà∂ÊùÉËøîÂõûÁªô <code>main</code>„ÄÇ</p>
<p>ËøôÊ†∑ÔºåÂáΩÊï∞Ë∞ÉÁî®Âà©Áî®‰∫Ü**Â†ÜÊ†àÔºàStackÔºâ**‰º†ÈÄíÂèÇÊï∞ÔºåÂ≠òÂÇ®ËøîÂõû‰ø°ÊÅØÔºå‰øùÂ≠òÂØÑÂ≠òÂô®‰∏≠ÁöÑÂÄºÔºå‰ª•ÂèäÂ≠òÂÇ®ÂáΩÊï∞ÁöÑÂ±ÄÈÉ®ÂèòÈáèÔºåÊù•ÂÆûÁé∞ÂáΩÊï∞Ë∞ÉÁî®„ÄÇ</p>
<p>ÊØè‰∏™ÂáΩÊï∞ÁöÑÊ¥ªÂä®ËÆ∞ÂΩïÂØπÂ∫î‰∏Ä‰∏™<strong>Ê†àÂ∏ßÔºàstack frameÔºâ</strong>ÔºåÂ§ö‰∏™<strong>Ê†àÂ∏ßÔºàstack frameÔºâ<strong>Âè†Âä†Âú®‰∏ÄËµ∑ÊûÑÊàê</strong>Ë∞ÉÁî®Ê†à</strong>Ôºà <a class="link" href="https://en.wikipedia.org/wiki/Call_stack"  target="_blank" rel="noopener"
    >Call stack</a>Ôºâ„ÄÇ<strong>Frame Pointer</strong>ÔºàÈÄöÂ∏∏ÊòØ <strong>rbp</strong> ÂØÑÂ≠òÂô®ÔºâÊåáÂêëÂΩìÂâçÊøÄÊ¥ªÁöÑÂáΩÊï∞ÁöÑ<strong>Ê†àÂ∏ßÔºàstack frameÔºâ<strong>ÁöÑËµ∑ÂßãÂ§ÑÔºåËøô‰∏™Ëµ∑ÂßãÂ§Ñ‰øùÂ≠ò‰∫ÜË∞ÉÁî®ÂÆÉÁöÑÂáΩÊï∞ÁöÑ</strong>Ê†àÂ∏ßÔºàstack frameÔºâ<strong>ÁöÑËµ∑ÂßãÂú∞ÂùÄ„ÄÇÈÄöËøáËøôÁßçÈìæÊé•ÔºåÊàë‰ª¨Â∞±ËÉΩ‰ª• <strong>Frame Pointer</strong> ‰∏∫Ëµ∑ÁÇπÔºåËøΩÊ∫ØÊï¥‰∏™Ë∞ÉÁî®ÈìæÔºåÂç≥‰ªéÂΩìÂâçÂáΩÊï∞ÂºÄÂßãÔºåÈÄêÁ∫ßËÆøÈóÆÂà∞ÊØè‰∏™Ë∞ÉÁî®ËÄÖÁöÑ</strong>Ê†àÂ∏ßÔºàstack frameÔºâ</strong>Ôºå‰ªéËÄåÈáçÊûÑÂá∫Á®ãÂ∫èÊâßË°åÁöÑË∑ØÂæÑ„ÄÇ</p>
<p>ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåÂá∫‰∫éÁ©∫Èó¥ÂíåÊó∂Èó¥ÊïàÁéáÁöÑËÄÉËôëÔºåÁ®ãÂ∫èÈÉΩ‰ºö‰ºòÂÖà‰ΩøÁî®ÈÄöÁî®ÂØÑÂ≠òÂô®Êù•‰º†ÈÄíÂèÇÊï∞ÔºåÂè™ÊúâÂú®ÂØÑÂ≠òÂô®‰∏çÂ§üÁî®ÁöÑÊó∂ÂÄôÊâç‰ºöÂ∞ÜÂ§öÂá∫ÁöÑÂèÇÊï∞ÂéãÂÖ•Ê†à‰∏≠„ÄÇ</p>
<p>perf Ê≠£ÊòØÂà©Áî® <strong>Frame Pointer</strong>ÔºåËøòÂéüÈááÊ†∑Êó∂ÁöÑ‰ª£Á†ÅÊâßË°åË∑ØÂæÑ„ÄÇ</p>
<p>Âú®ÂºÄÂêØÁºñËØëÂô®‰ºòÂåñÁöÑÊÉÖÂÜµ‰∏ãÔºåÁ®ãÂ∫è‰ºöÂ∞Ü <strong>rbp</strong> ÂØÑÂ≠òÂô®‰Ωú‰∏∫ÈÄöÁî®ÂØÑÂ≠òÂô®ÈáçÊñ∞‰ΩøÁî®ÔºåËøôÊó∂Â∞±‰∏çËÉΩÂÜç‰ΩøÁî® <strong>Frame Pointer</strong> ËøòÂéüÂáΩÊï∞Ë∞ÉÁî®Ê†à„ÄÇperf ËøòÂèØ‰ª•‰ΩøÁî®ÂÖ∂‰ªñÊñπÊ≥ïËøõË°å stack walkingÔºö</p>
<ul>
<li><strong>&ndash;call-graph dwarf</strong> Ôºö‰ΩøÁî®Ë∞ÉËØï‰ø°ÊÅØ</li>
<li><strong>&ndash;call-graph lbr</strong>Ôºö ‰ΩøÁî® Intel ÁöÑ last branch record (LBR)</li>
<li><strong>&ndash;call-graph fp</strong>Ôºö‰ΩøÁî® <strong>Frame Pointer</strong> ÔºåÁº∫ÁúÅÊñπÊ≥ï</li>
</ul>
<p>Êú¨ÊñáÂ∞±‰∏çËØ¶ÁªÜËÆ®ËÆ∫ÂÖ∂‰ªñ‰∏§ÁßçËøòÂéüË∞ÉÁî®Ê†àÁöÑÊñπÊ≥ïÔºåÊÑüÂÖ¥Ë∂£ÁöÑÂèØ‰ª•ÂèÇËÄÉ<a class="link" href="https://www.brendangregg.com/bpf-performance-tools-book.html"  target="_blank" rel="noopener"
    >„ÄäBPF Performance Tools„Äã</a>„ÄÇ</p>
<p>Âú® Linux ‰∏äÔºåËøõÁ®ãÁöÑÊâßË°åÂàÜ‰∏∫‰∫ÜÁî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅÔºåË¶ÅÁü•ÈÅìÂÆåÊï¥ÁöÑ‰ª£Á†ÅÊâßË°åË∑ØÂæÑÔºåÂ∞±ÈúÄË¶ÅÂàÜÂà´ËøòÂéüÁî®Êà∑Ê†àÂíåÂÜÖÊ†∏Ê†à„ÄÇ‰ªÄ‰πàÊòØÁî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅÂë¢Ôºü</p>
<h3 id="Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ">Áî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅ</h3>
<p>Êìç‰ΩúÁ≥ªÁªüÈúÄË¶ÅËÉΩÂ§üÈôêÂà∂ÂØπÂÖ≥ÈîÆÁ≥ªÁªüËµÑÊ∫êÁöÑËÆøÈóÆÔºåÊèê‰æõÂØπËµÑÊ∫ê‰∏çÂêåÁ∫ßÂà´ÁöÑËÆøÈóÆÊùÉÈôêÔºåËøôÊ†∑ÂèØ‰ª•‰øùÊä§Á≥ªÁªüÂÖçÂèóÈîôËØØÂíåÊÅ∂ÊÑèË°å‰∏∫ÁöÑ‰æµÂÆ≥„ÄÇËøôÁßçËÆøÈóÆÊùÉÈôêÁî± CPU Âú®Á°¨‰ª∂Á∫ßÂà´‰∏äÂÆûÁé∞Ôºå‰æãÂ¶Ç x86 Êû∂ÊûÑÂÆö‰πâ‰∫ÜÁâπÊùÉÁ∫ßÂà´Ôºå‰πüÁß∞‰∏∫‰øùÊä§ÁéØÔºà<strong>protection rings</strong>ÔºâÔºå‰ªé <strong>Ring 0</strong> Âà∞ <strong>Ring 3</strong> ÔºåÊØè‰∏™Á∫ßÂà´ÂÆö‰πâ‰∫ÜÂèØ‰ΩøÁî®ÁöÑÊåá‰ª§ÈõÜÂíåÂèØËÆøÈóÆÁöÑËµÑÊ∫êÔºå<strong>Ring 0</strong> ÂÖ∑ÊúâÊúÄÈ´òÁöÑÁâπÊùÉÁ∫ßÂà´„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202311151103732.png"
	
	
	
	loading="lazy"
	
		alt="protection rings"
	
	
></p>
<ul>
<li><strong>Ring 0</strong>: ÊúÄÈ´òÁâπÊùÉÁ∫ßÂà´ÔºåÁî®‰∫éÊìç‰ΩúÁ≥ªÁªüÁöÑÂÜÖÊ†∏ÔºåÂèØ‰ª•Áõ¥Êé•ËÆøÈóÆÊâÄÊúâÁöÑÁ°¨‰ª∂ÂíåÁ≥ªÁªüËµÑÊ∫ê„ÄÇ</li>
<li><strong>Ring 1 Âíå Ring 2</strong>: Ëøô‰∫õ‰∏≠Èó¥Â±ÇÊ¨°ÁöÑÁéØÈÄöÂ∏∏Áî®‰∫éÁâπÂÆöÁöÑÁ≥ªÁªü‰ªªÂä°ÔºåÂ¶ÇËÆæÂ§áÈ©±Âä®Á®ãÂ∫èÔºå‰ΩÜÂú®Áé∞‰ª£Êìç‰ΩúÁ≥ªÁªü‰∏≠ÔºåËøô‰∫õ‰ªªÂä°ÈÄöÂ∏∏‰πüÂú® Ring 0 ÊâßË°å„ÄÇ</li>
<li><strong>Ring 3</strong>: ÊúÄ‰ΩéÁâπÊùÉÁ∫ßÂà´ÔºåÁî®‰∫éÊôÆÈÄöÁöÑÂ∫îÁî®Á®ãÂ∫èÔºåËøô‰∫õÂ∫îÁî®Á®ãÂ∫è‰∏çËÉΩÁõ¥Êé•ÊâßË°åÂΩ±ÂìçÁ≥ªÁªüÁ®≥ÂÆöÊÄßÊàñÂÆâÂÖ®ÊÄßÁöÑÊìç‰Ωú„ÄÇ</li>
</ul>
<p>Linux ‰∏ªË¶Å‰ΩøÁî®‰∫Ü <strong>Ring 0</strong> Âíå <strong>Ring 3</strong>ÔºåÂ∞ÜËÉΩÂ§üËÆøÈóÆÂÖ≥ÈîÆËµÑÊ∫êÁöÑÂÜÖÊ†∏ÊîæÂú® Ring0ÔºåÁß∞‰∏∫ÂÜÖÊ†∏ÊÄÅÔºà<strong>Kernel Mode</strong>ÔºâÔºåÊôÆÈÄöÁöÑÂ∫îÁî®Á®ãÂ∫èÂ∞ÜÊîæÂú® Ring3ÔºåÁß∞‰∏∫Áî®Êà∑ÊÄÅÔºà<strong>User Mode</strong>Ôºâ„ÄÇ</p>
<h3 id="Á≥ªÁªüË∞ÉÁî®">Á≥ªÁªüË∞ÉÁî®</h3>
<p>Â¶ÇÊûúÁî®Êà∑ÊÄÅ‰ª£Á†ÅÈúÄË¶ÅËÆøÈóÆÊ†∏ÂøÉËµÑÊ∫êÔºåÂÆÉÂøÖÈ°ªÈÄöËøá<strong>Á≥ªÁªüË∞ÉÁî®Ôºàsystem call Ôºâ</strong>„ÄÇÁ≥ªÁªüË∞ÉÁî®ÊòØËøõÂÖ•ÂÜÖÊ†∏ÁöÑÂÖ•Âè£ÁÇπÔºåÂÜÖÊ†∏ÈÄöËøáÁ≥ªÁªüË∞ÉÁî®ÂêëÁ®ãÂ∫èÊèê‰æõ‰∏ÄÁ≥ªÂàóÊúçÂä°ÔºåÂ¶ÇÊñá‰ª∂ËØªÂÜô„ÄÅËøõÁ®ãÂàõÂª∫„ÄÅËæìÂÖ•ËæìÂá∫Êìç‰ΩúÁ≠â„ÄÇÂ∫îÁî®Á®ãÂ∫èÈÄöËøáÁ≥ªÁªüË∞ÉÁî®ËØ∑Ê±ÇÂÜÖÊ†∏‰ª£‰∏∫ÊâßË°åËøô‰∫õÊúçÂä°„ÄÇ</p>
<p>Ë∞ÉÁî®Á≥ªÁªüË∞ÉÁî®ÁúãËµ∑Êù•ÂæàÂÉèË∞ÉÁî® C ÂáΩÊï∞„ÄÇ‰ΩÜÂÆûÈôÖ‰∏äÔºåÂú®Á≥ªÁªüË∞ÉÁî®ÁöÑÊâßË°åËøáÁ®ã‰∏≠Ôºå‰ºöËøõË°åÂ§ö‰∏™Ê≠•È™§„ÄÇ‰ª• x86 Âπ≥Âè∞ÁöÑÂÆûÁé∞‰∏∫‰æãÔºåÂåÖÊã¨‰ª•‰∏ãÂá†‰∏™ÂÖ≥ÈîÆÁéØËäÇÔºö</p>
<p><img src="https://cdn.mazhen.tech/images/202311211416813.png"
	
	
	
	loading="lazy"
	
		alt="system call"
	
	
></p>
<ol>
<li>Â∫îÁî®Á®ãÂ∫èÈÄöËøáË∞ÉÁî® C Â∫ì‰∏≠ÁöÑÂåÖË£ÖÂáΩÊï∞Êù•ÂèëËµ∑Á≥ªÁªüË∞ÉÁî®„ÄÇ</li>
<li>ÂåÖË£ÖÂáΩÊï∞Ë¥üË¥£Â∞ÜÊâÄÊúâÁ≥ªÁªüË∞ÉÁî®ÂèÇÊï∞‰º†ÈÄíÁªôÂÜÖÊ†∏„ÄÇËøô‰∫õÂèÇÊï∞ÈÄöÂ∏∏ÈÄöËøáÊ†à‰º†ÈÄíÁªôÂåÖË£ÖÂáΩÊï∞ÔºåÁÑ∂ÂêéË¢´Â§çÂà∂Âà∞ÁâπÂÆöÁöÑ CPU ÂØÑÂ≠òÂô®‰∏≠„ÄÇ</li>
<li>‰∏∫‰∫ÜËÆ©ÂÜÖÊ†∏ËØÜÂà´‰∏çÂêåÁöÑÁ≥ªÁªüË∞ÉÁî®ÔºåÂåÖË£ÖÂáΩÊï∞‰ºöÊääÁ≥ªÁªüË∞ÉÁî®ÁöÑÁºñÂè∑Â§çÂà∂Âà∞‰∏Ä‰∏™ÁâπÂÆöÁöÑ CPU ÂØÑÂ≠òÂô®Ôºà%eaxÔºâ‰∏≠„ÄÇ</li>
<li>ÂåÖË£ÖÂáΩÊï∞ÊâßË°å <strong>trap</strong> Êú∫Âô®Êåá‰ª§Ôºà x86 Êû∂ÊûÑ <code>sysenter</code> Êåá‰ª§ÔºâÔºå‰Ωø CPU ‰ªéÁî®Êà∑Ê®°ÂºèÂàáÊç¢Âà∞ÂÜÖÊ†∏Ê®°Âºè„ÄÇ</li>
<li>ÂÜÖÊ†∏ÂìçÂ∫î‰∏≠Êñ≠ÔºåÊääÂΩìÂâçÁöÑÂØÑÂ≠òÂô®ÂÄº‰øùÂ≠òÂà∞ÂÜÖÊ†∏Ê†àÊï∞ÊçÆÁªìÊûÑ <strong>struct pt_regs</strong> ‰∏≠ÔºåÊ†πÊçÆÁºñÂè∑Âú®‰∏Ä‰∏™Ë°®Ê†º‰∏≠ÊâæÂà∞Áõ∏Â∫îÁöÑÁ≥ªÁªüË∞ÉÁî®ÊúçÂä°Á®ãÂ∫èÔºåÂπ∂ÊâßË°åÂÆÉÔºåÁÑ∂ÂêéËøîÂõûÁªìÊûú„ÄÇ</li>
<li>ÂÆåÊàêÊìç‰ΩúÂêéÔºåÂÜÖÊ†∏Â∞ÜÂØÑÂ≠òÂô®ÂÄºÊÅ¢Â§çÂà∞ÂéüÂßãÁä∂ÊÄÅÔºåÂπ∂Â∞ÜÊéßÂà∂ÊùÉËøîÂõûÁªôÁî®Êà∑Á©∫Èó¥ÁöÑÂ∫îÁî®Á®ãÂ∫èÔºåÂêåÊó∂ËøîÂõûÁ≥ªÁªüË∞ÉÁî®ÁöÑÁªìÊûú„ÄÇ</li>
</ol>
<h3 id="Áî®Êà∑Ê†àÂíåÂÜÖÊ†∏Ê†à">Áî®Êà∑Ê†àÂíåÂÜÖÊ†∏Ê†à</h3>
<p>ÂèØ‰ª•ÁúãÂá∫Âú®ÊâßË°åÁ≥ªÁªüË∞ÉÁî®Êó∂ÔºåËøõÁ®ãÂÖ∑Êúâ‰∏§‰∏™Ê†àÔºö<strong>Áî®Êà∑Ê†àÔºàUser StackÔºâ<strong>Âíå</strong>ÂÜÖÊ†∏Ê†àÔºàKernel StackÔºâ</strong>„ÄÇ</p>
<ul>
<li><strong>Áî®Êà∑Ê†àÔºàUser StackÔºâ</strong> ‰øùÁïô‰∫ÜËøõÂÖ•Á≥ªÁªüË∞ÉÁî®ÂâçÁöÑÁä∂ÊÄÅÔºåÁî®Êà∑Ê†àÂú®Á≥ªÁªüË∞ÉÁî®ÊúüÈó¥‰∏ç‰ºöÊîπÂèò</li>
<li><strong>ÂÜÖÊ†∏Ê†àÔºàKernel StackÔºâ</strong> ÊòØÂú®Á≥ªÁªüË∞ÉÁî®ÊúüÈó¥‰ΩøÁî®ÔºåÁî®‰∫éÂ≠òÂÇ®Âú®ÂÜÖÊ†∏ÊÄÅ‰∏ãÊâßË°åÁöÑÁä∂ÊÄÅ‰ø°ÊÅØÔºåÂåÖÊã¨ÂØÑÂ≠òÂô®ÁöÑÂÄºÂíåÁ≥ªÁªüË∞ÉÁî®ÁöÑÂèÇÊï∞„ÄÇÊ≠§Â§ñÂ§ÑÁêÜ‰∏≠Êñ≠ÂíåÂºÇÂ∏∏Êó∂Ôºå‰πü‰ºö‰ΩøÁî®ÂÜÖÊ†∏Ê†à„ÄÇ</li>
</ul>
<p>Áî®Êà∑Ê†àÂíåÂÜÖÊ†∏Ê†àÂú®‰ªÄ‰πà‰ªÄ‰πà‰ΩçÁΩÆÔºüÊàë‰ª¨ÈúÄË¶ÅÂÖà‰∫ÜËß£ËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ÁöÑÊ¶ÇÂøµ„ÄÇ</p>
<h3 id="ËøõÁ®ãËôöÊãüÂú∞ÂùÄÁ©∫Èó¥">ËøõÁ®ãËôöÊãüÂú∞ÂùÄÁ©∫Èó¥</h3>
<p>Âú®Áé∞‰ª£Êìç‰ΩúÁ≥ªÁªü‰∏äÔºåÁî®Êà∑Á®ãÂ∫èÈÉΩ‰∏çËÉΩÁõ¥Êé•Êìç‰ΩúÁâ©ÁêÜÂÜÖÂ≠ò„ÄÇÊìç‰ΩúÁ≥ªÁªü‰ºöÁªôËøõÁ®ãÂàÜÈÖçËôöÊãüÂÜÖÂ≠òÁ©∫Èó¥ÔºåÊâÄÊúâËøõÁ®ãÁúãÂà∞ÁöÑËøô‰∏™Âú∞ÂùÄÈÉΩÊòØ‰∏ÄÊ†∑ÁöÑÔºåÈáåÈù¢ÁöÑÂÜÖÂ≠òÈÉΩÊòØ‰ªé 0 ÂºÄÂßãÁºñÂè∑„ÄÇ</p>
<p>Á®ãÂ∫èÈáåÊåá‰ª§Êìç‰ΩúÁöÑÈÉΩÊòØËôöÊãüÂú∞ÂùÄ„ÄÇÂÜÖÊ†∏‰ºöÁª¥Êä§‰∏Ä‰∏™ËôöÊãüÂÜÖÂ≠òÂà∞Áâ©ÁêÜÂÜÖÂ≠òÁöÑÊò†Â∞ÑË°®ÔºåÂ∞Ü‰∏çÂêåËøõÁ®ãÁöÑËôöÊãüÂú∞ÂùÄÂíå‰∏çÂêåÁöÑÁâ©ÁêÜÂú∞ÂùÄÊò†Â∞ÑËµ∑Êù•„ÄÇÂΩìÁ®ãÂ∫èË¶ÅËÆøÈóÆËôöÊãüÂú∞ÂùÄÊó∂Ôºå‰ºöÈÄöËøáÊò†Â∞ÑË°®ËøõË°åËΩ¨Êç¢ÔºåÊâæÂà∞ÂØπÂ∫îÁöÑÁâ©ÁêÜÂÜÖÂ≠òÂú∞ÂùÄ„ÄÇ‰∏çÂêåËøõÁ®ãÁõ∏ÂêåÁöÑËôöÊãüÂú∞ÂùÄÔºå‰ºöÊò†Â∞ÑÂà∞‰∏çÂêåÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºå‰∏ç‰ºöÂèëÁîüÂÜ≤Á™Å„ÄÇËøôÊ†∑ÊØè‰∏™ËøõÁ®ãÁöÑÂú∞ÂùÄÁ©∫Èó¥ÈÉΩÊòØÁã¨Á´ãÁöÑÔºåÁõ∏‰∫íÈöîÁ¶ª‰∫í‰∏çÂΩ±Âìç„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202311151758027.png"
	
	
	
	loading="lazy"
	
		alt="Virtual Memory Address"
	
	
></p>
<p>Êàë‰ª¨Êù•Áúã‰∏Ä‰∏ãËøõÁ®ãÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥Â∏ÉÂ±Ä„ÄÇ</p>
<p>‰∏Ä‰∏™ËøõÁ®ãÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ÂàÜ‰∏∫‰∏§‰∏™ÈÉ®ÂàÜÔºå‰∏ÄÈÉ®ÂàÜÊòØÁî®Êà∑ÊÄÅÂú∞ÂùÄÁ©∫Èó¥Ôºå‰∏ÄÈÉ®ÂàÜÊòØÂÜÖÊ†∏ÊÄÅÂú∞ÂùÄÁ©∫Èó¥„ÄÇ</p>
<p>Áî®Êà∑Á©∫Èó¥ÊòØÂ∫îÁî®Á®ãÂ∫èÊâßË°åÁöÑÂú∫ÊâÄÔºåÊØè‰∏™ËøõÁ®ãÈÉΩÊúâËá™Â∑±Áã¨Á´ãÁöÑÁî®Êà∑Á©∫Èó¥ÔºåÂÖ∂Â∏ÉÂ±ÄÂåÖÂê´‰ª£Á†Å„ÄÅÂÖ®Â±ÄÂèòÈáè„ÄÅÂ†Ü„ÄÅÊ†àÂíåÂÜÖÂ≠òÊò†Â∞ÑÂå∫ÂüüÁ≠âÂ§öÁßçÈÉ®ÂàÜ„ÄÇ</p>
<p>ÂÜÖÊ†∏Á©∫Èó¥ÊòØÂÜÖÊ†∏‰ª£Á†ÅËøêË°åÁöÑÂÜÖÂ≠òÂå∫ÂüüÔºåÂÆÉÂπ∂Èùû‰∏ìÂ±û‰∫éÊüê‰∏™ÂçïÁã¨ÁöÑËøõÁ®ãÔºåÊâÄÊúâËøõÁ®ãÈÄöËøáÁ≥ªÁªüË∞ÉÁî®ËøõÂÖ•Âà∞ÂÜÖÊ†∏‰πãÂêéÔºåÁúãÂà∞ÁöÑËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ÈÉΩÊòØ‰∏ÄÊ†∑ÁöÑ„ÄÇ</p>
<p>Áî®Êà∑Á©∫Èó¥‰∏éÂÜÖÊ†∏Á©∫Èó¥ÁöÑËøôÁßçÂàÜÁ¶ªÔºåÁ°Æ‰øù‰∫ÜÁî®Êà∑Â∫îÁî®Á®ãÂ∫è‰∏çËÉΩÁõ¥Êé•Âπ≤Êâ∞ÂÜÖÊ†∏Ôºå‰øùËØÅ‰∫ÜÁ≥ªÁªüÁöÑÂÆâÂÖ®Á®≥ÂÆöÊÄß„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202311161738057.png"
	
	
	
	loading="lazy"
	
		alt="process virtual addrsss space"
	
	
></p>
<p>Linux ÁöÑÂèØÊâßË°åÊñá‰ª∂ÊòØ <a class="link" href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format"  target="_blank" rel="noopener"
    >ELFÔºàExecutable and Linkable FormatÔºâ</a>Ê†ºÂºèÔºåÊâßË°åÊó∂‰ªéÁ°¨ÁõòÂä†ËΩΩÂà∞ÂÜÖÂ≠òÔºåELF Êñá‰ª∂‰∏≠ÁöÑ‰ª£Á†ÅÊÆµÂíåÊï∞ÊçÆÊÆµË¢´Áõ¥Êé•Êò†Â∞ÑÂà∞ËøõÁ®ãËôöÊãüÂú∞ÂùÄÁ©∫Èó¥Áî®Êà∑ÊÄÅÁöÑÊï∞ÊçÆÊÆµÂíå‰ª£Á†ÅÊÆµ„ÄÇ</p>
<p>Áî®Êà∑Á©∫Èó¥ÁöÑ**Â†ÜÔºàheapÔºâ**ÊòØÂä®ÊÄÅÂÜÖÂ≠òÂàÜÈÖçÁöÑÂå∫ÂüüÔºåÂèØ‰ª•‰ΩøÁî®Á≥ªÁªüË∞ÉÁî® <a class="link" href="https://www.man7.org/linux/man-pages/man2/brk.2.html"  target="_blank" rel="noopener"
    >sbrk</a> „ÄÅ<a class="link" href="https://www.man7.org/linux/man-pages/man2/mmap.2.html"  target="_blank" rel="noopener"
    >mmap</a> Âíå glibc Êèê‰æõÁöÑ <a class="link" href="https://elixir.bootlin.com/glibc/glibc-2.38/source/malloc/malloc.c"  target="_blank" rel="noopener"
    >malloc</a> ÂáΩÊï∞ËøõË°åÂ†ÜÂÜÖÂ≠òÁöÑÁî≥ËØ∑„ÄÇÂÜÖÊ†∏‰ºöÁª¥Êä§‰∏Ä‰∏™ÂèòÈáè <strong>brk</strong> ÊåáÂêëÂ†ÜÁöÑÈ°∂ÈÉ®Ôºå<strong>sbrk</strong> ÈÄöËøáÊîπÂèò <strong>brk</strong> Êù•Áª¥Êä§Â†ÜÁöÑÂ§ßÂ∞è„ÄÇ<strong>malloc</strong> ÂÜÖÈÉ®‰πü‰ΩøÁî®‰∫ÜÁ≥ªÁªüË∞ÉÁî® <strong>sbrk</strong> Êàñ <strong>mmap</strong>Ôºå‰ΩÜ glibc ‰ºöÁª¥Êä§‰∏Ä‰∏™ÂÜÖÂ≠òÊ±†ÔºåÂπ∂‰∏çÊòØÊØèÊ¨°‰ΩøÁî® <strong>malloc</strong> Áî≥ËØ∑ÂÜÖÂ≠òÊó∂ÈÉΩÁõ¥Êé•ËøõË°åÁ≥ªÁªüË∞ÉÁî®„ÄÇ</p>
<p>ÂÜÖÂ≠òÊò†Â∞ÑÂå∫Âüü‰∏∫ÂÖ±‰∫´Â∫ìÂèäÊñá‰ª∂Êò†Â∞ÑÊèê‰æõÁ©∫Èó¥„ÄÇÂèØ‰ª•‰ΩøÁî®Á≥ªÁªüË∞ÉÁî® <a class="link" href="https://www.man7.org/linux/man-pages/man2/mmap.2.html"  target="_blank" rel="noopener"
    >mmap</a> Â∞ÜÂàõÂª∫Êñá‰ª∂Êò†Â∞ÑÊèêÂçá IO ÊïàÁéá„ÄÇ</p>
<p>Áî®Êà∑Á©∫Èó¥ÁöÑ<strong>Â†ÜÊ†àÔºàStackÔºâ</strong> ÊòØÁî®Êà∑ÊÄÅÂáΩÊï∞ÊâßË°åÁöÑÊ¥ªË∑ÉËÆ∞ÂΩïÔºå<code>%rsp</code>ÊåáÂêëÂΩìÂâçÂ†ÜÊ†àÈ°∂ÈÉ®„ÄÇ</p>
<p>ÂÜÖÊ†∏Á©∫Èó¥‰πüÊúâ‰ª£Á†ÅÊÆµÂíåÊï∞ÊçÆÊÆµÔºåÊò†Â∞ÑÂÜÖÊ†∏ÁöÑ‰ª£Á†ÅÊÆµÂíåÊï∞ÊçÆÊÆµ„ÄÇ</p>
<p>ÂΩìËøõÁ®ãÊâßË°åÁ≥ªÁªüË∞ÉÁî®Êó∂Ôºå‰ºö‰ªéÁî®Êà∑Á©∫Èó¥ÂàáÊç¢Âà∞ÂÜÖÊ†∏Á©∫Èó¥ÔºåËøõÁ®ãÁöÑÂΩìÂâçÁä∂ÊÄÅÔºåÂåÖÊã¨Ê†àÊåáÈíàÔºà<strong>rsp</strong> ÂØÑÂ≠òÂô®Ôºâ„ÄÅÁ®ãÂ∫èËÆ°Êï∞Âô®Ôºà<strong>rip</strong>Ôºå‰πüÂ∞±ÊòØ <strong>PC</strong> ÂØÑÂ≠òÂô®ÔºâÁ≠âÔºå‰ºöË¢´‰øùÂ≠òÂú®ÂÜÖÊ†∏Êï∞ÊçÆÁªìÊûÑ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/include/asm/ptrace.h#L59"  target="_blank" rel="noopener"
    >struct pt_regs</a> ÂÜÖÔºå‰ª•‰æøÂú®Á≥ªÁªüË∞ÉÁî®ÂÆåÊàêÂêéËÉΩÂ§üÂáÜÁ°ÆÂú∞ÊÅ¢Â§çÔºåÁªßÁª≠ÊâßË°åÂõ†Á≥ªÁªüË∞ÉÁî®ËÄåÊöÇÂÅúÁöÑÁî®Êà∑Á©∫Èó¥Êìç‰Ωú„ÄÇ</p>
<p>ÊâßË°åÂÜÖÊ†∏‰ª£Á†Å‰ºö‰ΩøÁî®<strong>ÂÜÖÊ†∏Ê†àÔºàKernel-StackÔºâ</strong>„ÄÇ</p>
<p>Áé∞Âú®Êúâ‰∫ÜËøõÁ®ãËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ÁöÑÂÖ®ÊôØÂõæÔºåÊàë‰ª¨ÂÜçÂõûÂ§¥ÁúãÁúãËøòÂéüÂáΩÊï∞Ë∞ÉÁî®Ê†àÁöÑÈóÆÈ¢ò„ÄÇ</p>
<h3 id="ËøòÂéüÂÆåÊï¥Ë∞ÉÁî®Ê†à">ËøòÂéüÂÆåÊï¥Ë∞ÉÁî®Ê†à</h3>
<p>Âú® Linux Á≥ªÁªü‰∏≠ÔºåÊàë‰ª¨ÂèØ‰ª•ËØ¥Âú®‰ªª‰ΩïÁªôÂÆöÁöÑÊó∂ÂàªÔºåCPU Â§Ñ‰∫é‰∏ãÈù¢‰∏âÁßçÁä∂ÊÄÅ‰πã‰∏ÄÔºö</p>
<ol>
<li>Âú®Áî®Êà∑Á©∫Èó¥ÔºåÊâßË°åÊüê‰∏™ËøõÁ®ãÈáåÁöÑÁî®Êà∑Á∫ß‰ª£Á†Å</li>
<li>Âú®ÂÜÖÊ†∏Á©∫Èó¥Ôºå‰ª•ËøõÁ®ãÁöÑË∫´‰ªΩËøêË°åÔºå‰∏∫ÁâπÂÆöÁöÑËøõÁ®ãÊúçÂä°Ôºå‰πüÂ∞±ÊòØÊâßË°åÁ≥ªÁªüË∞ÉÁî®</li>
<li>Âú®ÂÜÖÊ†∏Á©∫Èó¥ÔºåÂ§Ñ‰∫éÂ§ÑÁêÜ‰∏≠Êñ≠ÁöÑÁä∂ÊÄÅÔºåÊ≠§Êó∂‰∏ç‰∏é‰ªª‰ΩïËøõÁ®ãÁõ∏ÂÖ≥ËÅîÔºåËøêË°åÂú®ÂÜÖÊ†∏Á∫øÁ®ã‰∏≠Ôºå‰∏ìÊ≥®‰∫éÂ§ÑÁêÜ‰∏≠Êñ≠‰∫ã‰ª∂</li>
</ol>
<p>ÂØπ‰∫éÁ¨¨‰∏Ä„ÄÅÁ¨¨‰∏âÁßçÊÉÖÂÜµÔºå perf Âú®ÈááÊ†∑‰∫ã‰ª∂Ëß¶ÂèëÊó∂ÔºåÂè™Ë¶ÅÈÄöËøá <strong>Frame Pointer</strong>Ôºà <strong>rsp</strong> ÂØÑÂ≠òÂô®ÔºâÂ∞±ÂèØ‰ª•ËøòÂéüÁî®Êà∑Ê†àÊàñÂÜÖÊ†∏Ê†àÔºåÂπ∂‰∏îÂ∑≤ÁªèÊòØÂÆåÊï¥ÁöÑË∞ÉÁî®Ê†à„ÄÇ</p>
<p>ÂØπ‰∫éÁ¨¨‰∫åÁßçÊÉÖÂÜµÔºåËøõÁ®ãÊ≠£Â•ΩÈô∑ÂÖ•ÂÜÖÊ†∏ÊâßË°åÁ≥ªÁªüË∞ÉÁî®ÔºåÈÇ£‰πàÈÄöËøá <strong>Frame Pointer</strong>Ôºà <strong>rsp</strong> ÂØÑÂ≠òÂô®ÔºâÂèØ‰ª•ËøòÂéüÂÜÖÊ†∏‰ª£Á†ÅÁöÑÊâßË°åË∑ØÂæÑ„ÄÇÁÑ∂ÂêéÂÜçÈÄöËøáÂÜÖÊ†∏Êï∞ÊçÆÁªìÊûÑ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/include/asm/ptrace.h#L59"  target="_blank" rel="noopener"
    >struct pt_regs</a> ÂÜÖ‰øùÂ≠òÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºåËøòÂéüËøõÂÖ•ÂÜÖÊ†∏ÂâçÁî®Êà∑Á©∫Èó¥ÁöÑ‰ª£Á†ÅÊâßË°åË∑ØÂæÑ„ÄÇËøôÊ†∑Êàë‰ª¨Â∞±ËÉΩËé∑ÂæóÈááÊ†∑‰∫ã‰ª∂Ëß¶ÂèëÊó∂ÔºåÂåÖÂê´‰∫ÜÁî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅÁöÑÂÆåÊï¥‰ª£Á†ÅÊâßË°åË∑ØÂæÑ„ÄÇ</p>
<p>ÈÄöËøá <strong>PC</strong> ÂØÑÂ≠òÂô®„ÄÅ <strong>rsp</strong> ÂØÑÂ≠òÂô®Ôºå‰ª•ÂèäÂÜÖÊ†∏Êï∞ÊçÆÁªìÊûÑ<strong>pt_regs</strong>ÔºåÊàë‰ª¨ËÉΩÁü•ÈÅì CPU Áû¨Êó∂ÁöÑ‚ÄúÂä®‰Ωú‚ÄùÔºå‰ª•ÂèäÂÆÉÊòØÊÄé‰πàÂÅöËøô‰∏™Âä®‰ΩúÁöÑÔºà‰ª£Á†ÅÊâßË°åË∑ØÂæÑÔºâÔºåÈÇ£‰πàËøòÂâ©ÊúÄÂêé‰∏Ä‰∏™ÈóÆÈ¢òÔºåÊàë‰ª¨ÊÄé‰πàÁü•ÈÅìÈááÊ†∑ÂèëÁîüÊó∂Âàª CPU ÂØÑÂ≠òÂô®ÁöÑÂÜÖÂÆπÂë¢Ôºü</p>
<h3 id="‰∏≠Êñ≠Â§ÑÁêÜ">‰∏≠Êñ≠Â§ÑÁêÜ</h3>
<p>ÂÜÖÊ†∏ÊòØË¢´Âä®Â∑•‰ΩúÊ®°ÂºèÔºåÂÆÉ‚ÄúË∫∫‚ÄùÂú®ÂÜÖÊ†∏Á©∫Èó¥‰∏ç‰ºö‰∏ªÂä®Â∑•‰ΩúÔºåË¶Å‰πàÈÄöËøáÁ≥ªÁªüË∞ÉÁî®ËÆ©ÂÆÉ‰∏∫Áî®Êà∑ËøõÁ®ãÊúçÂä°ÔºåË¶Å‰πàÁî±Êó∂Èíü‰∏≠Êñ≠ÂíåÂêÑÁßçÂ§ñÈÉ®ËÆæÂ§á‰∏≠Êñ≠‰∫ã‰ª∂È©±Âä®ÊâßË°å„ÄÇ</p>
<p>‰∏≠Êñ≠ÊòØ Linux ÁöÑÊ†∏ÂøÉÂäüËÉΩ‰πã‰∏ÄÔºåÂÆÉÂÖÅËÆ∏ CPU ÂìçÂ∫îÂ§ñÈÉ®ÊàñÂÜÖÈÉ®‰∫ã‰ª∂ÔºåÂ¶ÇÊ∫êËá™Á°¨‰ª∂ËÆæÂ§áÁöÑÈîÆÁõò„ÄÅÈº†Ê†á„ÄÅÁΩëÂç°ÔºåÊàñÊù•Ëá™ËΩØ‰ª∂ÁöÑÂºÇÂ∏∏„ÄÇÂΩìËøô‰∫õ‰∫ã‰ª∂Ôºå‰πüÂ∞±ÊòØ‰∏≠Êñ≠‰∫ã‰ª∂ÂèëÁîüÊó∂ÔºåCPU ‰ºöÊöÇÂÅúÂΩìÂâçÁöÑÂ∑•‰ΩúÔºåËΩ¨ÂÖ•ÂÜÖÊ†∏ÁöÑ<strong>‰∏≠Êñ≠Â§ÑÁêÜÁ®ãÂ∫èÔºàInterrupt HandlerÔºâ</strong>„ÄÇÂΩìÂ§ÑÁêÜÂÆåÊàêÂêéÔºå‰ºö‰ªé‰∏≠Êñ≠Â§ÑÁêÜÁ®ãÂ∫èËøîÂõûÂà∞ÂéüÊù•Ë¢´‰∏≠Êñ≠ÁöÑ‰ª£Á†ÅÂ§ÑÁªßÁª≠ÊâßË°å„ÄÇ</p>
<p>‰∏≠Êñ≠ÂèØ‰ª•ÂàÜ‰∏∫**ÂêåÊ≠•ÔºàSynchronousÔºâ<strong>‰∏≠Êñ≠Âíå</strong>ÂºÇÊ≠•ÔºàAsynchronousÔºâ**‰∏≠Êñ≠‰∏§Á±ªÔºö</p>
<ul>
<li><strong>ÂêåÊ≠•‰∏≠Êñ≠</strong>ÔºöÁî±CPUÂΩìÂâçÊâßË°åÁöÑÊåá‰ª§Â∫èÂàóÂºïËµ∑ÁöÑ„ÄÇ</li>
<li><strong>ÂºÇÊ≠•‰∏≠Êñ≠</strong>ÔºöÁî±Â§ñÈÉ®‰∫ã‰ª∂ÔºàÂÆöÊó∂‰∏≠Êñ≠Âíå I/O ËÆæÂ§áÔºâÂºïËµ∑Ôºå‰∏éCPUÂΩìÂâçÊâßË°åÁöÑÊåá‰ª§Â∫èÂàóÊó†ÂÖ≥„ÄÇ</li>
</ul>
<p>Âú® x86 Âπ≥Âè∞‰∏äÔºåÂêåÊ≠•‰∏≠Êñ≠Ë¢´Áß∞‰∏∫<strong>ÂºÇÂ∏∏ÔºàExceptionÔºâ</strong>ÔºåËÄåÂºÇÊ≠•‰∏≠Êñ≠Ë¢´Áß∞‰∏∫<strong>‰∏≠Êñ≠ÔºàInterruptÔºâ</strong>„ÄÇÊ≥®ÊÑè‚Äú‰∏≠Êñ≠‚ÄùËøô‰∏™ËØçÊ†πÊçÆ‰∏ä‰∏ãÊñáÔºåÂèØ‰ª•‰ªÖÊåáÂºÇÊ≠•‰∏≠Êñ≠Ôºå‰πüÂèØ‰ª•ÊåáÂåÖÂê´‰∫ÜÂºÇÂ∏∏ÁöÑ‰∏§Á±ª‰∏≠Êñ≠ÁöÑÊÄªÁß∞„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202311201051594.png"
	
	
	
	loading="lazy"
	
		alt="interrupts"
	
	
></p>
<p>Âú® x86 Êû∂ÊûÑ‰∏≠ÔºåÊØè‰∏™‰∏≠Êñ≠ÊàñÂºÇÂ∏∏ÈÉΩÈÄöËøá‰∏Ä‰∏™ 0 Âà∞ 255 ËåÉÂõ¥ÂÜÖÁöÑÊï∞Â≠óÊù•ËØÜÂà´ÔºåËøô‰∏™Êï∞Â≠óÊòØ‰∏Ä‰∏™ 8 ‰ΩçÁöÑÊó†Á¨¶Âè∑Êï∞ÔºåË¢´Áß∞‰∏∫‚Äú<strong>ÂêëÈáèÔºà<em>vector</em>Ôºâ</strong>‚Äù„ÄÇÂÖ∂‰∏≠ÔºåÂºÇÂ∏∏Âíå‰∏çÂèØÂ±èËîΩ‰∏≠Êñ≠ÁöÑÂêëÈáèÂÄºÊòØÂõ∫ÂÆö‰∏çÂèòÁöÑÔºà0ÔΩû31ÔºâÔºåËÄåÂèØÂ±èËîΩ‰∏≠Êñ≠ÁöÑÂêëÈáèÂèØ‰ª•ÈÄöËøá<strong>ÂèØÁºñÁ®ã‰∏≠Êñ≠ÊéßÂà∂Âô®</strong>Ôºà<em>Programmable Interrupt Controller</em>Ôºå<strong>PIC</strong>ÔºâËøõË°åË∞ÉÊï¥„ÄÇ</p>
<p>ÊØè‰∏™ I/O ËÆæÂ§áÈÄöÂ∏∏Êúâ‰∏Ä‰∏™ÂçïÁã¨ÁöÑËæìÂá∫Á∫øË∑ØÔºåÁî®Êù•ÂèëÈÄÅ‰∏≠Êñ≠ËØ∑Ê±ÇÔºà<strong>I</strong>nterrupt <strong>R</strong>e<strong>Q</strong>uest, <strong>IRQ</strong>Ôºâ„ÄÇÊâÄÊúâ <strong>IRQ</strong> Á∫øË∑ØÈÉΩËøûÊé•Âà∞ <strong>PIC</strong>ÔºåÁÑ∂Âêé <strong>PIC</strong> ÂèàËøûÊé•Âà∞ CPU ÁöÑ <strong>INTR</strong> ÂºïËÑö„ÄÇÂΩìÊüê‰∏™ I/O ËÆæÂ§áÂèëÁîü‰∫ÜÈúÄË¶Å CPU Ê≥®ÊÑèÁöÑ‰∫ã‰ª∂Ôºå‰æãÂ¶ÇÁî®Êà∑Êï≤ÂáªÈîÆÁõòÔºåÊï∞ÊçÆÂà∞ËææÁΩëÂç°ÔºåËØ•ËÆæÂ§áÂú®Áõ∏Â∫îÁöÑ IRQ Á∫øË∑Ø‰∏äÂèëÈÄÅ‰ø°Âè∑Ôºå<strong>PIC</strong> Â∞ÜËøô‰∏™ <strong>IRQ</strong> ‰ø°Âè∑ËΩ¨Êç¢Êàê‰∏Ä‰∏™<strong>‰∏≠Êñ≠ÂêëÈáè</strong>ÔºåÁÑ∂ÂêéÂú® CPU ÁöÑ <strong>INTR</strong> ÂºïËÑö‰∏äÂèëËµ∑‰∏Ä‰∏™‰∏≠Êñ≠ËØ∑Ê±ÇÔºåÁ≠âÂæÖ CPU Â§ÑÁêÜ„ÄÇ</p>
<p>‰∏çÂèØÂ±èËîΩ‰∏≠Êñ≠ÈÄöËøá <strong>NMI</strong> ÂºïËÑöÊé•ÂÖ• CPU„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202311201445225.png"
	
	
	
	loading="lazy"
	
		alt="PIC"
	
	
></p>
<p>Êàë‰ª¨ÂèØ‰ª•Âú® <strong>/proc/interrupts</strong> Êü•ÁúãÂà∞Á≥ªÁªüÁ°¨‰ª∂ËÆæÂ§á <strong>IRQ</strong> Á∫øË∑ØÂèäÂØπÂ∫î CPU ÁöÑÁªüËÆ°‰ø°ÊÅØÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ cat /proc/interrupts 
</span></span><span class="line"><span class="cl">           CPU0       CPU1       CPU2       CPU3       
</span></span><span class="line"><span class="cl">  8:          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  IR-IO-APIC   8-edge      rtc0
</span></span><span class="line"><span class="cl">  9:          <span class="m">0</span>          <span class="m">4</span>          <span class="m">0</span>          <span class="m">0</span>  IR-IO-APIC   9-fasteoi   acpi
</span></span><span class="line"><span class="cl"> 18:          <span class="m">0</span>          <span class="m">2</span>          <span class="m">0</span>          <span class="m">0</span>  IR-IO-APIC  18-fasteoi   i801_smbus
</span></span><span class="line"><span class="cl"> 23:         <span class="m">35</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  IR-IO-APIC  23-fasteoi   ehci_hcd:usb1
</span></span><span class="line"><span class="cl"> 40:          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  DMAR-MSI   0-edge      dmar0
</span></span><span class="line"><span class="cl"> 41:          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  DMAR-MSI   1-edge      dmar1
</span></span><span class="line"><span class="cl"> 42:          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>          <span class="m">0</span>  IR-PCI-MSI-0000:00:1c.0   0-edge      PCIe PME
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">NMI:         <span class="m">67</span>        <span class="m">124</span>         <span class="m">61</span>         <span class="m">60</span>   Non-maskable interrupts
</span></span><span class="line"><span class="cl">LOC:    <span class="m">7386692</span>    <span class="m">9261862</span>    <span class="m">8162396</span>    <span class="m">7051922</span>   Local timer interrupts
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">PMI:         <span class="m">67</span>        <span class="m">124</span>         <span class="m">61</span>         <span class="m">60</span>   Performance monitoring interrupts
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ê≥®ÊÑèÁ¨¨‰∏ÄÂàóËæìÂá∫ÁöÑÊòØ <strong>IRQ</strong> Á∫øË∑ØÁºñÂè∑ÔºåÈúÄË¶ÅÈÄöËøá <strong>PIC</strong> ËΩ¨Êç¢‰∏∫ CPU ‰ΩøÁî®ÁöÑ<strong>‰∏≠Êñ≠ÂêëÈáè</strong>ÔºåÂØπ‰∫é Intel CPUÔºåIRQn ËΩ¨Êç¢‰∏∫ÁöÑ‰∏≠Êñ≠ÂêëÈáèÊòØ <strong>n+32</strong>ÔºåÂõ†‰∏∫ 0ÔΩû31 ÊòØÂõ∫ÂÆöÁªô‰∫ÜÂºÇÂ∏∏‰ΩøÁî®„ÄÇ</p>
<p>√ó86 Á≥ªÂàóÁöÑ CPU ËÉΩÂ§ÑÁêÜ 20 Áßç‰∏çÂêåÁ±ªÂûãÁöÑÂºÇÂ∏∏ÔºåÂÜÖÊ†∏ÂøÖÈ°ª‰∏∫ÊØè‰∏ÄÁßçÂºÇÂ∏∏ÈÉΩÊèê‰æõ‰∏Ä‰∏™‰∏ìÈó®ÁöÑÂºÇÂ∏∏Â§ÑÁêÜÁ®ãÂ∫è„ÄÇÊàë‰ª¨ÂèØ‰ª•Âú® <a class="link" href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html"  target="_blank" rel="noopener"
    >Intel&rsquo;s Software Development Manual: System Programming Guide</a> ‰∏≠ÊâæÂà∞ÂØπËøô‰∫õÂºÇÂ∏∏ÁöÑÂÆåÊï¥ÊèèËø∞„ÄÇ</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Vector</th>
<th>Mnemonic</th>
<th>Description</th>
<th>Type</th>
<th>Error Code</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>#DE</td>
<td>Divide Error</td>
<td>Fault</td>
<td>No</td>
<td>DIV and IDIV instructions.</td>
</tr>
<tr>
<td>1</td>
<td>#DB</td>
<td>Debug Exception</td>
<td>Fault/ Trap</td>
<td>No</td>
<td>Instruction, data, and I/O breakpoints; single-step; and others.</td>
</tr>
<tr>
<td>2</td>
<td>-</td>
<td>NMI Interrupt</td>
<td>Interrupt</td>
<td>No</td>
<td>Nonmaskable external interrupt.</td>
</tr>
<tr>
<td>3</td>
<td>#BP</td>
<td>Breakpoint</td>
<td>Trap</td>
<td>No</td>
<td>INT3 instruction.</td>
</tr>
<tr>
<td>4</td>
<td>#OF</td>
<td>Overflow</td>
<td>Trap</td>
<td>No</td>
<td>INTO instruction.</td>
</tr>
<tr>
<td>5</td>
<td>#BR</td>
<td>BOUND Range  Exceeded</td>
<td>Fault</td>
<td>No</td>
<td>BOUND instruction.</td>
</tr>
<tr>
<td>6</td>
<td>#UD</td>
<td>Invalid Opcode (Undefined Opcode)</td>
<td>Fault</td>
<td>No</td>
<td>UD instruction or reserved opcode.</td>
</tr>
<tr>
<td>7</td>
<td>#NM</td>
<td>Device Not Available (No Math  Coprocessor)</td>
<td>Fault</td>
<td>No</td>
<td>Floating-point or WAIT/FWAIT instruction.</td>
</tr>
<tr>
<td>8</td>
<td>#DF</td>
<td>Double Fault</td>
<td>Abort</td>
<td>Yes (zero)</td>
<td>Any instruction that can generate an  exception, an NMI, or an INTR.</td>
</tr>
<tr>
<td>9</td>
<td></td>
<td>Coprocessor Segment Overrun (reserved)</td>
<td>Fault</td>
<td>No</td>
<td>Floating-point instruction.</td>
</tr>
<tr>
<td>10</td>
<td>#TS</td>
<td>Invalid TSS</td>
<td>Fault</td>
<td>Yes</td>
<td>Task switch or TSS access.</td>
</tr>
<tr>
<td>11</td>
<td>#NP</td>
<td>Segment Not Present</td>
<td>Fault</td>
<td>Yes</td>
<td>Loading segment registers or accessing  system segments.</td>
</tr>
<tr>
<td>12</td>
<td>#SS</td>
<td>Stack-Segment Fault</td>
<td>Fault</td>
<td>Yes</td>
<td>Stack operations and SS register loads.</td>
</tr>
<tr>
<td>13</td>
<td>#GP</td>
<td>General Protection</td>
<td>Fault</td>
<td>Yes</td>
<td>Any memory reference and other protection checks.</td>
</tr>
<tr>
<td>14</td>
<td>#PF</td>
<td>Page Fault</td>
<td>Fault</td>
<td>Yes</td>
<td>Any memory reference.</td>
</tr>
<tr>
<td>15</td>
<td>‚Äî</td>
<td>(Intel reserved. Do  not use.)</td>
<td></td>
<td>No</td>
<td></td>
</tr>
<tr>
<td>16</td>
<td>#MF</td>
<td>x87 FPU Floating-Point Error (Math Fault)</td>
<td>Fault</td>
<td>No</td>
<td>x87 FPU  floating-point or WAIT/FWAIT instruction.</td>
</tr>
<tr>
<td>17</td>
<td>#AC</td>
<td>Alignment Check</td>
<td>Fault</td>
<td>Yes (Zero)</td>
<td>Any data reference in memory.</td>
</tr>
<tr>
<td>18</td>
<td>#MC</td>
<td>Machine Check</td>
<td>Abort</td>
<td>No</td>
<td>Error codes (if any) and source are model  dependent.</td>
</tr>
<tr>
<td>19</td>
<td>#XM</td>
<td>SIMD Floating-Point Exception</td>
<td>Fault</td>
<td>No</td>
<td>SSE/SSE2/SSE3 floating-point instructions</td>
</tr>
<tr>
<td>20</td>
<td>#VE</td>
<td>Virtualization Exception</td>
<td>Fault</td>
<td>No</td>
<td>EPT violations</td>
</tr>
<tr>
<td>21</td>
<td>#CP</td>
<td>Control Protection Exception</td>
<td>Fault</td>
<td>Yes</td>
<td>RET, IRET, RSTORSSP, and SETSSBSY  instructions can generate this exception. When CET indirect branch tracking  is enabled, this exception can be generated due to a missing ENDBRANCH  instruction at target of an indirect call or jump.</td>
</tr>
<tr>
<td>22-31</td>
<td>-</td>
<td>Intel reserved. Do not use.</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table></div>
<p>‰∏ãÂõæÊèèËø∞‰∫Ü‰∏≠Êñ≠Â§ÑÁêÜÁöÑÂ§ßËá¥ÊµÅÁ®ãÔºö</p>
<p><img src="https://cdn.mazhen.tech/images/202311201727048.png"
	
	
	
	loading="lazy"
	
		alt="Interrupt Handler"
	
	
></p>
<p>ÂºÇÂ∏∏ÊòØÁî± CPU ÊâßË°åÁöÑÊåá‰ª§‰∫ßÁîüÔºå‰∏≠Êñ≠ÊòØÁî±Â§ñÈÉ®ËÆæÂ§áÁöÑÁ¥ßÊÄ•‰∫ã‰ª∂‰∫ßÁîü„ÄÇ</p>
<p>CPU Âú®Êî∂Âà∞‰∏≠Êñ≠ËØ∑Ê±ÇÂêéÔºåÊ†πÊçÆ‰∏≠Êñ≠Âè∑Âú®<strong>‰∏≠Êñ≠ÂêëÈáèË°®</strong>‰∏≠ÊâæÂà∞Áõ∏Â∫îÁöÑ**‰∏≠Êñ≠Â§ÑÁêÜÁ®ãÂ∫èÔºàInterrupt HandlerÔºâ**ÂÖ•Âè£Ôºå‰ªéËÄåÂÅöÂá∫Áõ∏Â∫îÁöÑÂ§ÑÁêÜ„ÄÇ<strong>‰∏≠Êñ≠ÂêëÈáèË°®</strong>Â∞ÜÊØè‰∏™‰∏≠Êñ≠ÊàñÂºÇÂ∏∏‰∏éÂØπÂ∫îÁöÑ‰∏≠Êñ≠Â§ÑÁêÜÁ®ãÂ∫èÂÖ≥ËÅî‰∫ÜËµ∑Êù•„ÄÇ</p>
<p>‰ªé‰∏äÂõæÂèØ‰ª•ÁúãÂá∫Ôºå‰∏≠Êñ≠ÂêëÈáèË°®ÁöÑ 0ÔΩû31Âõ∫ÂÆö‰∏∫ÂºÇÂ∏∏Â§ÑÁêÜÔºå32ÔΩû127 Âíå 129ÔΩû238 È°πÁî®Êù•Â§ÑÁêÜÂ§ñÈÉ® I/O ËÆæÂ§áÁöÑËØ∑Ê±Ç„ÄÇ <strong>PIC</strong> ‰ºöÂ∞Ü <strong>IRQ</strong> ÁºñÂè∑ËΩ¨Êç¢‰∏∫<strong>‰∏≠Êñ≠ÂêëÈáè</strong>„ÄÇ</p>
<p>ÂΩìÁ≥ªÁªüÊî∂Âà∞‰∏≠Êñ≠ËØ∑Ê±ÇÊó∂ÔºåÂ¶ÇÊûú‰∏çÂú®ÂÜÖÊ†∏ÊÄÅÔºåÂÖà‰ºö‰ªéÁî®Êà∑ÊÄÅÂàáÊç¢Âà∞ÂÜÖÊ†∏ÊÄÅÔºåÂπ∂Âú®ÂÜÖÊ†∏Ê†à‰∏≠‰øùÂ≠òÂΩìÂâçÁöÑÁä∂ÊÄÅ‰ø°ÊÅØÔºà‰∏ªË¶ÅÊòØÂØÑÂ≠òÂô®‰ø°ÊÅØÔºâ„ÄÇ</p>
<p>Êé•ÁùÄ‰ΩøÁî®‰∏≠Êñ≠ÂêëÈáèÂè∑ÔºåÂú®‰∏≠Êñ≠ÂêëÈáèË°®‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑÂ§ÑÁêÜ‰ª£Á†ÅÁöÑÂÖ•Âè£Âú∞ÂùÄ„ÄÇÁÑ∂ÂêéÁ≥ªÁªüË∑≥ËΩ¨Âà∞Ëøô‰∏™Âú∞ÂùÄÔºåÊâßË°åÁõ∏Â∫îÁöÑ‰∏≠Êñ≠Â§ÑÁêÜÁ®ãÂ∫è„ÄÇ</p>
<p>Â§ÑÁêÜÂÆåÊàêÂêéÔºåÁ≥ªÁªüÈÄöËøá‰∏≠Êñ≠ËøîÂõûÊú∫Âà∂ÊÅ¢Â§çË¢´‰∏≠Êñ≠‰ªªÂä°ÁöÑÁé∞Âú∫ÔºàÂÜÖÊ†∏ÊÄÅÊàñÁî®Êà∑ÊÄÅÔºâÔºåÂπ∂ÁªßÁª≠ÊâßË°åÂéüÊù•ÁöÑ‰ª£Á†Å„ÄÇ</p>
<p>‰∏≠Êñ≠Â§ÑÁêÜÁöÑ‰∏Ä‰∏™ÂÖ≥ÈîÆÊ≠•È™§ÊòØÔºå<strong>‰øùÁïô‰∏≠Êñ≠ÂèëÁîüÊó∂ÁöÑÁé∞Âú∫‰ø°ÊÅØ</strong>Ôºåperf ÁöÑ CPU ÈááÊ†∑ÂäüËÉΩÊ≠£ÊòØÂà©Áî®‰∫ÜËøô‰∏ÄÁÇπ„ÄÇ</p>
<p>Êàë‰ª¨‰ΩøÁî® <code>perf record</code> ËøõË°å CPU ÂàÜÊûêÊó∂Ôºå‰ºöÈÄöËøá <strong>-F</strong> ÊåáÂÆöÈááÊ†∑È¢ëÁéá„ÄÇÂΩìËææÂà∞È¢ÑËÆæÁöÑÈòàÂÄºÔºàÂ¶Ç‰∏ÄÂÆöÊï∞ÈáèÁöÑÊåá‰ª§ÊâßË°åÊàñÁâπÂÆöÊó∂Èó¥Èó¥ÈöîÔºâÔºåÁ°¨‰ª∂ÊÄßËÉΩËÆ°Êï∞Âô®‰ºöËß¶Âèë‰∏Ä‰∏™ <strong>PMI</strong> ÔºàPerformance monitoring interruptsÔºâ‰∏≠Êñ≠„ÄÇ</p>
<p><strong>PMI</strong> ÊòØ‰∏™‰ªÄ‰πàÁ±ªÂûãÁöÑ‰∏≠Êñ≠Âë¢Ôºü‰∏ÄËà¨ <strong>PMI</strong> ÊòØÁî±Êú¨Âú∞ <strong>APIC</strong>Ôºà <em>Advanced</em> PICÔºâ‰∫ßÁîüÔºåËÄå APIC Êé•ÂÖ• CPU ÁöÑ <strong>INTR</strong> ÂºïËÑöÔºå‰Ω†ÂèØËÉΩËßâÂæóÂÆÉÊòØ‰∏Ä‰∏™ÂèØÂ±èËîΩ‰∏≠Êñ≠„ÄÇ‰ΩÜÊ†πÊçÆ<a class="link" href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html"  target="_blank" rel="noopener"
    >Intel&rsquo;s Software Development Manual: System Programming Guide</a> Ôºå<strong>ÈùûÂ±èËîΩ‰∏≠Êñ≠ (NMI)</strong> ÂèØÈÄöËøá‰∏§ÁßçÊñπÂºèÁîüÊàêÔºö</p>
<ul>
<li>Â§ñÈÉ®Á°¨‰ª∂ÊøÄÊ¥ª CPU ÁöÑ <strong>NMI</strong> ÂºïËÑö</li>
<li>CPU ÈÄöËøáÁ≥ªÁªüÊÄªÁ∫øÊàñ APIC ‰∏≤Ë°åÊÄªÁ∫øÊé•Êî∂‰∏ÄÊù°ÂåÖÂê´ <strong>NMI</strong> ‰º†ÈÄíÊ®°ÂºèÁöÑÊ∂àÊÅØ</li>
</ul>
<p>‰πüÂ∞±ÊòØËØ¥ÔºåAPIC ÂèØ‰ª•ÁîüÊàê <strong>NMI</strong> Ê®°ÂºèÁöÑ‰∏≠Êñ≠Ê∂àÊÅØÔºå‰ª•Ë∞ÉÁî® NMI ‰∏≠Êñ≠Â§ÑÁêÜÁ®ãÂ∫è„ÄÇ</p>
<p>Áî±‰∫é <strong>NMI</strong> Êó†Ê≥ïË¢´ÂøΩÁï•ÔºåÂÆÉ‰ª¨Â∏∏Ë¢´‰∏Ä‰∫õÁ≥ªÁªüÁî®‰ΩúÁ°¨‰ª∂ÁõëÊéßÂ∑•ÂÖ∑„ÄÇÂ¶ÇÊûúÂá∫Áé∞Êüê‰∫õÁâπÂÆöÊÉÖÂÜµÔºåÊØîÂ¶ÇÂú®È¢ÑÂÆöÁöÑÊó∂Èó¥ÂÜÖÊ≤°ÊúâËß¶Âèë‰∏≠Êñ≠ÔºåNMI Â§ÑÁêÜÁ®ãÂ∫èÂ∞±‰ºö‰∫ßÁîüË≠¶ÂëäÂπ∂Êèê‰æõÂÖ≥‰∫éËØ•ÈóÆÈ¢òÁöÑË∞ÉËØï‰ø°ÊÅØ„ÄÇËøôÁßçÊú∫Âà∂ÊúâÂä©‰∫éÂèëÁé∞Âπ∂È¢ÑÈò≤Á≥ªÁªüÊ≠ªÈîÅ„ÄÇ</p>
<p>Á°¨‰ª∂ÊÄßËÉΩËÆ°Êï∞Âô®Ëß¶ÂèëÁöÑ <strong>PMI</strong> ‰∏≠Êñ≠Ë¢´ËÆæÁΩÆ‰∏∫‰∫Ü <strong>NMI</strong>Á±ªÂûã„ÄÇÊàë‰ª¨‰ª• x86 Âπ≥Âè∞‰∏∫‰æãÔºåÂΩì <strong>PMI</strong> ‰∏≠Êñ≠ÂèëÁîüÊó∂ÔºåÂ§ÑÁêÜÂÖ•Âè£‰ΩçÁΩÆÂú® <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/entry/entry_64.S"  target="_blank" rel="noopener"
    >arch/x86/entry/entry_64.S</a>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">SYM_CODE_START</span><span class="p">(</span><span class="no">asm_exc_nmi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="na">...</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">5</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;ss */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">4</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;rsp */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">3</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;flags */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">2</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;cs */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>	<span class="mi">1</span><span class="p">*</span><span class="mi">8</span><span class="p">(</span><span class="nv">%rdx</span><span class="p">)</span>	<span class="cm">/* pt_regs-&gt;rip */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">UNWIND_HINT_IRET_REGS</span>
</span></span><span class="line"><span class="cl">	<span class="nf">pushq</span>   <span class="no">$-1</span>		<span class="cm">/* pt_regs-&gt;orig_ax */</span>
</span></span><span class="line"><span class="cl">	<span class="na">...</span>
</span></span><span class="line"><span class="cl">	<span class="nf">movq</span>	<span class="nv">%rsp</span><span class="p">,</span> <span class="nv">%rdi</span>
</span></span><span class="line"><span class="cl">	<span class="nf">movq</span>	<span class="no">$-1</span><span class="p">,</span> <span class="nv">%rsi</span>
</span></span><span class="line"><span class="cl">	<span class="nf">call</span>	<span class="no">exc_nmi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/entry/entry_64.S"  target="_blank" rel="noopener"
    >arch/x86/entry/entry_64.S</a>ÊòØÁî®Ê±áÁºñËØ≠Ë®ÄÁºñÂÜôÔºåË¥üË¥£Á≥ªÁªüË∞ÉÁî®„ÄÅ‰∏≠Êñ≠ÂºÇÂ∏∏Â§ÑÁêÜ„ÄÅ‰ªªÂä°ÂàáÊç¢Âíå‰ø°Âè∑Â§ÑÁêÜÔºå‰∏ìÈó®ÈíàÂØπ x86_64 Êû∂ÊûÑËøõË°å‰∫Ü‰ºòÂåñ„ÄÇ</p>
<p><code>asm_exc_nmi</code> ÂáΩÊï∞ÊòØÂ§ÑÁêÜ <strong>NMI</strong> ÁöÑÂÖ•Âè£Ôºå‰ªéÊà™Âèñ‰ª£Á†ÅÁâáÊÆµÁöÑÊ≥®ÈáäÂèØ‰ª•ÁúãÂá∫Ôºå <code>asm_exc_nmi</code> ‰ºö‰ΩøÁî® <code>pushq</code> Êåá‰ª§Â∞ÜÂΩìÂâçÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅ‰øùÂ≠òÂà∞ÂÜÖÊ†∏Ê†à‰∏äÔºåËøô‰∫õÂåÖÊã¨Á®ãÂ∫èËÆ°Êï∞Âô®Ôºà<strong>rip</strong>Ôºå‰πüÂ∞±ÊòØ PC ÂØÑÂ≠òÂô®Ôºâ„ÄÅ‰ª£Á†ÅÊÆµÔºà<strong>cs</strong>Ôºâ„ÄÅÊ†áÂøóÔºà<strong>flags</strong>Ôºâ„ÄÅÂ†ÜÊ†àÊåáÈíàÔºà<strong>rsp</strong>ÔºâÂíåÂ†ÜÊ†àÊÆµÔºà<strong>ss</strong>Ôºâ„ÄÇËøô‰∏ÄÊ≠•ÈùûÂ∏∏ÂÖ≥ÈîÆÔºå‰øùÁïô‰∏≠Êñ≠ÂèëÁîüÊó∂ÁöÑÁé∞Âú∫‰ø°ÊÅØ„ÄÇÊúÄÂêé‰ΩøÁî®**<code>call exc_nmi</code>** Êåá‰ª§Ë∞ÉÁî® <code>exc_nmi</code> ÂáΩÊï∞„ÄÇ<code>exc_nmi</code> ‰ºöÊ†πÊçÆÁ±ªÂûãÔºåË∞ÉÁî®È¢ÑÂÖàÊ≥®ÂÜåÁöÑ NMI Â§ÑÁêÜÂáΩÊï∞„ÄÇ</p>
<p>Â¶ÇÊûúÊòØ <strong>PMI</strong> Á±ªÂûãÁöÑ‰∏≠Êñ≠ÔºåÊúÄÁªàË∞ÉÁî®ÁöÑÂ§ÑÁêÜÂáΩÊï∞ÊòØ <strong>perf_event_nmi_handler</strong> ÔºåÂÆö‰πâÂú® <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/events/core.c#L1729"  target="_blank" rel="noopener"
    >arch/x86/events/core.c</a>‰∏≠Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="nf">perf_event_nmi_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">start_clock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">finish_clock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * All PMUs/events that share this PMI handler should make sure to
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * increment active_events for their events.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">active_events</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">NMI_DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">start_clock</span> <span class="o">=</span> <span class="nf">sched_clock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">ret</span> <span class="o">=</span> <span class="nf">static_call</span><span class="p">(</span><span class="n">x86_pmu_handle_irq</span><span class="p">)(</span><span class="n">regs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">finish_clock</span> <span class="o">=</span> <span class="nf">sched_clock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">perf_sample_event_took</span><span class="p">(</span><span class="n">finish_clock</span> <span class="o">-</span> <span class="n">start_clock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂèØ‰ª•ÁúãÂà∞ÔºåÁ¨¨‰∫å‰∏™ÂèÇÊï∞ <strong>pt_regs</strong> Âú®ÂâçÈù¢‰ªãÁªçÁ≥ªÁªüË∞ÉÁî®Êó∂Â∑≤ÁªèÂá∫Áé∞ËøáÔºåÊòØÂÜÖÊ†∏Áî®Êù•‰øùÂ≠òÂØÑÂ≠òÂô®Áä∂ÊÄÅÁöÑÁªìÊûÑ‰Ωì„ÄÇËøôÊ†∑Âú®<strong>perf_event_nmi_handler</strong>‰∏≠ÔºåÊàë‰ª¨Â∞±ÂèØ‰ª•‰ΩøÁî® <strong>pt_regs</strong> ‰∏≠‰øùÂ≠òÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅÔºåËøòÂéüÂá∫ <strong>PMI</strong> ‰∏≠Êñ≠ÂèëÁîüÊó∂ÔºåCPU ÂΩìÊó∂ÁöÑÂä®‰ΩúÔºå‰ª•ÂèäÂåÖÂê´‰∫ÜÁî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅÁöÑÂÆåÊï¥‰ª£Á†ÅÊâßË°åË∑ØÂæÑ„ÄÇ</p>
<p>Ëá≥Ê≠§ÔºåÊàë‰ª¨‰∫ÜËß£‰∫Ü perf Âú®ËøõË°å CPU Profiling Êó∂Ê∂âÂèäÁöÑÂÖ®ÈÉ®ÊäÄÊúØÊú∫Âà∂„ÄÇ</p>
<h2 id="ÊÄªÁªì">ÊÄªÁªì</h2>
<p>Áé∞Âú®ÂÜçÂõûÈ°æÊàë‰ª¨‰ΩøÁî® perf ËøõË°å CPU Profiling Êó∂ÁöÑÂëΩ‰ª§Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo perf record -F <span class="m">99</span> -a -g -- sleep <span class="m">30</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>perf ÊòØ‰∫ã‰ª∂È©±Âä®ÁöÑÊñπÂºèÂ∑•‰ΩúÔºåËøô‰∏™ÂëΩ‰ª§Ê≤°ÊúâÊåáÂÆö <strong>-e</strong> ÂèÇÊï∞Ôºå‰ºöÊî∂ÈõÜ‰ªÄ‰πà‰∫ã‰ª∂Âë¢Ôºüperf ‰ºöÈªòËÆ§Êî∂ÈõÜ <strong>cycles</strong> Áõ∏ÂÖ≥‰∫ã‰ª∂Ôºå‰ªéÊúÄÁ≤æÁ°ÆÁöÑ <strong>cycles:ppp</strong> Âà∞Êó†Á≤æÁ°ÆËÆæÁΩÆÁöÑ <strong>cycles</strong>Ôºå‰ºòÂÖàÈÄâÊã©ÂèØÁî®‰∏îÁ≤æÂ∫¶È´òÁöÑ‰∫ã‰ª∂„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÁ°¨‰ª∂ <strong>cycles</strong> ‰∫ã‰ª∂ÂèØÁî®ÔºåÈÄÄËÄåÈÄâÊã© <strong>cpu-clock</strong> ËΩØ‰ª∂‰∫ã‰ª∂„ÄÇ</p>
<p>‰∏∫‰ªÄ‰πàÈááÊ†∑ <strong>cycles</strong> ‰∫ã‰ª∂Â∞±ËÉΩÂàÜÊûêÁ®ãÂ∫èÁöÑ CPU ÊÄßËÉΩÔºüÂõ†‰∏∫ÊØè‰∏™ CPU Âë®ÊúüÈÉΩ‰ºöËß¶Âèë‰∏Ä‰∏™ <strong>cycles</strong> ‰∫ã‰ª∂Ôºå<strong>cycles</strong> ‰∫ã‰ª∂ÂùáÂåÄÁöÑÂàÜÂ∏ÉÂú®Á®ãÂ∫èÁöÑÊâßË°åÊúüÈó¥Ôºå‰ª•Âõ∫ÂÆöÈ¢ëÁéáÈááÊ†∑ÁöÑ <strong>cycles</strong> ‰∫ã‰ª∂ÂêåÊ†∑ÂùáÂåÄÂàÜÂ∏ÉÔºåÂ¶ÇÊûúÊàë‰ª¨Âú®ÈááÊ†∑ <strong>cycles</strong> ‰∫ã‰ª∂Êó∂ÔºåËÆ∞ÂΩï CPU Ê≠£Âú®Âπ≤‰ªÄ‰πàÔºåÊåÅÁª≠‰∏ÄÊÆµÊó∂Èó¥Êî∂ÈõÜÂà∞Â§ö‰∏™ÈááÊ†∑ÂêéÔºåÂ∞±ËÉΩÂü∫‰∫éËøô‰∫õ‰ø°ÊÅØÂàÜÊûêÁ®ãÂ∫èÁöÑË°å‰∏∫ÔºåÂ§öÊ¨°Âá∫Áé∞ÁöÑÂêåÊ†∑Âä®‰ΩúÔºåÂ∞±ÂèØ‰ª•ËÆ§‰∏∫ÊòØÁ®ãÂ∫èÁöÑÁÉ≠ÁÇπ„ÄÇ</p>
<p>Â¶ÇÊûúÊåáÂÆöÈááÊ†∑È¢ëÁéáÔºü<strong>-F 99</strong> ËÆæÁΩÆÈááÊ†∑È¢ëÁéá‰∏∫ 99 HertzÔºåÂç≥ÊØèÁßíËøõË°å 99 Ê¨°ÈááÊ†∑„ÄÇ‰πüÂèØ‰ª•‰ΩøÁî® **-c 1000 ** ËÆæÁΩÆÈááÊ†∑Âë®ÊúüÔºåÂç≥ÊØèÈöî 1000 Ê¨°‰∫ã‰ª∂ËøõË°å‰∏ÄÊ¨°ÈááÊ†∑„ÄÇ</p>
<p>Â¶ÇÊûúÁü•ÈÅìÈááÊ†∑Êó∂ CPU Ê≠£Âú®ÂÅö‰ªÄ‰πàÔºüÈÄöËøáCPU ÁöÑ <strong>PCÔºàProgram CounterÔºâÂØÑÂ≠òÂô®</strong>Ôºàx86-64 Âπ≥Âè∞‰∏äÂØπÂ∫îÁöÑÊòØ <strong>rip</strong> ÂØÑÂ≠òÂô®Ôºâ„ÄÅÊåá‰ª§ÂØÑÂ≠òÂô®Á≠âÁä∂ÊÄÅ‰ø°ÊÅØÔºåËÉΩÊé®Êñ≠Âá∫ CPU ÁöÑÁû¨Êó∂Âä®‰Ωú„ÄÇ</p>
<p>Áü•ÈÅì‰∫Ü CPU ÈááÊ†∑Êó∂ÁöÑ‚ÄúÂä®‰Ωú‚ÄùËøò‰∏çÂ§üÔºåËøòÈúÄË¶ÅÁü•ÈÅì CPU ÊòØÊÄé‰πàÂÅöËøô‰∏™‚ÄúÂä®‰Ωú‚ÄùÁöÑÔºå‰πüÂ∞±ÊòØ‰ª£Á†ÅÁöÑÊâßË°åË∑ØÂæÑ„ÄÇÁ≥ªÁªüÂà©Áî®‰∫Ü<strong>Â†ÜÊ†àÔºàStackÔºâ<strong>ÁöÑ</strong>ÂêéËøõÂÖàÂá∫ÔºàLIFOÔºâ<strong>ÂÆûÁé∞‰∫ÜÂáΩÊï∞Ë∞ÉÁî®ÔºåÊØè‰∏™ÂáΩÊï∞Âú®Â†ÜÊ†à‰∏äÂàÜÈÖçÁöÑÁ©∫Èó¥Áß∞‰∏∫</strong>Ê†àÂ∏ßÔºàstack frameÔºâ</strong>ÔºåÂ§ö‰∏™<strong>Ê†àÂ∏ßÔºàstack frameÔºâ<strong>ÁªÑÊàê <a class="link" href="https://en.wikipedia.org/wiki/Call_stack"  target="_blank" rel="noopener"
    >Call stack</a>Ôºå‰ΩìÁé∞Âá∫‰∫ÜÂáΩÊï∞ÁöÑË∞ÉÁî®ÂÖ≥Á≥ª„ÄÇÈÄöËøáÊ†àÂ∏ßÊåáÈíà</strong>Frame Pointer</strong>Ôºà<strong>rbp</strong> ÂØÑÂ≠òÂô®ÔºâÔºåÂèØ‰ª•ËøΩÊ∫ØÊï¥‰∏™Ë∞ÉÁî®ÈìæÔºåÈÄêÁ∫ßËÆøÈóÆÂà∞ÊØè‰∏™Ë∞ÉÁî®ËÄÖÁöÑ<strong>Ê†àÂ∏ßÔºàstack frameÔºâ</strong>ÔºåÈáçÊûÑÂá∫Á®ãÂ∫èÊâßË°åÁöÑË∑ØÂæÑ„ÄÇËøôÂ∞±ÊòØ <strong>-g</strong> ÂèÇÊï∞ÁöÑ‰ΩúÁî®Ôºö‰ΩøÁî® <strong>Frame Pointer</strong> ËøòÂéüË∞ÉÁî®Ê†à„ÄÇ</p>
<p>Êìç‰ΩúÁ≥ªÁªü‰∏∫‰∫ÜÂÆâÂÖ®‰ºöÈôêÂà∂Áî®Êà∑ËøõÁ®ãÂØπÂÖ≥ÈîÆËµÑÊ∫êÁöÑËÆøÈóÆÔºåÂ∞ÜÁ≥ªÁªüÂàÜ‰∏∫‰∫ÜÁî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅÔºåÁî®Êà∑ÊÄÅÁöÑ‰ª£Á†ÅÂøÖÈ°ªÈÄöËøá**Á≥ªÁªüË∞ÉÁî®Ôºàsystem call Ôºâ**ËÆøÈóÆÊ†∏ÂøÉËµÑÊ∫ê„ÄÇÊâÄ‰ª•Âú®ÊâßË°åÁ≥ªÁªüË∞ÉÁî®Êó∂ÔºåËøõÁ®ãÂÖ∑Êúâ‰∏§‰∏™Ê†àÔºö<strong>Áî®Êà∑Ê†àÔºàUser StackÔºâ<strong>Âíå</strong>ÂÜÖÊ†∏Ê†àÔºàKernel StackÔºâ</strong>„ÄÇ‰∏∫‰∫ÜËøòÂéüÂåÖÂê´‰∫ÜÁî®Êà∑Ê†àÂíåÂÜÖÊ†∏Ê†àÂú®ÂÜÖÂÆåÊï¥ÁöÑË∞ÉÁî®Ê†àÔºåÊàë‰ª¨Êé¢Á¥¢‰∫ÜËøõÁ®ãËôöÊãüÂú∞ÂùÄÁ©∫Èó¥ÁöÑÂ∏ÉÂ±ÄÔºå‰ª•ÂèäÁ≥ªÁªüË∞ÉÁî®ÁöÑÂÆûÁé∞ÔºöÂéüÊù•Âú®Á≥ªÁªüË∞ÉÁî®Êó∂Ôºå‰ºöÂ∞ÜËøõÁ®ãÁî®Êà∑ÊÄÅÁöÑÊâßË°åÁä∂ÊÄÅÔºà<strong>rsp</strong>„ÄÅ<strong>rip</strong>Á≠âÂØÑÂ≠òÂô®Ôºâ‰øùÂ≠òÂú®ÂÜÖÊ†∏Êï∞ÊçÆÁªìÊûÑ <a class="link" href="https://elixir.bootlin.com/linux/v6.6.1/source/arch/x86/include/asm/ptrace.h#L59"  target="_blank" rel="noopener"
    >struct pt_regs</a> ÂÜÖÔºåËøôÊ†∑Â∞±ËÉΩÈÄöËøá <strong>Frame Pointer</strong> Âíå <strong>pt_regs</strong> ÂàÜÂà´ËøòÂéüÂÜÖÊ†∏Ê†àÂíåÁî®Êà∑Ê†à„ÄÇ</p>
<p>ÊÄé‰πàËé∑ÂèñÈááÊ†∑ÂèëÁîüÊó∂Âàª CPU ÂØÑÂ≠òÂô®ÁöÑÂÜÖÂÆπÂë¢ÔºüÂú®ÁâπÂÆöÁöÑÊó∂Èó¥Èó¥ÈöîÂà∞ËææÊó∂Ôºå‰πüÂ∞±ÊòØËØ•ÈááÊ†∑ÁöÑÊó∂ÂàªÔºåAPIC ‰ºöËß¶Âèë <strong>PMI</strong> ‰∏≠Êñ≠ÔºåCPU Âú®Â∞ÜÊéßÂà∂ÊùÉËΩ¨Áªô‰∏≠Êñ≠Â§ÑÁêÜÁ®ãÂ∫è‰πãÂâçÔºåÂ∞ÜÂΩìÂâçÁöÑÂØÑÂ≠òÂô®Áä∂ÊÄÅ‰øùÂ≠òÂà∞<strong>pt_regs</strong>ÔºåÁÑ∂Âêé‰Ωú‰∏∫ÂèÇÊï∞‰º†ÈÄíÁªô <strong>perf_event_nmi_handler</strong>„ÄÇËøôÊ†∑ perf Â∞±ÊãøÂà∞‰∫ÜÈááÊ†∑ÂèëÁîüÊó∂ÂàªÔºåCPU ÂØÑÂ≠òÂô®ÁöÑÂÜÖÂÆπ„ÄÇ</p>
<p>ÊúÄÂêéÔºåÊàë‰ª¨ÂèØ‰ª•Áúã‰∏Ä‰∏ã <code>perf record</code> Êî∂ÈõÜ‰∫Ü‰ªÄ‰πàÊ†∑ÁöÑÊï∞ÊçÆ„ÄÇ‰ΩøÁî® <code>perf script</code> ÂëΩ‰ª§ÂèØ‰ª•ÊâìÂç∞Êî∂ÈõÜÂú® <code>perf.data</code> ‰∏≠ÁöÑÊØè‰∏™Ê†∑Êú¨Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo perf script
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">sshd <span class="m">50588</span> 430947.269426:      <span class="m">16854</span> cycles: 
</span></span><span class="line"><span class="cl">        ffffffff824b84f6 native_write_msr+0x6 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff82413dc5 intel_pmu_enable_all+0x15 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff82407abb x86_pmu_enable+0x1ab <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8273d05a perf_ctx_enable+0x3a <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8274646a __perf_event_task_sched_in+0x15a <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff82534bf9 finish_task_switch.isra.0+0x179 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834a57bf __schedule+0x2bf <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834a5b68 schedule+0x68 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834ac3cb schedule_hrtimeout_range_clock+0x11b <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834ac403 schedule_hrtimeout_range+0x13 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8289de3a do_poll.constprop.0+0x22a <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8289e136 do_sys_poll+0x166 <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff8289e7cc __x64_sys_ppoll+0xbc <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff834931ac do_syscall_64+0x5c <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">        ffffffff836000eb entry_SYSCALL_64+0xab <span class="o">(</span>/usr/lib/debug/boot/vmlinux-6.2.0-36-generic<span class="o">)</span>
</span></span><span class="line"><span class="cl">                  118e5f __ppoll+0x4f <span class="o">(</span>inlined<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   89a97 server_loop2.constprop.0+0x547 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   89a97 wait_until_can_do_something+0x547 <span class="o">(</span>inlined<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   89a97 server_loop2.constprop.0+0x547 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   2bcf7 do_authenticated2+0x1e7 <span class="o">(</span>inlined<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   2bcf7 do_authenticated+0x1e7 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   11b66 main+0x3616 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   29d8f __libc_start_call_main+0x7f <span class="o">(</span>/usr/lib/x86_64-linux-gnu/libc.so.6<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   29e3f __libc_start_main_impl+0x7f <span class="o">(</span>inlined<span class="o">)</span>
</span></span><span class="line"><span class="cl">                   <span class="m">12844</span> _start+0x24 <span class="o">(</span>/usr/sbin/sshd<span class="o">)</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ªªÊÑèÊà™Âèñ‰∫ÜÂÖ∂‰∏≠‰∏ÄÊÆµËæìÂá∫ÔºåÂèØ‰ª•ÁúãÂà∞ÂåÖÂê´‰∫ÜÁî®Êà∑ÊÄÅÂíåÂÜÖÊ†∏ÊÄÅÂÆåÊï¥ÁöÑË∞ÉÁî®Ê†à„ÄÇÂü∫‰∫éÂ§ö‰∏™ËøôÊ†∑ÁöÑ‰ª£Á†ÅÊâßË°åË∑ØÂæÑÔºåÊàë‰ª¨ËøòËÉΩÁîüÊàê<a class="link" href="https://brendangregg.com/flamegraphs.html"  target="_blank" rel="noopener"
    >ÁÅ´ÁÑ∞Âõæ</a>Ëøõ‰∏ÄÊ≠•ËøõË°åÂàÜÊûê„ÄÇ</p>
<p>‰∏∫‰∫Ü‰∫ÜËß£ <code>perf record</code> ÁöÑÂÆûÁé∞ÂéüÁêÜÔºåÊàë‰ª¨Âú® Linux ÂÜÖÊ†∏ËøõË°å‰∫Ü‰∏ÄÊÆµÊ∑±ÂÖ•ËÄåÂà∫ÊøÄÁöÑÊóÖÁ®ãÔºåÊÑüË∞¢ÂêÑ‰ΩçÂèÇ‰∏éÊé¢Èô©ÔºÅ</p>
<p>ÊàëÁöÑÂçöÂÆ¢Âç≥Â∞ÜÂêåÊ≠•Ëá≥ËÖæËÆØ‰∫ëÂºÄÂèëËÄÖÁ§æÂå∫ÔºåÈÇÄËØ∑Â§ßÂÆ∂‰∏ÄÂêåÂÖ•È©ªÔºöhttps://cloud.tencent.com/developer/support-plan?invite_code=1k39tbi20c30f</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/linux/">Linux</a>
        
            <a href="/tags/kernel/">Kernel</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Áõ∏ÂÖ≥ÊñáÁ´†</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/%E4%BB%8E%E6%BA%90%E7%A0%81%E6%9E%84%E5%BB%BA-perf/">
        
        

        <div class="article-details">
            <h2 class="article-title">‰ªéÊ∫êÁ†ÅÊûÑÂª∫ perf</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/linux-gnu/linux%E4%BB%A5%E5%8F%8Aalpine-linux/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linux, GNU/Linux‰ª•ÂèäAlpine Linux</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/">
        
        

        <div class="article-details">
            <h2 class="article-title">Ê∑±ÂÖ•ÊµÖÂá∫ÂÆπÂô®ÊäÄÊúØ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/gcc-%E4%B8%BA%E9%BE%99%E8%8A%AF-cpu%E7%9A%84%E9%A2%84%E5%AE%9A%E4%B9%89%E5%AE%8F/">
        
        

        <div class="article-details">
            <h2 class="article-title">GCC ‰∏∫ÈæôËäØ CPUÁöÑÈ¢ÑÂÆö‰πâÂÆè</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/linux-%E4%BF%A1%E5%8F%B7signal/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linux ‰ø°Âè∑(Signal)</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mazhen-tech" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2014 - 
        
        2024 mazhen.tech
    </section>
    
    <section class="powerby">
        
            <a target=\"_blank\" href=\"https://beian.miit.gov.cn\">Á≤§ICPÂ§á2022085181Âè∑-1</a> <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
