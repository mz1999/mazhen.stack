<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÂØπÂ∫îÁî®ÂºÄÂèëÂ∑•Á®ãÂ∏àÊù•ËØ¥Â∞±ÂÉè‰∏Ä‰∏™ÈªëÁõíÔºå‰ºº‰πéÂæàÈöæÁ™•Êé¢Âà∞ÂÖ∂ÂÜÖÈÉ®ÁöÑËøêË°åÊú∫Âà∂„ÄÇÂÖ∂ÂÆûLinuxÂÜÖÊ†∏ÂæàÊó©Â∞±ÂÜÖÁΩÆ‰∫Ü‰∏Ä‰∏™Âº∫Â§ßÁöÑtracingÂ∑•ÂÖ∑ÔºöF'>
<title>‰ªéFtraceÂºÄÂßãÂÜÖÊ†∏Êé¢Á¥¢‰πãÊóÖ</title>

<link rel='canonical' href='https://mazhen.tech/p/%E4%BB%8Eftrace%E5%BC%80%E5%A7%8B%E5%86%85%E6%A0%B8%E6%8E%A2%E7%B4%A2%E4%B9%8B%E6%97%85/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='‰ªéFtraceÂºÄÂßãÂÜÖÊ†∏Êé¢Á¥¢‰πãÊóÖ'>
<meta property='og:description' content='Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÂØπÂ∫îÁî®ÂºÄÂèëÂ∑•Á®ãÂ∏àÊù•ËØ¥Â∞±ÂÉè‰∏Ä‰∏™ÈªëÁõíÔºå‰ºº‰πéÂæàÈöæÁ™•Êé¢Âà∞ÂÖ∂ÂÜÖÈÉ®ÁöÑËøêË°åÊú∫Âà∂„ÄÇÂÖ∂ÂÆûLinuxÂÜÖÊ†∏ÂæàÊó©Â∞±ÂÜÖÁΩÆ‰∫Ü‰∏Ä‰∏™Âº∫Â§ßÁöÑtracingÂ∑•ÂÖ∑ÔºöF'>
<meta property='og:url' content='https://mazhen.tech/p/%E4%BB%8Eftrace%E5%BC%80%E5%A7%8B%E5%86%85%E6%A0%B8%E6%8E%A2%E7%B4%A2%E4%B9%8B%E6%97%85/'>
<meta property='og:site_name' content='mazhen.tech'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='linux' /><meta property='article:tag' content='kernel' /><meta property='article:published_time' content='2021-06-21T11:44:02&#43;08:00'/><meta property='article:modified_time' content='2021-06-21T11:44:02&#43;08:00'/>
<meta name="twitter:site" content="@mazhen">
    <meta name="twitter:creator" content="@mazhen"><meta name="twitter:title" content="‰ªéFtraceÂºÄÂßãÂÜÖÊ†∏Êé¢Á¥¢‰πãÊóÖ">
<meta name="twitter:description" content="Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÂØπÂ∫îÁî®ÂºÄÂèëÂ∑•Á®ãÂ∏àÊù•ËØ¥Â∞±ÂÉè‰∏Ä‰∏™ÈªëÁõíÔºå‰ºº‰πéÂæàÈöæÁ™•Êé¢Âà∞ÂÖ∂ÂÜÖÈÉ®ÁöÑËøêË°åÊú∫Âà∂„ÄÇÂÖ∂ÂÆûLinuxÂÜÖÊ†∏ÂæàÊó©Â∞±ÂÜÖÁΩÆ‰∫Ü‰∏Ä‰∏™Âº∫Â§ßÁöÑtracingÂ∑•ÂÖ∑ÔºöF">
    <link rel="shortcut icon" href="/favicon.png" />

<script async src="https://www.googletagmanager.com/gtag/js?id=G-LBEVB8TRX2"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LBEVB8TRX2', { 'anonymize_ip': false });
}
</script>

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/mazhen_hu6e56901738cd7f8ddabbbe3def51a5b4_111611_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">mazhen.tech</a></h1>
            <h2 class="site-description">Stay hungry. Stay foolish.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='mailto:me@mazhen.tech'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="3" y="5" width="18" height="14" rx="2" />
  <polyline points="3 7 12 13 21 7" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/mz1999'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.instagram.com/sword_holder/'
                        target="_blank"
                        title="instagram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-instagram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="4" y="4" width="16" height="16" rx="4" />
  <circle cx="12" cy="12" r="3" />
  <line x1="16.5" y1="7.5" x2="16.5" y2="7.501" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://t.me/sword_holder'
                        target="_blank"
                        title="telegram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-telegram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/mazhen'
                        target="_blank"
                        title="twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://mazhen.tech/" selected>‰∏≠Êñá</option>
                        
                            <option value="https://mazhen.tech/en/" >English</option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>ÊöóËâ≤Ê®°Âºè</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ftraceÂàù‰ΩìÈ™å">FtraceÂàù‰ΩìÈ™å</a></li>
    <li><a href="#tracefs-Êñá‰ª∂Á≥ªÁªü">tracefs Êñá‰ª∂Á≥ªÁªü</a></li>
    <li><a href="#ÂáΩÊï∞Ë∑üË∏™">ÂáΩÊï∞Ë∑üË∏™</a></li>
    <li><a href="#ftrace-function_graph">Ftrace function_graph</a></li>
    <li><a href="#ÂáΩÊï∞profiler">ÂáΩÊï∞Profiler</a></li>
    <li><a href="#ËøΩË∏™ÁÇπ-tracepoints">ËøΩË∏™ÁÇπ Tracepoints</a></li>
    <li><a href="#Âà©Áî®-tracepoints-ÁêÜËß£ÂÜÖÊ†∏‰ª£Á†Å">Âà©Áî® Tracepoints ÁêÜËß£ÂÜÖÊ†∏‰ª£Á†Å</a></li>
    <li><a href="#ÂÜôÂú®ÊúÄÂêé">ÂÜôÂú®ÊúÄÂêé</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tech/" >
                tech
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E4%BB%8Eftrace%E5%BC%80%E5%A7%8B%E5%86%85%E6%A0%B8%E6%8E%A2%E7%B4%A2%E4%B9%8B%E6%97%85/">‰ªéFtraceÂºÄÂßãÂÜÖÊ†∏Êé¢Á¥¢‰πãÊóÖ</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2021-06-21</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 11 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>Êìç‰ΩúÁ≥ªÁªüÂÜÖÊ†∏ÂØπÂ∫îÁî®ÂºÄÂèëÂ∑•Á®ãÂ∏àÊù•ËØ¥Â∞±ÂÉè‰∏Ä‰∏™ÈªëÁõíÔºå‰ºº‰πéÂæàÈöæÁ™•Êé¢Âà∞ÂÖ∂ÂÜÖÈÉ®ÁöÑËøêË°åÊú∫Âà∂„ÄÇÂÖ∂ÂÆûLinuxÂÜÖÊ†∏ÂæàÊó©Â∞±ÂÜÖÁΩÆ‰∫Ü‰∏Ä‰∏™Âº∫Â§ßÁöÑtracingÂ∑•ÂÖ∑Ôºö<a class="link" href="https://www.kernel.org/doc/html/latest/trace/ftrace.html"  target="_blank" rel="noopener"
    >Ftrace</a>ÔºåÂÆÉÂá†‰πéÂèØ‰ª•Ë∑üË∏™ÂÜÖÊ†∏ÁöÑÊâÄÊúâÂáΩÊï∞Ôºå‰∏ç‰ªÖÂèØ‰ª•Áî®‰∫éË∞ÉËØïÂíåÂàÜÊûêÔºåËøòÂèØ‰ª•Áî®‰∫éËßÇÂØüÂ≠¶‰π†LinuxÂÜÖÊ†∏ÁöÑÂÜÖÈÉ®ËøêË°å„ÄÇËôΩÁÑ∂<code>Ftrace</code>Âú®<a class="link" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=16444a8a40d4c7b4f6de34af0cae1f76a4f6c901"  target="_blank" rel="noopener"
    >2008Âπ¥Â∞±Âä†ÂÖ•‰∫ÜÂÜÖÊ†∏</a>Ôºå‰ΩÜÂæàÂ§öÂ∫îÁî®ÂºÄÂèëÂ∑•Á®ãÂ∏à‰ªçÁÑ∂‰∏çÁü•ÈÅìÂÆÉÁöÑÂ≠òÂú®„ÄÇÊú¨ÊñáÂ∞±Áªô‰Ω†‰ªãÁªç‰∏Ä‰∏ã<code>Ftrace</code>ÁöÑÂü∫Êú¨‰ΩøÁî®„ÄÇ</p>
<h2 id="ftraceÂàù‰ΩìÈ™å">FtraceÂàù‰ΩìÈ™å</h2>
<p>ÂÖàÁî®‰∏Ä‰∏™‰æãÂ≠ê‰ΩìÈ™å‰∏Ä‰∏ã<code>Ftrace</code>ÁöÑ‰ΩøÁî®ÁÆÄÂçïÔºå‰∏îÂäüËÉΩÂº∫Â§ß„ÄÇ‰ΩøÁî® root Áî®Êà∑ËøõÂÖ•<code>/sys/kernel/debug/tracing</code>ÁõÆÂΩïÔºåÊâßË°å <code>echo</code> Âíå <code>cat</code> ÂëΩ‰ª§Ôºö</p>
<pre><code>
# <b>echo _do_fork > set_graph_function</b>
# <b>echo function_graph > current_tracer</b>
# <b>cat trace | head -20</b>
# tracer: function_graph
#
# CPU  DURATION                  FUNCTION CALLS
# |     |   |                     |   |   |   |
 3)               |  _do_fork() {
 3)               |    copy_process() {
 3)   0.895 us    |      _raw_spin_lock_irq();
 3)               |      recalc_sigpending() {
 3)   0.740 us    |        recalc_sigpending_tsk();
 3)   2.248 us    |      }
 3)               |      dup_task_struct() {
 3)   0.775 us    |        tsk_fork_get_node();
 3)               |        kmem_cache_alloc_node() {
 3)               |          _cond_resched() {
 3)   0.740 us    |            rcu_all_qs();
 3)   2.117 us    |          }
 3)   0.701 us    |          should_failslab();
 3)   2.023 us    |          memcg_kmem_get_cache();
 3)   0.889 us    |          memcg_kmem_put_cache();
 3) + 12.206 us   |        }
</code></pre>
<p>Êàë‰ª¨‰ΩøÁî®<code>Ftrace</code>ÁöÑ<code>function_graph</code>ÂäüËÉΩÊòæÁ§∫‰∫ÜÂÜÖÊ†∏ÂáΩÊï∞ <code>_do_fork()</code> ÊâÄÊúâÂ≠êÂáΩÊï∞Ë∞ÉÁî®„ÄÇÂ∑¶ËæπÁöÑÁ¨¨‰∏ÄÂàóÊòØÊâßË°åÂáΩÊï∞ÁöÑ CPUÔºåÁ¨¨‰∫åÂàó <code>DURATION</code> ÊòæÁ§∫Âú®Áõ∏Â∫îÂáΩÊï∞‰∏≠Ëä±Ë¥πÁöÑÊó∂Èó¥„ÄÇÊàë‰ª¨Ê≥®ÊÑèÂà∞ÊúÄÂêé‰∏ÄË°åÁöÑËÄóÊó∂‰πãÂâçÊúâ‰∏™ <code>+</code> Âè∑ÔºåÊèêÁ§∫Áî®Êà∑Ê≥®ÊÑèÂª∂ËøüÈ´òÁöÑÂáΩÊï∞„ÄÇ<code>+</code> ‰ª£Ë°®ËÄóÊó∂Â§ß‰∫é <code>10 Œºs</code>„ÄÇÂ¶ÇÊûúËÄóÊó∂Â§ß‰∫é <code>100 Œºs</code>ÔºåÂàôÊòæÁ§∫ <code>!</code> Âè∑„ÄÇ</p>
<p>Êàë‰ª¨Áü•ÈÅìÔºå<code>fork</code> ÊòØÂª∫Á´ãÁà∂ËøõÁ®ãÁöÑ‰∏Ä‰∏™ÂÆåÊï¥ÂâØÊú¨ÔºåÁÑ∂Âêé‰Ωú‰∏∫Â≠êËøõÁ®ãÊâßË°å„ÄÇÈÇ£‰πà<code>_do_fork()</code>ÁöÑÁ¨¨‰∏Ä‰ª∂Â§ß‰∫ãÂ∞±ÊòØË∞ÉÁî® <code>copy_process()</code> Â§çÂà∂Áà∂ËøõÁ®ãÁöÑÊï∞ÊçÆÁªìÊûÑÔºå‰ªé‰∏äÈù¢ËæìÂá∫ÁöÑË∞ÉÁî®Èìæ‰ø°ÊÅØ‰πüÈ™åËØÅ‰∫ÜËøô‰∏ÄÁÇπ„ÄÇ</p>
<p>‰ΩøÁî®ÂÆåÂêéÊâßË°å‰∏ãÈù¢ÁöÑÂëΩ‰ª§ÂÖ≥Èó≠<code>function_graph</code>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># echo nop &gt; current_tracer
</span></span><span class="line"><span class="cl"># echo &gt; set_graph_function
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ΩøÁî® <code>Ftrace</code> ÁöÑ <code>function_graph</code> ÂäüËÉΩÔºåÂèØ‰ª•Êü•ÁúãÂÜÖÊ†∏ÂáΩÊï∞ÁöÑÂ≠êÂáΩÊï∞Ë∞ÉÁî®ÈìæÔºåÂ∏ÆÂä©Êàë‰ª¨ÁêÜËß£Â§çÊùÇÁöÑ‰ª£Á†ÅÊµÅÁ®ãÔºåËÄåËøôÂè™ÊòØ <code>Ftrace</code> ÁöÑÂäüËÉΩ‰πã‰∏Ä„ÄÇËøô‰πàÂº∫Â§ßÁöÑÂäüËÉΩÔºåÊàë‰ª¨‰∏çÂøÖÂÆâË£ÖÈ¢ùÂ§ñÁöÑÁî®Êà∑Á©∫Èó¥Â∑•ÂÖ∑ÔºåÂè™Ë¶Å‰ΩøÁî® <code>echo</code> Âíå <code>cat</code> ÂëΩ‰ª§ËÆøÈóÆÁâπÂÆöÁöÑÊñá‰ª∂Â∞±ËÉΩÂÆûÁé∞„ÄÇ<code>Ftrace</code> ÂØπÁî®Êà∑ÁöÑ‰ΩøÁî®Êé•Âè£Ê≠£ÊòØ<strong>tracefs</strong>Êñá‰ª∂Á≥ªÁªü„ÄÇ</p>
<h2 id="tracefs-Êñá‰ª∂Á≥ªÁªü">tracefs Êñá‰ª∂Á≥ªÁªü</h2>
<p>Áî®Êà∑ÈÄöËøá<strong>tracefs</strong>Êñá‰ª∂Á≥ªÁªü‰ΩøÁî®<code>Ftrace</code>ÔºåËøôÂæàÁ¨¶Âêà‰∏ÄÂàáÁöÜÊñá‰ª∂ÁöÑLinuxÂì≤Â≠¶„ÄÇ<strong>tracefs</strong>Êñá‰ª∂Á≥ªÁªü‰∏ÄËà¨ÊåÇËΩΩÂú®<code>/sys/kernel/tracing</code>ÁõÆÂΩï„ÄÇÁî±‰∫é<code>Ftrace</code>ÊúÄÂàùÊòØ<code>debugfs</code>Êñá‰ª∂Á≥ªÁªüÁöÑ‰∏ÄÈÉ®ÂàÜÔºåÂêéÊù•ÊâçË¢´ÊãÜÂàÜ‰∏∫Ëá™Â∑±ÁöÑ<code>tracefs</code>„ÄÇÊâÄ‰ª•Â¶ÇÊûúÁ≥ªÁªüÂ∑≤ÁªèÊåÇËΩΩ‰∫Ü<code>debugfs</code>ÔºåÈÇ£‰πà‰ªçÁÑ∂‰ºö‰øùÁïôÂéüÊù•ÁöÑÁõÆÂΩïÁªìÊûÑÔºåÂ∞Ü<code>tracefs</code>ÊåÇËΩΩÂà∞<code>debugfs</code>ÁöÑÂ≠êÁõÆÂΩï‰∏ã„ÄÇÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî® <code>mount</code> ÂëΩ‰ª§Êü•ÁúãÂΩìÂâçÁ≥ªÁªü<code>debugfs</code>Âíå<code>tracefs</code>ÊåÇËΩΩÁÇπÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># mount -t debugfs,tracefs
</span></span><span class="line"><span class="cl">debugfs on /sys/kernel/debug type debugfs (rw,nosuid,nodev,noexec,relatime)
</span></span><span class="line"><span class="cl">tracefs on /sys/kernel/tracing type tracefs (rw,nosuid,nodev,noexec,relatime)
</span></span><span class="line"><span class="cl">tracefs on /sys/kernel/debug/tracing type tracefs (rw,nosuid,nodev,noexec,relatime)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Êàë‰ΩøÁî®ÁöÑÁ≥ªÁªüÊòØ<code>Ubuntu 20.04.2 LTS</code>ÔºåÂèØ‰ª•ÁúãÂà∞Ôºå‰∏∫‰∫Ü‰øùÊåÅÂÖºÂÆπÔºå<code>tracefs</code>ÂêåÊó∂ÊåÇËΩΩÂà∞‰∫Ü<code>/sys/kernel/tracing</code>Âíå<code>/sys/kernel/debug/tracing</code>„ÄÇ</p>
<p><code>tracefs</code>‰∏ãÁöÑÊñá‰ª∂‰∏ªË¶ÅÂàÜ‰∏§Á±ªÔºöÊéßÂà∂Êñá‰ª∂ÂíåËæìÂá∫Êñá‰ª∂„ÄÇËøô‰∫õÊñá‰ª∂ÁöÑÂêçÂ≠óÈÉΩÂæàÁõ¥ËßÇÔºåÂÉèÂâçÈù¢‰æãÂ≠êÈÄöËøá <code>current_tracer</code> ËÆæÁΩÆÂΩìÂâçË¶Å‰ΩøÁî®ÁöÑ tracerÔºåÁÑ∂Âêé‰ªé <code>trace</code>‰∏≠ËØªÂèñÁªìÊûú„ÄÇËøòÊúâÂÉè <code>available_tracers</code> ÂåÖÂê´‰∫ÜÂΩìÂâçÂÜÖÊ†∏ÂèØÁî®ÁöÑ tracerÔºåÂèØ‰ª•ËÆæÁΩÆ <code>trace_options</code> Ëá™ÂÆö‰πâËæìÂá∫„ÄÇ</p>
<pre><code>
# <b>ls -F /sys/kernel/tracing/</b>
available_events            max_graph_depth         stack_max_size
available_filter_functions  options/                stack_trace
available_tracers           per_cpu/                stack_trace_filter
buffer_percent              printk_formats          synthetic_events
buffer_size_kb              README                  timestamp_mode
buffer_total_size_kb        saved_cmdlines          trace
current_tracer              saved_cmdlines_size     trace_clock
dynamic_events              saved_tgids             trace_marker
dyn_ftrace_total_info       set_event               trace_marker_raw
enabled_functions           set_event_notrace_pid   trace_options
error_log                   set_event_pid           trace_pipe
events/                     set_ftrace_filter       trace_stat/
free_buffer                 set_ftrace_notrace      tracing_cpumask
function_profile_enabled    set_ftrace_notrace_pid  tracing_max_latency
hwlat_detector/             set_ftrace_pid          tracing_on
instances/                  set_graph_function      tracing_thresh
kprobe_events               set_graph_notrace       uprobe_events
kprobe_profile              snapshot                uprobe_profile
</code></pre>
<p>Êú¨ÊñáÂêéÈù¢ÁöÑÁ§∫‰æãÂÅáÂÆö‰Ω†Â∑≤ÁªèÂ§ÑÂú®‰∫Ü<code>/sys/kernel/tracing</code>Êàñ<code>/sys/kernel/debug/tracing</code>ÁõÆÂΩï‰∏ã„ÄÇ</p>
<h2 id="ÂáΩÊï∞Ë∑üË∏™">ÂáΩÊï∞Ë∑üË∏™</h2>
<p><code>Ftrace</code> ÂÆûÈôÖ‰∏ä‰ª£Ë°®ÁöÑÂ∞±ÊòØ<code>function trace</code>ÔºàÂáΩÊï∞Ë∑üË∏™ÔºâÔºåÂõ†Ê≠§ÂáΩÊï∞ËøΩË∏™ÊòØ<code>Ftrace</code>ÊúÄÂàùÁöÑ‰∏Ä‰∏™‰∏ªË¶ÅÂäüËÉΩ„ÄÇ</p>
<p><code>Ftrace</code> ÂèØ‰ª•Ë∑üË∏™Âá†‰πéÊâÄÊúâÂÜÖÊ†∏ÂáΩÊï∞Ë∞ÉÁî®ÁöÑËØ¶ÁªÜ‰ø°ÊÅØÔºåËøôÊòØÊÄé‰πàÂÅöÂà∞ÁöÑÂë¢ÔºüÁÆÄÂçïÊù•ËØ¥ÔºåÂú®ÁºñËØëÂÜÖÊ†∏ÁöÑÊó∂ÂÄô‰ΩøÁî®‰∫Ü <code>gcc</code> ÁöÑ <code>-pg</code> ÈÄâÈ°πÔºåÁºñËØëÂô®‰ºöÂú®ÊØè‰∏™ÂÜÖÊ†∏ÂáΩÊï∞ÁöÑÂÖ•Âè£Â§ÑË∞ÉÁî®‰∏Ä‰∏™ÁâπÊÆäÁöÑÊ±áÁºñÂáΩÊï∞‚Äú<strong>mcount</strong>‚Äù Êàñ ‚Äú<strong>__fentry__</strong>‚ÄùÔºåÂ¶ÇÊûúË∑üË∏™ÂäüËÉΩË¢´ÊâìÂºÄÔºå<code>mcount/fentry</code> ‰ºöË∞ÉÁî®ÂΩìÂâçËÆæÁΩÆÁöÑ <code>tracer</code>Ôºå<code>tracer</code>Â∞Ü‰∏çÂêåÁöÑÊï∞ÊçÆÂÜôÂÖ•<strong>ring buffer</strong>„ÄÇ</p>
<p><img src="https://cdn.mazhen.tech/images/202209241145662.png"
	
	
	
	loading="lazy"
	
		alt="ftrace"
	
	
></p>
<p>‰ªé‰∏äÂõæÂèØ‰ª•ÁúãÂá∫Ôºå<code>Ftrace</code> Êèê‰æõÁöÑ <code>function hooks</code> Êú∫Âà∂Âú®ÂÜÖÊ†∏ÂáΩÊï∞ÂÖ•Âè£Â§ÑÂüãÁÇπÔºåÊ†πÊçÆÈÖçÁΩÆË∞ÉÁî®ÁâπÂÆöÁöÑ <code>tracer</code>Ôºå <code>tracer</code>Â∞ÜÊï∞ÊçÆÂÜôÂÖ•<strong>ring buffer</strong>„ÄÇ<code>Ftrace</code>ÂÆûÁé∞‰∫Ü‰∏Ä‰∏™Êó†ÈîÅÁöÑ<a class="link" href="https://www.kernel.org/doc/html/latest/trace/ring-buffer-design.html"  target="_blank" rel="noopener"
    >ring buffer</a>ÔºåÊâÄÊúâÁöÑË∑üË∏™‰ø°ÊÅØÈÉΩÂ≠òÂÇ®Âú®<strong>ring buffer</strong>‰∏≠„ÄÇÁî®Êà∑ÈÄöËøá <code>tracefs</code> Êñá‰ª∂Á≥ªÁªüÊé•Âè£ËÆøÈóÆÂáΩÊï∞Ë∑üË∏™ÁöÑËæìÂá∫ÁªìÊûú„ÄÇ</p>
<p>‰Ω†ÂèØËÉΩÂ∑≤ÁªèÊÑèËØÜÂà∞ÔºåÂ¶ÇÊûúÊØè‰∏™ÂÜÖÊ†∏ÂáΩÊï∞ÂÖ•Âè£ÈÉΩÂä†ÂÖ•Ë∑üË∏™‰ª£Á†ÅÔºåÂøÖÁÑ∂‰ºöÈùûÂ∏∏ÂΩ±ÂìçÂÜÖÊ†∏ÁöÑÊÄßËÉΩÔºåÂπ∏Â•Ω<code>Ftrace</code>ÊîØÊåÅÂä®ÊÄÅË∑üË∏™ÂäüËÉΩ„ÄÇÂ¶ÇÊûúÂêØÁî®‰∫Ü<strong>CONFIG_DYNAMIC_FTRACE</strong>ÈÄâÈ°πÔºåÁºñËØëÂÜÖÊ†∏Êó∂ÊâÄÊúâÁöÑ<code>mcount/fentry</code>Ë∞ÉÁî®ÁÇπÈÉΩ‰ºöË¢´Êî∂ÈõÜËÆ∞ÂΩï„ÄÇÂú®ÂÜÖÊ†∏ÁöÑÂàùÂßãÂåñÂêØÂä®ËøáÁ®ã‰∏≠Ôºå‰ºöÊ†πÊçÆÁºñËØëÊúüËÆ∞ÂΩïÁöÑÂàóË°®ÔºåÂ∞Ü<code>mcount/fentry</code>Ë∞ÉÁî®ÁÇπÊõøÊç¢‰∏∫<strong>NOP</strong>Êåá‰ª§„ÄÇ<strong>NOP</strong>Â∞±ÊòØ <code>no-operation</code>Ôºå‰∏çÂÅö‰ªª‰Ωï‰∫ãÔºåÁõ¥Êé•ËΩ¨Âà∞‰∏ã‰∏ÄÊù°Êåá‰ª§„ÄÇÂõ†Ê≠§Âú®Ê≤°ÊúâÂºÄÂêØË∑üË∏™ÂäüËÉΩÁöÑÊÉÖÂÜµ‰∏ãÔºå<code>Ftrace</code>‰∏ç‰ºöÂØπÂÜÖÊ†∏ÊÄßËÉΩ‰∫ßÁîü‰ªª‰ΩïÂΩ±Âìç„ÄÇÂú®ÂºÄÂêØËøΩË∏™ÂäüËÉΩÊó∂Ôºå<code>Ftrace</code>Êâç‰ºöÂ∞Ü<strong>NOP</strong>Êåá‰ª§ÊõøÊç¢‰∏∫<code>mcount/fentry</code>„ÄÇ</p>
<p>ÂêØÁî®ÂáΩÊï∞ËøΩË∏™ÂäüËÉΩÔºåÂè™ÈúÄË¶ÅÂ∞Ü <code>current_tracer</code> Êñá‰ª∂ÁöÑÂÜÖÂÆπËÆæÁΩÆ‰∏∫ &ldquo;function&rdquo;Ôºö</p>
<pre><code>
# <b>echo function > current_tracer</b>
# <b>cat trace | head -20</b>
# tracer: function
#
# entries-in-buffer/entries-written: 204981/2728851   #P:4
#
#                                _-----=> irqs-off
#                               / _----=> need-resched
#                              | / _---=> hardirq/softirq
#                              || / _--=> preempt-depth
#                              ||| /     delay
#           TASK-PID     CPU#  ||||   TIMESTAMP  FUNCTION
#              | |         |   ||||      |         |
            sshd-1388    [000] .... 44388.890787: _cond_resched <-__flush_work
            curl-7231    [001] .... 44389.399226: PageHuge <-find_get_entry
            curl-7231    [001] .... 44389.399227: fsnotify_parent <-vfs_read
            curl-7231    [001] .... 44389.399227: _cond_resched <-copy_page_to_iter
            curl-7231    [001] .... 44389.399227: rcu_all_qs <-_cond_resched
            curl-7231    [001] .... 44389.399228: vmacache_find <-find_vma
            curl-7231    [001] .... 44389.399228: atime_needs_update <-touch_atime
            curl-7231    [001] .... 44389.399228: current_time <-atime_needs_update

# <b> echo nop > current_tracer </b>
</code></pre>
<p>Êñá‰ª∂Â§¥Â∑≤ÁªèÂæàÂ•ΩÁöÑËß£Èáä‰∫ÜÊØè‰∏ÄÂàóÁöÑÂê´‰πâ„ÄÇÂâç‰∏§È°πÊòØË¢´ËøΩË∏™ÁöÑ‰ªªÂä°ÂêçÁß∞Âíå PIDÔºåÂ§ßÊã¨Âè∑ÂÜÖÊòØÊâßË°åË∑üË∏™ÁöÑCPU„ÄÇ<code>TIMESTAMP</code> ÊòØÂêØÂä®ÂêéÁöÑÊó∂Èó¥ÔºåÂêéÈù¢ÊòØË¢´ËøΩË∏™ÁöÑÂáΩÊï∞ÔºåÂÆÉÁöÑË∞ÉÁî®ËÄÖÂú® <code>&lt;-</code> ‰πãÂêé„ÄÇ</p>
<p>Êàë‰ª¨ÂèØ‰ª•ËÆæÁΩÆ <code>set_ftrace_filter</code> ÈÄâÊã©ÊÉ≥Ë¶ÅË∑üË∏™ÁöÑÂáΩÊï∞Ôºö</p>
<pre><code>
# <b>echo '*sleep' > set_ftrace_filter</b>
# <b>echo function > current_tracer</b>
# <b>cat trace_pipe</b>

sleep-9445    [001] .... 45978.125872: common_nsleep <-__x64_sys_clock_nanosleep
sleep-9445    [001] .... 45978.125873: hrtimer_nanosleep <-common_nsleep
sleep-9445    [001] .... 45978.125873: do_nanosleep <-hrtimer_nanosleep
 cron-568     [002] .... 45978.504262: __x64_sys_clock_nanosleep <-do_syscall_64
 cron-568     [002] .... 45978.504264: common_nsleep <-__x64_sys_clock_nanosleep
 cron-568     [002] .... 45978.504264: hrtimer_nanosleep <-common_nsleep
 cron-568     [002] .... 45978.504264: do_nanosleep <-hrtimer_nanosleep
sleep-9448    [001] .... 45978.885085: __x64_sys_clock_nanosleep <-do_syscall_64
sleep-9448    [001] .... 45978.885087: common_nsleep <-__x64_sys_clock_nanosleep
sleep-9448    [001] .... 45978.885087: hrtimer_nanosleep <-common_nsleep

# <b>echo nop > current_tracer</b>
# <b>echo > set_ftrace_filter</b>
</code></pre>
<p><code>trace_pipe</code> ÂåÖÂê´‰∫Ü‰∏é <code>trace</code> Áõ∏ÂêåÁöÑËæìÂá∫Ôºå‰ªéËøô‰∏™Êñá‰ª∂ÁöÑËØªÂèñ‰ºöËøîÂõû‰∏Ä‰∏™Êó†Â∞ΩÁöÑ‰∫ã‰ª∂ÊµÅÔºåÂÆÉ‰πü‰ºöÊ∂àËÄó‰∫ã‰ª∂ÔºåÊâÄ‰ª•Âú®ËØªÂèñ‰∏ÄÊ¨°ÂêéÔºåÂÆÉ‰ª¨Â∞±‰∏çÂÜçÂú®Ë∑üË∏™ÁºìÂÜ≤Âå∫‰∏≠‰∫Ü„ÄÇ</p>
<p>‰πüËÆ∏‰Ω†Âè™ÊÉ≥Ë∑üË∏™‰∏Ä‰∏™ÁâπÂÆöÁöÑËøõÁ®ãÔºåÂèØ‰ª•ÈÄöËøáËÆæÁΩÆ <code>set_ftrace_pid</code> ÂÜÖÂÆπ‰∏∫PIDÊåáÂÆöÊÉ≥ËøΩË∏™ÁöÑÁâπÂÆöËøõÁ®ã„ÄÇËÆ© tracer Âè™ËøΩË∏™PIDÂàóÂú®Ëøô‰∏™Êñá‰ª∂‰∏≠ÁöÑÁ∫øÁ®ãÔºö</p>
<pre><code>
# <b>echo [PID] > set_ftrace_pid</b>
# <b>echo function > current_tracer</b>
</code></pre>
<p>Â¶ÇÊûúËÆæÁΩÆ‰∫Ü <code>function-fork</code> ÈÄâÈ°πÔºåÈÇ£‰πàÂΩì‰∏Ä‰∏™ PID Ë¢´ÂàóÂú® <code>set_ftrace_pid</code> Ëøô‰∏™Êñá‰ª∂‰∏≠Êó∂ÔºåÂÖ∂Â≠ê‰ªªÂä°ÁöÑ PID Â∞ÜË¢´Ëá™Âä®Ê∑ªÂä†Âà∞Ëøô‰∏™Êñá‰ª∂‰∏≠ÔºåÂπ∂‰∏îÂ≠ê‰ªªÂä°‰πüÂ∞ÜË¢´ tracer ËøΩË∏™„ÄÇ</p>
<pre><code>
# <b>echo function-fork > trace_options</b>
</code></pre>
<p>ÂèñÊ∂à<code>function-fork</code> ÈÄâÈ°πÔºö</p>
<pre><code>
# <b>echo nofunction-fork > trace_options</b>
# <b>cat trace_options</b>
...
noevent-fork
nopause-on-trace
function-trace
<b>nofunction-fork</b>
nodisplay-graph
nostacktrace
...
</code></pre>
<p>ÂèñÊ∂à <code>set_ftrace_pid</code> ÁöÑËÆæÁΩÆÔºö</p>
<pre><code>
# <b>echo > set_ftrace_pid</b>
</code></pre>
<h2 id="ftrace-function_graph">Ftrace function_graph</h2>
<p>ÊñáÁ´†ÂºÄÂßã‰æãÂ≠êÂ∑≤ÁªèÂ±ïÁ§∫ËøáÔºå<code>function_graph</code> ÂèØ‰ª•ÊâìÂç∞Âá∫ÂáΩÊï∞ÁöÑË∞ÉÁî®ÂõæÔºåÊè≠Á§∫‰ª£Á†ÅÁöÑÊµÅÁ®ã„ÄÇ<code>function_graph</code> ‰∏ç‰ªÖË∑üË∏™ÂáΩÊï∞ÁöÑËæìÂÖ•ÔºåËÄå‰∏îË∑üË∏™ÂáΩÊï∞ÁöÑËøîÂõûÔºåËøô‰ΩøÂæó tracer ËÉΩÂ§üÁü•ÈÅìË¢´Ë∞ÉÁî®ÁöÑÂáΩÊï∞ÁöÑÊ∑±Â∫¶„ÄÇ<code>function_graph</code> ÂèØ‰ª•ËÆ©‰∫∫Êõ¥ÂÆπÊòìË∑üË∏™ÂÜÖÊ†∏ÁöÑÊâßË°åÊµÅÁ®ã„ÄÇ</p>
<p>Êàë‰ª¨ÂÜçÁúã‰∏Ä‰∏™‰æãÂ≠êÔºö</p>
<pre><code>
# <b>echo try_to_wake_up > set_graph_function</b>
# <b>echo function_graph > current_tracer</b>
# <b>cat trace | head -20</b>
# tracer: function_graph
#
# CPU  DURATION                  FUNCTION CALLS
# |     |   |                     |   |   |   |
 0)               |  try_to_wake_up() {
 0)   1.083 us    |    ttwu_queue_wakelist();
 0)   0.622 us    |    update_rq_clock();
 0)               |    ttwu_do_activate() {
 0)               |      enqueue_task_fair() {
 0)               |        enqueue_entity() {
 0)   0.616 us    |          update_curr();
 0)   0.602 us    |          update_cfs_group();
 0)   0.662 us    |          account_entity_enqueue();
 0)   0.652 us    |          place_entity();
 0)   0.697 us    |          __enqueue_entity();
 0) + 12.890 us   |        }
 0)   0.672 us    |        hrtick_update();
 0) + 17.781 us   |      }
 0)               |      ttwu_do_wakeup() {
 0)               |        check_preempt_curr() {

# <b>echo nop > current_tracer</b>
# <b>echo > set_graph_function</b>
</code></pre>
<p>ÂâçÈù¢ÊèêÂà∞ËøáÔºåÂáΩÊï∞ËÄóÊó∂Â§ß‰∫é 10 ŒºsÔºåÂâçÈù¢‰ºöÊúâ + Âè∑ÊèêÈÜíÁî®Êà∑Ê≥®ÊÑèÔºåÂÖ∂‰ªñÁöÑÁ¨¶Âè∑ËøòÊúâÔºö</p>
<ul>
<li><strong>$</strong> ÔºöÂª∂ËøüÂ§ß‰∫é1Áßí</li>
<li><strong>@</strong> ÔºöÂª∂ËøüÂ§ß‰∫é 100 ms</li>
<li><strong>*</strong> ÔºöÂª∂ËøüÂ§ß‰∫é 10 ms</li>
<li><strong>#</strong> ÔºöÂª∂ËøüÂ§ß‰∫é 1 ms</li>
<li><strong>!</strong> ÔºöÂª∂ËøüÂ§ß‰∫é 100 Œºs</li>
<li><strong>+</strong> ÔºöÂª∂ËøüÂ§ß‰∫é 10 Œºs</li>
</ul>
<h2 id="ÂáΩÊï∞profiler">ÂáΩÊï∞Profiler</h2>
<p>ÂáΩÊï∞ProfilerÊèê‰æõ‰∫ÜÂÜÖÊ†∏ÂáΩÊï∞Ë∞ÉÁî®ÁöÑÁªüËÆ°Êï∞ÊçÆÔºåÂèØ‰ª•ËßÇÂØüÂì™‰∫õÂÜÖÊ†∏ÂáΩÊï∞Ê≠£Âú®Ë¢´‰ΩøÁî®ÔºåÂπ∂ËÉΩÂèëÁé∞Âì™‰∫õÂáΩÊï∞ÁöÑÊâßË°åËÄóÊó∂ÊúÄÈïø„ÄÇ</p>
<pre><code>
# echo nop > current_tracer
# echo 1 > function_profile_enabled
# echo 0 > function_profile_enabled
# echo > set_ftrace_filter
</code></pre>
<p>ËøôÈáåÊúâ‰∏Ä‰∏™Ë¶ÅÊ≥®ÊÑèÁöÑÂú∞ÊñπÔºåÁ°Æ‰øù‰ΩøÁî®ÁöÑÊòØ <code>0 &gt;</code>ÔºåËÄå‰∏çÊòØ <code>0&gt;</code>„ÄÇËøô‰∏§ËÄÖÁöÑÂê´‰πâ‰∏ç‰∏ÄÊ†∑Ôºå<code>0&gt;</code>ÊòØÂØπÊñá‰ª∂ÊèèËø∞Á¨¶ <code>0</code> ÁöÑÈáçÂÆöÂêë„ÄÇÂêåÊ†∑Ë¶ÅÈÅøÂÖç‰ΩøÁî® <code>1&gt;</code>ÔºåÂõ†‰∏∫ËøôÊòØÂØπÊñá‰ª∂ÊèèËø∞Á¨¶ <code>1</code> ÁöÑÈáçÂÆöÂêë„ÄÇ</p>
<p>Áé∞Âú®ÂèØ‰ª•‰ªé <code>trace_stat</code> ÁõÆÂΩï‰∏≠ËØªÂèñ profile ÁöÑÁªüËÆ°Êï∞ÊçÆ„ÄÇÂú®Ëøô‰∏™ÁõÆÂΩï‰∏≠Ôºåprofile Êï∞ÊçÆÊåâÁÖß CPU ‰øùÂ≠òÂú®Âêç‰∏∫ function[n] Êñá‰ª∂‰∏≠„ÄÇÊàë‰ΩøÁî®ÁöÑ4Ê†∏CPUÔºåÁúã‰∏Ä‰∏ãprofile ÁªìÊûúÔºö</p>
<pre><code>
# <b>ls  trace_stat/</b>
function0  function1  function2  function3
# <b>head trace_stat/function*</b>
==> trace_stat/function0 <==
  Function                               Hit    Time            Avg             s^2
  --------                               ---    ----            ---             ---
  tcp_sendmsg                            202    3791.163 us     18.768 us       659.733 us  
  tcp_sendmsg_locked                     202    3521.863 us     17.434 us       638.307 us  
  tcp_recvmsg                            125    2238.773 us     17.910 us       1062.699 us 
  tcp_push                               202    2168.569 us     10.735 us       467.879 us  
  tcp_write_xmit                          47    2107.768 us     44.846 us       414.934 us  
  tcp_v4_do_rcv                           49    871.318 us      17.782 us       126.562 us  
  tcp_send_ack                            50    849.091 us      16.981 us       164.986 us  
  tcp_rcv_established                     49    827.212 us      16.881 us       117.427 us  

==> trace_stat/function1 <==
  Function                               Hit    Time            Avg             s^2
--------                               ---    ----            ---             ---
  tcp_recvmsg                            312    3110.497 us     9.969 us        281.015 us  
  tcp_sendmsg                             86    1412.005 us     16.418 us       370.310 us  
  tcp_sendmsg_locked                      86    1313.847 us     15.277 us       362.495 us  
  tcp_send_ack                            47    863.222 us      18.366 us       121.567 us  
  tcp_v4_do_rcv                           60    825.359 us      13.755 us       102.550 us  
  tcp_write_xmit                          28    807.609 us      28.843 us       336.106 us  
  tcp_push                                86    805.776 us      9.369 us        299.815 us  
  tcp_rcv_established                     60    777.510 us      12.958 us       99.129 us   

==> trace_stat/function2 <==
  Function                               Hit    Time            Avg             s^2
--------                               ---    ----            ---             ---
  tcp_v4_rcv                            1618    27858.95 us     17.218 us       253.487 us  
  tcp_v4_do_rcv                         1216    22528.58 us     18.526 us       226.243 us  
  tcp_rcv_established                   1184    20535.08 us     17.343 us       210.765 us  
  tcp_send_ack                           487    7558.698 us     15.520 us       111.035 us  
  tcp_write_xmit                         328    6281.810 us     19.151 us       656.192 us  
  tcp_tasklet_func                       162    4258.312 us     26.285 us       797.278 us  
  tcp_ack                                575    4148.714 us     7.215 us        27.061 us   
  tcp_tsq_handler                        162    4123.507 us     25.453 us       791.961 us  

==> trace_stat/function3 <==
  Function                               Hit    Time            Avg             s^2
--------                               ---    ----            ---             ---
  tcp_recvmsg                            567    5773.997 us     10.183 us       397.950 us  
  tcp_send_ack                           127    1881.700 us     14.816 us       133.317 us  
  tcp_v4_do_rcv                          133    1783.527 us     13.409 us       86.122 us   
  tcp_rcv_established                    133    1690.142 us     12.707 us       83.527 us   
  tcp_sendmsg                             54    1652.290 us     30.597 us       698.120 us  
  tcp_sendmsg_locked                      54    1574.276 us     29.153 us       666.451 us  
  tcp_write_xmit                          40    1184.827 us     29.620 us       354.719 us  
  tcp_push                                54    1129.465 us     20.916 us       486.157 us  
</code></pre>
<p>Á¨¨‰∏ÄË°åÊòØÊØè‰∏ÄÂàóÁöÑÂêçÁß∞ÔºåÂàÜÂà´ÊòØÂáΩÊï∞ÂêçÁß∞ÔºàFunctionÔºâÔºåË∞ÉÁî®Ê¨°Êï∞ÔºàHitÔºâÔºåÂáΩÊï∞ÁöÑÊÄªÊó∂Èó¥ÔºàTimeÔºâ„ÄÅÂπ≥ÂùáÂáΩÊï∞Êó∂Èó¥ÔºàAvgÔºâÂíåÊ†áÂáÜÂ∑ÆÔºàs^2Ôºâ„ÄÇËæìÂá∫ÁªìÊûúÊòæÁ§∫Ôºå<code>tcp_sendmsg()</code> Âú®3‰∏™ CPU ‰∏äÈÉΩÊòØÊúÄÈ¢ëÁπÅÁöÑÔºå<code>tcp_v4_rcv()</code> Âú® CPU2 ‰∏äË¢´Ë∞ÉÁî®‰∫Ü1618Ê¨°ÔºåÂπ≥ÂùáÂª∂Ëøü‰∏∫ <code>17.218 us</code>„ÄÇ</p>
<p>ÊúÄÂêéË¶ÅÊ≥®ÊÑè‰∏ÄÁÇπÔºåÂú®‰ΩøÁî® Ftrace Profiler Êó∂ÔºåÂ∞ΩÈáèÈÄöËøá <code>set_ftrace_filter</code> ÈôêÂà∂ profile ÁöÑËåÉÂõ¥ÔºåÈÅøÂÖçÂØπÊâÄÊúâÁöÑÂÜÖÊ†∏ÂáΩÊï∞ÈÉΩËøõË°å profile„ÄÇ</p>
<h2 id="ËøΩË∏™ÁÇπ-tracepoints">ËøΩË∏™ÁÇπ Tracepoints</h2>
<p><strong>Tracepoints</strong>ÊòØÂÜÖÊ†∏ÁöÑÈùôÊÄÅÂüãÁÇπ„ÄÇÂÜÖÊ†∏Áª¥Êä§ËÄÖÂú®‰ªñËÆ§‰∏∫ÈáçË¶ÅÁöÑ‰ΩçÁΩÆÊîæÁΩÆÈùôÊÄÅ tracepoints ËÆ∞ÂΩï‰∏ä‰∏ãÊñá‰ø°ÊÅØÔºåÊñπ‰æøÂêéÁª≠ÊéíÊü•ÈóÆÈ¢ò„ÄÇ‰æãÂ¶ÇÁ≥ªÁªüË∞ÉÁî®ÁöÑÂºÄÂßãÂíåÁªìÊùüÔºå‰∏≠Êñ≠Ë¢´Ëß¶ÂèëÔºåÁΩëÁªúÊï∞ÊçÆÂåÖÂèëÈÄÅÁ≠âÁ≠â„ÄÇ</p>
<p>Âú®LinuxÁöÑÊó©ÊúüÔºåÂÜÖÊ†∏Áª¥Êä§ËÄÖÂ∞±‰∏ÄÁõ¥ÊÉ≥Âú®ÂÜÖÊ†∏‰∏≠Âä†ÂÖ•ÈùôÊÄÅ tracepointsÔºåÂ∞ùËØïËøáÂêÑÁßçÁ≠ñÁï•„ÄÇFtrace ÂàõÈÄ†‰∫Ü<a class="link" href="https://www.kernel.org/doc/html/latest/trace/events.html"  target="_blank" rel="noopener"
    >Event Tracing</a> Âü∫Á°ÄËÆæÊñΩÔºåËÆ©ÂºÄÂèëËÄÖ‰ΩøÁî® <a class="link" href="https://lwn.net/Articles/379903/"  target="_blank" rel="noopener"
    >TRACE_EVENT() ÂÆèÊ∑ªÂä†ÂÜÖÊ†∏ tracepoints</a>Ôºå‰∏çÁî®ÂàõÂª∫Ëá™ÂÆö‰πâÂÜÖÊ†∏Ê®°ÂùóÔºå‰ΩøÁî® <code>Event Tracing</code> Âü∫Á°ÄËÆæÊñΩÊù•Ê≥®ÂÜåÂüãÁÇπÂáΩÊï∞„ÄÇ</p>
<p>Áé∞Âú®ÂÜÖÊ†∏‰∏≠ÁöÑ<strong>Tracepoints</strong>ÈÉΩ‰ΩøÁî®‰∫Ü <code>TRACE_EVENT()</code> ÂÆèÊù•ÂÆö‰πâÔºåtracepoints ËÆ∞ÂΩïÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ‰Ωú‰∏∫ <strong>Trace events</strong> ËøõÂÖ• <code>Event Tracing</code> Âü∫Á°ÄËÆæÊñΩÔºåËøôÊ†∑Êàë‰ª¨Â∞±ÂèØ‰ª•Â§çÁî® Ftrace ÁöÑ tracefs ÔºåÈÄöËøáÊñá‰ª∂Êé•Âè£Êù•ÈÖçÁΩÆ tracepoint eventsÔºåÂπ∂‰ΩøÁî® trace Êàñ trace_pipe Êñá‰ª∂Êü•Áúã‰∫ã‰ª∂ËæìÂá∫„ÄÇ</p>
<p>ÊâÄÊúâÁöÑ tracepoint events ÁöÑÊéßÂà∂Êñá‰ª∂ÈÉΩÂú® events ÁõÆÂΩï‰∏ãÔºåÊåâÁÖßÁ±ªÂà´‰ª•Â≠êÁõÆÂΩïÂΩ¢ÂºèÁªÑÁªáÔºö</p>
<pre><code>
# <b>ls -F events/</b>
alarmtimer/    ftrace/          iwlwifi/        oom/             smbus/
block/         gpio/            iwlwifi_data/   page_isolation/  sock/
bpf_test_run/  gvt/             iwlwifi_io/     pagemap/         spi/
bridge/        hda/             iwlwifi_msg/    page_pool/       swiotlb/
btrfs/         hda_controller/  iwlwifi_ucode/  percpu/          sync_trace/
cfg80211/      hda_intel/       jbd2/           power/           syscalls/
cgroup/        header_event     kmem/           printk/          task/
clk/           header_page      kvm/            pwm/             tcp/

...
</code></pre>
<p>Êàë‰ª¨‰ª• <code>events/sched/sched_process_fork</code> ‰∫ã‰ª∂‰∏∫‰æãÔºåËØ•‰∫ã‰ª∂ÊòØÂú® <code>include/trace/events/sched.h</code> ‰∏≠Áî± <code>TRACE_EVENT</code> ÂÆèÊâÄ<a class="link" href="https://github.com/torvalds/linux/blob/bcf876870b95592b52519ed4aafcf9d95999bc9c/include/trace/events/sched.h#L287"  target="_blank" rel="noopener"
    >ÂÆö‰πâ</a>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Tracepoint for do_fork:
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nf">TRACE_EVENT</span><span class="p">(</span><span class="n">sched_process_fork</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">TP_PROTO</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">parent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">TP_ARGS</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>TRACE_EVENT</code> ÂÆè‰ºöÊ†πÊçÆ‰∫ã‰ª∂ÂêçÁß∞ <code>sched_process_fork</code> ÁîüÊàê tracepoint ÊñπÊ≥ï <code>trace_sched_process_fork()</code>„ÄÇ‰Ω†‰ºöÂú® <code>kernel/fork.c</code> ÁöÑ <a class="link" href="https://github.com/torvalds/linux/blob/bcf876870b95592b52519ed4aafcf9d95999bc9c/kernel/fork.c#L2453"  target="_blank" rel="noopener"
    >_do_fork()</a> ‰∏≠ÁúãÂà∞Ë∞ÉÁî®Ëøô‰∏™ tracepoint ÊñπÊ≥ï„ÄÇ<code>_do_fork()</code> ÊòØËøõÁ®ã fork ÁöÑ‰∏ªÊµÅÁ®ãÔºåÂú®ËøôÈáåÊîæÁΩÆ tracepoint ÊòØ‰∏Ä‰∏™ÂêàÈÄÇÁöÑ‰ΩçÁΩÆÔºå<code>trace_sched_process_fork(current, p)</code> ËÆ∞ÂΩïÂΩìÂâçËøõÁ®ãÂíå fork Âá∫ÁöÑÂ≠êËøõÁ®ã‰ø°ÊÅØÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  Ok, this is the main fork-routine.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * It copies the process, and if successful kick-starts
</span></span></span><span class="line"><span class="cl"><span class="cm"> * it and waits for it to finish using the VM if required.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * args-&gt;exit_signal is expected to be checked for sanity by the caller.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">_do_fork</span><span class="p">(</span><span class="k">struct</span> <span class="n">kernel_clone_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="nf">copy_process</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">NUMA_NO_NODE</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">add_latent_entropy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * Do this prior waking up the new thread - the thread pointer
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * might get invalid after that point, if the thread exits quickly.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">trace_sched_process_fork</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pid</span> <span class="o">=</span> <span class="nf">get_task_pid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">PIDTYPE_PID</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âú® <code>events/sched/sched_process_fork</code> ÁõÆÂΩï‰∏ãÔºåÊúâËøô‰∏™‰∫ã‰ª∂ÁöÑÊéßÂà∂Êñá‰ª∂Ôºö</p>
<pre><code>
# <b>ls events/sched/sched_process_fork</b>
enable  filter  format  hist  id  inject  trigger
</code></pre>
<p>Êàë‰ª¨ÊºîÁ§∫Â¶Ç‰ΩïÈÄöËøá <code>enable</code> Êñá‰ª∂ÂºÄÂêØÂíåÂÖ≥Èó≠Ëøô‰∏™ tracepoint ‰∫ã‰ª∂Ôºö</p>
<pre><code>
# <b>echo 1 > events/sched/sched_process_fork/enable</b>
# <b>cat trace_pipe</b>
   bash-14414   [000] .... 109721.823843: sched_process_fork: comm=bash pid=14414 child_comm=bash child_pid=24001
   bash-14468   [002] .... 109730.405810: sched_process_fork: comm=bash pid=14468 child_comm=bash child_pid=24002
   bash-14468   [002] .... 109737.925336: sched_process_fork: comm=bash pid=14468 child_comm=bash child_pid=24003
test.sh-24003   [000] .... 109737.968891: sched_process_fork: comm=test.sh pid=24003 child_comm=test.sh child_pid=24004
   curl-24004   [002] .... 109737.975038: sched_process_fork: comm=curl pid=24004 child_comm=curl child_pid=24005
   ...

# <b>echo 0 > events/sched/sched_process_fork/enable</b>
</code></pre>
<p>Ââç‰∫îÂàóÂàÜÂà´ÊòØËøõÁ®ãÂêçÁß∞ÔºåPIDÔºåCPU IDÔºåirqs-off Á≠âÊ†áÂøó‰ΩçÔºåtimestamp Âíå tracepoint ‰∫ã‰ª∂ÂêçÁß∞„ÄÇÂÖ∂‰ΩôÈÉ®ÂàÜÊòØ tracepoint Ê†ºÂºèÂ≠óÁ¨¶‰∏≤ÔºåÂåÖÂê´ÂΩìÂâçËøô‰∏™ tracepoint ËÆ∞ÂΩïÁöÑÈáçË¶Å‰ø°ÊÅØ„ÄÇÊ†ºÂºèÂ≠óÁ¨¶‰∏≤ÂèØ‰ª•Âú® <code>events/sched/sched_process_fork/format</code> Êñá‰ª∂‰∏≠Êü•ÁúãÔºö</p>
<pre><code>
# <b>cat events/sched/sched_process_fork/format</b>
name: sched_process_fork
ID: 315
format:
	field:unsigned short common_type;	offset:0;	size:2;	signed:0;
	field:unsigned char common_flags;	offset:2;	size:1;	signed:0;
	field:unsigned char common_preempt_count;	offset:3;	size:1;	signed:0;
	field:int common_pid;	offset:4;	size:4;	signed:1;

	field:char parent_comm[16];	offset:8;	size:16;	signed:1;
	field:pid_t parent_pid;	offset:24;	size:4;	signed:1;
	field:char child_comm[16];	offset:28;	size:16;	signed:1;
	field:pid_t child_pid;	offset:44;	size:4;	signed:1;

print fmt: "comm=%s pid=%d child_comm=%s child_pid=%d", REC->parent_comm, REC->parent_pid, REC->child_comm, REC->child_pid
</code></pre>
<p>ÈÄöËøáËøô‰∏™ format Êñá‰ª∂ÔºåÊàë‰ª¨ÂèØ‰ª•‰∫ÜËß£Ëøô‰∏™ tracepoint ‰∫ã‰ª∂ÊØè‰∏™Â≠óÊÆµÁöÑÂê´‰πâ„ÄÇ</p>
<p>Êàë‰ª¨ÂÜçÊºîÁ§∫‰∏Ä‰∏™‰ΩøÁî® <code>trigger</code> ÊéßÂà∂Êñá‰ª∂ÁöÑ‰æãÂ≠êÔºö</p>
<pre><code>
# <b>echo 'hist:key=parent_pid' > events/sched/sched_process_fork/trigger</b>
# [do some working]
# <b>cat events/sched/sched_process_fork/hist</b>
# event histogram
#
# trigger info: hist:keys=parent_pid:vals=hitcount:sort=hitcount:size=2048 [active]
#

{ parent_pid:        572 } hitcount:          1
{ parent_pid:      24494 } hitcount:          1
{ parent_pid:      24497 } hitcount:          1
{ parent_pid:      14414 } hitcount:          1
{ parent_pid:      24505 } hitcount:          1
{ parent_pid:      14053 } hitcount:          1
{ parent_pid:      24527 } hitcount:          1
{ parent_pid:      24501 } hitcount:          1
{ parent_pid:      24510 } hitcount:          2
{ parent_pid:      24508 } hitcount:          3
{ parent_pid:      24493 } hitcount:         24

Totals:
    Hits: 37
    Entries: 11
    Dropped: 0

# remove triger
# <b>echo '!hist:key=parent_pid' > events/sched/sched_process_fork/trigger</b>
</code></pre>
<p>Ëøô‰∏™‰æãÂ≠ê‰ΩøÁî®‰∫Ü hist triggersÔºåÈÄöËøá sched_process_fork ‰∫ã‰ª∂Êù•ÁªüËÆ° _do_fork ÁöÑÊ¨°Êï∞ÔºåÂπ∂ÊåâÁÖßËøõÁ®ãIDÁîüÊàêÁõ¥ÊñπÂõæ„ÄÇËæìÂá∫ÊòæÁ§∫‰∫Ü PID 24493 Âú®ËøΩË∏™ÊúüÈó¥ fork ‰∫Ü24‰∏™Â≠êËøõÁ®ãÔºåÊúÄÂêéÂá†Ë°åÊòæÁ§∫‰∫ÜÁªüËÆ°Êï∞ÊçÆ„ÄÇ</p>
<p>ÂÖ≥‰∫é Hist Triggers ÁöÑËØ¶ÁªÜ‰ªãÁªçÂèØ‰ª•ÂèÇËÄÉÊñáÊ°£ <a class="link" href="https://www.kernel.org/doc/html/latest/trace/histogram.html"  target="_blank" rel="noopener"
    >Event Histograms</a>„ÄÇ</p>
<p>ÊàëÁöÑÁ≥ªÁªüÂÜÖÊ†∏ÁâàÊú¨ÊòØ <code>5.8.0-59-generic</code>ÔºåÂΩìÂâçÂèØÁî®ÁöÑ tracepoints events Êúâ2547‰∏™Ôºö</p>
<pre><code>
# <b>cat available_events</b>
btrfs:btrfs_transaction_commit
btrfs:btrfs_inode_new
btrfs:btrfs_inode_request
btrfs:btrfs_inode_evict
btrfs:btrfs_get_extent
btrfs:btrfs_handle_em_exist
btrfs:btrfs_get_extent_show_fi_regular
btrfs:btrfs_truncate_show_fi_regular
btrfs:btrfs_get_extent_show_fi_inline
...

# <b>cat available_events | wc -l</b>
2547
</code></pre>
<p><a class="link" href="https://www.kernel.org/doc/html/latest/trace/events.html"  target="_blank" rel="noopener"
    >Event Tracing</a> Âü∫Á°ÄËÆæÊñΩÂ∫îËØ•ÊòØ Ftrace ÁöÑÂè¶‰∏ÄÂ§ßË¥°ÁåÆÔºåÂÆÉÊèê‰æõÁöÑ <code>TRACE_EVENT</code> ÂÆèÁªü‰∏Ä‰∫ÜÂÜÖÊ†∏ tracepoint ÁöÑÂÆûÁé∞ÊñπÂºèÔºå‰∏∫ tracepoint events Êèê‰æõ‰∫ÜÂü∫Á°ÄÊîØÊåÅ„ÄÇ<a class="link" href="https://perf.wiki.kernel.org/index.php/Main_Page"  target="_blank" rel="noopener"
    >perf</a> ÁöÑ tracepoint events ‰πüÊòØÂü∫‰∫é Ftrace ÂÆûÁé∞ÁöÑ„ÄÇ</p>
<h2 id="Âà©Áî®-tracepoints-ÁêÜËß£ÂÜÖÊ†∏‰ª£Á†Å">Âà©Áî® Tracepoints ÁêÜËß£ÂÜÖÊ†∏‰ª£Á†Å</h2>
<p>Áî±‰∫é tracepoints ÊòØÂÜÖÊ†∏Áª¥Êä§ËÄÖÂú®ÊµÅÁ®ãÈáçË¶Å‰ΩçÁΩÆËÆæÁΩÆÁöÑÂüãÁÇπÔºåÂõ†Ê≠§Êàë‰ª¨ÂèØ‰ª•‰ªé tracepoints ÂÖ•ÊâãÊù•Â≠¶‰π†ÂÜÖÊ†∏‰ª£Á†Å„ÄÇÊâÄÊúâÁöÑ tracepoints ÈÉΩÂÆö‰πâÂú® <a class="link" href="https://github.com/torvalds/linux/tree/master/include/trace/events"  target="_blank" rel="noopener"
    >include/trace/events/</a> ÁõÆÂΩï‰∏ãÁöÑÂ§¥Êñá‰ª∂‰∏≠Ôºå‰æãÂ¶ÇËøõÁ®ãË∞ÉÂ∫¶Áõ∏ÂÖ≥ÁöÑ tracepoints ÂÆö‰πâÂú® <a class="link" href="https://github.com/torvalds/linux/blob/master/include/trace/events/sched.h"  target="_blank" rel="noopener"
    >include/trace/events/sched.h</a>‰∏≠ÔºåÊàë‰ª¨‰ª• <a class="link" href="https://github.com/torvalds/linux/blob/bcf876870b95592b52519ed4aafcf9d95999bc9c/include/trace/events/sched.h#L138"  target="_blank" rel="noopener"
    >sched_switch</a> ‰∏∫‰æãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Tracepoint for task switches, performed by the scheduler:
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nf">TRACE_EVENT</span><span class="p">(</span><span class="n">sched_switch</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">TP_PROTO</span><span class="p">(</span><span class="kt">bool</span> <span class="n">preempt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		 <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		 <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">next</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">TP_ARGS</span><span class="p">(</span><span class="n">preempt</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">next</span><span class="p">),</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>TRACE_EVENT</code> ÂÆè‰ºöÊ†πÊçÆ‰∫ã‰ª∂ÂêçÁß∞ <code>sched_switch</code> ÁîüÊàê tracepoint ÊñπÊ≥ï <code>trace_sched_switch()</code>ÔºåÂú®Ê∫êÁ†Å‰∏≠Êü•ÊâæËØ•ÊñπÊ≥ïÔºåÂèëÁé∞Âú® <code>kernel/sched/core.c</code> ÁöÑ <a class="link" href="https://github.com/torvalds/linux/blob/bcf876870b95592b52519ed4aafcf9d95999bc9c/kernel/sched/core.c#L4216"  target="_blank" rel="noopener"
    >__schedule()</a>‰∏≠Ë∞ÉÁî®‰∫Ü<code>trace_sched_switch()</code> Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * __schedule() is the main scheduler function.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *...
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="n">__sched</span> <span class="n">notrace</span> <span class="nf">__schedule</span><span class="p">(</span><span class="kt">bool</span> <span class="n">preempt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">likely</span><span class="p">(</span><span class="n">prev</span> <span class="o">!=</span> <span class="n">next</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">rq</span><span class="o">-&gt;</span><span class="n">nr_switches</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="nf">trace_sched_switch</span><span class="p">(</span><span class="n">preempt</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">balance_callback</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊ†∑Êàë‰ª¨Â∞±ÊâæÂà∞‰∫Ü scheduler ÁöÑ‰∏ªÊµÅÁ®ãÔºåÂèØ‰ª•‰ªéËøôÈáåÂºÄÂßãÈòÖËØªËøõÁ®ãË∞ÉÂ∫¶ÁöÑÊ∫êÁ†Å„ÄÇ</p>
<h2 id="ÂÜôÂú®ÊúÄÂêé">ÂÜôÂú®ÊúÄÂêé</h2>
<p>Ftrace Â∞±ÂåÖÂê´Âú®ÂÜÖÊ†∏Ê∫êÁ†Å‰∏≠ <a class="link" href="https://github.com/torvalds/linux/tree/master/kernel/trace"  target="_blank" rel="noopener"
    >kernel/trace</a>ÔºåÁêÜËß£‰∫Ü Ftrace ÂÜÖÊ†∏‰∏çÂÜçÊòØÈªëÁÆ±Ôºå‰Ω†‰ºöÊúâË±ÅÁÑ∂ÂºÄÊúóÁöÑÊÑüËßâÔºåÂÜÖÊ†∏Ê∫êÁ†ÅÂøΩÁÑ∂ÊúâÊù°ÁêÜ‰∫ÜËµ∑Êù•„ÄÇËÆ©Êàë‰ª¨‰ªé Ftrace ÂºÄÂßãÂÜÖÊ†∏Êé¢Á¥¢‰πãÊóÖÂêß„ÄÇ</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/linux/">linux</a>
        
            <a href="/tags/kernel/">kernel</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Áõ∏ÂÖ≥ÊñáÁ´†</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/%E4%BB%8E%E6%BA%90%E7%A0%81%E6%9E%84%E5%BB%BA-perf/">
        
        

        <div class="article-details">
            <h2 class="article-title">‰ªéÊ∫êÁ†ÅÊûÑÂª∫ perf</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/linux-gnu/linux%E4%BB%A5%E5%8F%8Aalpine-linux/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linux, GNU/Linux‰ª•ÂèäAlpine Linux</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/">
        
        

        <div class="article-details">
            <h2 class="article-title">Ê∑±ÂÖ•ÊµÖÂá∫ÂÆπÂô®ÊäÄÊúØ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/gcc-%E4%B8%BA%E9%BE%99%E8%8A%AF-cpu%E7%9A%84%E9%A2%84%E5%AE%9A%E4%B9%89%E5%AE%8F/">
        
        

        <div class="article-details">
            <h2 class="article-title">GCC ‰∏∫ÈæôËäØ CPUÁöÑÈ¢ÑÂÆö‰πâÂÆè</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/linux-%E4%BF%A1%E5%8F%B7signal/">
        
        

        <div class="article-details">
            <h2 class="article-title">Linux ‰ø°Âè∑(Signal)</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mazhen-tech" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2014 - 
        
        2023 mazhen.tech
    </section>
    
    <section class="powerby">
        
            <a target=\"_blank\" href=\"https://beian.miit.gov.cn\">Á≤§ICPÂ§á2022085181Âè∑-1</a> <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
