<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="# CRaC çš„æ€§èƒ½é£è·ƒä¸ Linux å†…æ ¸çš„åŸºçŸ³ Java åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ï¼Œå°¤å…¶æ˜¯åœ¨å¾®æœåŠ¡å’Œ Serverless åœºæ™¯ä¸‹çš„â€œå†·å¯åŠ¨â€ï¼Œä¸€ç›´æ˜¯å…¶æ€§èƒ½ä¼˜åŒ–çš„é‡ç‚¹ã€‚ä¼ ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹æ¶‰åŠ JVM åˆå§‹åŒ–ã€ç±»åŠ ">
<title>ç†è§£ CRaC èƒŒåçš„ Linux ç³»ç»Ÿç¼–ç¨‹</title>

<link rel='canonical' href='https://mazhen.tech/p/%E7%90%86%E8%A7%A3-crac-%E8%83%8C%E5%90%8E%E7%9A%84-linux-%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/'>

<link rel="stylesheet" href="/scss/style.min.760e3dabc1e140d2e6abd27a8ca0aabb60e568829b29f67d2df12024136eff37.css"><meta property='og:title' content="ç†è§£ CRaC èƒŒåçš„ Linux ç³»ç»Ÿç¼–ç¨‹">
<meta property='og:description' content="# CRaC çš„æ€§èƒ½é£è·ƒä¸ Linux å†…æ ¸çš„åŸºçŸ³ Java åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ï¼Œå°¤å…¶æ˜¯åœ¨å¾®æœåŠ¡å’Œ Serverless åœºæ™¯ä¸‹çš„â€œå†·å¯åŠ¨â€ï¼Œä¸€ç›´æ˜¯å…¶æ€§èƒ½ä¼˜åŒ–çš„é‡ç‚¹ã€‚ä¼ ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹æ¶‰åŠ JVM åˆå§‹åŒ–ã€ç±»åŠ ">
<meta property='og:url' content='https://mazhen.tech/p/%E7%90%86%E8%A7%A3-crac-%E8%83%8C%E5%90%8E%E7%9A%84-linux-%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/'>
<meta property='og:site_name' content='mazhen.tech'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='linux' /><meta property='article:tag' content='java' /><meta property='article:tag' content='crac' /><meta property='article:tag' content='performance' /><meta property='article:published_time' content='2025-04-30T10:18:47&#43;08:00'/><meta property='article:modified_time' content='2025-04-30T10:18:47&#43;08:00'/>
<meta name="twitter:site" content="@rootletmistake">
    <meta name="twitter:creator" content="@rootletmistake"><meta name="twitter:title" content="ç†è§£ CRaC èƒŒåçš„ Linux ç³»ç»Ÿç¼–ç¨‹">
<meta name="twitter:description" content="# CRaC çš„æ€§èƒ½é£è·ƒä¸ Linux å†…æ ¸çš„åŸºçŸ³ Java åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ï¼Œå°¤å…¶æ˜¯åœ¨å¾®æœåŠ¡å’Œ Serverless åœºæ™¯ä¸‹çš„â€œå†·å¯åŠ¨â€ï¼Œä¸€ç›´æ˜¯å…¶æ€§èƒ½ä¼˜åŒ–çš„é‡ç‚¹ã€‚ä¼ ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹æ¶‰åŠ JVM åˆå§‹åŒ–ã€ç±»åŠ ">
    <link rel="shortcut icon" href="/favicon.png" />

  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-LBEVB8TRX2"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-LBEVB8TRX2');
        }
      </script>
    
  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/mazhen_hu6e56901738cd7f8ddabbbe3def51a5b4_111611_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">mazhen.tech</a></h1>
            <h2 class="site-description">Stay hungry. Stay foolish.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='mailto:me@mazhen.tech'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="3" y="5" width="18" height="14" rx="2" />
  <polyline points="3 7 12 13 21 7" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/mz1999'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.instagram.com/clippercongo/'
                        target="_blank"
                        title="instagram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-instagram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="4" y="4" width="16" height="16" rx="4" />
  <circle cx="12" cy="12" r="3" />
  <line x1="16.5" y1="7.5" x2="16.5" y2="7.501" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://t.me/crownrecount'
                        target="_blank"
                        title="telegram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-telegram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" />
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/rootletmistake'
                        target="_blank"
                        title="twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://mazhen.tech/" selected>ä¸­æ–‡</option>
                                
                                    <option value="https://mazhen.tech/en/" >English</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#crac-çš„æ€§èƒ½é£è·ƒä¸-linux-å†…æ ¸çš„åŸºçŸ³">CRaC çš„æ€§èƒ½é£è·ƒä¸ Linux å†…æ ¸çš„åŸºçŸ³</a></li>
    <li><a href="#è¿›ç¨‹ä¸çº¿ç¨‹åŠå…¶ç”Ÿå‘½å‘¨æœŸ">è¿›ç¨‹ä¸çº¿ç¨‹åŠå…¶ç”Ÿå‘½å‘¨æœŸ</a></li>
    <li><a href="#proc-æ–‡ä»¶ç³»ç»Ÿå†…æ ¸çŠ¶æ€çš„é€è§†é•œ">/proc æ–‡ä»¶ç³»ç»Ÿï¼šå†…æ ¸çŠ¶æ€çš„â€œé€è§†é•œâ€</a></li>
    <li><a href="#ptrace-ç³»ç»Ÿè°ƒç”¨æŒæ§è¿›ç¨‹çš„é¥æ§å™¨">ptrace ç³»ç»Ÿè°ƒç”¨ï¼šæŒæ§è¿›ç¨‹çš„â€œé¥æ§å™¨â€</a></li>
    <li><a href="#criu-å¦‚ä½•å®ç°-checkpoint-å’Œ-restore">CRIU å¦‚ä½•å®ç° Checkpoint å’Œ Restoreï¼Ÿ</a>
      <ol>
        <li><a href="#checkpoint-å†»ç»“è¿‡ç¨‹ä¸ºè¿›ç¨‹æ‹ä¸‹ç²¾ç¡®å¿«ç…§">Checkpoint (å†»ç»“è¿‡ç¨‹)ï¼šä¸ºè¿›ç¨‹æ‹ä¸‹ç²¾ç¡®å¿«ç…§</a></li>
        <li><a href="#restore-å¤è‹è¿‡ç¨‹ä»å¿«ç…§é‡å»ºé²œæ´»è¿›ç¨‹">Restore (å¤è‹è¿‡ç¨‹)ï¼šä»å¿«ç…§é‡å»ºé²œæ´»è¿›ç¨‹</a></li>
      </ol>
    </li>
    <li><a href="#crac-å¦‚ä½•æŒ‡æŒ¥-criu">CRaC å¦‚ä½•æŒ‡æŒ¥ CRIU</a>
      <ol>
        <li><a href="#checkpoint-æµç¨‹ä¸­çš„è¿›ç¨‹ä¹‹èˆ-double-fork">Checkpoint æµç¨‹ä¸­çš„è¿›ç¨‹ä¹‹èˆ (double fork)</a></li>
        <li><a href="#restore-æµç¨‹ä¸­çš„è¿›ç¨‹å˜èº«-execv-é“¾">Restore æµç¨‹ä¸­çš„è¿›ç¨‹â€œå˜èº«â€ (execv é“¾)</a></li>
      </ol>
    </li>
    <li><a href="#æ€»ç»“linux-ç³»ç»Ÿç¼–ç¨‹æ˜¯-crac-çš„åŸºçŸ³">æ€»ç»“ï¼šLinux ç³»ç»Ÿç¼–ç¨‹æ˜¯ CRaC çš„åŸºçŸ³</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tech/" >
                Tech
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E7%90%86%E8%A7%A3-crac-%E8%83%8C%E5%90%8E%E7%9A%84-linux-%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/">ç†è§£ CRaC èƒŒåçš„ Linux ç³»ç»Ÿç¼–ç¨‹</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-04-30</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 22 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="crac-çš„æ€§èƒ½é£è·ƒä¸-linux-å†…æ ¸çš„åŸºçŸ³">
    <a href="#crac-%e7%9a%84%e6%80%a7%e8%83%bd%e9%a3%9e%e8%b7%83%e4%b8%8e-linux-%e5%86%85%e6%a0%b8%e7%9a%84%e5%9f%ba%e7%9f%b3" class="header-anchor">#</a>
    CRaC çš„æ€§èƒ½é£è·ƒä¸ Linux å†…æ ¸çš„åŸºçŸ³
</h2><p>Java åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ï¼Œå°¤å…¶æ˜¯åœ¨å¾®æœåŠ¡å’Œ Serverless åœºæ™¯ä¸‹çš„â€œå†·å¯åŠ¨â€ï¼Œä¸€ç›´æ˜¯å…¶æ€§èƒ½ä¼˜åŒ–çš„é‡ç‚¹ã€‚ä¼ ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹æ¶‰åŠ JVM åˆå§‹åŒ–ã€ç±»åŠ è½½å’Œ JIT é¢„çƒ­ï¼Œè€—æ—¶è¾ƒé•¿ã€‚<strong>CRaC (Coordinated Restore at Checkpoint)</strong> æŠ€æœ¯ä¸ºæ­¤æä¾›äº†ä¸€ç§åˆ›æ–°æ–¹æ¡ˆï¼šå®ƒåœ¨åº”ç”¨è¾¾åˆ°ç†æƒ³çŠ¶æ€æ—¶æ•è·å…¶å®Œæ•´è¿è¡Œæ—¶å¿«ç…§ï¼ˆCheckpointï¼‰ï¼Œå¹¶åœ¨éœ€è¦æ—¶å¿«é€Ÿæ¢å¤ï¼ˆRestoreï¼‰ï¼Œä»è€Œå®ç°æ¯«ç§’çº§å¯åŠ¨å’Œå³æ—¶å³°å€¼æ€§èƒ½ã€‚</p>
<p>è¿™ç§å¼ºå¤§çš„è¿›ç¨‹â€œå†»ç»“â€ä¸â€œå¤è‹â€èƒ½åŠ›å¹¶éå‡­ç©ºè€Œæ¥ï¼Œå®ƒæ·±åº¦ä¾èµ–äº Linux æ“ä½œç³»ç»Ÿæä¾›çš„åº•å±‚æœºåˆ¶ï¼Œå¹¶é€šè¿‡ <strong>CRIU (Checkpoint/Restore In Userspace)</strong> è¿™ä¸ªå·¥å…·é›†å¾—ä»¥å®ç°ã€‚å› æ­¤ï¼Œè¦çœŸæ­£ç†è§£ CRaC çš„å·¥ä½œåŸç†ï¼Œæ¢ç©¶å…¶èƒŒåçš„ Linux ç³»ç»Ÿç¼–ç¨‹çŸ¥è¯†è‡³å…³é‡è¦ã€‚æœ¬æ–‡å°†ä¸ºç†Ÿæ‚‰ç¼–ç¨‹ä½†å¯èƒ½ä¸ç†Ÿæ‚‰ Linux åº•å±‚çš„å¼€å‘è€…ï¼Œè§£æ CRaC å®ç°æ‰€ä¾èµ–çš„å…³é”® Linux æ¦‚å¿µï¼ˆå¦‚è¿›ç¨‹/çº¿ç¨‹ã€/proc æ–‡ä»¶ç³»ç»Ÿã€ptrace ç³»ç»Ÿè°ƒç”¨ç­‰ï¼‰ï¼Œæ­ç¤º CRaC æ€§èƒ½é£è·ƒèƒŒåçš„ Linuxâ€œé­”æ³•â€ã€‚</p>
<h2 id="è¿›ç¨‹ä¸çº¿ç¨‹åŠå…¶ç”Ÿå‘½å‘¨æœŸ">
    <a href="#%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b%e5%8f%8a%e5%85%b6%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" class="header-anchor">#</a>
    è¿›ç¨‹ä¸çº¿ç¨‹åŠå…¶ç”Ÿå‘½å‘¨æœŸ
</h2><p>è¦ç†è§£ CRaC å¦‚ä½•æ“ä½œè¿è¡Œä¸­çš„ Java åº”ç”¨ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦äº†è§£ Linux æ˜¯å¦‚ä½•ç»„ç»‡å’Œç®¡ç†ç¨‹åºæ‰§è¡Œçš„ã€‚å…¶æ ¸å¿ƒæ¦‚å¿µæ˜¯<strong>è¿›ç¨‹ (Process)</strong>ã€‚ä½ å¯ä»¥å°†è¿›ç¨‹çœ‹ä½œæ˜¯ä¸€ä¸ª<strong>æ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„å®ä¾‹</strong>ï¼Œå®ƒæ˜¯æ“ä½œç³»ç»Ÿåˆ†é…èµ„æºï¼ˆå¦‚å†…å­˜ã€æ–‡ä»¶å¥æŸ„ï¼‰å’Œè¿›è¡Œè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½ä»¿ä½›ç”Ÿæ´»åœ¨è‡ªå·±çš„ç‹¬ç«‹ä¸–ç•Œé‡Œï¼Œæ‹¥æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œè¿™ä¿è¯äº†è¿›ç¨‹é—´çš„éš”ç¦»æ€§ã€‚</p>
<p>ç„¶è€Œï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹å†…éƒ¨ï¼Œå¾€å¾€éœ€è¦åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡æµã€‚è¿™æ—¶<strong>çº¿ç¨‹ (Thread)</strong> å°±ç™»åœºäº†ã€‚çº¿ç¨‹æ˜¯è¿›ç¨‹å†…éƒ¨çš„å®é™…æ‰§è¡Œå•å…ƒï¼Œæœ‰æ—¶ä¹Ÿè¢«ç§°ä¸ºè½»é‡çº§è¿›ç¨‹ï¼ˆLWPï¼‰ã€‚ä¸è¿›ç¨‹ä¸åŒï¼ŒåŒä¸€è¿›ç¨‹å†…çš„æ‰€æœ‰çº¿ç¨‹<strong>å…±äº«</strong>è¯¥è¿›ç¨‹çš„åœ°å€ç©ºé—´å’Œå¤§éƒ¨åˆ†èµ„æºï¼Œè¿™ä½¿å¾—çº¿ç¨‹é—´çš„é€šä¿¡å’Œåˆ‡æ¢æ›´ä¸ºé«˜æ•ˆã€‚ä½†æ¯ä¸ªçº¿ç¨‹ä»ç„¶ä¿æœ‰è‡ªå·±ç‹¬ç«‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œå¦‚ç¨‹åºè®¡æ•°å™¨ã€å¯„å­˜å™¨å’Œæ ˆã€‚</p>
<p>æœ‰è¶£çš„æ˜¯ï¼Œä» Linux å†…æ ¸çš„è§†è§’æ¥çœ‹ï¼Œå®ƒå¹¶ä¸ä¸¥æ ¼åŒºåˆ†è¿›ç¨‹å’Œçº¿ç¨‹ã€‚ä¸¤è€…éƒ½è¢«è§†ä¸ºå¯è°ƒåº¦çš„â€œ<strong>ä»»åŠ¡ (Task)</strong>â€ï¼Œå¹¶ç”±ç»Ÿä¸€çš„æ•°æ®ç»“æ„ task_struct æ¥æè¿°ã€‚çº¿ç¨‹ä»…ä»…æ˜¯ä¸å…¶ä»–ä»»åŠ¡å…±äº«äº†æ›´å¤šèµ„æºï¼ˆç‰¹åˆ«æ˜¯å†…å­˜åœ°å€ç©ºé—´ï¼‰çš„ä»»åŠ¡è€Œå·²ã€‚å› æ­¤ï¼Œå†…æ ¸è°ƒåº¦å™¨å¯ä»¥å¯¹å®ƒä»¬ä¸€è§†åŒä»ã€‚ä¸ºäº†ç®¡ç†è¿™äº›ä»»åŠ¡ï¼Œç³»ç»Ÿä¸ºå®ƒä»¬åˆ†é…äº†å”¯ä¸€çš„èº«ä»½æ ‡è¯†ï¼š<strong>PID (Process ID)</strong> ç”¨äºæ ‡è¯†æ•´ä¸ªè¿›ç¨‹ï¼ˆä¸€ç»„å…±äº«èµ„æºçš„çº¿ç¨‹ï¼‰ï¼Œè€Œ <strong>TID (Thread ID)</strong> åˆ™ç”¨äºæ ‡è¯†æ¯ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰ã€‚å¯¹äºå•çº¿ç¨‹è¿›ç¨‹ï¼ŒPID å’Œ TID æ˜¯ç›¸åŒçš„ã€‚</p>
<p>æ–°è¿›ç¨‹çš„è¯ç”Ÿï¼Œæœ€ç»å…¸çš„æ–¹å¼æ˜¯é€šè¿‡ fork() ç³»ç»Ÿè°ƒç”¨ã€‚å½“ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨ fork()ï¼Œå†…æ ¸ä¼šåˆ›å»ºå‡ºå®ƒçš„ä¸€ä¸ªå‡ ä¹å®Œå…¨ç›¸åŒçš„å‰¯æœ¬â€”â€”å­è¿›ç¨‹ã€‚å­è¿›ç¨‹ç»§æ‰¿äº†çˆ¶è¿›ç¨‹å¤§éƒ¨åˆ†çŠ¶æ€ï¼ŒåŒ…æ‹¬å†…å­˜å†…å®¹çš„å‰¯æœ¬ï¼ˆé€šè¿‡å†™æ—¶å¤åˆ¶ä¼˜åŒ–ï¼‰ã€æ–‡ä»¶æè¿°ç¬¦ç­‰ã€‚fork() çš„å¥‡å¦™ä¹‹å¤„åœ¨äºå®ƒåœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹çš„ PIDï¼Œè€Œåœ¨å­è¿›ç¨‹ä¸­è¿”å› 0ï¼Œä½¿å¾—ç¨‹åºå¯ä»¥æ ¹æ®è¿”å›å€¼åŒºåˆ†çˆ¶å­ï¼Œæ‰§è¡Œä¸åŒçš„é€»è¾‘ã€‚CRIU åœ¨æ¢å¤è¿›ç¨‹çŠ¶æ€æ—¶ï¼Œæ­£æ˜¯åˆ©ç”¨ fork() æ¥é‡å»º Checkpoint æ—¶åˆ»çš„è¿›ç¨‹æ ‘ç»“æ„ã€‚</p>
<p><strong>fork() ç¤ºä¾‹ä»£ç  (fork_example.c)</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span> <span class="c1">// åˆ›å»ºå­è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// fork å¤±è´¥  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fork failed&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// å­è¿›ç¨‹æ‰§è¡Œçš„ä»£ç   
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;I am the child process, PID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// æ¨¡æ‹Ÿå·¥ä½œ  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Child process exiting.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT</span><span class="err">\</span><span class="n">_SUCCESS</span><span class="p">);</span> <span class="c1">// å­è¿›ç¨‹æ­£å¸¸é€€å‡º  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// çˆ¶è¿›ç¨‹æ‰§è¡Œçš„ä»£ç   
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;I am the parent process, PID: %d, Child PID: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">(),</span> <span class="n">pid</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Parent waiting for child...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">wait</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="c1">// ç®€å•ç­‰å¾…ä»»æ„å­è¿›ç¨‹  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Parent process: Child finished.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Process %d exiting.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// ç¼–è¯‘è¿è¡Œï¼šgcc fork_example.c -o fork_example &amp;&amp; ./fork_example
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>é™¤äº† fork()ï¼Œè¿˜æœ‰ä¸€ä¸ªæ›´åº•å±‚çš„ç³»ç»Ÿè°ƒç”¨ clone()ï¼Œå®ƒæä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œå…è®¸æŒ‡å®šæ–°åˆ›å»ºçš„ä»»åŠ¡ä¸çˆ¶ä»»åŠ¡å…±äº«å“ªäº›èµ„æºï¼Œå› æ­¤ clone() æ—¢å¯ä»¥ç”¨æ¥åˆ›å»ºè¿›ç¨‹ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥åˆ›å»ºçº¿ç¨‹ã€‚</p>
<p>fork() åˆ›å»ºçš„å­è¿›ç¨‹é»˜è®¤æ‰§è¡Œçš„æ˜¯å’Œçˆ¶è¿›ç¨‹ç›¸åŒçš„ä»£ç ã€‚å¦‚æœå¸Œæœ›å­è¿›ç¨‹å»æ‰§è¡Œä¸€ä¸ª<strong>å…¨æ–°çš„ç¨‹åº</strong>ï¼Œå°±éœ€è¦ exec ç³»åˆ—ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ execv(), execlp() ç­‰ï¼‰çš„å¸®åŠ©ã€‚exec è°ƒç”¨ä¼šç”¨æ–°ç¨‹åºçš„æ˜ åƒ<strong>å®Œå…¨æ›¿æ¢</strong>å½“å‰è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼ˆä»£ç ã€æ•°æ®ã€å †æ ˆï¼‰ï¼Œç„¶åä»æ–°ç¨‹åºçš„å…¥å£ç‚¹å¼€å§‹æ‰§è¡Œã€‚ä¸€æ—¦ exec æˆåŠŸï¼ŒåŸæ¥çš„ç¨‹åºå°±ä¸å¤å­˜åœ¨äº†ï¼Œè¿™ä¸ªè°ƒç”¨æœ¬èº«ä¹Ÿä¸ä¼šè¿”å›ã€‚CRaC åœ¨æ¢å¤è¿‡ç¨‹ä¸­ï¼Œcriuengine è¿™ä¸ªè¾…åŠ©ç¨‹åºå°±åˆ©ç”¨äº†ä¸€è¿ä¸²çš„ execv è°ƒç”¨ï¼Œä¸æ–­â€œå˜èº«â€ï¼Œæœ€ç»ˆæˆä¸ºè´Ÿè´£ç­‰å¾…æ¢å¤å JVM é€€å‡ºçš„ restorewait è¿›ç¨‹ã€‚</p>
<p><strong>execv() ç¤ºä¾‹ä»£ç  (exec_example.c)</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;fork failed&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// å­è¿›ç¨‹  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Child process (PID: %d) will execute &#39;ls -l&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;/bin/ls&#34;</span><span class="p">,</span> <span class="s">&#34;-l&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span> <span class="c1">// å‡†å¤‡å‚æ•°åˆ—è¡¨  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">execv</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">);</span> <span class="c1">// æ‰§è¡Œæ–°ç¨‹åº  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœ execv è¿”å›ï¼Œè¯´æ˜å‡ºé”™äº†  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;execv failed&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// çˆ¶è¿›ç¨‹  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Parent process (PID: %d) waiting for child (PID: %d)...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">(),</span> <span class="n">pid</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">wait</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="c1">// ç­‰å¾…å­è¿›ç¨‹ç»“æŸ  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Parent process: Child finished executing &#39;ls -l&#39;.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// ç¼–è¯‘è¿è¡Œï¼šgcc exec_example.c -o exec_example &amp;&amp; ./exec_example
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>è¿›ç¨‹æœ‰ç”Ÿå°±æœ‰ç­ã€‚å½“å­è¿›ç¨‹ç»“æŸæ—¶ï¼Œå®ƒå¹¶ä¸ä¼šç«‹å³æ¶ˆå¤±ã€‚å†…æ ¸ä¼šä¿ç•™å®ƒçš„é€€å‡ºçŠ¶æ€ç­‰ä¿¡æ¯ï¼Œç­‰å¾…çˆ¶è¿›ç¨‹æ¥â€œè®¤é¢†â€ã€‚çˆ¶è¿›ç¨‹é€šè¿‡è°ƒç”¨ wait() æˆ– waitpid() ç³»ç»Ÿè°ƒç”¨æ¥è·å–å­è¿›ç¨‹çš„ç»ˆæ­¢ä¿¡æ¯ï¼Œå¹¶å‘ŠçŸ¥å†…æ ¸å¯ä»¥å½»åº•æ¸…ç†è¯¥å­è¿›ç¨‹äº†ã€‚waitpid() æä¾›äº†æ›´å¤šæ§åˆ¶ï¼Œæ¯”å¦‚å¯ä»¥ç­‰å¾…æŒ‡å®šçš„å­è¿›ç¨‹ï¼Œæˆ–è€…ä»¥éé˜»å¡çš„æ–¹å¼æ£€æŸ¥å­è¿›ç¨‹çŠ¶æ€ã€‚</p>
<p><strong>waitpid() ç¤ºä¾‹ä»£ç  (waitpid_example.c)</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span> <span class="n">pid1</span><span class="p">,</span> <span class="n">pid2</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">pid1</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span> <span class="c1">// åˆ›å»ºç¬¬ä¸€ä¸ªå­è¿›ç¨‹  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">pid1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Child 1 */</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Child 1 (PID: %d) running...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">());</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Child 1 exiting.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> <span class="nf">exit</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">pid2</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span> <span class="c1">// åˆ›å»ºç¬¬äºŒä¸ªå­è¿›ç¨‹  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">pid2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Child 2 */</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Child 2 (PID: %d) running...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">());</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Child 2 exiting.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span> <span class="nf">exit</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// çˆ¶è¿›ç¨‹ç­‰å¾…ç‰¹å®šçš„å­è¿›ç¨‹ pid1  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Parent waiting for Child 1 (PID: %d)...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid1</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span> <span class="n">terminated_pid</span> <span class="o">=</span> <span class="nf">waitpid</span><span class="p">(</span><span class="n">pid1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// é˜»å¡ç­‰å¾… pid1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">terminated_pid</span> <span class="o">==</span> <span class="n">pid1</span> <span class="o">&amp;&amp;</span> <span class="nf">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Parent: Child 1 terminated normally with status: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Handle error or abnormal termination */</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// çˆ¶è¿›ç¨‹ç­‰å¾…å¦ä¸€ä¸ªå­è¿›ç¨‹ pid2  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Parent waiting for Child 2 (PID: %d)...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid2</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="n">terminated_pid</span> <span class="o">=</span> <span class="nf">waitpid</span><span class="p">(</span><span class="n">pid2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// é˜»å¡ç­‰å¾… pid2  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">if</span> <span class="p">(</span><span class="n">terminated_pid</span> <span class="o">==</span> <span class="n">pid2</span> <span class="o">&amp;&amp;</span> <span class="nf">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Parent: Child 2 terminated normally with status: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Handle error or abnormal termination */</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Parent exiting.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// ç¼–è¯‘è¿è¡Œï¼šgcc waitpid_example.c -o waitpid_example &amp;&amp; ./waitpid_example
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœåœ¨å­è¿›ç¨‹ç»ˆæ­¢åï¼Œçˆ¶è¿›ç¨‹æ²¡æœ‰åŠæ—¶è°ƒç”¨ wait() æˆ– waitpid()ï¼Œé‚£ä¹ˆè¿™ä¸ªå­è¿›ç¨‹å°±ä¼šå˜æˆ<strong>åƒµå°¸è¿›ç¨‹ (Zombie Process)</strong>ã€‚å®ƒè™½ç„¶ä¸å†è¿è¡Œï¼Œä½†ä»åœ¨è¿›ç¨‹è¡¨ä¸­å æ®ä¸€ä¸ªä½ç½®ï¼Œç­‰å¾…çˆ¶è¿›ç¨‹å›æ”¶ã€‚å¦‚æœçˆ¶è¿›ç¨‹å…ˆäºå­è¿›ç¨‹é€€å‡ºï¼Œå­è¿›ç¨‹å°±æˆäº†<strong>å­¤å„¿è¿›ç¨‹ (Orphan Process)</strong>ã€‚ä¸ºäº†é¿å…å­¤å„¿è¿›ç¨‹å˜æˆæ— äººè®¤é¢†çš„åƒµå°¸ï¼ŒLinux ä¼šè‡ªåŠ¨å°†å®ƒä»¬çš„çˆ¶è¿›ç¨‹è®¾ç½®ä¸º init è¿›ç¨‹ï¼ˆPID 1ï¼‰ï¼Œç”± init è¿›ç¨‹è´Ÿè´£å›æ”¶å®ƒä»¬ã€‚</p>
<p>ç†è§£äº†å­¤å„¿è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å›æ”¶æœºåˆ¶åï¼Œå°±èƒ½æ˜ç™½ä¸€ç§å¸¸è§çš„ç¼–ç¨‹æŠ€å·§â€”â€”<strong>Double Fork</strong>ã€‚å®ƒçš„ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªä¸åŸå§‹çˆ¶è¿›ç¨‹å®Œå…¨è„±ç¦»å…³ç³»çš„åå°è¿›ç¨‹ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰ã€‚å…¶æ­¥éª¤æ˜¯ï¼šè¿›ç¨‹ A fork å‡ºå­è¿›ç¨‹ Bï¼Œç„¶åè¿›ç¨‹ A ç«‹åˆ» waitpid() ç­‰å¾… B ç»“æŸå¹¶é€€å‡ºï¼›å­è¿›ç¨‹ B å†æ¬¡ fork å‡ºå­™å­è¿›ç¨‹ Cï¼Œç„¶å B è‡ªå·±ç«‹åˆ»é€€å‡ºï¼›æ­¤æ—¶ï¼Œå­™å­è¿›ç¨‹ C æˆä¸ºå­¤å„¿ï¼Œè¢« init è¿›ç¨‹æ¥ç®¡ï¼Œä»è€Œä¸ A å½»åº•è§£è€¦ã€‚CRIU åœ¨æ‰§è¡Œ Checkpoint æ—¶ï¼Œå°±è¿ç”¨äº†ç±»ä¼¼ double fork çš„æ–¹æ³•ï¼Œè®©æ‰§è¡Œ criu dump å‘½ä»¤çš„è¿›ç¨‹è„±ç¦»è¢«æ“ä½œçš„ JVM è¿›ç¨‹æ ‘ï¼Œé¿å…äº†â€œè‡ªå·±å†»ç»“è‡ªå·±â€çš„å°´å°¬å±€é¢ã€‚</p>
<p><strong>double_fork ç¤ºä¾‹ä»£ç  (double_fork_example.c)</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;  </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span> <span class="n">pid1</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span> <span class="c1">// ç¬¬ä¸€æ¬¡ fork
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pid1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;First fork failed&#34;</span><span class="p">);</span> <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span> <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ç¬¬ä¸€ä¸ªå­è¿›ç¨‹ (è¿›ç¨‹ B)  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">pid_t</span> <span class="n">pid2</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span> <span class="c1">// ç¬¬äºŒæ¬¡ fork  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pid2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;Second fork failed&#34;</span><span class="p">);</span> <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span> <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// å­™å­è¿›ç¨‹ (è¿›ç¨‹ C)  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Grandchild process (PID: %d, Parent PID: %d) starting.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">(),</span> <span class="nf">getppid</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">// é€šå¸¸åœ¨è¿™é‡Œæ‰§è¡Œ setsid() ç­‰å®ˆæŠ¤è¿›ç¨‹åŒ–æ“ä½œ  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c1">// æ¨¡æ‹Ÿåå°ä»»åŠ¡  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Grandchild process finished.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// ç¬¬ä¸€ä¸ªå­è¿›ç¨‹ (è¿›ç¨‹ B) ç«‹å³é€€å‡º  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;First child process (PID: %d) exiting immediately.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// åŸå§‹çˆ¶è¿›ç¨‹ (è¿›ç¨‹ A)  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Original parent process (PID: %d) waiting for first child (PID: %d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">getpid</span><span class="p">(),</span> <span class="n">pid1</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="nf">waitpid</span><span class="p">(</span><span class="n">pid1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// ç­‰å¾…ç¬¬ä¸€ä¸ªå­è¿›ç¨‹é€€å‡º  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Original parent exiting.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">// å­™å­è¿›ç¨‹å·²æˆä¸ºå­¤å„¿å¹¶ç”± init æ¥ç®¡  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="c1">// ç¼–è¯‘è¿è¡Œï¼šgcc double_fork_example.c -o double_fork_example &amp;&amp; ./double_fork_example
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æŒæ¡äº† Linux è¿›ç¨‹å’Œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæˆ‘ä»¬å°±èƒ½æ›´å¥½åœ°ç†è§£ CRaC æ˜¯å¦‚ä½•åœ¨è¿™äº›åŸºç¡€ä¸Šè¿›è¡Œç²¾ç¡®çš„çŠ¶æ€æ•è·ä¸æ¢å¤ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ç›®å…‰æŠ•å‘ Linux æä¾›çš„ä¸€ä¸ªå¼ºå¤§å·¥å…·â€”â€”/proc æ–‡ä»¶ç³»ç»Ÿï¼Œçœ‹çœ‹å®ƒå¦‚ä½•å¸®åŠ©æˆ‘ä»¬â€œé€è§†â€è¿è¡Œä¸­è¿›ç¨‹çš„å†…éƒ¨çŠ¶æ€ã€‚</p>
<h2 id="proc-æ–‡ä»¶ç³»ç»Ÿå†…æ ¸çŠ¶æ€çš„é€è§†é•œ">
    <a href="#proc-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e5%86%85%e6%a0%b8%e7%8a%b6%e6%80%81%e7%9a%84%e9%80%8f%e8%a7%86%e9%95%9c" class="header-anchor">#</a>
    /proc æ–‡ä»¶ç³»ç»Ÿï¼šå†…æ ¸çŠ¶æ€çš„â€œé€è§†é•œâ€
</h2><p>æˆ‘ä»¬å·²ç»äº†è§£äº† Linux å¦‚ä½•åˆ›å»ºå’Œç®¡ç†è¿›ç¨‹ï¼Œä½†è¦å®ç°åƒ CRaC é‚£æ ·çš„â€œå†»ç»“â€ä¸â€œå¤è‹â€ï¼Œå°±å¿…é¡»æœ‰åŠæ³•<strong>æ·±å…¥æ¢æŸ¥</strong>ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å†…éƒ¨çš„è¯¦ç»†çŠ¶æ€ã€‚Linux æä¾›äº†ä¸€ä¸ªéå¸¸å¼ºå¤§çš„æœºåˆ¶æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œé‚£å°±æ˜¯ /proc æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<p>åˆçœ‹èµ·æ¥ï¼Œ/proc åƒæ˜¯ä¸€ä¸ªæ™®é€šçš„ç›®å½•ï¼Œä½ å¯ä»¥ç”¨ cd è¿›å…¥ï¼Œç”¨ ls æŸ¥çœ‹ã€‚ä½†å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ª<strong>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</strong>ã€‚è¿™æ„å‘³ç€å®ƒé‡Œé¢çš„æ–‡ä»¶å’Œç›®å½•å¹¶ä¸çœŸæ­£å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œè€Œæ˜¯ç”± Linux å†…æ ¸åœ¨<strong>è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆ</strong>çš„ã€‚/proc æ˜¯å†…æ ¸å‘ç”¨æˆ·ç©ºé—´ï¼ˆè¿è¡Œä¸­çš„ç¨‹åºå’Œç”¨æˆ·ï¼‰æš´éœ²å…¶å†…éƒ¨æ•°æ®ç»“æ„å’Œç³»ç»Ÿä¿¡æ¯çš„ä¸»è¦æ¥å£ä¹‹ä¸€ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€æ‰‡çª—æˆ·ï¼Œé€è¿‡å®ƒï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è§‚å¯Ÿåˆ°å†…æ ¸ç®¡ç†ä¸‹çš„ç³»ç»ŸçŠ¶æ€ï¼Œç‰¹åˆ«æ˜¯<strong>è¿è¡Œä¸­è¿›ç¨‹çš„å®æ—¶ä¿¡æ¯</strong>ã€‚</p>
<p>è¿™å¯¹äº CRIU å’Œ CRaC æ¥è¯´ç®€ç›´æ˜¯æ— ä»·ä¹‹å®ã€‚å½“ CRIU éœ€è¦å¯¹ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œ Checkpoint æ—¶ï¼Œå®ƒçš„å¤§éƒ¨åˆ†ä¿¡æ¯æ¥æºå°±æ˜¯ /proc æ–‡ä»¶ç³»ç»Ÿã€‚é€šè¿‡è¯»å– /proc ä¸‹çš„ç‰¹å®šæ–‡ä»¶ï¼ŒCRIU èƒ½å¤Ÿè·å–åˆ°ç›®æ ‡è¿›ç¨‹å‡ ä¹æ‰€æœ‰çš„å…³é”®çŠ¶æ€æ•°æ®ï¼Œä»è€Œæ„å»ºå‡ºå®Œæ•´çš„è¿›ç¨‹å¿«ç…§ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ /proc ä¸‹ä¸è¿›ç¨‹ç›¸å…³çš„å‡ ä¸ªå…³é”®â€œæƒ…æŠ¥ç«™â€ï¼Œå®ƒä»¬é€šå¸¸ä½äºä»¥è¿›ç¨‹ PID å‘½åçš„ç›®å½•ä¸‹ï¼Œå³ /proc/&lt;pid&gt;/ï¼š</p>
<ul>
<li><strong>å†…å­˜å¸ƒå±€å›¾ (/proc/&lt;pid&gt;/maps å’Œ smaps)</strong>: è¿™ä¸¤ä¸ªæ–‡ä»¶æ­ç¤ºäº†è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜æ˜¯å¦‚ä½•ç»„ç»‡çš„ã€‚maps æ–‡ä»¶åˆ—å‡ºäº†è¿›ç¨‹çš„æ‰€æœ‰å†…å­˜åŒºåŸŸï¼ˆç§°ä¸º VMAï¼ŒVirtual Memory Areaï¼‰ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€å †ã€æ ˆä»¥åŠå†…å­˜æ˜ å°„çš„æ–‡ä»¶å’Œå…±äº«åº“ï¼Œæ ‡æ˜äº†æ¯ä¸ªåŒºåŸŸçš„èµ·æ­¢åœ°å€å’Œæƒé™ã€‚smaps æ–‡ä»¶åˆ™æä¾›äº†æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯ä¸ª VMA å®é™…å ç”¨çš„ç‰©ç†å†…å­˜ï¼ˆRSS - Resident Set Sizeï¼‰ã€å…±äº«/ç§æœ‰å†…å­˜é‡ã€è„é¡µï¼ˆDirty pagesï¼‰æ•°é‡ç­‰ã€‚CRIU é€šè¿‡è§£æå®ƒä»¬æ¥ç²¾ç¡®äº†è§£è¿›ç¨‹çš„å†…å­˜ç»“æ„ï¼Œè¿™æ˜¯ Checkpoint å’Œ Restore å†…å­˜çŠ¶æ€çš„åŸºç¡€ã€‚</li>
<li><strong>æ‰“å¼€çš„æ–‡ä»¶å’Œè¿æ¥ (/proc/&lt;pid&gt;/fd/ å’Œ fdinfo/)</strong>: fd æ˜¯ä¸€ä¸ªç›®å½•ï¼Œé‡Œé¢åŒ…å«äº†æŒ‡å‘è¯¥è¿›ç¨‹å½“å‰æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„ç¬¦å·é“¾æ¥ã€‚é“¾æ¥çš„åç§°å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦çš„æ•°å­—ï¼ˆå¦‚ 0, 1, 2 åˆ†åˆ«ä»£è¡¨æ ‡å‡†è¾“å…¥ã€è¾“å‡ºã€é”™è¯¯ï¼‰ï¼Œé“¾æ¥çš„ç›®æ ‡åˆ™æŒ‡æ˜äº†å®ƒå®é™…ä»£è¡¨çš„æ–‡ä»¶ã€ç®¡é“æˆ–å¥—æ¥å­—ã€‚è€Œ fdinfo ç›®å½•ä¸‹åˆ™åŒ…å«äº†ä¸ fd ä¸­æ¯ä¸ªæè¿°ç¬¦å¯¹åº”çš„æ–‡ä»¶ï¼Œè®°å½•äº†æ›´è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ä»¶çš„å½“å‰è¯»å†™ä½ç½®ï¼ˆoffsetï¼‰ã€æ‰“å¼€æ—¶çš„æ ‡å¿—ä½ï¼ˆflagsï¼‰ç­‰ã€‚CRIU éœ€è¦è¯»å–è¿™äº›ä¿¡æ¯æ¥ä¿å­˜å’Œæ¢å¤è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶çŠ¶æ€ã€‚</li>
<li><strong>è¿›ç¨‹çŠ¶æ€æŠ¥å‘Š (/proc/&lt;pid&gt;/stat)</strong>: è¿™ä¸ªæ–‡ä»¶ä»¥ä¸€è¡Œæ–‡æœ¬çš„å½¢å¼ï¼Œæä¾›äº†å…³äºè¿›ç¨‹çš„å¤§é‡çŠ¶æ€ä¿¡æ¯ï¼Œç”±ç©ºæ ¼åˆ†éš”ã€‚åŒ…æ‹¬è¿›ç¨‹åã€çŠ¶æ€ï¼ˆè¿è¡Œã€ç¡çœ ã€åƒµå°¸ç­‰ï¼‰ã€çˆ¶è¿›ç¨‹ PIDã€è¿›ç¨‹ç»„ IDã€ä½¿ç”¨çš„å†…å­˜é‡ã€CPU æ—¶é—´ç»Ÿè®¡ç­‰ç­‰ã€‚CRIU ç”¨å®ƒæ¥è·å–è¿›ç¨‹çš„åŸºæœ¬å±æ€§å’Œè¿è¡Œç»Ÿè®¡ã€‚</li>
<li><strong>çº¿ç¨‹æˆå‘˜åˆ—è¡¨ (/proc/&lt;pid&gt;/task/)</strong>: å¯¹äºå¤šçº¿ç¨‹è¿›ç¨‹ï¼Œè¿™ä¸ªç›®å½•éå¸¸é‡è¦ã€‚å®ƒä¸‹é¢åŒ…å«äº†ä»¥è¯¥è¿›ç¨‹ä¸‹<strong>æ‰€æœ‰çº¿ç¨‹çš„ TID</strong> å‘½åçš„å­ç›®å½•ã€‚é€šè¿‡éå†è¿™ä¸ªç›®å½•ï¼ŒCRIU å¯ä»¥è¯†åˆ«å‡ºä¸€ä¸ªè¿›ç¨‹åŒ…å«çš„æ‰€æœ‰çº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰ï¼Œå¹¶å¯¹æ¯ä¸ªçº¿ç¨‹è¿›è¡Œå•ç‹¬çš„çŠ¶æ€æ•è·ã€‚</li>
<li><strong>å­è¿›ç¨‹è®°å½• (/proc/&lt;pid&gt;/task/&lt;tid&gt;/children)</strong>: è¿™ä¸ªæ–‡ä»¶ï¼ˆä½äºç‰¹å®šçº¿ç¨‹ç›®å½•ä¸‹ï¼‰è®°å½•äº†ç”±è¯¥çº¿ç¨‹ç›´æ¥åˆ›å»ºçš„æ‰€æœ‰å­è¿›ç¨‹çš„ PID åˆ—è¡¨ã€‚é€šè¿‡é€’å½’åœ°è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼ŒCRIU èƒ½å¤Ÿå‡†ç¡®åœ°æ„å»ºå‡ºå®Œæ•´çš„è¿›ç¨‹æ ‘æˆ–è¿›ç¨‹å®¶æ—ã€‚</li>
<li><strong>å†…å­˜æ˜ å°„æ–‡ä»¶è®¿é—® (/proc/&lt;pid&gt;/map_files/)</strong>: è¿™ä¸ªç›®å½•åŒ…å«äº†æŒ‡å‘è¿›ç¨‹å†…å­˜ä¸­é€šè¿‡æ–‡ä»¶æ˜ å°„ï¼ˆmmapï¼‰æ–¹å¼åŠ è½½çš„å®é™…æ–‡ä»¶çš„ç¬¦å·é“¾æ¥ã€‚é“¾æ¥çš„åç§°å¯¹åº” maps æ–‡ä»¶ä¸­çš„åœ°å€èŒƒå›´ã€‚è¿™ä¸º CRIU æä¾›äº†ä¸€ç§å¯é çš„æ–¹å¼æ¥è®¿é—®å’Œè¯»å–è¿™äº›æ˜ å°„æ–‡ä»¶çš„å†…å®¹ã€‚</li>
</ul>
<p>é€šè¿‡ç»„åˆåˆ©ç”¨ /proc æ–‡ä»¶ç³»ç»Ÿæä¾›çš„è¿™äº›ï¼ˆä»¥åŠå…¶ä»–æœªåˆ—å‡ºçš„ï¼‰ä¿¡æ¯æºï¼ŒCRIU èƒ½å¤Ÿåƒä¾¦æ¢ä¸€æ ·ï¼Œç»†è‡´å…¥å¾®åœ°æ”¶é›†ç›®æ ‡è¿›ç¨‹åŠå…¶æ‰€æœ‰çº¿ç¨‹ã€å­è¿›ç¨‹åœ¨ Checkpoint æ—¶åˆ»çš„å®Œæ•´çŠ¶æ€ã€‚æ²¡æœ‰ /proc è¿™ä¸ªå¼ºå¤§çš„â€œé€è§†é•œâ€ï¼Œå®ç°ç”¨æˆ·ç©ºé—´çš„ Checkpoint/Restore å°†ä¼šå›°éš¾å¾—å¤šã€‚</p>
<p>äº†è§£äº†å¦‚ä½•é€šè¿‡ /proc è·å–è¿›ç¨‹çŠ¶æ€åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†å…³æ³¨è¿›ç¨‹è¿è¡Œçš„â€œèˆå°â€â€”â€”å†…å­˜ç®¡ç†ï¼Œä»¥åŠè¿›ç¨‹å¦‚ä½•ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’çš„â€œç®¡é“â€â€”â€”æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<h2 id="ptrace-ç³»ç»Ÿè°ƒç”¨æŒæ§è¿›ç¨‹çš„é¥æ§å™¨">
    <a href="#ptrace-%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e6%8e%8c%e6%8e%a7%e8%bf%9b%e7%a8%8b%e7%9a%84%e9%81%a5%e6%8e%a7%e5%99%a8" class="header-anchor">#</a>
    ptrace ç³»ç»Ÿè°ƒç”¨ï¼šæŒæ§è¿›ç¨‹çš„â€œé¥æ§å™¨â€
</h2><p>é€šè¿‡ /proc æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬è·å¾—äº†è§‚å¯Ÿè¿è¡Œä¸­è¿›ç¨‹å†…éƒ¨çŠ¶æ€çš„å¼ºå¤§èƒ½åŠ›ï¼Œå°±åƒæœ‰äº†ä¸€å‰¯â€œé€è§†é•œâ€ã€‚ä½†è¿™è¿˜ä¸å¤Ÿï¼Œè¦å®ç°åƒ CRaC/CRIU çš„ Checkpoint/Restoreï¼Œæˆ‘ä»¬ä¸ä»…éœ€è¦<strong>è§‚å¯Ÿ</strong>ï¼Œè¿˜éœ€è¦èƒ½å¤Ÿ<strong>æ§åˆ¶</strong>å’Œ<strong>æ“çºµ</strong>ç›®æ ‡è¿›ç¨‹â€”â€”åœ¨åˆé€‚çš„æ—¶æœºè®©å®ƒæš‚åœï¼Œè¯»å–ç”šè‡³ä¿®æ”¹å®ƒçš„å†…å­˜å’Œå¯„å­˜å™¨çŠ¶æ€ï¼Œç”šè‡³å¼ºåˆ¶å®ƒæ‰§è¡ŒæŸäº›æ“ä½œã€‚è¿™æ—¶ï¼ŒLinux æä¾›äº†ä¸€ä¸ªç»ˆææ­¦å™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé¢‡å…·äº‰è®®ä½†æå…¶å¼ºå¤§çš„ç³»ç»Ÿè°ƒç”¨ï¼šptrace (process trace)ã€‚</p>
<p>ptrace æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå…è®¸ä¸€ä¸ªè¿›ç¨‹ï¼ˆç§°ä¸º <strong>tracer</strong>ï¼Œè¿½è¸ªè€…ï¼‰å»<strong>è§‚å¯Ÿå’Œæ§åˆ¶</strong>å¦ä¸€ä¸ªè¿›ç¨‹ï¼ˆç§°ä¸º <strong>tracee</strong>ï¼Œè¢«è¿½è¸ªè€…ï¼‰çš„æ‰§è¡Œï¼Œæ£€æŸ¥å’Œæ”¹å˜ tracee çš„å†…å­˜å’Œå¯„å­˜å™¨ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªèµ‹äºˆ tracer è¿›ç¨‹çš„â€œè¿œç¨‹æ§åˆ¶å™¨â€ï¼Œå¯ä»¥ç”¨æ¥é¥æ§ tracee è¿›ç¨‹çš„ä¸€ä¸¾ä¸€åŠ¨ã€‚</p>
<p>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯è®¸å¤šåº•å±‚å·¥å…·çš„åŸºçŸ³ï¼š</p>
<ul>
<li><strong>è°ƒè¯•å™¨ (Debuggers)</strong>ï¼šåƒ GDB è¿™æ ·çš„è°ƒè¯•å™¨ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½ï¼ˆè®¾ç½®æ–­ç‚¹ã€å•æ­¥æ‰§è¡Œã€æ£€æŸ¥å˜é‡å€¼ã€æŸ¥çœ‹è°ƒç”¨æ ˆç­‰ï¼‰å‡ ä¹å®Œå…¨ä¾èµ–äº ptraceã€‚è°ƒè¯•å™¨å°±æ˜¯ä¸€ä¸ª tracer è¿›ç¨‹ï¼Œè€Œè¢«è°ƒè¯•çš„ç¨‹åºå°±æ˜¯ traceeã€‚</li>
<li><strong>ç³»ç»Ÿè°ƒç”¨è¿½è¸ªå·¥å…· (System Call Tracers)</strong>ï¼šstrace å‘½ä»¤èƒ½å¤Ÿæ˜¾ç¤ºä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œçš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨åŠå…¶å‚æ•°å’Œè¿”å›å€¼ï¼Œè¿™ä¹Ÿæ˜¯é€šè¿‡ ptrace å®ç°çš„ã€‚</li>
<li><strong>CRIU (Checkpoint/Restore In Userspace)</strong>ï¼šæ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼ŒCRIU å¤§é‡ä½¿ç”¨ ptrace æ¥å®Œæˆé‚£äº›ä»…é  /proc æ— æ³•å®Œæˆçš„ä»»åŠ¡ï¼Œæ¯”å¦‚ç²¾ç¡®åœ°æš‚åœè¿›ç¨‹ã€è·å–å’Œæ¢å¤å¯„å­˜å™¨çŠ¶æ€ã€æ³¨å…¥â€œå¯„ç”Ÿä»£ç â€ç­‰ã€‚</li>
</ul>
<p>ptrace æœ¬èº«æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒçš„è¡Œä¸ºç”±ä¼ é€’ç»™å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•° request å†³å®šã€‚ä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸€äº›å®ƒæä¾›çš„å…³é”®èƒ½åŠ›ï¼Œè¿™äº›èƒ½åŠ›å¯¹äºç†è§£ CRIU çš„å·¥ä½œè‡³å…³é‡è¦ï¼š</p>
<ol>
<li><strong>å»ºç«‹è¿½è¸ªå…³ç³» (Attaching)</strong>ï¼š
<ul>
<li>PTRACE_ATTACH æˆ– PTRACE_SEIZEï¼šè¿™æ˜¯ tracer æ§åˆ¶ tracee çš„ç¬¬ä¸€æ­¥ã€‚Tracer ä½¿ç”¨è¿™ä¸¤ä¸ªè¯·æ±‚ä¹‹ä¸€æ¥â€œé™„ç€â€åˆ°ç›®æ ‡ tracee è¿›ç¨‹ä¸Šã€‚ä¸€æ—¦é™„ç€æˆåŠŸï¼Œtracee å°±ä¼šæš‚åœä¸‹æ¥ï¼Œå¹¶ä¸”å…¶çŠ¶æ€å˜åŒ–ï¼ˆå¦‚æ”¶åˆ°ä¿¡å·ã€æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼‰éƒ½ä¼šé€šçŸ¥ tracerã€‚PTRACE_SEIZE æ˜¯ä¸€ä¸ªè¾ƒæ–°çš„ã€æ›´æ¨èçš„æ–¹å¼ï¼Œå®ƒé¿å…äº† PTRACE_ATTACH ä¸­ä½¿ç”¨ SIGSTOP ä¿¡å·å¯èƒ½å¸¦æ¥çš„å‰¯ä½œç”¨ï¼Œæ§åˆ¶æ›´ä¸ºç²¾ç¡®ã€‚</li>
</ul>
</li>
<li><strong>è¯»å†™å¯„å­˜å™¨ (Reading/Writing Registers)</strong>ï¼š
<ul>
<li>PTRACE_GETREGS, PTRACE_GETFPREGS ç­‰ï¼šå…è®¸ tracer è¯»å– tracee å½“å‰çš„é€šç”¨å¯„å­˜å™¨ï¼ˆå¦‚æŒ‡ä»¤æŒ‡é’ˆ EIP/RIPã€æ ˆæŒ‡é’ˆ ESP/RSP ç­‰ï¼‰ã€æµ®ç‚¹å¯„å­˜å™¨ç­‰ CPU çŠ¶æ€ã€‚</li>
<li>PTRACE_SETREGS, PTRACE_SETFPREGS ç­‰ï¼šå…è®¸ tracer ä¿®æ”¹ tracee çš„å¯„å­˜å™¨çŠ¶æ€ã€‚è¿™å¯¹äºæ¢å¤è¿›ç¨‹åˆ°æŸä¸ªç²¾ç¡®çš„æ‰§è¡Œç‚¹è‡³å…³é‡è¦ï¼ŒCRIU åœ¨ Restore é˜¶æ®µå°±éœ€è¦ç”¨å®ƒæ¥è®¾ç½®å¥½æ¢å¤åè¿›ç¨‹çš„ CPU ä¸Šä¸‹æ–‡ã€‚</li>
</ul>
</li>
<li><strong>è¯»å†™å†…å­˜ (Reading/Writing Memory)</strong>ï¼š
<ul>
<li>PTRACE_PEEKDATA, PTRACE_PEEKTEXTï¼šå…è®¸ tracer è¯»å– tracee è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ä»»æ„ä½ç½®çš„æ•°æ®ï¼ˆé€šå¸¸ä»¥å­—é•¿ä¸ºå•ä½ï¼‰ã€‚</li>
<li>PTRACE_POKEDATA, PTRACE_POKETEXTï¼šå…è®¸ tracer å‘ tracee è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ä»»æ„ä½ç½®å†™å…¥æ•°æ®ã€‚CRIU æ­£æ˜¯åˆ©ç”¨è¿™ä¸ªèƒ½åŠ›ï¼Œåœ¨ Checkpoint é˜¶æ®µå‘ç›®æ ‡è¿›ç¨‹æ³¨å…¥â€œå¯„ç”Ÿä»£ç â€ï¼ˆä¸€æ®µå¸®åŠ©æ”¶é›†å†…éƒ¨ä¿¡æ¯çš„äºŒè¿›åˆ¶ä»£ç ï¼‰ï¼Œå¹¶åœ¨ Restore é˜¶æ®µå°†å¿«ç…§ä¸­çš„å†…å­˜æ•°æ®å†™å›è¿›ç¨‹ç©ºé—´ã€‚</li>
</ul>
</li>
<li><strong>æ§åˆ¶æ‰§è¡Œ (Controlling Execution)</strong>ï¼š
<ul>
<li>PTRACE_CONTï¼šè®©æš‚åœçš„ tracee ç»§ç»­æ‰§è¡Œã€‚å¯ä»¥é€‰æ‹©æ˜¯å¦ä¼ é€’ä¸€ä¸ªä¿¡å·ç»™ traceeã€‚</li>
<li>PTRACE_SYSCALLï¼šè®© tracee ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°å®ƒè¿›å…¥æˆ–é€€å‡ºä¸‹ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ—¶å†æ¬¡æš‚åœï¼Œå¹¶é€šçŸ¥ tracerã€‚strace å°±æ˜¯åŸºäºæ­¤å·¥ä½œçš„ã€‚CRIU ä¹Ÿç”¨å®ƒæ¥ç²¾ç¡®æ§åˆ¶ç›®æ ‡è¿›ç¨‹æ‰§è¡Œç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚ mmap, munmapï¼‰æ¥è¾…åŠ©å†…å­˜çš„ Checkpoint å’Œ Restoreã€‚</li>
<li>PTRACE_SINGLESTEPï¼šè®© tracee æ‰§è¡Œ<strong>ä¸€æ¡</strong>æœºå™¨æŒ‡ä»¤ï¼Œç„¶åå†æ¬¡æš‚åœã€‚è¿™æ˜¯è°ƒè¯•å™¨å®ç°å•æ­¥æ‰§è¡Œçš„åŸºç¡€ã€‚</li>
</ul>
</li>
<li><strong>è§£é™¤è¿½è¸ªå…³ç³» (Detaching)</strong>ï¼š
<ul>
<li>PTRACE_DETACHï¼šTracer ç»“æŸå¯¹ tracee çš„è¿½è¸ªã€‚Tracee ä¼šæ¢å¤æ­£å¸¸æ‰§è¡Œï¼Œå°±åƒä»æœªè¢«è¿½è¸ªè¿‡ä¸€æ ·ï¼ˆé™¤é tracer ä¿®æ”¹äº†å®ƒçš„çŠ¶æ€ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<p>é€šè¿‡è¿™äº›å¼ºå¤§çš„ï¼ˆç”šè‡³å¯ä»¥è¯´æ˜¯å±é™©çš„ï¼‰èƒ½åŠ›ï¼Œptrace èµ‹äºˆäº† CRIU è¶…è¶Šæ™®é€šè¿›ç¨‹æƒé™çš„æ“ä½œèƒ½åŠ›ã€‚å®ƒä¸ä»…èƒ½é€šè¿‡ /proc çœ‹åˆ°è¿›ç¨‹çš„çŠ¶æ€ï¼Œæ›´èƒ½åƒå¤–ç§‘åŒ»ç”Ÿä¸€æ ·ï¼Œç²¾ç¡®åœ°æš‚åœè¿›ç¨‹ã€æ£€æŸ¥å’Œä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå†…å­˜å’Œå¯„å­˜å™¨ï¼‰ï¼Œç”šè‡³â€œå€Ÿç”¨â€ç›®æ ‡è¿›ç¨‹çš„ä¸Šä¸‹æ–‡æ¥æ‰§è¡Œç‰¹å®šæ“ä½œï¼ˆå¦‚æ³¨å…¥ä»£ç ã€å¼ºåˆ¶æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚æ­£æ˜¯ ptrace çš„å­˜åœ¨ï¼Œä½¿å¾—åœ¨ç”¨æˆ·ç©ºé—´å®ç°å¤æ‚ä¸”ç²¾ç¡®çš„è¿›ç¨‹ Checkpoint/Restore æˆä¸ºå¯èƒ½ï¼Œä¹Ÿé—´æ¥æ”¯æ’‘äº† CRaC æŠ€æœ¯çš„å®ç°ã€‚</p>
<p>å½“ç„¶ï¼Œptrace çš„å¼ºå¤§ä¹Ÿæ„å‘³ç€æ½œåœ¨çš„é£é™©ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä¼šå¯¹å…¶ä½¿ç”¨æ–½åŠ ä¸€äº›å®‰å…¨é™åˆ¶ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæ™®é€šç”¨æˆ·è¿›ç¨‹ä¸èƒ½éšæ„ ptrace å…¶ä»–ç”¨æˆ·çš„è¿›ç¨‹æˆ–ç‰¹æƒè¿›ç¨‹ï¼‰ã€‚</p>
<p>ç†è§£äº† ptrace çš„æ ¸å¿ƒèƒ½åŠ›åï¼Œæˆ‘ä»¬å¯¹ CRIU å¦‚ä½•å®Œæˆé‚£äº›çœ‹ä¼¼ä¸å¯èƒ½çš„ä»»åŠ¡ï¼Œåº”è¯¥æœ‰äº†æ›´æ·±çš„ä½“ä¼šã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æŠŠå‰é¢ä»‹ç»çš„çŸ¥è¯†ç‚¹ä¸²è”èµ·æ¥ï¼Œçœ‹çœ‹ CRIU å…·ä½“æ˜¯å¦‚ä½•ä¸€æ­¥æ­¥å®ç° Checkpoint å’Œ Restore çš„ã€‚</p>
<h2 id="criu-å¦‚ä½•å®ç°-checkpoint-å’Œ-restore">
    <a href="#criu-%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0-checkpoint-%e5%92%8c-restore" class="header-anchor">#</a>
    CRIU å¦‚ä½•å®ç° Checkpoint å’Œ Restoreï¼Ÿ
</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº† Linux çš„è¿›ç¨‹çº¿ç¨‹æ¨¡å‹ã€å¼ºå¤§çš„ /proc æ–‡ä»¶ç³»ç»Ÿä»¥åŠæ‹¥æœ‰â€œé¥æ§â€èƒ½åŠ›çš„ ptrace ç³»ç»Ÿè°ƒç”¨ã€‚æ˜¯æ—¶å€™å°†è¿™äº›çŸ¥è¯†ç‚¹ä¸²è”èµ·æ¥ï¼Œçœ‹çœ‹ CRIU (Checkpoint/Restore In Userspace) æ˜¯å¦‚ä½•åˆ©ç”¨å®ƒä»¬æ¥æ–½å±•â€œå†»ç»“â€ (Checkpoint) å’Œâ€œå¤è‹â€ (Restore) è¿›ç¨‹çš„é­”æ³•äº†ã€‚</p>
<h3 id="checkpoint-å†»ç»“è¿‡ç¨‹ä¸ºè¿›ç¨‹æ‹ä¸‹ç²¾ç¡®å¿«ç…§">
    <a href="#checkpoint-%e5%86%bb%e7%bb%93%e8%bf%87%e7%a8%8b%e4%b8%ba%e8%bf%9b%e7%a8%8b%e6%8b%8d%e4%b8%8b%e7%b2%be%e7%a1%ae%e5%bf%ab%e7%85%a7" class="header-anchor">#</a>
    Checkpoint (å†»ç»“è¿‡ç¨‹)ï¼šä¸ºè¿›ç¨‹æ‹ä¸‹ç²¾ç¡®å¿«ç…§
</h3><p>å½“ CRIU è¢«è¦æ±‚å¯¹ä¸€ä¸ªè¿›ç¨‹ï¼ˆåŠå…¶åä»£ï¼‰è¿›è¡Œ Checkpoint æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œä¸€ç³»åˆ—ç²¾å¿ƒè®¾è®¡çš„æ­¥éª¤ï¼š</p>
<ol>
<li><strong>è¯†åˆ«ç›®æ ‡å®¶æ—</strong>: é¦–å…ˆï¼ŒCRIU éœ€è¦ç¡®å®šè¦å†»ç»“çš„å®Œæ•´ç›®æ ‡ã€‚å®ƒä»ç”¨æˆ·æŒ‡å®šçš„æ ¹è¿›ç¨‹ PID å¼€å§‹ï¼Œé€šè¿‡é€’å½’åœ°è¯»å– /proc/&lt;pid&gt;/task/&lt;tid&gt;/children æ–‡ä»¶ï¼Œåƒå‰¥æ´‹è‘±ä¸€æ ·ï¼Œæ‰¾å‡ºæ‰€æœ‰ç›¸å…³çš„å­è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œæ„å»ºå‡ºå®Œæ•´çš„<strong>è¿›ç¨‹æ ‘</strong>ã€‚</li>
<li><strong>å…¨ä½“â€œç«‹æ­£â€</strong>: æ¥ä¸‹æ¥ï¼ŒCRIU éœ€è¦è®©è¿™ä¸ªåºå¤§å®¶æ—çš„æ‰€æœ‰æˆå‘˜éƒ½æš‚åœä¸‹æ¥ã€‚å®ƒä½¿ç”¨ ptrace(PTRACE_SEIZE, &hellip;) é™„ç€åˆ°è¿›ç¨‹æ ‘ä¸­çš„<strong>æ¯ä¸€ä¸ªä»»åŠ¡</strong>ï¼ˆè¿›ç¨‹/çº¿ç¨‹ï¼‰ä¸Šã€‚PTRACE_SEIZE ä¼šè®©è¿™äº›ä»»åŠ¡åœ¨ä¸‹ä¸€æ¬¡å†…æ ¸æœ‰æœºä¼šä»‹å…¥æ—¶ï¼ˆæ¯”å¦‚ç³»ç»Ÿè°ƒç”¨æˆ–ä¸­æ–­ï¼‰è¿›å…¥æš‚åœçŠ¶æ€ï¼Œå¹¶ä¸”è¿™ç§æš‚åœæ–¹å¼æ¯”è€çš„ PTRACE_ATTACH æ›´ä¸ºå¹²å‡€ï¼Œä¸ä¾èµ– SIGSTOP ä¿¡å·ã€‚</li>
<li><strong>ä¿¡æ¯å¤§æœé›†</strong>: è¿›ç¨‹æ ‘è¢«å†»ç»“åï¼ŒCRIU å¼€å§‹æ‰®æ¼”â€œæƒ…æŠ¥å‘˜â€çš„è§’è‰²ï¼Œé€šè¿‡ /proc æ–‡ä»¶ç³»ç»Ÿå’Œ ptrace æ”¶é›†æ¯ä¸ªä»»åŠ¡çš„è¯¦ç»†çŠ¶æ€ï¼š
<ul>
<li><strong>å†…å­˜å¸ƒå±€</strong>: è§£æ /proc/&lt;pid&gt;/maps å’Œ smaps è·å–è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼ˆVMAï¼‰çš„åœ°å€ã€å¤§å°ã€æƒé™ã€æ˜ å°„æ¥æºï¼ˆæ–‡ä»¶æˆ–åŒ¿åï¼‰ç­‰ä¿¡æ¯ã€‚</li>
<li><strong>æ–‡ä»¶æè¿°ç¬¦</strong>: è¯»å– /proc/&lt;pid&gt;/fd/ å’Œ fdinfo/ ç›®å½•ï¼Œè®°å½•ä¸‹æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶ã€ç®¡é“ã€å¥—æ¥å­—åŠå…¶ç±»å‹ã€è·¯å¾„ã€å½“å‰è¯»å†™ä½ç½®ã€æ ‡å¿—ä½ç­‰çŠ¶æ€ã€‚</li>
<li><strong>è¿›ç¨‹/çº¿ç¨‹æ ¸å¿ƒçŠ¶æ€</strong>: é€šè¿‡ /proc/&lt;pid&gt;/stat è·å–è¿›ç¨‹çš„åŸºæœ¬å±æ€§ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œä½¿ç”¨ ptrace(PTRACE_GETREGS, &hellip;) å’Œ PTRACE_GETFPREGS ç­‰å‘½ä»¤ï¼Œç›´æ¥è¯»å–æ¯ä¸ªä»»åŠ¡æš‚åœæ—¶çš„<strong>CPU å¯„å­˜å™¨</strong>å†…å®¹ï¼ˆåŒ…æ‹¬æŒ‡ä»¤æŒ‡é’ˆã€æ ˆæŒ‡é’ˆã€é€šç”¨å¯„å­˜å™¨ç­‰ï¼‰ã€‚è¿™æ˜¯ç¡®ä¿æ¢å¤åèƒ½ä»æ­£ç¡®ä½ç½®ç»§ç»­æ‰§è¡Œçš„å…³é”®ã€‚</li>
<li><strong>å…¶ä»–èµ„æº</strong>: æ”¶é›†å¦‚ä¿¡å·å¤„ç†å™¨è®¾ç½®ã€å®šæ—¶å™¨ã€å‡­è¯ï¼ˆUID/GIDï¼‰ã€å‘½åç©ºé—´éš¶å±å…³ç³»ç­‰ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li><strong>å†…å­˜å†…å®¹è½¬å‚¨ (å¯èƒ½éœ€è¦â€œå¯„ç”Ÿè™«â€å¸®å¿™)</strong>: è·å–å†…å­˜å¸ƒå±€åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œè¿˜éœ€è¦æŠŠè¿™äº›å†…å­˜åŒºåŸŸé‡Œçš„<strong>å®é™…æ•°æ®</strong>ä¿å­˜ä¸‹æ¥ã€‚å¯¹äºå¤§éƒ¨åˆ†å†…å­˜åŒºåŸŸï¼ŒCRIU å¯ä»¥é€šè¿‡ /proc/&lt;pid&gt;/mem æ–‡ä»¶æˆ–è€… process_vm_readv ç³»ç»Ÿè°ƒç”¨æ¥è¯»å–ã€‚ä½†å¯¹äºæŸäº›ç‰¹æ®Šæˆ–ç§æœ‰çš„å†…å­˜åŒºåŸŸï¼Œæˆ–è€…ä¸ºäº†è·å–æŸäº›æ— æ³•ä»å¤–éƒ¨æ¢æµ‹çš„å†…éƒ¨çŠ¶æ€ï¼ˆå¦‚ç²¾ç¡®çš„æ–‡ä»¶æè¿°ç¬¦çŠ¶æ€ï¼‰ï¼Œç›´æ¥è¯»å–å¯èƒ½å—é™æˆ–æ•ˆç‡ä¸é«˜ã€‚è¿™æ—¶ï¼ŒCRIU ä¼šç¥­å‡ºå®ƒçš„â€œæ€æ‰‹é”â€â€”â€”<strong>å¯„ç”Ÿä»£ç  (Parasite Code)</strong>ã€‚
<ul>
<li>CRIU ä½¿ç”¨ ptrace åœ¨ç›®æ ‡è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­åˆ†é…ä¸€å°å—å†…å­˜ï¼ˆé€šè¿‡å¼ºåˆ¶ç›®æ ‡è¿›ç¨‹æ‰§è¡Œ mmap ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚</li>
<li>ç„¶åï¼Œä½¿ç”¨ ptrace(PTRACE_POKEDATA, &hellip;) å°†ä¸€æ®µé¢„å…ˆç¼–è¯‘å¥½çš„ã€ä¸ä½ç½®æ— å…³çš„ï¼ˆPIEï¼‰äºŒè¿›åˆ¶ä»£ç ï¼ˆå¯„ç”Ÿä»£ç ï¼‰å†™å…¥è¿™å—å†…å­˜ã€‚</li>
<li>æœ€åï¼Œé€šè¿‡ ptrace ä¿®æ”¹ç›®æ ‡è¿›ç¨‹çš„æŒ‡ä»¤æŒ‡é’ˆï¼Œè®©å®ƒè·³è½¬æ‰§è¡Œè¿™æ®µå¯„ç”Ÿä»£ç ã€‚</li>
<li>å¯„ç”Ÿä»£ç è¿è¡Œåœ¨ç›®æ ‡è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæ‹¥æœ‰è®¿é—®å…¶æ‰€æœ‰èµ„æºçš„æƒé™ï¼Œå¯ä»¥é«˜æ•ˆåœ°å®Œæˆå†…å­˜è½¬å‚¨ã€æ”¶é›†å†…éƒ¨ä¿¡æ¯ç­‰ä»»åŠ¡ï¼Œå¹¶å°†ç»“æœä¼ é€’ç»™ CRIUã€‚ä»»åŠ¡å®Œæˆåï¼Œå¯„ç”Ÿä»£ç é€šè¿‡ rt_sigreturn ç³»ç»Ÿè°ƒç”¨æ¢å¤ç›®æ ‡è¿›ç¨‹ä¹‹å‰çš„å¯„å­˜å™¨çŠ¶æ€ï¼ŒCRIU å†å¼ºåˆ¶ç›®æ ‡è¿›ç¨‹æ‰§è¡Œ munmap æ¸…ç†æ‰å¯„ç”Ÿä»£ç å ç”¨çš„å†…å­˜ï¼Œæœ€å ptrace(PTRACE_DETACH, &hellip;) è„±ç¦»ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯¹ç›®æ ‡è¿›ç¨‹æ¥è¯´å‡ ä¹æ˜¯â€œæ— ç—•â€çš„ã€‚</li>
</ul>
</li>
<li><strong>å†™å…¥é•œåƒæ–‡ä»¶</strong>: CRIU å°†æ”¶é›†åˆ°çš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯ï¼ˆå†…å­˜å¸ƒå±€ã€å¯„å­˜å™¨ã€æ–‡ä»¶æè¿°ç¬¦çŠ¶æ€ã€å†…å­˜æ•°æ®ç­‰ï¼‰ç»„ç»‡èµ·æ¥ï¼Œå†™å…¥åˆ°ç£ç›˜ä¸Šçš„ä¸€ç³»åˆ—é•œåƒæ–‡ä»¶ä¸­ã€‚è¿™äº›æ–‡ä»¶å…±åŒæ„æˆäº†è¿›ç¨‹åœ¨ Checkpoint æ—¶åˆ»çš„å®Œæ•´å¿«ç…§ã€‚</li>
<li><strong>(å¯é€‰) ç»ˆæ­¢åŸè¿›ç¨‹</strong>: åœ¨æŸäº›åœºæ™¯ä¸‹ï¼ˆæ¯”å¦‚ CRaC çš„é»˜è®¤è¡Œä¸ºï¼‰ï¼ŒCheckpoint å®Œæˆåï¼ŒåŸå§‹çš„ JVM è¿›ç¨‹ä¼šè¢« CRIU ç»ˆæ­¢ã€‚</li>
</ol>
<h3 id="restore-å¤è‹è¿‡ç¨‹ä»å¿«ç…§é‡å»ºé²œæ´»è¿›ç¨‹">
    <a href="#restore-%e5%a4%8d%e8%8b%8f%e8%bf%87%e7%a8%8b%e4%bb%8e%e5%bf%ab%e7%85%a7%e9%87%8d%e5%bb%ba%e9%b2%9c%e6%b4%bb%e8%bf%9b%e7%a8%8b" class="header-anchor">#</a>
    Restore (å¤è‹è¿‡ç¨‹)ï¼šä»å¿«ç…§é‡å»ºé²œæ´»è¿›ç¨‹
</h3><p>Restore è¿‡ç¨‹å¯ä»¥çœ‹ä½œæ˜¯ Checkpoint çš„é€†æ“ä½œï¼Œå®ƒæ›´åŠ å¤æ‚ï¼Œéœ€è¦ç²¾ç¡®åœ°é‡å»ºè¿›ç¨‹çŠ¶æ€ï¼š</p>
<ol>
<li><strong>è§£æé•œåƒï¼Œè§„åˆ’è“å›¾</strong>: CRIU é¦–å…ˆè¯»å– Checkpoint ç”Ÿæˆçš„é•œåƒæ–‡ä»¶ï¼Œåˆ†æè¿›ç¨‹é—´çš„å…³ç³»ï¼ˆçˆ¶å­ã€å…±äº«èµ„æºç­‰ï¼‰ï¼Œåˆ¶å®šæ¢å¤è®¡åˆ’ã€‚</li>
<li><strong>æ­å»ºéª¨æ¶</strong>: CRIU ä¸¥æ ¼æŒ‰ç…§é•œåƒä¸­è®°å½•çš„è¿›ç¨‹æ ‘ç»“æ„ï¼Œé€šè¿‡å¤šæ¬¡è°ƒç”¨ fork() æ¥åˆ›å»ºæ–°çš„è¿›ç¨‹ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œé€šå¸¸åªåˆ›å»ºè¿›ç¨‹çš„ä¸»çº¿ç¨‹ã€‚</li>
<li><strong>æ¢å¤åŸºæœ¬èµ„æº</strong>: å¯¹äºæ¯ä¸ªæ–°åˆ›å»ºçš„è¿›ç¨‹ï¼ŒCRIU å¼€å§‹æ¢å¤å¤§éƒ¨åˆ†çŠ¶æ€ï¼š
<ul>
<li><strong>æ–‡ä»¶æè¿°ç¬¦</strong>: æ ¹æ®é•œåƒä¿¡æ¯é‡æ–°æ‰“å¼€æ–‡ä»¶ï¼ˆå¯èƒ½éœ€è¦éªŒè¯è·¯å¾„æœ‰æ•ˆæ€§ï¼‰ã€åˆ›å»ºç®¡é“å’Œå¥—æ¥å­—ï¼Œå¹¶è®¾ç½®å¥½å®ƒä»¬çš„çŠ¶æ€ï¼ˆå¦‚æ–‡ä»¶åç§»é‡ï¼‰ã€‚å¯¹äºå…±äº«çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œéœ€è¦ç¡®ä¿å®ƒä»¬æŒ‡å‘åŒä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼ˆå¯èƒ½ç”¨åˆ° SCM_RIGHTS ç­‰æŠ€æœ¯ï¼‰ã€‚</li>
<li><strong>å†…å­˜æ˜ å°„ (åˆæ­¥)</strong>: ä½¿ç”¨ mmap() æ ¹æ®é•œåƒä¸­çš„ VMA ä¿¡æ¯åˆ›å»ºå†…å­˜åŒºåŸŸã€‚å¯¹äºç§æœ‰å†…å­˜ï¼Œä¼šå…ˆæ˜ å°„åŒ¿åå†…å­˜ï¼Œç¨åå†å¡«å……æ•°æ®ï¼›å¯¹äºæ–‡ä»¶æ˜ å°„ï¼Œä¼šé‡æ–°æ˜ å°„ç›¸åº”çš„æ–‡ä»¶ã€‚æ­¤æ—¶æ˜ å°„çš„è™šæ‹Ÿåœ°å€å¯èƒ½è¿˜ä¸æ˜¯æœ€ç»ˆçš„ç›®æ ‡åœ°å€ã€‚</li>
<li><strong>å‘½åç©ºé—´</strong>: å¦‚æœè¿›ç¨‹ä½¿ç”¨äº†éé»˜è®¤çš„å‘½åç©ºé—´ï¼ŒCRIU ä¼šè´Ÿè´£åˆ›å»ºæˆ–åŠ å…¥è¿™äº›å‘½åç©ºé—´ã€‚</li>
<li><strong>å…¶ä»–</strong>: æ¢å¤å·¥ä½œç›®å½•ã€æ ¹ç›®å½•ã€ä¿¡å·å¤„ç†å™¨ç­‰ã€‚</li>
</ul>
</li>
<li><strong>å…³é”®æ­¥éª¤ï¼šåˆ‡æ¢ä¸Šä¸‹æ–‡ä¸ç²¾ç»†æ¢å¤</strong>: è¿™æ˜¯ Restore ä¸­æœ€ç²¾å¦™ä¹Ÿæœ€å›°éš¾çš„éƒ¨åˆ†ã€‚å› ä¸ºæ‰§è¡Œ Restore æ“ä½œçš„ CRIU ä»£ç æœ¬èº«å¯èƒ½å°±ä½äºéœ€è¦è¢«æ¢å¤å†…å®¹è¦†ç›–çš„å†…å­˜åŒºåŸŸã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼š
<ul>
<li>CRIU ä¼šæ‰¾åˆ°ä¸€å—ä¸´æ—¶çš„ã€å®‰å…¨çš„å†…å­˜â€œç©ºåœ°â€ï¼ŒåŠ è½½ä¸€å°æ®µè‡ªåŒ…å«çš„ã€ä½ç½®æ— å…³çš„<strong>æ¢å¤å™¨ä»£ç  (Restorer Context)</strong>ã€‚</li>
<li>ç„¶åï¼Œé€šè¿‡ä¸€æ¬¡è·³è½¬ï¼Œå°† CPU çš„æ§åˆ¶æƒäº¤ç»™è¿™æ®µæ¢å¤å™¨ä»£ç ã€‚</li>
<li>åœ¨æ¢å¤å™¨ä»£ç çš„æ§åˆ¶ä¸‹ï¼Œè¿›è¡Œæœ€åä¹Ÿæ˜¯æœ€å…³é”®çš„æ¢å¤æ­¥éª¤ï¼š
<ul>
<li><strong>ç²¾ç¡®å†…å­˜å¸ƒå±€</strong>: ä½¿ç”¨ mremap() å°†ä¹‹å‰æ˜ å°„åœ¨ä¸´æ—¶åœ°å€çš„å†…å­˜ç§»åŠ¨åˆ°é•œåƒä¸­è®°å½•çš„<strong>æœ€ç»ˆè™šæ‹Ÿåœ°å€</strong>ã€‚ä½¿ç”¨ mmap() åœ¨æ­£ç¡®çš„ä½ç½®åˆ›å»ºæ–‡ä»¶æ˜ å°„å’Œå…±äº«å†…å­˜æ˜ å°„ã€‚è‡³æ­¤ï¼Œè¿›ç¨‹çš„å†…å­˜å¸ƒå±€ä¸ Checkpoint æ—¶å®Œå…¨ä¸€è‡´ã€‚</li>
<li><strong>å¡«å……å†…å­˜æ•°æ®</strong>: å°†é•œåƒæ–‡ä»¶ä¸­ä¿å­˜çš„å†…å­˜é¡µæ•°æ®ï¼Œé€šè¿‡ read() æˆ–ç±»ä¼¼æ–¹å¼å†™å›åˆ°ç›¸åº”çš„å†…å­˜åŒºåŸŸã€‚</li>
<li><strong>æ¢å¤çº¿ç¨‹</strong>: åœ¨æœ€ç»ˆçš„å†…å­˜å¸ƒå±€ä¸­ï¼Œæ ¹æ®ä¿å­˜çš„çŠ¶æ€åˆ›å»ºå¹¶æ¢å¤è¿›ç¨‹çš„æ‰€æœ‰å…¶ä»–çº¿ç¨‹ã€‚</li>
<li><strong>æ¢å¤å¯„å­˜å™¨</strong>: ä½¿ç”¨ ptrace(PTRACE_SETREGS, &hellip;)ï¼ˆæˆ–è€…åœ¨æ¢å¤å™¨ä»£ç å†…éƒ¨é€šè¿‡ç‰¹å®šæœºåˆ¶ï¼‰å°†æ¯ä¸ªçº¿ç¨‹çš„ CPU å¯„å­˜å™¨ï¼ˆç‰¹åˆ«æ˜¯æŒ‡ä»¤æŒ‡é’ˆ IP/PC å’Œæ ˆæŒ‡é’ˆ SPï¼‰<strong>ç²¾ç¡®åœ°è®¾ç½®</strong>ä¸º Checkpoint æ—¶ä¿å­˜çš„å€¼ã€‚</li>
<li><strong>æ¢å¤å…¶ä»–ç»†èŠ‚</strong>: æ¢å¤å®šæ—¶å™¨ã€å‡­è¯ç­‰ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>â€œç‚¹ç«â€å¯åŠ¨</strong>: å½“æ‰€æœ‰çŠ¶æ€éƒ½æ¢å¤å®Œæ¯•ï¼Œæ¢å¤å™¨ä»£ç ä¼šæ‰§è¡Œæœ€åä¸€æ­¥â€”â€”é€šå¸¸æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„è¿”å›æˆ–è·³è½¬æŒ‡ä»¤ï¼Œå°† CPU çš„æ§åˆ¶æƒå½»åº•äº¤è¿˜ç»™æ¢å¤åçš„è¿›ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ã€‚ç”±äºæŒ‡ä»¤æŒ‡é’ˆå·²ç»è¢«ç²¾ç¡®è®¾ç½®ï¼Œè¿›ç¨‹ä¼šä» Checkpoint æ—¶è¢«ä¸­æ–­çš„é‚£æ¡æŒ‡ä»¤<strong>æ— ç¼åœ°ç»§ç»­æ‰§è¡Œ</strong>ï¼Œä»¿ä½›ä»æœªè¢«æ‰“æ–­è¿‡ã€‚</li>
<li><strong>ç®¡ç† Restore æµç¨‹ (execv é“¾)</strong>: å‰é¢æåˆ°ï¼ŒCRaC çš„ java -XX:CRaCRestoreFrom=&hellip; å‘½ä»¤å¯åŠ¨åï¼Œä¼šé€šè¿‡ criuengine è¿™ä¸ªè¾…åŠ©ç¨‹åºæ¥åè°ƒ Restoreã€‚è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠå¤šæ¬¡ execv è°ƒç”¨ï¼šåˆå§‹ Java å‘½ä»¤ execv å˜æˆ criuengine restoreï¼Œåè€…å† execv å˜æˆ criu restore æ¥æ‰§è¡ŒçœŸæ­£çš„æ¢å¤æ“ä½œã€‚å½“ criu restore æˆåŠŸæ¢å¤ç›®æ ‡ JVM è¿›ç¨‹åï¼Œå®ƒä¼šå†æ¬¡ execv å˜æˆ criuengine restorewaitï¼Œè¿™ä¸ªæœ€ç»ˆçš„è¿›ç¨‹è´Ÿè´£ç­‰å¾…æ¢å¤åçš„ JVM è¿›ç¨‹ç»“æŸï¼Œå¹¶å°† JVM çš„é€€å‡ºçŠ¶æ€ä¼ é€’å›å»ã€‚</li>
</ol>
<p>é€šè¿‡è¿™ä¸€ç³»åˆ—å¤æ‚è€Œç²¾å¯†çš„æ­¥éª¤ï¼Œç»“åˆå¯¹ /proc çš„è¯»å–å’Œå¯¹ ptrace çš„æ·±åº¦è¿ç”¨ï¼ŒCRIU å®ç°äº†åœ¨ç”¨æˆ·ç©ºé—´å¯¹è¿è¡Œä¸­è¿›ç¨‹è¿›è¡Œå¿«ç…§å’Œæ¢å¤çš„å¼ºå¤§èƒ½åŠ›ï¼Œä¸º CRaC æŠ€æœ¯çš„å®ç°å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚</p>
<p>ç†è§£äº† CRIU çš„åŸºæœ¬å·¥ä½œåŸç†åï¼Œæˆ‘ä»¬å°±èƒ½æ›´å¥½åœ°ç†è§£ CRaC ä¸ºä½•è¿˜éœ€è¦ä¸€ä¸ªâ€œåè°ƒâ€å±‚ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ¢è®¨ CRaC çš„ Resource API å­˜åœ¨çš„æ„ä¹‰ã€‚</p>
<h2 id="crac-å¦‚ä½•æŒ‡æŒ¥-criu">
    <a href="#crac-%e5%a6%82%e4%bd%95%e6%8c%87%e6%8c%a5-criu" class="header-anchor">#</a>
    CRaC å¦‚ä½•æŒ‡æŒ¥ CRIU
</h2><p>æˆ‘ä»¬å·²ç»äº†è§£äº† CRIU å¦‚ä½•åˆ©ç”¨ Linux çš„åº•å±‚æœºåˆ¶æ¥å®ç°è¿›ç¨‹çš„ Checkpoint å’Œ Restoreã€‚ä½† CRaC (Coordinated Restore at Checkpoint) æœ¬èº«å¹¶ä¸ç›´æ¥æ‰§è¡Œè¿™äº›å¤æ‚çš„åº•å±‚æ“ä½œã€‚ç›¸åï¼ŒCRaC æ›´åƒæ˜¯ä¸€ä¸ª<strong>æŒ‡æŒ¥å®˜</strong>ï¼Œå®ƒé€šè¿‡åè°ƒ JVM å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨èµ„æºï¼Œå¹¶åœ¨æ°å½“çš„æ—¶æœº<strong>è°ƒç”¨</strong> CRIU æ¥å®Œæˆå®é™…çš„â€œå†»ç»“â€ä¸â€œå¤è‹â€å·¥ä½œã€‚è¿™ç§è°ƒç”¨é€šå¸¸æ˜¯é€šè¿‡ä¸€ä¸ªè¾…åŠ©ç¨‹åºï¼ˆåœ¨ OpenJDK CRaC å®ç°ä¸­ç§°ä¸º criuengineï¼‰æ¥é—´æ¥å®Œæˆçš„ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒLinux çš„è¿›ç¨‹åˆ›å»ºã€æ›¿æ¢å’Œç®¡ç†æŠ€æœ¯ï¼Œç‰¹åˆ«æ˜¯ forkã€execv å’Œ double forkï¼Œæ‰®æ¼”äº†è‡³å…³é‡è¦çš„è§’è‰²ã€‚</p>
<h3 id="checkpoint-æµç¨‹ä¸­çš„è¿›ç¨‹ä¹‹èˆ-double-fork">
    <a href="#checkpoint-%e6%b5%81%e7%a8%8b%e4%b8%ad%e7%9a%84%e8%bf%9b%e7%a8%8b%e4%b9%8b%e8%88%9e-double-fork" class="header-anchor">#</a>
    Checkpoint æµç¨‹ä¸­çš„è¿›ç¨‹ä¹‹èˆ (double fork)
</h3><p>å½“ç”¨æˆ·é€šè¿‡ jcmd &lt;pid&gt; JDK.checkpoint å‘½ä»¤è§¦å‘ CRaC çš„ Checkpoint æ—¶ï¼Œä¸€åœºç²¾å¿ƒç¼–æ’çš„è¿›ç¨‹äº¤äº’å°±å¼€å§‹äº†ï¼š</p>
<ol>
<li><strong>JVM å†…éƒ¨å‡†å¤‡</strong>: JVM æ¥æ”¶åˆ°å‘½ä»¤åï¼Œä¼šæ‰§è¡Œä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚è§¦å‘ä¸€æ¬¡ Full GC æ¥å‡å°é•œåƒä½“ç§¯ï¼Œç„¶åè¿›å…¥ä¸€ä¸ªå…¨å±€å®‰å…¨ç‚¹ï¼ˆSafepointï¼‰ï¼Œæš‚åœæ‰€æœ‰ Java çº¿ç¨‹ã€‚</li>
<li><strong>å¯åŠ¨å¤–éƒ¨å¼•æ“</strong>: JVM è°ƒç”¨ fork() åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ (æˆ‘ä»¬ç§°ä¹‹ä¸º P1)ï¼Œè¿™ä¸ªå­è¿›ç¨‹ P1 çš„ä»»åŠ¡æ˜¯æ‰§è¡Œ criuengine checkpoint å‘½ä»¤ã€‚JVM ä¸»è¿›ç¨‹åˆ™ä¼šæš‚åœï¼Œç­‰å¾… P1 çš„æŸç§å½¢å¼çš„å®Œæˆä¿¡å·æˆ–é€€å‡ºã€‚</li>
<li><strong>double fork ç™»åœº</strong>: è¿™é‡Œçš„å…³é”®åœ¨äº criuengine (P1) å¦‚ä½•è°ƒç”¨ criu dump æ¥å†»ç»“åŸå§‹çš„ JVM è¿›ç¨‹ã€‚å¦‚æœ P1 ç›´æ¥è°ƒç”¨ criu dumpï¼Œé‚£ä¹ˆ criu è¿›ç¨‹å°±ä¼šæ˜¯ JVM çš„å­™å­è¿›ç¨‹ï¼Œä»ç„¶å±äºåŒä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œè¿™åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½å¯¼è‡´é—®é¢˜ï¼ˆæ¯”å¦‚å°è¯•å†»ç»“è‡ªå·±æ‰€åœ¨çš„è¿›ç¨‹ç»„ï¼‰ã€‚ä¸ºäº†å½»åº•è§£è€¦ï¼Œcriuengine ä½¿ç”¨äº† double fork æŠ€å·§ï¼š
<ul>
<li>P1 (criuengine checkpoint) è°ƒç”¨ fork() åˆ›å»ºå­è¿›ç¨‹ P2ã€‚ç„¶å P1 ä¼šç­‰å¾… P2 é€€å‡ºã€‚</li>
<li>P2 <strong>å†æ¬¡</strong>è°ƒç”¨ fork() åˆ›å»ºå­™å­è¿›ç¨‹ P3ã€‚</li>
<li>P2 <strong>ç«‹å³é€€å‡º</strong> (exit())ã€‚</li>
<li>P1 æ£€æµ‹åˆ° P2 é€€å‡ºåï¼ŒP1 ä¹Ÿé€€å‡ºã€‚</li>
<li>æ­¤æ—¶ï¼ŒP3 æˆä¸ºäº†<strong>å­¤å„¿è¿›ç¨‹</strong>ï¼Œå…¶çˆ¶è¿›ç¨‹è¢«ç³»ç»Ÿ init è¿›ç¨‹ï¼ˆPID 1ï¼‰æ¥ç®¡ã€‚P3 ç°åœ¨ä¸åŸå§‹çš„ JVM è¿›ç¨‹ï¼ˆå®ƒçš„â€œæ›¾ç¥–çˆ¶â€ï¼‰åœ¨è¿›ç¨‹æ ‘ä¸Šå·²ç»æ²¡æœ‰ç›´æ¥å…³ç³»äº†ã€‚</li>
</ul>
</li>
<li><strong>æ‰§è¡Œå†»ç»“</strong>: æˆä¸ºå­¤å„¿çš„ P3 è¿›ç¨‹ç°åœ¨å¯ä»¥å®‰å…¨åœ°æ‰§è¡Œ criu dump -t &lt;jvm_pid&gt; &hellip; å‘½ä»¤ï¼Œç›®æ ‡ç›´æŒ‡åŸå§‹çš„ã€æ­£åœ¨ç­‰å¾…çš„ JVM è¿›ç¨‹ã€‚criu åˆ©ç”¨æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ /proc å’Œ ptrace æŠ€æœ¯ï¼Œå°† JVM çš„å®Œæ•´çŠ¶æ€ä¿å­˜åˆ°é•œåƒæ–‡ä»¶ä¸­ã€‚</li>
<li><strong>ç»ˆç»“ä¸ç­‰å¾…</strong>: criu dump åœ¨æˆåŠŸåˆ›å»ºé•œåƒåï¼Œé€šå¸¸ä¼š<strong>æ€æ­»</strong> (kill) è¢«å†»ç»“çš„åŸå§‹ JVM è¿›ç¨‹ã€‚è€ŒåŸå§‹ JVM è¿›ç¨‹åœ¨ fork å‡º P1 åï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰å®Œå…¨é˜»å¡ï¼Œå®ƒä¼šç»§ç»­æ‰§è¡Œä¸€å°æ®µä»£ç ï¼Œé€šå¸¸æ˜¯è¿›å…¥ä¸€ä¸ª sigwaitinfo() è°ƒç”¨ï¼Œç­‰å¾…ä¸€ä¸ªç‰¹å®šçš„ä¿¡å·ï¼ˆRESTORE_SIGNALï¼‰ï¼Œè¿™ä¸ªä¿¡å·åªæœ‰åœ¨æœªæ¥çš„ Restore è¿‡ç¨‹ä¸­æ‰ä¼šè¢«å‘é€ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œå®ƒå°±è¢« criu dump ç»“æŸäº†ç”Ÿå‘½ã€‚</li>
</ol>
<p>é€šè¿‡ double forkï¼ŒCRaC å·§å¦™åœ°ç¡®ä¿äº†æ‰§è¡Œå†»ç»“æ“ä½œçš„ criu è¿›ç¨‹ç‹¬ç«‹äºè¢«å†»ç»“çš„ JVM è¿›ç¨‹æ ‘ä¹‹å¤–ï¼Œä¿è¯äº† Checkpoint æ“ä½œçš„å¹²å‡€å’Œå¯é ã€‚</p>
<h3 id="restore-æµç¨‹ä¸­çš„è¿›ç¨‹å˜èº«-execv-é“¾">
    <a href="#restore-%e6%b5%81%e7%a8%8b%e4%b8%ad%e7%9a%84%e8%bf%9b%e7%a8%8b%e5%8f%98%e8%ba%ab-execv-%e9%93%be" class="header-anchor">#</a>
    Restore æµç¨‹ä¸­çš„è¿›ç¨‹â€œå˜èº«â€ (execv é“¾)
</h3><p>Restore è¿‡ç¨‹åˆ™å±•ç¤ºäº† execv ç³»ç»Ÿè°ƒç”¨çš„å¨åŠ›ï¼Œå®ƒå…è®¸ä¸€ä¸ªè¿›ç¨‹ç”¨ä¸€ä¸ªå…¨æ–°çš„ç¨‹åºæ˜ åƒæ›¿æ¢è‡ªå·±ï¼Œå®ç°â€œåŸåœ°å˜èº«â€ï¼š</p>
<ol>
<li><strong>å¯åŠ¨ Restore å‘½ä»¤</strong>: ç”¨æˆ·æ‰§è¡Œ java -XX:CRaCRestoreFrom=&lt;checkpoint_dir&gt;ã€‚</li>
<li><strong>JVM çš„â€œæ”¹é“â€</strong>: è¿™ä¸ª Java å‘½ä»¤å¯åŠ¨çš„ JVM è¿›ç¨‹ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º P1ï¼‰åœ¨éå¸¸æ—©æœŸçš„åˆå§‹åŒ–é˜¶æ®µï¼Œå°±ä¼šæ£€æµ‹åˆ° -XX:CRaCRestoreFrom å‚æ•°ã€‚å®ƒ<strong>ä¸ä¼š</strong>ç»§ç»­æ‰§è¡Œæ ‡å‡†çš„ JVM å¯åŠ¨æµç¨‹ï¼Œè€Œæ˜¯ç«‹å³â€œæ”¹é“â€ã€‚</li>
<li><strong>ç¬¬ä¸€æ¬¡å˜èº« (execv)</strong>: P1 è°ƒç”¨ execv()ï¼Œå°†å…¶è‡ªèº«æ›¿æ¢ä¸º criuengine restore ç¨‹åºã€‚æ­¤æ—¶ï¼ŒåŸæ¥çš„ java è¿›ç¨‹ P1 ä¸å¤å­˜åœ¨ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯è¿è¡Œç€ criuengine restore ä»£ç çš„è¿›ç¨‹ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º P2ï¼Œå°½ç®¡ PID å¯èƒ½ä¸ P1 ç›¸åŒï¼‰ã€‚</li>
<li><strong>ç¬¬äºŒæ¬¡å˜èº« (execv)</strong>: P2 (criuengine restore) è´Ÿè´£è§£æå‚æ•°ï¼Œå‡†å¤‡å¥½è°ƒç”¨ criu æ‰€éœ€çš„ç¯å¢ƒï¼Œç„¶åå†æ¬¡è°ƒç”¨ execv()ï¼Œå°†è‡ªèº«æ›¿æ¢ä¸º criu restore ç¨‹åºï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º P3ï¼‰ã€‚</li>
<li><strong>CRIU æ‰§è¡Œæ¢å¤</strong>: P3 (criu restore) è¯»å–é•œåƒæ–‡ä»¶ï¼Œåˆ©ç”¨ forkã€mmapã€ptrace ç­‰æŠ€æœ¯ï¼Œåœ¨å†…å­˜ä¸­é€æ­¥é‡å»º JVM è¿›ç¨‹çš„çŠ¶æ€ã€‚è¿™ä¸ªæ¢å¤è¿‡ç¨‹å¯èƒ½ç›¸å½“å¤æ‚ï¼Œæ¶‰åŠåˆ›å»ºæ–°çš„è¿›ç¨‹ï¼ˆæ¢å¤åçš„ JVMï¼‰ï¼Œè®¾ç½®å†…å­˜ï¼Œæ¢å¤æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¢å¤çº¿ç¨‹ç­‰ã€‚</li>
<li><strong>å”¤é†’ä¸äº¤æ¥</strong>: åœ¨æ¢å¤çš„ç›®æ ‡ JVM è¿›ç¨‹çŠ¶æ€åŸºæœ¬å°±ç»ªï¼Œä½†å°šæœªå¼€å§‹æ‰§è¡Œç”¨æˆ·ä»£ç æ—¶ï¼ŒP3 (criu restore) ä¼šé€šè¿‡å…¶é…ç½®çš„åŠ¨ä½œè„šæœ¬ï¼ˆé€šå¸¸æ˜¯ criuengine è‡ªèº«ï¼‰å‘æ¢å¤åçš„ JVM è¿›ç¨‹å‘é€ä¸€ä¸ªç‰¹å®šçš„ä¿¡å·ï¼ˆå¦‚ RESTORE_SIGNALï¼‰ï¼Œè¿™ä¸ªä¿¡å·ä¼šå”¤é†’ JVM å†…éƒ¨ç­‰å¾…çš„ä»£ç ï¼ˆè¿˜è®°å¾— Checkpoint æœ€å JVM ç­‰å¾…çš„ sigwaitinfo å—ï¼Ÿæ¢å¤åçš„ JVM å°±ä»è¿™é‡Œâ€œé†’æ¥â€ï¼‰ã€‚</li>
<li><strong>ç¬¬ä¸‰æ¬¡å˜èº« (execv)</strong>: åœ¨æˆåŠŸæ¢å¤ JVM å¹¶å‘é€å”¤é†’ä¿¡å·åï¼ŒP3 (criu restore) è¿›ç¨‹çš„ä»»åŠ¡ä¹Ÿå³å°†ç»“æŸã€‚æ ¹æ®å¯åŠ¨æ—¶é€šè¿‡ --exec-cmd å‚æ•°çš„æŒ‡ç¤ºï¼Œå®ƒä¼šæ‰§è¡Œæœ€åä¸€æ¬¡ execv()ï¼Œå°†è‡ªèº«æ›¿æ¢ä¸º criuengine restorewait ç¨‹åºï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º P4ï¼‰ã€‚</li>
<li><strong>å®ˆæœ›è€… (waitpid)</strong>: P4 (criuengine restorewait) çš„å”¯ä¸€ä½¿å‘½å°±æ˜¯æ‰®æ¼”ä¸€ä¸ªâ€œå®ˆæœ›è€…â€ã€‚å®ƒçŸ¥é“åˆšåˆšæ¢å¤çš„ JVM è¿›ç¨‹çš„ PIDï¼Œç„¶åè°ƒç”¨ waitpid() ç­‰å¾…è¿™ä¸ª JVM è¿›ç¨‹ç»“æŸã€‚å½“ JVM æœ€ç»ˆé€€å‡ºæ—¶ï¼ŒP4 ä¼šè·å–å…¶é€€å‡ºçŠ¶æ€ï¼Œå¹¶ä»¥ç›¸åŒçš„çŠ¶æ€é€€å‡ºã€‚è¿™æ ·ï¼Œæœ€åˆå¯åŠ¨ java -XX:CRaCRestoreFrom=&hellip; å‘½ä»¤çš„ç”¨æˆ·å°±èƒ½å¾—åˆ°æ¢å¤å JVM çš„æœ€ç»ˆæ‰§è¡Œç»“æœã€‚</li>
</ol>
<p>åœ¨è¿™ä¸ª execv è°ƒç”¨é“¾ä¸­ï¼Œæ§åˆ¶æƒè¢«å¹³æ»‘åœ°ä»åˆå§‹çš„ Java å‘½ä»¤ä¼ é€’ç»™ criuengineï¼Œå†åˆ° criu æœ¬èº«ï¼Œæœ€åäº¤æ¥ç»™è´Ÿè´£ç­‰å¾…çš„ criuengine restorewaitã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¿›ç¨‹çš„èº«ä»½ï¼ˆæ‰§è¡Œçš„ç¨‹åºï¼‰ä¸æ–­å˜åŒ–ï¼Œä½†é€šå¸¸æ˜¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ ID ä¸‹å®Œæˆï¼ˆé™¤äº† criu restore å†…éƒ¨é‡å»º JVM æ—¶ä¼šåˆ›å»ºæ–°è¿›ç¨‹ï¼‰ï¼Œé«˜æ•ˆåœ°åˆ©ç”¨äº†ç°æœ‰çš„è¿›ç¨‹ä¸Šä¸‹æ–‡æ¥æ‰§è¡Œä¸åŒçš„ä»»åŠ¡é˜¶æ®µã€‚</p>
<p>æ€»ç»“æ¥è¯´ï¼ŒCRaC å¹¶éé­”æ³•ï¼Œè€Œæ˜¯å»ºç«‹åœ¨å¯¹ Linux è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æ·±åˆ»ç†è§£å’Œå·§å¦™è¿ç”¨ä¹‹ä¸Šã€‚å®ƒé€šè¿‡è¾…åŠ©ç¨‹åºï¼Œç²¾ç¡®åœ°ç¼–æ’ forkã€execvã€waitpid ç­‰ç³»ç»Ÿè°ƒç”¨ï¼ŒæŒ‡æŒ¥ CRIU è¿™ä½â€œåº•å±‚å¤§å¸ˆâ€å®Œæˆå¤æ‚çš„ Checkpoint å’Œ Restore æ“ä½œï¼Œæœ€ç»ˆå®ç°äº† Java åº”ç”¨å¯åŠ¨æ€§èƒ½çš„å·¨å¤§é£è·ƒã€‚</p>
<h2 id="æ€»ç»“linux-ç³»ç»Ÿç¼–ç¨‹æ˜¯-crac-çš„åŸºçŸ³">
    <a href="#%e6%80%bb%e7%bb%93linux-%e7%b3%bb%e7%bb%9f%e7%bc%96%e7%a8%8b%e6%98%af-crac-%e7%9a%84%e5%9f%ba%e7%9f%b3" class="header-anchor">#</a>
    æ€»ç»“ï¼šLinux ç³»ç»Ÿç¼–ç¨‹æ˜¯ CRaC çš„åŸºçŸ³
</h2><p>å›é¡¾å…¨æ–‡ï¼Œæˆ‘ä»¬ä¸€èµ·æ¢ç´¢äº† CRaC æŠ€æœ¯èƒŒåæ‰€ä¾èµ–çš„å…³é”® Linux ç³»ç»Ÿç¼–ç¨‹æ¦‚å¿µã€‚ä»åŸºæœ¬çš„è¿›ç¨‹ä¸çº¿ç¨‹æ¨¡å‹ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆfork, execv, waitpid, double forkï¼‰ï¼Œåˆ°å¼ºå¤§çš„è¿›ç¨‹çŠ¶æ€â€œé€è§†é•œâ€ /proc æ–‡ä»¶ç³»ç»Ÿï¼Œå†åˆ°èƒ½å¤Ÿç²¾ç»†æ§åˆ¶è¿›ç¨‹çš„â€œé¥æ§å™¨â€ptrace ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™äº›éƒ½æ˜¯ Linux æä¾›çš„åº•å±‚èƒ½åŠ›ã€‚</p>
<p>æˆ‘ä»¬çœ‹åˆ°ï¼ŒCRIU æ­£æ˜¯å·§å¦™åœ°ç»„åˆè¿ç”¨äº†è¿™äº›æœºåˆ¶ï¼Œæ‰å¾—ä»¥åœ¨ç”¨æˆ·ç©ºé—´å®ç°å¯¹è¿è¡Œä¸­è¿›ç¨‹è¿›è¡Œç²¾ç¡® Checkpoint å’Œ Restore çš„å¤æ‚æ“ä½œã€‚è€Œ CRaC åˆ™æ›´è¿›ä¸€æ­¥ï¼Œé€šè¿‡åè°ƒ JVM å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨èµ„æºï¼Œå¹¶æŒ‡æŒ¥ CRIU å®Œæˆæ ¸å¿ƒçš„å†»ç»“ä¸å¤è‹ä»»åŠ¡ï¼Œæœ€ç»ˆè¾¾æˆäº†å¤§å¹…ä¼˜åŒ– Java åº”ç”¨å¯åŠ¨æ€§èƒ½çš„ç›®æ ‡ã€‚</p>
<p>å› æ­¤ï¼Œç†è§£è¿™äº› Linux ç³»ç»Ÿç¼–ç¨‹çš„çŸ¥è¯†ï¼Œä¸ä»…èƒ½å¸®åŠ©æˆ‘ä»¬æ­å¼€ CRaC å®ç°åŸç†çš„ç¥ç§˜é¢çº±ï¼Œæ›´èƒ½è®©æˆ‘ä»¬ä½“ä¼šåˆ°ç°ä»£è½¯ä»¶æŠ€æœ¯åˆ›æ–°å¾€å¾€æ˜¯å»ºç«‹åœ¨å¯¹åº•å±‚ç³»ç»Ÿæ·±åˆ»ç†è§£å’Œåˆ›é€ æ€§åº”ç”¨çš„åŸºç¡€ä¹‹ä¸Šã€‚å¸Œæœ›æœ¬æ–‡èƒ½ä¸ºæ‚¨æ‰“å¼€ä¸€æ‰‡é€šå¾€ Linux ç³»ç»Ÿç¼–ç¨‹ä¸–ç•Œçš„å°çª—ï¼Œæ¿€å‘æ‚¨è¿›ä¸€æ­¥æ¢ç´¢çš„å…´è¶£ã€‚</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/linux/">Linux</a>
        
            <a href="/tags/java/">Java</a>
        
            <a href="/tags/crac/">Crac</a>
        
            <a href="/tags/performance/">Performance</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/crac-%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/">
        
        

        <div class="article-details">
            <h2 class="article-title">CRaC æŠ€æœ¯æ·±åº¦è§£æ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E6%8F%AD%E7%A7%98-jvm-%E5%81%9C%E9%A1%BF%E7%9A%84%E8%83%8C%E5%90%8E%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-safepoint/">
        
        

        <div class="article-details">
            <h2 class="article-title">æ­ç§˜ JVM åœé¡¿çš„èƒŒåï¼šæ·±å…¥ç†è§£ Safepoint</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/perf-%E7%9A%84-cpu-clock-%E4%B8%8E-cpu-cycles-%E9%87%87%E6%A0%B7%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%AF%B9%E6%AF%94/">
        
        

        <div class="article-details">
            <h2 class="article-title">Perf çš„ cpu-clock ä¸ cpu-cycles é‡‡æ ·å®ç°ä¸å¯¹æ¯”</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/wall-clock-%E4%B8%8E-cpu-cycles-%E9%87%87%E6%A0%B7%E7%9A%84%E5%8C%BA%E5%88%AB/">
        
        

        <div class="article-details">
            <h2 class="article-title">Wall-Clock ä¸ CPU-Cycles é‡‡æ ·çš„åŒºåˆ«</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/%E4%BD%BF%E7%94%A8-printassembly-%E6%9F%A5%E7%9C%8B-jit-%E7%BC%96%E8%AF%91%E5%90%8E%E7%9A%84%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81/">
        
        

        <div class="article-details">
            <h2 class="article-title">ä½¿ç”¨ PrintAssembly æŸ¥çœ‹ JIT ç¼–è¯‘åçš„æ±‡ç¼–ä»£ç </h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mazhen-tech" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2014 - 
        
        2025 mazhen.tech
    </section>
    
    <section class="powerby">
        
            <a target=\"_blank\" href=\"https://beian.miit.gov.cn\">ç²¤ ICP å¤‡ 2022085181 å· -1</a> <br/>
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.25.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
